<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
<!-- 2018-02-21 Wed 19:00 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>MMAP机制分析</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="yanyg" />
<link rel="stylesheet" type="text/css" href="../r/org-code.css" />
<link rel="stylesheet" type="text/css" href="../r/blog-bluetopbar.css" />
<script type="text/javascript" src="../r/MathJax.js?config=TeX-AMS_HTML"> </script>
<script type="text/javascript" src="../r/bootstrap.min.js"></script>
<script type="text/javascript" src="../r/jquery.stickytableheaders.min.js"></script>
</head>
<body>
<div id="preamble" class="status">
<a href="../index.html">Yanyg - SAN Software Engineer</a>
<div class="sitelinks">
  <a href="archives.html">Archives</a> |
  <a href="theindex.html">Index</a> |
  <a href="tags.html">TAGS</a> |
  <a href="https://github.com/yygcode">Github</a> |
  <a href="../about.html">About Me</a>
</div>
</div>
<div id="content">
<h1 class="title">MMAP机制分析</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org52c648a">1. 使用mmap读写文件</a></li>
<li><a href="#orgd7d2e2f">2. mmap的内核实现</a></li>
</ul>
</div>
</div>
<p>
#+PREVIEW_BEGIN
用strace跟踪常见命令，可以看到有大量 <code>mmap</code> 调用：
</p>
<div class="org-src-container">
<pre class="src src-sh">~$ strace ls 2&gt;&amp;1 | grep mmap
<span class="org-function-name">mmap</span>(NULL, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f1da2f60000
<span class="org-function-name">mmap</span>(NULL, 152705, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f1da2f3a000
<span class="org-function-name">mmap</span>(NULL, 2259664, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f1da2b18000
<span class="org-function-name">mmap</span>(0x7f1da2d3c000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x24000) = 0x7f1da2d3c000
<span class="org-function-name">mmap</span>(0x7f1da2d3e000, 6864, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f1da2d3e000
<span class="org-function-name">mmap</span>(NULL, 3795360, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f1da2779000
<span class="org-function-name">mmap</span>(0x7f1da2b0e000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x195000) = 0x7f1da2b0e000
<span class="org-function-name">mmap</span>(0x7f1da2b14000, 14752, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f1da2b14000
...
</pre>
</div>

<p>
通过 <code>/proc/&lt;pid&gt;/maps</code> 查看指定进程映射了哪几个文件：
</p>
<div class="org-src-container">
<pre class="src src-sh">~$ cat /proc/self/maps
556e0e237000-556e0e23f000 r-xp 00000000 08:02 786434                     /bin/cat
556e0e43e000-556e0e43f000 r--p 00007000 08:02 786434                     /bin/cat
556e0e43f000-556e0e440000 rw-p 00008000 08:02 786434                     /bin/cat
556e0fdb0000-556e0fdd1000 rw-p 00000000 00:00 0                          [heap]
7f7a531df000-7f7a5352e000 r--p 00000000 08:02 558542                     /usr/lib/locale/locale-archive
7f7a5352e000-7f7a536c3000 r-xp 00000000 08:02 9699336                    /lib/x86_64-linux-gnu/libc-2.24.so
7f7a536c3000-7f7a538c3000 ---p 00195000 08:02 9699336                    /lib/x86_64-linux-gnu/libc-2.24.so
7f7a538c3000-7f7a538c7000 r--p 00195000 08:02 9699336                    /lib/x86_64-linux-gnu/libc-2.24.so
7f7a538c7000-7f7a538c9000 rw-p 00199000 08:02 9699336                    /lib/x86_64-linux-gnu/libc-2.24.so
7f7a538c9000-7f7a538cd000 rw-p 00000000 00:00 0
7f7a538cd000-7f7a538f0000 r-xp 00000000 08:02 9699331                    /lib/x86_64-linux-gnu/ld-2.24.so
7f7a53ac5000-7f7a53ac7000 rw-p 00000000 00:00 0
7f7a53acb000-7f7a53af0000 rw-p 00000000 00:00 0
7f7a53af0000-7f7a53af1000 r--p 00023000 08:02 9699331                    /lib/x86_64-linux-gnu/ld-2.24.so
7f7a53af1000-7f7a53af2000 rw-p 00024000 08:02 9699331                    /lib/x86_64-linux-gnu/ld-2.24.so
7f7a53af2000-7f7a53af3000 rw-p 00000000 00:00 0
7ffc991b3000-7ffc991d4000 rw-p 00000000 00:00 0                          [stack]
7ffc991e8000-7ffc991ea000 r--p 00000000 00:00 0                          [vvar]
7ffc991ea000-7ffc991ec000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
</pre>
</div>

<p>
#+PREVIEW_END
</p>

<div id="outline-container-org52c648a" class="outline-2">
<h2 id="org52c648a"><span class="section-number-2">1</span> 使用mmap读写文件</h2>
<div class="outline-text-2" id="text-1">
<p>
如下程序更新一个文件，让文件内容在字母A-Z之间变动：
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;errno.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;stdio.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;stdlib.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;string.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;sys/mman.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;sys/stat.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;sys/types.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;fcntl.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;unistd.h&gt;</span>

<span class="org-type">int</span> <span class="org-function-name">main</span>(<span class="org-type">int</span> <span class="org-variable-name">argc</span>, <span class="org-type">char</span> *<span class="org-variable-name">argv</span>[])
{
        <span class="org-type">int</span> <span class="org-variable-name">fd</span>;
        <span class="org-type">pid_t</span> <span class="org-variable-name">pid</span>;
        <span class="org-keyword">struct</span> <span class="org-type">stat</span> <span class="org-variable-name">sb</span>;
        <span class="org-type">char</span> *<span class="org-variable-name">addr</span>, <span class="org-variable-name">val</span>, <span class="org-variable-name">cmdbuf</span>[128];
        <span class="org-keyword">const</span> <span class="org-type">char</span> *<span class="org-variable-name">pathname</span> = <span class="org-string">"/tmp/mmap.test"</span>;

        <span class="org-keyword">if</span> (argc &gt; 1)
                pathname = argv[1];

        printf(<span class="org-string">"pathname: %s\n"</span>, pathname);
        fd = open(pathname, O_RDWR|O_CREAT, S_IWUSR|S_IRUSR|S_IRGRP|S_IROTH);
        <span class="org-keyword">if</span> (-1 == fd) {
                perror(<span class="org-string">"open failed"</span>);
                <span class="org-keyword">return</span> EXIT_FAILURE;
        }

        <span class="org-comment-delimiter">/* </span><span class="org-comment">ensure up to 2MB </span><span class="org-comment-delimiter">*/</span>
        lseek(fd, 1024*1024*2, SEEK_CUR);
        write(fd, <span class="org-string">""</span>, 1);
        <span class="org-keyword">if</span> (-1 == fstat(fd, &amp;sb)) {
                perror(<span class="org-string">"fstat failed"</span>);
                <span class="org-keyword">return</span> EXIT_FAILURE;
        }

        <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>S_ISREG(sb.st_mode)) {
                perror(<span class="org-string">"Not a Regular file"</span>);
                <span class="org-keyword">return</span> EXIT_FAILURE;
        }

        printf(<span class="org-string">"file size:%lu\n"</span>, sb.st_size);
        addr = mmap(0, sb.st_size, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0);
        <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>addr) {
                perror(<span class="org-string">"mmap failed"</span>);
        }

        val = addr[0];
        <span class="org-keyword">if</span> (<span class="org-string">'A'</span> &gt; val || <span class="org-string">'Z'</span> &lt;= val)
                val = <span class="org-string">'A'</span>;
        val += 1;
        memset(addr, val, sb.st_size);

        pid = getpid();
        sprintf(cmdbuf, <span class="org-string">"ls -l /proc/%u/map_files/"</span>, pid);
        system(cmdbuf);
        printf(<span class="org-string">"---------------------------\n"</span>);
        sprintf(cmdbuf, <span class="org-string">"cat /proc/%u/maps"</span>, pid);
        system(cmdbuf);

        <span class="org-keyword">return</span> 0;
}
</pre>
</div>

<p class="verse">
#+RESULTS:<br />
total 0<br />
pathname: /tmp/mmap.test<br />
file size:2097153<br />
lr---&#x2013;&#x2014; 1 yanyg yanyg 64 Jan 26 15:20 555f1c428000-555f1c429000 -&gt; /tmp/babel-M94bzk/C-bin-W4q33F<br />
lr---&#x2013;&#x2014; 1 yanyg yanyg 64 Jan 26 15:20 555f1c629000-555f1c62a000 -&gt; /tmp/babel-M94bzk/C-bin-W4q33F<br />
lr---&#x2013;&#x2014; 1 yanyg yanyg 64 Jan 26 15:20 555f1c62a000-555f1c62b000 -&gt; /tmp/babel-M94bzk/C-bin-W4q33F<br />
lrw--&#x2013;&#x2014; 1 yanyg yanyg 64 Jan 26 15:20 7ff4f04be000-7ff4f06bf000 -&gt; /tmp/mmap.test<br />
lr---&#x2013;&#x2014; 1 yanyg yanyg 64 Jan 26 15:20 7ff4f06bf000-7ff4f0854000 -&gt; /lib/x86_64-linux-gnu/libc-2.24.so<br />
lr---&#x2013;&#x2014; 1 yanyg yanyg 64 Jan 26 15:20 7ff4f0854000-7ff4f0a54000 -&gt; /lib/x86_64-linux-gnu/libc-2.24.so<br />
lr---&#x2013;&#x2014; 1 yanyg yanyg 64 Jan 26 15:20 7ff4f0a54000-7ff4f0a58000 -&gt; /lib/x86_64-linux-gnu/libc-2.24.so<br />
lr---&#x2013;&#x2014; 1 yanyg yanyg 64 Jan 26 15:20 7ff4f0a58000-7ff4f0a5a000 -&gt; /lib/x86_64-linux-gnu/libc-2.24.so<br />
lr---&#x2013;&#x2014; 1 yanyg yanyg 64 Jan 26 15:20 7ff4f0a5e000-7ff4f0a81000 -&gt; /lib/x86_64-linux-gnu/ld-2.24.so<br />
lr---&#x2013;&#x2014; 1 yanyg yanyg 64 Jan 26 15:20 7ff4f0c81000-7ff4f0c82000 -&gt; /lib/x86_64-linux-gnu/ld-2.24.so<br />
lr---&#x2013;&#x2014; 1 yanyg yanyg 64 Jan 26 15:20 7ff4f0c82000-7ff4f0c83000 -&gt; /lib/x86_64-linux-gnu/ld-2.24.so<br />
555f1c428000-555f1c429000 r-xp 00000000 08:02 11927613                   /tmp/babel-M94bzk/C-bin-W4q33F<br />
555f1c629000-555f1c62a000 r&#x2013;p 00001000 08:02 11927613                   /tmp/babel-M94bzk/C-bin-W4q33F<br />
555f1c62a000-555f1c62b000 rw-p 00002000 08:02 11927613                   /tmp/babel-M94bzk/C-bin-W4q33F<br />
555f1e396000-555f1e3b8000 rw-p 00000000 00:00 0                          [heap]<br />
7ff4f04be000-7ff4f06bf000 rw-s 00000000 08:02 11796543                   /tmp/mmap.test<br />
7ff4f06bf000-7ff4f0854000 r-xp 00000000 08:02 9699336                    /lib/x86_64-linux-gnu/libc-2.24.so<br />
7ff4f0854000-7ff4f0a54000 &#x2014;p 00195000 08:02 9699336                    /lib/x86_64-linux-gnu/libc-2.24.so<br />
7ff4f0a54000-7ff4f0a58000 r&#x2013;p 00195000 08:02 9699336                    /lib/x86_64-linux-gnu/libc-2.24.so<br />
7ff4f0a58000-7ff4f0a5a000 rw-p 00199000 08:02 9699336                    /lib/x86_64-linux-gnu/libc-2.24.so<br />
7ff4f0a5a000-7ff4f0a5e000 rw-p 00000000 00:00 0<br />
7ff4f0a5e000-7ff4f0a81000 r-xp 00000000 08:02 9699331                    /lib/x86_64-linux-gnu/ld-2.24.so<br />
7ff4f0c56000-7ff4f0c58000 rw-p 00000000 00:00 0<br />
7ff4f0c7e000-7ff4f0c81000 rw-p 00000000 00:00 0<br />
7ff4f0c81000-7ff4f0c82000 r&#x2013;p 00023000 08:02 9699331                    /lib/x86_64-linux-gnu/ld-2.24.so<br />
7ff4f0c82000-7ff4f0c83000 rw-p 00024000 08:02 9699331                    /lib/x86_64-linux-gnu/ld-2.24.so<br />
7ff4f0c83000-7ff4f0c84000 rw-p 00000000 00:00 0<br />
7ffd5f9f2000-7ffd5fa13000 rw-p 00000000 00:00 0                          [stack]<br />
7ffd5fadc000-7ffd5fade000 r&#x2013;p 00000000 00:00 0                          [vvar]<br />
7ffd5fade000-7ffd5fae0000 r-xp 00000000 00:00 0                          [vdso]<br />
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]<br />
</p>
</div>
</div>
<div id="outline-container-orgd7d2e2f" class="outline-2">
<h2 id="orgd7d2e2f"><span class="section-number-2">2</span> mmap的内核实现</h2>
</div>
</div>
<div id="postamble" class="status">
2012-2020 Copyright&copy; <i> YANYG - Powered by Emacs Orgmode</i>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = 'https://yanyg.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>
</body>
</html>
