<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
<!-- 2018-07-04 Wed 22:22 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>grub2 1.95 源码分析之一 —— boot.S 分析及注释</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="yanyg" />
<link rel="stylesheet" type="text/css" href="../r/org-code.css" />
<link rel="stylesheet" type="text/css" href="../r/blog-bluetopbar.css" />
<script type="text/javascript" src="../r/MathJax.js?config=TeX-AMS_HTML"> </script>
<script type="text/javascript" src="../r/bootstrap.min.js"></script>
<script type="text/javascript" src="../r/jquery.stickytableheaders.min.js"></script>
</head>
<body>
<div id="preamble" class="status">
<a href="../index.html">Yanyg - SAN Software Engineer</a>
<div class="sitelinks">
  <a href="archives.html">Archives</a> |
  <a href="theindex.html">Index</a> |
  <a href="tags.html">TAGS</a> |
  <a href="https://github.com/yygcode">Github</a> |
  <a href="../about.html">About Me</a>
</div>
</div>
<div id="content">
<h1 class="title">grub2 1.95 源码分析之一 —— boot.S 分析及注释</h1>
<p>
本文最早发布于CSDN：<a href="https://blog.csdn.net/cppgp/article/details/2060146">https://blog.csdn.net/cppgp/article/details/2060146</a>
</p>

<div class="org-src-container">
<pre class="src src-asm"><span class="org-comment-delimiter">/* </span><span class="org-comment">-*-Asm-*- */</span>
<span class="org-comment-delimiter">/*</span>
<span class="org-comment"> *  GRUB  --  GRand Unified Bootloader</span>
<span class="org-comment"> *  Copyright (C) 1999,2000,2001,2002,2005,2006  Free Software Foundation, Inc.</span>
<span class="org-comment"> *</span>
<span class="org-comment"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="org-comment"> *  it under the terms of the GNU General Public License as published by</span>
<span class="org-comment"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="org-comment"> *  (at your option) any later version.</span>
<span class="org-comment"> *</span>
<span class="org-comment"> *  This program is distributed in the hope that it will be useful,</span>
<span class="org-comment"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="org-comment"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="org-comment"> *  GNU General Public License for more details.</span>
<span class="org-comment"> *</span>
<span class="org-comment"> *  You should have received a copy of the GNU General Public License</span>
<span class="org-comment"> *  along with this program; if not, write to the Free Software</span>
<span class="org-comment"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="org-comment"> */</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">cppgp &#27880;&#37322;&#29256;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#36716;&#36733;&#35831;&#27880;&#26126;&#21407;&#20316;&#32773;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#27880;&#37322;&#29256;&#26412;&#21495; : 1.00</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#26085;&#26399; : 2008-01-22</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#32852;&#31995;&#26041;&#24335; :</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">email yanyg02@163.com</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">msn  yanyg02@hotmail.com</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">qq  281607998</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">boot.S &#27969;&#31243;&#21450;&#21151;&#33021;&#31616;&#20171; :</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">boot.S &#29983;&#25104; 512 &#23383;&#33410;&#30340;&#26426;&#22120;&#30721;&#23384;&#20648;&#22312;&#30828;&#30424;&#25110;&#32773;&#36719;&#30424;&#30340; MBR &#20013; , &#34987; BIOS &#21152;&#36733;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#21040;&#20869;&#23384; 0x7C00 &#22788; , &#28982;&#21518; BIOS &#35774;&#32622; CPU &#36339;&#36716;&#33267; 0x7C00 &#22788;&#24320;&#22987;&#25191;&#34892; , &#25511;&#21046;&#26435;&#21040;&#20102;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">boot.S &#25163;&#20013; . boot.S &#26681;&#25454; BIOS &#35774;&#32622;&#30340;&#23492;&#23384;&#22120;&#21021;&#22987;&#20540;&#21644;&#19968;&#20123; INT &#20013;&#26029;&#35843;&#29992; , &#21028;&#26029;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#24341;&#23548;&#39537;&#21160;&#22120;&#26159; LBA&#30828;&#30424;/CHS&#30828;&#30424;/&#36719;&#30424; &#20013;&#30340;&#21738;&#19968;&#31181; , &#24182;&#20445;&#23384;&#30913;&#30424;&#21442;&#25968;&#21040;&#30913;&#30424;&#21442;&#25968;&#22359;&#22320;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#22336;(BPB) , &#28982;&#21518;&#35835;&#21462;&#30001; kernel_sector &#22788;&#30340; 8 &#23383;&#33410;&#30830;&#23450;&#30340;&#25159;&#21306;&#22359; ( &#21363;diskboot.img</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#30001; bootdisk.S &#29983;&#25104;&#30340;&#20108;&#36827;&#21046;&#30721;&#25991;&#20214; )&#20869;&#23384;&#20648;&#30340; 512 &#23383;&#33410;&#30340;&#20869;&#23481;&#21040;&#20869;&#23384;&#22320;&#22336; 0x70000</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#22788; , &#20877;&#25335;&#36125;&#21040;&#20869;&#23384; 0x8000 &#22788; , &#28982;&#21518;&#36339;&#36716;&#33267; 0x8000 &#24320;&#22987;&#25191;&#34892; , &#30001; bootdisk.S &#33719;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#24471;&#25511;&#21046;&#26435; , &#32780; boot.S &#23601;&#21151;&#25104;&#36523;&#36864;&#20102;. &#20294;&#26159; boot.S &#35774;&#32622;&#30340;&#23454;&#27169;&#24335;&#19979;&#30340;&#22534;&#26632;&#21450;&#23492;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#23384;&#22120;&#20540;,&#20197;&#21450;&#24341;&#23548;&#39537;&#21160;&#22120;&#30340;&#27169;&#24335;&#21644;&#21442;&#25968; , &#22312; bootdisk.S &#20013;&#37117;&#26377;&#29992;&#21040; . &#20855;&#20307;&#35831;&#30475;&#20195;&#30721;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#27880;&#37322;&#21450; diskboot.S &#30340;&#27880;&#37322; . &#22914;&#26524;&#22312;&#21152;&#36733; diskboot.img &#30340;&#36807;&#31243;&#20013;&#20986;&#38169;, &#21017;&#36755;&#20986;&#38169;&#35823;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#25552;&#31034;&#20449;&#24687; , &#36827;&#20837;&#27515;&#24490;&#29615; , &#31561;&#24453;&#25163;&#24037;&#37325;&#36215;&#25110;&#32773;&#20851;&#38381;.</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">boot.S &#29983;&#25104;&#30340;&#26426;&#22120;&#30721;&#34987;&#21152;&#36733;&#22312; 0x7C00~0x7DFF &#22788;, &#20855;&#20307;&#26426;&#22120;&#30721;&#35265;&#25991;&#26723;&#26368;&#21518;&#37096;&#20998;</span>


<span class="org-comment-delimiter">// </span><span class="org-comment">&#36825;&#20010;&#22836;&#25991;&#20214;&#37324;&#38754;&#21482;&#23450;&#20041;&#20102;&#19968;&#20010;&#29256;&#26412;&#21495;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;grub/boot.h&gt;</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">&#36825;&#20010;&#22836;&#25991;&#20214;&#21363;../.././include/grub/i386/pc/boot.h , &#23450;&#20041;&#24341;&#23548;&#38656;&#35201;&#30340;&#31995;&#32479;&#24120;&#37327;&#23450;&#20041;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;grub/machine/boot.h&gt;</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">&#22312;&#20195;&#30721;&#20013;&#20351;&#29992;&#23439;&#30340;&#22320;&#26041; , &#25105;&#37117;&#20570;&#20102;&#23439;&#30340;&#35828;&#26126; , &#35835;&#32773;&#19981;&#38656;&#35201;&#36319;&#36394;&#21040;&#23545;&#24212; .h &#25991;&#20214;&#20013;&#30475;&#23439;&#23450;&#20041;</span>

<span class="org-comment-delimiter">/*</span>
<span class="org-comment"> *  defines for the code go here</span>
<span class="org-comment"> */</span>

<span class="org-comment-delimiter">/* </span><span class="org-comment">Absolute addresses</span>
<span class="org-comment">   This makes the assembler generate the address without support</span>
<span class="org-comment">   from the linker. (ELF can't relocate 16-bit addresses!)</span>
<span class="org-comment">*/</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">ABS(x)&#35745;&#31639;x&#30340;&#32477;&#23545;&#22320;&#22336;,&#29992;&#26469;&#29983;&#25104;&#19981;&#21463;&#36830;&#25509;&#22120;&#38480;&#21046;&#30340;&#22320;&#22336;(ELF&#19981;&#33021;&#29983;&#25104;&#21487;&#37325;&#20837;&#30340;&#22320;&#22336;).</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">ABS</span>(<span class="org-variable-name">x</span>) (x-_start+0x7c00)

<span class="org-comment-delimiter">/* </span><span class="org-comment">Print message string */</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#25171;&#21360; x &#25351;&#21521;&#30340;&#23383;&#31526;&#20018;&#21040;&#32456;&#31471;</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">MSG</span>(<span class="org-variable-name">x</span>) movw $ABS(x), <span class="org-variable-name">%si</span><span class="org-comment-delimiter">; </span><span class="org-comment">call message</span>

<span class="org-comment-delimiter">/* </span><span class="org-comment">XXX: binutils-2.9.1.0.x doesn't produce a short opcode for this. */</span>
<span class="org-preprocessor">#define</span> <span class="org-function-name">MOV_MEM_TO_AL</span>(<span class="org-variable-name">x</span>) .byte 0xa0<span class="org-comment-delimiter">;  </span><span class="org-comment">.word x</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">binutils-2.9.1.0.x&#19981;&#33021;&#29983;&#25104;short&#25805;&#20316;&#30721;,&#20351;&#29992;&#36825;&#20010;&#23439;&#20256;&#36882;x&#32473;AL</span>

 <span class="org-keyword">.file</span> <span class="org-string">"boot.S"</span>

 <span class="org-keyword">.text</span>

<span class="org-comment-delimiter">/* </span><span class="org-comment">Tell GAS to generate 16-bit instructions so that this code works</span>
<span class="org-comment">   in real mode.</span>
<span class="org-comment">*/</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#21578;&#30693;GAS&#29983;&#25104;16&#20301;&#30340;&#25351;&#20196;,&#20351;&#20197;&#19979;&#20195;&#30721;&#21487;&#20197;&#24037;&#20316;&#22312;&#23454;&#27169;&#24335;&#19979;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#35828;&#26126; : GAS&#26159;gcc&#30340;&#27719;&#32534;&#22120;</span>

 <span class="org-keyword">.code16</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">&#20197;&#19979;&#20195;&#30721;&#34987;BIOS&#21551;&#21160;&#20363;&#31243;&#21152;&#36733;&#33267;0X7C00&#22788;&#24182;&#19988;&#36339;&#36716;&#21040;&#27492;&#22788;&#25191;&#34892;,&#36807;&#31243;&#25551;&#36848;&#22914;&#19979;:</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">(&#20026;&#38477;&#20302;&#20998;&#26512;&#22797;&#26434;&#24230;,&#25105;&#20204;&#20551;&#35774;&#20174;&#30828;&#30424;&#21551;&#21160;.)</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">BIOS&#35835;&#21462;&#30828;&#30424;&#30340;MBR&#25159;&#21306;&#20849;512&#23383;&#33410;,&#24182;&#25918;&#22312;&#22320;&#22336;0X0000:0X7C00&#22788;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#36339;&#36716;&#21040;0X0000:0X7C00&#22788;&#21435;&#25191;&#34892;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#27492;&#26102;&#35774;&#32622;&#23492;&#23384;&#22120;&#22914;&#19979;:</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">CS:IP = 0X0000:0X7C00 !&#21363;&#20195;&#30721;&#27573;&#22522;&#22336;&#20026;0,&#20559;&#31227;&#37327;&#20026;0X7C00</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">ES:SI   !&#25351;&#21521;BIOS&#20013;&#30828;&#30424;&#20998;&#21306;&#34920;&#30340;&#22320;&#22336;.</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">DL   !&#24341;&#23548;&#35774;&#22791;number,00x80~0xFF</span>

<span class="org-keyword">.globl</span> _start<span class="org-comment-delimiter">; </span><span class="org-comment">_start:</span>
 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  * _start is loaded at 0x7c00 and is jumped to with CS:IP 0:0x7c00</span>
<span class="org-comment">  */</span>

 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  * Beginning of the sector is compatible with the FAT/HPFS BIOS</span>
<span class="org-comment">  * parameter block.</span>
<span class="org-comment">  */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#25159;&#21306;&#24320;&#22987;&#22788;&#21644;BIOS&#21442;&#25968;&#22359;&#37117;&#26159;FAT/HPFS&#26684;&#24335;&#20860;&#23481;&#30340;.</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36339;&#36716;&#21040;after_BPB&#20869;&#23384;&#22788;</span>
 <span class="org-keyword">jmp</span> after_BPB
 <span class="org-keyword">nop</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">do I care about this ??? */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">nop &#27704;&#36828;&#19981;&#20250;&#25191;&#34892;!</span>

 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  * This space is for the BIOS parameter block!!!!  Don't change</span>
<span class="org-comment">  * the first jump, nor start the code anywhere but right after</span>
<span class="org-comment">  * this area.</span>
<span class="org-comment">  */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20197;&#19979;&#31354;&#38388;&#26159;&#30041;&#32473;BIOS&#21442;&#25968;&#22359;&#30340;!!!</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#19981;&#35201;&#26356;&#25913;&#36339;&#36716;&#25351;&#20196;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#38500;&#20102;&#24688;&#22312;BIOS&#21442;&#25968;&#22359;&#21518;&#30340;&#20301;&#32622;,&#20063;&#19981;&#35201;&#24320;&#22987;&#25191;&#34892;&#25351;&#20196;</span>

 . = _start + 4
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20445;&#30041;&#31354;&#38388; : &#20351;&#26412;&#33410;&#20195;&#30721;&#21344;&#29992;&#30340;&#31354;&#38388;&#21040;_start+4&#22788;.&#22914;&#19979;&#20998;&#26512;:</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">jmp after_BPB  &#21344;&#29992;2&#23383;&#33410;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">nop   &#21344;&#29992;1&#23383;&#33410;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22240;&#27492;&#22810;&#20445;&#30041;&#19968;&#23383;&#33410;&#22320;&#22336;&#24182;&#20197;0&#22635;&#20805;.</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20107;&#23454;&#19978;,&#22312;&#29983;&#25104;&#30340;.img&#25991;&#20214;&#20013;,&#24320;&#22987;&#22788;&#22235;&#23383;&#33410;&#30340;&#26426;&#22120;&#30721;&#26159;:eb4b9000</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">Address  0x7C00  0x7C01  0x7C02  0x7C03</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">Value  eb  4b  90  00</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">Operator jmp  sfter_BPB nop  00</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">scratch space */</span>
 <span class="org-comment-delimiter">//</span><span class="org-comment">&#20445;&#30041;&#30340;&#31354;&#38388;</span>
 <span class="org-comment-delimiter">//</span><span class="org-comment">&#21344;&#29992; 4 &#23383;&#33410; , _start+0x00 ~ _start+0x03</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">&#30913;&#30424;&#20449;&#24687;&#21442;&#25968;&#22359;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">CHS &#23547;&#22336;&#26041;&#24335;&#29992;&#21040; 11 &#23383;&#33410; _start+0x04 ~ _start+0x0E</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">mode = 0 ; &#28982;&#21518;&#20381;&#27425;&#26159;&#36890;&#36807; BIOS INT 0x13 , AH = 0x08 &#35843;&#29992;&#24471;&#26469;&#30340;"&#25159;&#21306;/&#30913;&#22836;/&#26609;&#38754;"&#21442;&#25968;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">LBA &#23547;&#22336;&#26041;&#24335;&#29992;&#21040; 16 &#23383;&#33410; _start+0x04 ~ _start+0x14</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">mode = 1 ; &#28982;&#21518;&#20250;&#36890;&#36807;&#27492;&#21518;&#25968;&#25454;&#22359;&#30340;&#20540;&#21644;&#35843;&#29992;&#35201;&#27714;&#22635;&#20805;&#30913;&#30424;&#21442;&#25968;&#22359;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#27492;&#26102; , &#35832;&#22914; sectors/heads/cylinders &#31561;&#26631;&#31614;&#26159;&#26080;&#29992;&#30340; , &#20855;&#20307;&#21442;&#25968;&#26684;&#24335;&#35265; lba_mode &#19968;&#33410;&#23545;&#20195;&#30721;&#30340;&#27880;&#37322;</span>

<span class="org-function-name">mode</span>:
 <span class="org-keyword">.byte</span> 0
<span class="org-function-name">disk_address_packet</span>:
<span class="org-function-name">sectors</span>:
 <span class="org-keyword">.long</span> 0
<span class="org-function-name">heads</span>:
 <span class="org-keyword">.long</span> 0
<span class="org-function-name">cylinders</span>:
 <span class="org-keyword">.word</span> 0

<span class="org-function-name">sector_start</span>:
 <span class="org-keyword">.byte</span> 0
<span class="org-function-name">head_start</span>:
 <span class="org-keyword">.byte</span> 0
<span class="org-function-name">cylinder_start</span>:
 <span class="org-keyword">.word</span> 0
 <span class="org-comment-delimiter">/* </span><span class="org-comment">more space... */</span>

 . = _start + GRUB_BOOT_MACHINE_BPB_END
 <span class="org-comment-delimiter">//</span><span class="org-comment">&#20445;&#30041;&#31354;&#38388;</span>

 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  * End of BIOS parameter block.</span>
<span class="org-comment">  */</span>
 <span class="org-comment-delimiter">//</span><span class="org-comment">BIOS&#21442;&#25968;&#22359;&#32467;&#26463;&#22320;&#22336;</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">&#29616;&#22312;,&#31354;&#38388;&#24050;&#32463;&#20998;&#37197;&#21040;&#20102;_start + GRUB_BOOT_MACHINE_BPB_END</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#20854;&#20013;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#25968;&#25454;&#31354;&#38388;&#26159; : _start+0x04 ~ _start+0x12</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#20445;&#30041;&#31354;&#38388;&#26159; : _start+0x13 ~ _start+0x3D</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">grub&#33258;&#36523;&#20449;&#24687;&#20445;&#23384;&#22320;&#22336;:</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#20849; 14 &#23383;&#33410; : _start + 0x3E ~ _start + 0x4B</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">boot_version !&#29256;&#26412;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">kernel_address !&#20869;&#26680;&#21152;&#36733;&#22320;&#22336;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">kernel_segment !&#20869;&#26680;&#21152;&#36733;&#27573;&#22320;&#22336;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">kernel_sector !&#25159;&#21306;&#32477;&#23545;&#22320;&#22336;,&#40664;&#35748;&#20026;0&#30913;&#22836;0&#26609;&#38754;1&#25159;&#21306;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">boot_drive !&#20174;&#21738;&#20010;&#30913;&#30424;&#21152;&#36733;,0xff&#34920;&#31034;&#20351;&#29992;boot&#39537;&#21160;&#22120;&#21152;&#36733;</span>
<span class="org-function-name">boot_version</span>:
 <span class="org-keyword">.byte</span> GRUB_BOOT_VERSION_MAJOR, GRUB_BOOT_VERSION_MINOR
 <span class="org-comment-delimiter">//  </span><span class="org-comment">4   0</span>
<span class="org-function-name">kernel_address</span>:
 <span class="org-keyword">.word</span> GRUB_BOOT_MACHINE_KERNEL_ADDR
 <span class="org-comment-delimiter">//  </span><span class="org-comment">0x8000</span>
<span class="org-function-name">kernel_segment</span>:
 <span class="org-keyword">.word</span> GRUB_BOOT_MACHINE_KERNEL_SEG
 <span class="org-comment-delimiter">//  </span><span class="org-comment">0x800</span>
<span class="org-function-name">kernel_sector</span>:
 <span class="org-keyword">.long</span> 1, 0
<span class="org-function-name">boot_drive</span>:
 <span class="org-keyword">.byte</span> 0xff <span class="org-comment-delimiter">/* </span><span class="org-comment">the disk to load kernel from */</span>
   <span class="org-comment-delimiter">/* </span><span class="org-comment">0xff means use the boot drive */</span>

<span class="org-function-name">after_BPB</span>:

<span class="org-comment-delimiter">/* </span><span class="org-comment">general setup */</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#39318;&#20808;&#23631;&#34109;&#25481;&#19968;&#20999;&#21487;&#23631;&#34109;&#30340;&#20013;&#26029;!</span>
 <span class="org-keyword">cli</span>  <span class="org-comment-delimiter">/* </span><span class="org-comment">we're not safe here! */</span>

        <span class="org-comment-delimiter">/*</span>
<span class="org-comment">         * This is a workaround for buggy BIOSes which don't pass boot</span>
<span class="org-comment">         * drive correctly. If GRUB is installed into a HDD, check if</span>
<span class="org-comment">         * DL is masked correctly. If not, assume that the BIOS passed</span>
<span class="org-comment">         * a bogus value and set DL to 0x80, since this is the only</span>
<span class="org-comment">         * possible boot drive. If GRUB is installed into a floppy,</span>
<span class="org-comment">         * this does nothing (only jump).</span>
<span class="org-comment">         */</span>

<span class="org-function-name">boot_drive_check</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36339;&#36716;&#33267;&#19979;&#19968;&#20010;1&#22788; , &#27492;&#22788;&#21363;&#24448;&#19979;&#31532;5&#34892;&#22788;</span>
        <span class="org-keyword">jmp</span>     1f
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20197;&#19979;&#19977;&#34892;&#26377;&#20160;&#20040;&#20316;&#29992; ? &#25105;&#19981;&#26126;&#30333; ? &#20272;&#35745;&#26159;&#27531;&#30041;&#19979;&#26469;&#30340;&#19996;&#35199; , &#19978;&#38754;&#33521;&#25991;&#27880;&#37322;&#35828;&#26159;&#20026;&#20102;&#20462;&#27491;&#24067;&#28385; bug &#30340; BIOS</span>
        <span class="org-keyword">testb</span>   $0x80, <span class="org-variable-name">%dl</span>
        <span class="org-keyword">jnz</span>     1f
        <span class="org-keyword">movb</span>    $0x80, <span class="org-variable-name">%dl</span>
<span class="org-function-name">1</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20351; CS : IP = 0x0000 : 0x7C00</span>
 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  * ljmp to the next instruction because some bogus BIOSes</span>
<span class="org-comment">  * jump to 07C0:0000 instead of 0000:7C00.</span>
<span class="org-comment">  */</span>
 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  * ljmp&#36339;&#36716;&#21040;$0, $ABS(real_start)&#25351;&#23450;&#30340;&#32477;&#23545;&#20301;&#32622;&#25191;&#34892;&#25351;&#20196;</span>
<span class="org-comment">  * &#22240;&#20026;&#19968;&#20123;&#31967;&#31957;&#30340;BIOS&#20351;&#29992;07C0:0000&#20195;&#26367;0000:7C00&#26469;&#23454;&#29616;&#36339;&#36716;</span>
<span class="org-comment">  */</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36339;&#36716;&#21040; real_start &#33410;&#30340;&#32477;&#23545;&#22320;&#22336;&#24182;&#25191;&#34892;&#37027;&#37324;&#30340;&#20195;&#30721;.</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">cs : ip = 0x0000 : $ABS(real_start)</span>
 <span class="org-keyword">ljmp</span> $0, $ABS(real_start)

<span class="org-function-name">real_start</span>:
 <span class="org-comment-delimiter">/* </span><span class="org-comment">set up %ds and %ss as offset from 0 */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">ax/ds/ss &#28165;&#38646;</span>
 <span class="org-keyword">xorw</span> <span class="org-variable-name">%ax</span>, <span class="org-variable-name">%ax</span>
 <span class="org-keyword">movw</span> <span class="org-variable-name">%ax</span>, <span class="org-variable-name">%ds</span>
 <span class="org-keyword">movw</span> <span class="org-variable-name">%ax</span>, <span class="org-variable-name">%ss</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">ds = 0 ; ss = 0</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">set up the REAL stack */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">GRUB_BOOT_MACHINE_STACK_SEG &#26159;&#23439;&#23450;&#20041; , &#31561;&#20110; 0x2000</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#35774;&#32622;&#23454;&#27169;&#24335;&#19979;&#30340;&#22534;&#26632; , &#35774;&#32622;&#34920;&#31034;&#26632;&#39030;&#25351;&#38024;&#30340;&#21464;&#22336;&#23492;&#23384;&#22120; sp &#20026; 0x2000</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#29616;&#22312; , ss : sp = 0x0000 : 0x2000</span>
 <span class="org-keyword">movw</span> $GRUB_BOOT_MACHINE_STACK_SEG, <span class="org-variable-name">%sp</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#29616;&#22312; &#25968;&#25454;&#27573;&#22534;&#26632;&#27573;&#35774;&#32622;&#27491;&#30830; , &#20801;&#35768;&#20013;&#26029;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20013;&#26029;&#26631;&#24535;&#20301;IF&#32622;1</span>
 <span class="org-keyword">sti</span>  <span class="org-comment-delimiter">/* </span><span class="org-comment">we're safe again */</span>

 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  *  Check if we have a forced disk reference here</span>
<span class="org-comment">  */</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23558; boot_drive &#22788;&#30340;&#20540;&#23384;&#20648;&#21040; al</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">address(boot_drive) = _start+0x4B = 0x7C00+0x4B = 0x7C4B</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#27492;&#22788;&#20540;&#40664;&#35748;&#20026; 0xff , &#21487;&#22312; setup &#36807;&#31243;&#22635;&#20805;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#31561;&#20110; 0xff , &#34920;&#31034;&#20351;&#29992;&#40664;&#35748;&#39537;&#21160; , &#21363;&#20174; BIOS &#20256;&#36882;&#36807;&#26469;&#30340;&#39537;&#21160;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#19981;&#31561;&#20110; , &#21017;&#23558;&#20540;&#23384;&#20837; DL , &#34920;&#31034;&#20351;&#29992;&#30001;&#35813;&#20540;&#30830;&#23450;&#30340;&#24341;&#23548;&#39537;&#21160;</span>
 <span class="org-keyword">MOV_MEM_TO_AL</span>(ABS(boot_drive)) <span class="org-comment-delimiter">/* </span><span class="org-comment">movb ABS(boot_drive), %al */</span>
 <span class="org-keyword">cmpb</span> $0xff, <span class="org-variable-name">%al</span>
 <span class="org-keyword">je</span> 1f
 <span class="org-keyword">movb</span> <span class="org-variable-name">%al</span>, <span class="org-variable-name">%dl</span>
<span class="org-function-name">1</span>:
 <span class="org-comment-delimiter">/* </span><span class="org-comment">save drive reference first thing! */</span>
 <span class="org-comment-delimiter">//</span><span class="org-comment">&#39537;&#21160;&#20449;&#24687;&#21387;&#26632; : dl &#20013;&#20445;&#23384;&#39537;&#21160;number , dh &#20013;&#20160;&#20040;&#37117;&#19981;&#26159;</span>
 <span class="org-keyword">pushw</span> <span class="org-variable-name">%dx</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">print a notification message on the screen */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36755;&#20986;&#23383;&#31526;&#20018; notification_string &#21040;&#23631;&#24149;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">notification_string = "GRUB"</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">MSG&#23439;&#32463;&#23637;&#24320;&#20197;&#21518;&#26159;&#36825;&#26679;&#30340; :</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">movw $(notification_string-_start+0x7c00), %si; call message</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20854;&#20013; $(notification_string-_start+0x7c00) &#26159;&#23383;&#31526;&#20018; notification_string &#32477;&#23545;&#22320;&#22336;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#29616;&#22312; , &#25105;&#20204;&#30693;&#36947; ds = 0x0000 , si = address(notification_string)</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#32780;&#22312;&#20989;&#25968; message &#20013; , &#20250;&#36890;&#36807; BIOS &#25552;&#20379;&#30340; INT 0x10 &#35843;&#29992;&#36880;&#23383;&#31526;&#26174;&#31034;&#21040;&#32456;&#31471;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20855;&#20307;&#35265; message &#20989;&#25968;&#23450;&#20041;&#37096;&#20998;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#27880;&#24847; , &#27492;&#26102;&#19981;&#38656;&#35201;&#35774;&#32622; DF</span>
 <span class="org-keyword">MSG</span>(notification_string)

 <span class="org-comment-delimiter">/* </span><span class="org-comment">set %si to the disk address packet */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#35774;&#32622;&#21464;&#22336;&#23492;&#23384;&#22120;si&#20026; disk_address_packet &#30340;&#32477;&#23545;&#22320;&#22336;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23439;&#23637;&#24320;&#20197;&#21518;&#26159; : movw $(disk_address_packet-_start+0x7c00), %si</span>
 <span class="org-keyword">movw</span> $ABS(disk_address_packet), <span class="org-variable-name">%si</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">do not probe LBA if the drive is a floppy */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#39537;&#21160;&#22120;&#26159;&#36719;&#30424;,&#21017;&#19981;&#21028;&#26029;&#26159;&#21542;&#26159;&#25903;&#25345;LBA&#30340;&#30913;&#30424; , &#32780;&#30452;&#25509;&#36339;&#36716;&#21040;chs_mod</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#26681;&#25454;&#21069;&#38754;&#36164;&#26009; , &#25105;&#20204;&#30693;&#36947;&#30913;&#30424;&#30340; DL &#20540;&#20026; 0X80~0XFF , DL &#26368;&#39640;&#20301;&#24517;&#28982;&#20026;1</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">GRUB_BOOT_MACHINE_BIOS_HD_FLAG&#23439;&#23450;&#20041; = 0x80</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22240;&#27492; , &#22914;&#26524;&#26159;&#30913;&#30424; , ZF = 0 ;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#21542;&#21017; , &#26159;&#36719;&#30424;&#24341;&#23548; , ZF = 1 , &#23558;&#36339;&#36716;&#33267; chs_mod</span>
 <span class="org-keyword">testb</span> $GRUB_BOOT_MACHINE_BIOS_HD_FLAG, <span class="org-variable-name">%dl</span>
 <span class="org-keyword">jz</span> chs_mode

 <span class="org-comment-delimiter">/* </span><span class="org-comment">check if LBA is supported */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#29616;&#22312; , &#24050;&#32463;&#30830;&#23450;&#26159;&#30913;&#30424;&#24341;&#23548; , &#21028;&#26029;&#26159;&#21482;&#25903;&#25345; 8G &#23547;&#22336;&#30340;&#32769;&#24335;&#30340;&#30913;&#30424;&#36824;&#26159; LBA &#30913;&#30424;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36890;&#36807; BIOS &#35843;&#29992; INT 0x13 &#26469;&#30830;&#23450;&#26159;&#21542;&#25903;&#25345;&#25193;&#23637; , &#35814;&#32454;&#35265;&#20855;&#20307;&#20195;&#30721;&#37096;&#20998;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">LBA &#25193;&#23637;&#21151;&#33021;&#20998;&#20004;&#20010;&#23376;&#38598; , &#22914;&#19979; :</span>
 <span class="org-comment-delimiter">//  </span><span class="org-comment">&#31532;&#19968;&#20010;&#23376;&#38598;&#25552;&#20379;&#20102;&#35775;&#38382;&#22823;&#30828;&#30424;&#25152;&#24517;&#39035;&#30340;&#21151;&#33021; , &#21253;&#25324;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">1.&#26816;&#26597;&#25193;&#23637;&#26159;&#21542;&#23384;&#22312; : ah = 41h , bx = 0x55aa , dl = drive( 0x80 ~ 0xff )</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">2.&#25193;&#23637;&#35835;  : ah = 42h</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">3.&#25193;&#23637;&#20889;  : ah = 43h</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">4.&#26657;&#39564;&#25159;&#21306;  : ah = 44h</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">5.&#25193;&#23637;&#23450;&#20301;  : ah = 47h</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">6.&#21462;&#24471;&#39537;&#21160;&#22120;&#21442;&#25968; : ah = 48h</span>
 <span class="org-comment-delimiter">//  </span><span class="org-comment">&#31532;&#20108;&#20010;&#23376;&#38598;&#25552;&#20379;&#20102;&#23545;&#36719;&#20214;&#25511;&#21046;&#39537;&#21160;&#22120;&#38145;&#23450;&#21644;&#24377;&#20986;&#30340;&#25903;&#25345; ,&#21253;&#25324;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">1.&#26816;&#26597;&#25193;&#23637;  : ah = 41h</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">2.&#38145;&#23450;/&#35299;&#38145;&#39537;&#21160;&#22120; : ah = 45h</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">3.&#24377;&#20986;&#39537;&#21160;&#22120;  : ah = 46h</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">4.&#21462;&#24471;&#39537;&#21160;&#22120;&#21442;&#25968; : ah = 48h</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">5.&#21462;&#24471;&#25193;&#23637;&#39537;&#21160;&#22120;&#25913;&#21464;&#29366;&#24577;: ah = 49h</span>

 <span class="org-comment-delimiter">//</span><span class="org-comment">&#19979;&#38754;&#24320;&#22987;&#20855;&#20307;&#26816;&#27979; , &#39318;&#20808;&#26816;&#27979;&#25193;&#23637;&#26159;&#21542;&#23384;&#22312;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#27492;&#26102;&#23492;&#23384;&#22120;&#30340;&#20540;&#21644; BIOS &#35843;&#29992;&#20998;&#21035;&#26159; :</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">AH = 0x41</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">BX = 0x55AA</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">DL = driver( 0x80 ~ 0xFF )</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">INT  13H</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36820;&#22238;&#32467;&#26524; : &#22914;&#26524;&#25903;&#25345; CF = 0 ; &#21542;&#21017; CF = 1</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">CF = 0 (&#25903;&#25345;LBA) &#26102;&#30340;&#23492;&#23384;&#22120;&#20540; :</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">ah : &#25193;&#23637;&#21151;&#33021;&#30340;&#20027;&#29256;&#26412;&#21495;( major version of extensions )</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">al : &#20869;&#37096;&#20351;&#29992;( internal use )</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">bx : AA55h ( magic number )</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">cx :</span>
 <span class="org-comment-delimiter">//  </span><span class="org-comment">Bits  Description</span>
 <span class="org-comment-delimiter">//  </span><span class="org-comment">0  extended disk access functions</span>
 <span class="org-comment-delimiter">//  </span><span class="org-comment">1  removable drive controller functions supported</span>
 <span class="org-comment-delimiter">//  </span><span class="org-comment">2  enhanced disk drive (EDD) functions (AH=48h,AH=4Eh) supported.</span>
 <span class="org-comment-delimiter">//    </span><span class="org-comment">Extended drive parameter table is valid</span>
 <span class="org-comment-delimiter">//  </span><span class="org-comment">3~15  reserved (0)</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">CF = 1 (&#19981;&#25903;&#25345;LBA) &#26102;&#30340;&#23492;&#23384;&#22120;&#20540; :</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">ah = 0x01 ( invalid function )</span>
 <span class="org-keyword">movb</span> $0x41, <span class="org-variable-name">%ah</span>
 <span class="org-keyword">movw</span> $0x55aa, <span class="org-variable-name">%bx</span>
 <span class="org-keyword">int</span> $0x13

 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  *  %dl may have been clobbered by INT 13, AH=41H.</span>
<span class="org-comment">  *  This happens, for example, with AST BIOS 1.04.</span>
<span class="org-comment">  */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">dl &#21487;&#33021;&#24050;&#34987; INT 13 , AH = 41H , BX = 55AAH &#35843;&#29992;&#20462;&#25913;,&#37325;&#26032;&#25913;&#22238;!</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20363;&#22914; AST BIOS 1.04 &#23558;&#23384;&#22312;&#36825;&#31181;&#20462;&#25913;</span>
 <span class="org-keyword">popw</span> <span class="org-variable-name">%dx</span>
 <span class="org-keyword">pushw</span> <span class="org-variable-name">%dx</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">use CHS if fails */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#25193;&#23637;&#26816;&#27979;&#35843;&#29992;&#22833;&#36133; , &#36827;&#20837; chs_mod , &#20998;&#21035;&#36890;&#36807;&#26816;&#27979; CF/BX/CX &#30830;&#35748;&#26159;&#21542;&#25903;&#25345; LBA</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#26816;&#27979; CF &#20540; , &#20026; 1 &#34920;&#31034;&#22833;&#36133;&#36827;&#20837; chs_mod</span>
 <span class="org-keyword">jc</span> chs_mode

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#26816;&#27979; BX &#20540; , &#22914;&#26524;&#19981;&#31561;&#20110; 0xAA55 , &#36827;&#20837; chs_mod</span>
 <span class="org-keyword">cmpw</span> $0xaa55, <span class="org-variable-name">%bx</span>
 <span class="org-keyword">jne</span> chs_mode

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#19981;&#25903;&#25345;&#25193;&#23637;&#31532;&#19968;&#23376;&#38598;(&#35265;&#19978;) , CX.bit0 = 0 , &#36827;&#20837; chs_mod</span>
 <span class="org-keyword">andw</span> $1, <span class="org-variable-name">%cx</span>
 <span class="org-keyword">jz</span> chs_mode

<span class="org-function-name">lba_mode</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#26412;&#33410;&#20195;&#30721;&#30340;&#21151;&#33021; : &#21152;&#36733; bootdisk.S &#29983;&#25104;&#30340;&#26426;&#22120;&#30721;&#21040;&#32477;&#23545;&#22320;&#22336; 0x7000 &#22788; , &#24182;&#36339;&#36716;&#25191;&#34892; copy_buffer</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36827;&#20837;&#21040;&#36825;&#37324;&#26102; , &#24050;&#25506;&#27979;&#21040;&#31995;&#32479;&#25903;&#25345; LBA &#25193;&#23637;&#30340;&#31532;&#19968;&#23376;&#38598;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#19979;&#38754;&#39318;&#20808;&#20026;&#25193;&#23637;&#35835;&#30340; BIOS &#35843;&#29992;&#35774;&#32622;&#21442;&#25968;&#22359;&#20540;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20851;&#20110;&#25193;&#23637;&#35835;&#35843;&#29992;&#30340;&#35814;&#32454;&#24773;&#20917;&#21644;&#32467;&#26524;&#20540;&#35265;&#35843;&#29992;&#37096;&#20998;&#27880;&#37322;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#25193;&#23637;&#35835;&#38656;&#35201;&#30340;&#30913;&#30424;&#21442;&#25968;&#22359;&#35828;&#26126;&#22914;&#19979; :</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#30913;&#30424;&#21442;&#25968;&#22359;&#30340;&#35268;&#23450;&#26684;&#24335;&#22914;&#19979; :</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">Format of disk address packet:</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">Offset Size Bits Description</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">00h BYTE 8 size of packet (10h or 18h)</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">01h BYTE 8 reserved (0)</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">02h WORD 16 number of blocks to transfer (max 007Fh for Phoenix EDD)</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">04h DWORD 32 -&gt; transfer buffer</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">08h QWORD 64 starting absolute block number</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#29616;&#22312; , &#25105;&#20204;&#30340; ds = 0x0000 , si = $ABS(disk_address_packet)</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#25105;&#20204;&#21462;&#25193;&#23637;&#35835;&#30913;&#30424;&#21442;&#25968;&#22359;&#30340;&#22320;&#22336;&#26631;&#21495;&#26159; ADDR_LBA_BPB(0x00) ~ ADDR_LBA_BPB(0x0F) &#20849; 16 &#23383;&#33410;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23545;&#20110;&#21508;&#20010;&#20540;&#30340;&#35774;&#32622;&#35265;&#19979;&#38754;&#20195;&#30721;</span>

 <span class="org-keyword">xorw</span> <span class="org-variable-name">%ax</span>, <span class="org-variable-name">%ax</span>
 <span class="org-keyword">movw</span> <span class="org-variable-name">%ax</span>, 4(<span class="org-variable-name">%si</span>)
 <span class="org-comment-delimiter">// </span><span class="org-comment">ADDR_LBA_BPB(0x04) = 0x00</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">ADDR_LBA_BPB(0x05) = 0x00</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#35774;&#32622; mode , &#22312; diskboot.S &#37324;&#38754;&#20250;&#29992;&#21040;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">mode = 1 , LBA &#25193;&#23637;&#35835;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">mode = 0 , CHS &#23547;&#22336;&#35835;</span>
 <span class="org-keyword">incw</span> <span class="org-variable-name">%ax</span>
 <span class="org-comment-delimiter">/* </span><span class="org-comment">set the mode to non-zero */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">-1(%si)&#21363;&#20026;mode&#25152;&#22312;&#22788;&#22320;&#22336;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#27492;&#26102; AX = 0x0001 , AL = 0x01</span>
 <span class="org-keyword">movb</span> <span class="org-variable-name">%al</span>, -1(<span class="org-variable-name">%si</span>)

 <span class="org-comment-delimiter">/* </span><span class="org-comment">the blocks */</span>
 <span class="org-keyword">movw</span> <span class="org-variable-name">%ax</span>, 2(<span class="org-variable-name">%si</span>)
 <span class="org-comment-delimiter">// </span><span class="org-comment">ADDR_LBA_BPB(0x02) = 0x01</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">ADDR_LBA_BPB(0x03) = 0x00</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">the size and the reserved byte */</span>
 <span class="org-keyword">movw</span> $0x0010, (<span class="org-variable-name">%si</span>)
 <span class="org-comment-delimiter">// </span><span class="org-comment">ADDR_LBA_BPB(0x00) = 0x10</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">ADDR_LBA_BPB(0x01) = 0x00</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">the absolute address */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23558;(kernel_sector~kernel_sector+3)&#21333;&#20803;(&#32477;&#23545;&#22320;&#22336;)&#30340;&#20540;&#32473; ebx , &#40664;&#35748;&#20026; 1</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22312; grub-mkimage &#21629;&#20196;&#20013;&#34987;&#20462;&#25913; ,&#23384;&#20648; diskboot.S &#29983;&#25104;&#20195;&#30721;&#30340;&#23384;&#20648;&#25159;&#21306;</span>
 <span class="org-keyword">movl</span> ABS(kernel_sector), <span class="org-variable-name">%ebx</span>
 <span class="org-keyword">movl</span> <span class="org-variable-name">%ebx</span>, 8(<span class="org-variable-name">%si</span>)
 <span class="org-comment-delimiter">// </span><span class="org-comment">ADDR_LBA_BPB(0x08~0x0B) = 0x0000 0001</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23558;(kernel_sector+4~kernel_sector+7)&#21333;&#20803;(&#32477;&#23545;&#22320;&#22336;)&#30340;&#20540;&#32473; ebx , &#40664;&#35748;&#20026; 0</span>
 <span class="org-keyword">movl</span> ABS(kernel_sector + 4), <span class="org-variable-name">%ebx</span>
 <span class="org-keyword">movl</span> <span class="org-variable-name">%ebx</span>, 12(<span class="org-variable-name">%si</span>)
 <span class="org-comment-delimiter">// </span><span class="org-comment">ADDR_LBA_BPB(0x0C~0x0F) = 0x0000 0000</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">the segment of buffer address */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">GRUB_BOOT_MACHINE_BUFFER_SEG &#23439;&#23450;&#20041; = 0x7000</span>
 <span class="org-keyword">movw</span> $GRUB_BOOT_MACHINE_BUFFER_SEG, 6(<span class="org-variable-name">%si</span>)
 <span class="org-comment-delimiter">// </span><span class="org-comment">ADDR_LBA_BPB(0x06~0x07) = 0x7000</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23545;&#24212;&#22914;&#19979; :</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">Offset  Size/Bits  Value  Description</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">00h  BYTE/8   0x10  size of packet (10h or 18h)</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">01h  BYTE/8   0x00  reserved (0)</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">02h  WORD/16   0x0001  number of blocks to transfer (max 007Fh for Phoenix EDD)</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">04h  DWORD/32  0x70000000 -&gt; transfer buffer</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">08h  QWORD/64  0x01  starting absolute block number</span>

<span class="org-comment-delimiter">/*</span>
<span class="org-comment"> * BIOS call "INT 0x13 Function 0x42" to read sectors from disk into memory</span>
<span class="org-comment"> * Call with %ah = 0x42</span>
<span class="org-comment"> *   %dl = drive number</span>
<span class="org-comment"> *   %ds:%si = segment:offset of disk address packet</span>
<span class="org-comment"> *</span>
<span class="org-comment"> * Return:</span>
<span class="org-comment"> *   %al = 0x0 on success; err code on failure</span>
<span class="org-comment"> */</span>
 <span class="org-keyword">movb</span> $0x42, <span class="org-variable-name">%ah</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23492;&#23384;&#22120;&#21644;&#30913;&#30424;&#21442;&#25968;&#22359;&#35774;&#32622;&#23436;&#27605;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23492;&#23384;&#22120;&#20540; : AH = 0x42 ; DL = driver number ; DS : SI = 0x0000 : ABS(disk_address_packet)</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">disk_address_packet &#21508;&#20010;&#20540;&#35265;&#19978;&#38754;&#27880;&#37322;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36825;&#27425; INT 0x13 &#35843;&#29992;&#23558;&#23436;&#25104; :</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36890;&#36807;&#25193;&#23637;&#35835; , &#20174;&#30913;&#30424;&#35835;&#21462;&#30001; kernel_sector &#22788;8&#23383;&#33410;&#38271;&#24230;&#30830;&#23450;&#30340;&#26576;&#19968;&#25159;&#21306;&#30340;&#20869;&#23481;&#21040;&#20869;&#23384;&#22320;&#22336; 0x70000(0x7000:0x0000) &#22788;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#25104;&#21151; : CF = 0 , AH = 0</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22833;&#36133; : CF = 1 , AH = &#38169;&#35823;&#30721;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#35843;&#29992;&#32467;&#26463;&#21518; &#30913;&#30424;&#22320;&#22336;&#22359;&#30340; block &#35745;&#25968;&#39033; (ADDR_LBA_BPB(0x02)) &#23384;&#25918;&#25104;&#21151;&#25104;&#21151;&#20256;&#36865;&#30340;&#25968;&#25454;&#22359;&#25968;.</span>

 <span class="org-keyword">int</span> $0x13

 <span class="org-comment-delimiter">// </span><span class="org-comment">LBA&#25193;&#23637;&#35835;&#22833;&#36133; , &#36827;&#20837; chs_mod</span>
 <span class="org-comment-delimiter">/* </span><span class="org-comment">LBA read is not supported, so fallback to CHS.  */</span>
 <span class="org-keyword">jc</span> chs_mode

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23384;&#20648; GRUB_BOOT_MACHINE_BUFFER_SEG &#21040; bx , &#36339;&#36716;&#33267; copy_buffer</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">GRUB_BOOT_MACHINE_BUFFER_SEG = 0x7000</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#25968;&#25454;&#23492;&#23384;&#22120; BX &#35774;&#32622;&#20026; 0x7000</span>
 <span class="org-keyword">movw</span> $GRUB_BOOT_MACHINE_BUFFER_SEG, <span class="org-variable-name">%bx</span>
 <span class="org-keyword">jmp</span> copy_buffer

<span class="org-function-name">chs_mode</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36827;&#20837;&#27492;&#22788; , &#24050;&#32463;&#21028;&#23450;&#26159;&#19981;&#25903;&#25345;&#30913;&#30424; LBA &#25193;&#23637;&#20102; , &#20294;&#26159;&#20174;&#30913;&#30424;&#24341;&#23548;&#36824;&#26159;&#36719;&#30424;&#24341;&#23548;&#23578;&#26410;&#30830;&#23450;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22240;&#27492; , CHS&#30913;&#30424;&#24341;&#23548; &#25110;&#32773; &#36719;&#30424;&#24341;&#23548; &#22343;&#20174;&#27492;&#22788;&#22788;&#29702;</span>
 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  *  Determine the hard disk geometry from the BIOS!</span>
<span class="org-comment">  *  We do this first, so that LS-120 IDE floppies work correctly.</span>
<span class="org-comment">  */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36890;&#36807; BIOS INT 0x13 , AH = 0x08 &#35843;&#29992;&#27979;&#23450;&#30913;&#30424;&#30340;&#29289;&#29702;&#21442;&#25968;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#35813;&#30340;&#35814;&#32454;&#35299;&#37322;&#22914;&#19979; :</span>
 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  * &#20316;&#29992; :</span>
<span class="org-comment">  * &#21462;&#24471;&#30913;&#30424;&#21442;&#25968;</span>
<span class="org-comment">  * &#23492;&#23384;&#22120;&#20540; :</span>
<span class="org-comment">  * AH = 0x08</span>
<span class="org-comment">  * DL = drive (bit 7 set for hard disk)</span>
<span class="org-comment">  * ES:DI = 0x0000 : 0x0000 to guard against BIOS bugs</span>
<span class="org-comment">  * &#25104;&#21151; :</span>
<span class="org-comment">  * CF = 0</span>
<span class="org-comment">  * AH = 00h</span>
<span class="org-comment">  * AL = 00h on at least some BIOSes</span>
<span class="org-comment">  * BL = drive type (AT/PS2 floppies only)</span>
<span class="org-comment">  * CH = low eight bits of maximum cylinder number</span>
<span class="org-comment">  * CL = maximum sector number (bits 5-0) , high two bits of maximum cylinder number (bits 7-6)</span>
<span class="org-comment">  * DH = maximum head number</span>
<span class="org-comment">  * DL = number of drives</span>
<span class="org-comment">  * ES:DI -&gt; drive parameter table (floppies only)</span>
<span class="org-comment">  * &#22833;&#36133; :</span>
<span class="org-comment">  * CF = 1</span>
<span class="org-comment">  * AH = status (07h)</span>
<span class="org-comment">  */</span>

 <span class="org-keyword">movb</span> $8, <span class="org-variable-name">%ah</span>
 <span class="org-keyword">int</span> $0x13
 <span class="org-keyword">jnc</span> final_init
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#35843;&#29992;&#25104;&#21151; , CF = 0 , &#36339;&#36716;&#21040; final_init &#22788;!</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#29616;&#22312;&#24050;&#32463;&#30830;&#23450;&#19981;&#25903;&#25345; CHS , &#27979;&#35797;&#26159;&#21542;&#26159;&#36719;&#30424;&#24341;&#23548;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#26159;&#36719;&#30424;&#24341;&#23548; , &#36827;&#20837; floppy_probe</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#21542;&#21017;&#20986;&#38169; , &#36827;&#20837; hd_probe_error</span>
 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  *  The call failed, so maybe use the floppy probe instead.</span>
<span class="org-comment">  */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524; DL &#26368;&#39640;&#20301;&#20026; 0 ,&#21017;&#20026;&#36719;&#30424;</span>
 <span class="org-keyword">testb</span> $GRUB_BOOT_MACHINE_BIOS_HD_FLAG, <span class="org-variable-name">%dl</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#26159;&#36719;&#30424; , &#36339;&#36716;&#21040; floppy_probe</span>
 <span class="org-keyword">jz</span> floppy_probe

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#29616;&#22312; , &#30693;&#36947;&#25105;&#20204;&#30830;&#23454;&#26159;&#19968;&#20010;&#30913;&#30424;(&#30828;&#30424;) , &#20294;&#26159;&#23454;&#22312;&#19981;&#30693;&#36947;&#35813;&#24590;&#20040;&#35835; , &#21435; hd_probe_error &#29609;&#29609;&#21543;</span>
 <span class="org-comment-delimiter">/* </span><span class="org-comment">Nope, we definitely have a hard disk, and we're screwed. */</span>
 <span class="org-keyword">jmp</span> hd_probe_error

<span class="org-function-name">final_init</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#35774;&#32622; mode = 0 , mode &#22312; diskboot.S &#20013;&#29992;&#21040; , &#29992;&#26469;&#21028;&#26029;&#24341;&#23548;&#30913;&#30424;&#26159; LBA &#35835;&#36824;&#26159; CHS &#35835;</span>
 <span class="org-comment-delimiter">/* </span><span class="org-comment">set the mode to zero */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">DH &#23384;&#25918;&#30913;&#22836;&#25968;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36825;&#21477;&#23436;&#25104;&#20102;2&#20010;&#21151;&#33021; : dh &#23384;&#25918;&#21040; eax &#30340; al ; eax &#30340;&#20854;&#23427;&#20301;&#32622; 0</span>
 <span class="org-keyword">movzbl</span> <span class="org-variable-name">%dh</span>, <span class="org-variable-name">%eax</span>
 <span class="org-keyword">movb</span> <span class="org-variable-name">%ah</span>, -1(<span class="org-variable-name">%si</span>)
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#35774;&#32622; mode = 0</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20445;&#23384; &#30913;&#22836;/&#26609;&#38754;/&#25159;&#21306;&#25968;</span>
 <span class="org-comment-delimiter">/* </span><span class="org-comment">save number of heads */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">BIOS &#20013;&#30913;&#22836;&#32534;&#21495;&#26159;&#25353;&#29031; 0 ~ n-1 , &#27492;&#22788;&#21152; 1 &#24182;&#20445;&#23384;&#21040;&#30913;&#30424;&#21442;&#25968;&#22359;</span>
 <span class="org-keyword">incw</span> <span class="org-variable-name">%ax</span>
 <span class="org-keyword">movl</span> <span class="org-variable-name">%eax</span>, 4(<span class="org-variable-name">%si</span>)

 <span class="org-comment-delimiter">// </span><span class="org-comment">cl &#20013; 0~5 bits &#23384;&#25918;&#25159;&#21306;&#25968; , 6~7 bits &#23384;&#25918;&#26609;&#38754;&#25968;&#30340;&#39640; 2 &#20301;</span>
 <span class="org-keyword">movzbw</span> <span class="org-variable-name">%cl</span>, <span class="org-variable-name">%dx</span>
 <span class="org-keyword">shlw</span> $2, <span class="org-variable-name">%dx</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#26609;&#38754;&#25968;&#30340;&#20302; 8 &#20301;</span>
 <span class="org-keyword">movb</span> <span class="org-variable-name">%ch</span>, <span class="org-variable-name">%al</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">dh &#29616;&#22312;&#26159;&#30913;&#22836;&#25968;&#30340;&#39640;&#20004;&#20301;!</span>
 <span class="org-keyword">movb</span> <span class="org-variable-name">%dh</span>, <span class="org-variable-name">%ah</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#29616;&#22312; ah &#23384;&#25918;&#26609;&#38754;&#25968;&#30340;&#39640; 2 &#20301;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">al &#23384;&#25918;&#26609;&#38754;&#25968;&#30340;&#20302; 8 &#20301;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">ax &#23384;&#25918;&#25972;&#20010;&#26609;&#38754;&#21442;&#25968;</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">save number of cylinders */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">BIOS &#20013;&#26609;&#38754;&#32534;&#21495;&#26159; 0 ~ n-1 , &#27492;&#22788;&#21152; 1 &#24182;&#20445;&#23384;&#21040;&#30913;&#30424;&#21442;&#25968;&#22359;</span>
 <span class="org-keyword">incw</span> <span class="org-variable-name">%ax</span>
 <span class="org-keyword">movw</span> <span class="org-variable-name">%ax</span>, 8(<span class="org-variable-name">%si</span>)

 <span class="org-comment-delimiter">// </span><span class="org-comment">dl &#20013; 0~2bits &#26159;0  ,5~7bits &#26159;&#25159;&#21306;&#25968;</span>
 <span class="org-keyword">movzbw</span> <span class="org-variable-name">%dl</span>, <span class="org-variable-name">%ax</span>
 <span class="org-keyword">shrb</span> $2, <span class="org-variable-name">%al</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#21491;&#31227; 2 &#20301; , &#29616;&#22312; al &#20013; 0~5 bits &#26159;&#25159;&#21306;&#25968; , 6~7 bits &#26159; 0</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">save number of sectors */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">BIOS &#20013;&#25159;&#21306;&#32534;&#21495;&#26159; 1 ~ n , &#30452;&#25509;&#20445;&#23384;&#21040;&#30913;&#30424;&#21442;&#25968;&#22359;!</span>
 <span class="org-keyword">movl</span> <span class="org-variable-name">%eax</span>, (<span class="org-variable-name">%si</span>)

<span class="org-function-name">setup_sectors</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20351;&#29992; CHS &#27169;&#24335;&#19979; BIOS &#25552;&#20379;&#30340;&#35835;&#35843;&#29992; , &#21152;&#36733;&#30001; kernel_sector &#30830;&#23450;&#30340;&#19968;&#20010;&#25159;&#21306;&#21040;&#20869;&#23384; 0x70000 &#22788;</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">load logical sector start (top half) */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">kernel_sector + 4 &#23384;&#20648;&#20869;&#23384;&#20559;&#31227;&#37327;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22312; CHS &#35835;&#20013;&#24517;&#39035;&#20026; 0 , &#21542;&#21017;&#20986;&#38169;</span>
 <span class="org-keyword">movl</span> ABS(kernel_sector + 4), <span class="org-variable-name">%eax</span>
 <span class="org-keyword">orl</span> <span class="org-variable-name">%eax</span>, <span class="org-variable-name">%eax</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524; eax != 0x0000 0000 0000 0000 , &#21017;&#26080;&#27861;&#24341;&#23548; , &#36339;&#36716; geometry_error &#22788;&#29702; !</span>
 <span class="org-keyword">jnz</span> geometry_error

 <span class="org-comment-delimiter">/* </span><span class="org-comment">load logical sector start (bottom half) */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">kernel_sector &#22788;&#20540;&#40664;&#35748;&#20026; 1 , &#22312; grub-mkimage &#21629;&#20196;&#20013;&#35774;&#32622;&#20026; diskboot.img(diskboot.S&#29983;&#25104;) &#23384;&#20648;&#30340;&#25159;&#21306;&#21495;</span>
 <span class="org-keyword">movl</span> ABS(kernel_sector), <span class="org-variable-name">%eax</span>


 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20197;&#19979;&#36890;&#36807;&#38500;&#27861;&#36816;&#31639;&#30340;&#21830;&#21644;&#20313;&#25968; , &#35745;&#31639;&#24341;&#23548;&#25159;&#21306;&#25152;&#22312;&#30340; &#30913;&#22836;/&#26609;&#38754;/&#25159;&#21306;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">eax &#29616;&#22312;&#23384;&#20648;&#30340;&#26159;&#24341;&#23548;&#25159;&#21306;&#32534;&#21495;</span>
 <span class="org-comment-delimiter">/* </span><span class="org-comment">zero %edx */</span>
 <span class="org-keyword">xorl</span> <span class="org-variable-name">%edx</span>, <span class="org-variable-name">%edx</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">divide by number of sectors */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">(%si) &#22788;&#23384;&#25918;&#25159;&#21306;&#25968;</span>
 <span class="org-keyword">divl</span> (<span class="org-variable-name">%si</span>)
 <span class="org-comment-delimiter">// </span><span class="org-comment">(%si)&#20013;&#23384;&#25918;sectors , (%si)/%eax</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">eax &#26159; sectors/eax &#30340;&#21830; , kernel_sector &#21462;&#40664;&#35748;&#20540;&#26102;&#31561;&#20110; sectors</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">edx &#20013;&#29616;&#22312;&#26159;&#20313;&#25968; , kernel_sector &#20026;&#40664;&#35748;&#26102;&#20026; edx &#20026; 0</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">save sector start */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23384;&#20648;&#36215;&#22987;&#25159;&#21306; , &#22240;&#20026;&#25159;&#21306;&#32534;&#21495;&#26159; 1~n ,&#38656;&#35201; cl+=1(&#35265;&#21518;&#38754;&#25805;&#20316;)</span>
 <span class="org-keyword">movb</span> <span class="org-variable-name">%dl</span>, <span class="org-variable-name">%cl</span>

 <span class="org-keyword">xorw</span> <span class="org-variable-name">%dx</span>, <span class="org-variable-name">%dx</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">zero %edx */</span>
 <span class="org-keyword">divl</span> 4(<span class="org-variable-name">%si</span>)  <span class="org-comment-delimiter">/* </span><span class="org-comment">divide by number of heads */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">4(%si) &#26159;&#30913;&#22836;&#25968; , &#30913;&#22836;&#25968;&#38500;&#20197;&#25159;&#21306;&#25968; , eax &#20013;&#23384;&#25918;&#26609;&#38754;&#25968; , edx &#23384;&#25918;&#20313;&#25968; , &#34920;&#31034;&#36215;&#22987;&#30913;&#22836;</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">do we need too many cylinders? */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">8(%si)&#26159;&#26609;&#38754;&#25968;  , &#22914;&#26524; ax &#20013;&#25968;&#20540;&#22823;&#20110;&#26609;&#38754;&#25968; , &#34920;&#31034;&#36229;&#20986;&#33539;&#22260; , &#36339;&#36716;&#33267; geometry_error &#22788;&#29702;!</span>
 <span class="org-keyword">cmpw</span> 8(<span class="org-variable-name">%si</span>), <span class="org-variable-name">%ax</span>
 <span class="org-keyword">jge</span> geometry_error

 <span class="org-comment-delimiter">/* </span><span class="org-comment">normalize sector start (1-based) */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">start &#25159;&#21306; += 1 , &#22240;&#20026;&#25159;&#21306;&#32534;&#21495;&#26159; 1~n</span>
 <span class="org-keyword">incb</span> <span class="org-variable-name">%cl</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">low bits of cylinder start */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">al &#26159;&#26609;&#38754;&#30340;&#20302; 8 &#20301;</span>
 <span class="org-keyword">movb</span> <span class="org-variable-name">%al</span>, <span class="org-variable-name">%ch</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">high bits of cylinder start */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">ah &#26159;&#26609;&#38754;&#30340;&#39640; 2 &#20301; , &#25805;&#20316;&#20043;&#21518; , cl &#39640; 2 &#20301;&#23384;&#20648;&#26609;&#38754;&#30340;&#39640; 2 &#20301;</span>
 <span class="org-keyword">xorb</span> <span class="org-variable-name">%al</span>, <span class="org-variable-name">%al</span>
 <span class="org-keyword">shrw</span> $2, <span class="org-variable-name">%ax</span>
 <span class="org-keyword">orb</span> <span class="org-variable-name">%al</span>, <span class="org-variable-name">%cl</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20445;&#23384;&#36215;&#22987;&#30913;&#22836;&#21040; al</span>
 <span class="org-comment-delimiter">/* </span><span class="org-comment">save head start */</span>
 <span class="org-keyword">movb</span> <span class="org-variable-name">%dl</span>, <span class="org-variable-name">%al</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#37325;&#26032;&#35774;&#32622;DL&#20026;&#24341;&#23548;&#39537;&#21160;&#22120;&#32534;&#21495;</span>
 <span class="org-comment-delimiter">/* </span><span class="org-comment">restore %dl */</span>
 <span class="org-keyword">popw</span> <span class="org-variable-name">%dx</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">head start */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">al &#20013;&#29616;&#22312;&#26159;&#36215;&#22987;&#30913;&#22836;&#21040; dh</span>
 <span class="org-keyword">movb</span> <span class="org-variable-name">%al</span>, <span class="org-variable-name">%dh</span>

<span class="org-comment-delimiter">/*</span>
<span class="org-comment"> * BIOS call "INT 0x13 Function 0x2" to read sectors from disk into memory</span>
<span class="org-comment"> * Call with %ah = 0x2</span>
<span class="org-comment"> *   %al = number of sectors</span>
<span class="org-comment"> *   %ch = cylinder</span>
<span class="org-comment"> *   %cl = sector (bits 6-7 are high bits of "cylinder")</span>
<span class="org-comment"> *   %dh = head</span>
<span class="org-comment"> *   %dl = drive (0x80 for hard disk, 0x0 for floppy disk)</span>
<span class="org-comment"> *   %es:%bx = segment:offset of buffer</span>
<span class="org-comment"> * Return:</span>
<span class="org-comment"> *   %al = 0x0 on success; err code on failure</span>
<span class="org-comment"> */</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">&#23492;&#23384;&#22120; :</span>
<span class="org-comment">  * AH = 0x02</span>
<span class="org-comment">  * AL = number of sectors to read (must be nonzero)</span>
<span class="org-comment">  * CH = low eight bits of cylinder number</span>
<span class="org-comment">  * CL = sector number 1-63 (bits 0-5),high two bits of cylinder (bits 6-7, hard disk only)</span>
<span class="org-comment">  * DH = head number</span>
<span class="org-comment">  * DL = drive number (bit 7 set for hard disk)</span>
<span class="org-comment">  * ES:BX -&gt; data buffer</span>
<span class="org-comment">  * &#25104;&#21151; :</span>
<span class="org-comment">  * CF = 0</span>
<span class="org-comment">  * AH = status</span>
<span class="org-comment">  * AL = number of sectors transferred (only valid if CF set for some BIOSes)</span>
<span class="org-comment">  * BX</span>
<span class="org-comment">  * &#22833;&#36133; :</span>
<span class="org-comment">  * CF = 1</span>
<span class="org-comment">  * AH = 11h (corrected ECC error), AL = burst length</span>
<span class="org-comment">  */</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#35774;&#32622;&#30913;&#30424;&#35835;&#21462;&#32531;&#20914;&#21306;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#25805;&#20316;&#23436;&#27605;&#20043;&#21518; , bx = 0x0000 , es = 0x7000</span>
 <span class="org-keyword">movw</span> $GRUB_BOOT_MACHINE_BUFFER_SEG, <span class="org-variable-name">%bx</span>
 <span class="org-keyword">movw</span> <span class="org-variable-name">%bx</span>, <span class="org-variable-name">%es</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">load %es segment with disk buffer */</span>

 <span class="org-keyword">xorw</span> <span class="org-variable-name">%bx</span>, <span class="org-variable-name">%bx</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">%bx = 0, put it at 0 in the segment */</span>
 <span class="org-keyword">movw</span> $0x0201, <span class="org-variable-name">%ax</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">function 2 */</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">CHS &#27169;&#24335;&#35835;&#30340; BIOS INT 0x13 &#35843;&#29992; , &#23492;&#23384;&#22120;&#20540;&#24050;&#32463;&#35774;&#32622;&#22914;&#19979; :</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23492;&#23384;&#22120;&#21517;  &#20540;  &#24847;&#20041;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">AH   0x02  CHS&#27169;&#24335;&#35835;&#38656;&#35201;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">AL   0x01  &#38656;&#35201;&#35835;&#30340;&#25159;&#21306;&#25968;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">CH   &#24050;&#35774;&#32622;  &#26609;&#38754;&#25968;&#30340;&#20302; 8 &#20301;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">CL   &#24050;&#35774;&#32622;  0~5bits &#25159;&#21306;&#21495; , bits 6-7bits &#26609;&#38754;&#30340;&#39640; 2 &#20301;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">DH   &#24050;&#35774;&#32622;  &#30913;&#22836;&#25968;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">DL   &#24050;&#24674;&#22797;  &#39537;&#21160;&#21495;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">ES:BX   0x7000:0x0000 &#25968;&#25454;&#32531;&#20914;&#21306;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20854;&#20013; , CH/CL/DH &#20445;&#23384;&#36215;&#22987; &#30913;&#22836;/&#26609;&#38754;/&#25159;&#21306; , &#26159;&#30001; kernel_sector &#20013;&#35774;&#32622;&#30340;&#20540;&#32463;&#36816;&#31639;&#24471;&#26469; ,</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20854;&#20013; , CH/CL/DH &#20445;&#23384;&#36215;&#22987; &#30913;&#22836;/&#26609;&#38754;/&#25159;&#21306; , &#26159;&#30001; kernel_sector &#20013;&#35774;&#32622;&#30340;&#20540;&#32463;&#36816;&#31639;&#24471;&#26469; , &#20855;&#20307;&#35265;&#19978;&#38754;&#36816;&#31639;&#36807;&#31243;</span>

 <span class="org-keyword">int</span> $0x13

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524; CHS &#35835;&#22833;&#36133; , &#36827;&#20837; read_error</span>
 <span class="org-keyword">jc</span> read_error

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#35774;&#32622; bx &#20026; 0x7000 , &#22312; copy_buffer &#29992;&#21040;</span>
 <span class="org-keyword">movw</span> <span class="org-variable-name">%es</span>, <span class="org-variable-name">%bx</span>

<span class="org-function-name">copy_buffer</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#20197;&#19979;&#20195;&#30721;&#25226;&#36890;&#36807; BIOS &#35843;&#29992;&#35835;&#36827;&#26469;&#30340;&#19968;&#25159;&#21306;&#30340;&#25968;&#25454;&#31227;&#21160;&#21040;&#20869;&#23384;&#22320;&#22336; 0x8000 &#22788;</span>

 <span class="org-keyword">movw</span> ABS(kernel_segment), <span class="org-variable-name">%es</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">es = 0x800</span>

 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  * We need to save %cx and %si because the startup code in</span>
<span class="org-comment">  * kernel uses them without initializing them.</span>
<span class="org-comment">  */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36825;&#37324;&#38656;&#35201;&#20445;&#23384; cx &#21644; si &#30340;&#20540;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22240;&#20026;&#20869;&#26680; startup &#37324;&#38754;&#30340;&#20195;&#30721;&#26410;&#32463;&#21021;&#22987;&#21270;&#23601;&#20351;&#29992;&#20102;&#23427;( &#20854;&#23454;&#26159; diskboot.S &#20195;&#30721; )</span>
 <span class="org-keyword">pusha</span>
 <span class="org-keyword">pushw</span> <span class="org-variable-name">%ds</span>


 <span class="org-comment-delimiter">// </span><span class="org-comment">&#35774;&#32622;&#24490;&#29615;&#27425;&#25968;&#21644;&#28304;/&#30446;&#30340;&#20018;&#27573;&#23492;&#23384;&#22120;&#21644;&#20559;&#31227;&#25351;&#38024;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#35774;&#32622;&#23436;&#27605;&#20043;&#21518; , &#23492;&#23384;&#22120;&#20540; :</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">CX = 0x100 ; ES:SI=0x800:0x0000</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">LBA&#35835; : DS:SI = 0x7000:0x0000</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">CHS&#35835; : DS:SI = ?</span>
 <span class="org-keyword">movw</span> $0x100, <span class="org-variable-name">%cx</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">cx = 0x100 = 256</span>

 <span class="org-keyword">movw</span> <span class="org-variable-name">%bx</span>, <span class="org-variable-name">%ds</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">ds = 0x7000</span>

 <span class="org-keyword">xorw</span> <span class="org-variable-name">%si</span>, <span class="org-variable-name">%si</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">si = 0x00</span>

 <span class="org-keyword">xorw</span> <span class="org-variable-name">%di</span>, <span class="org-variable-name">%di</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">di = 0</span>

 <span class="org-keyword">cld</span>
 <span class="org-comment-delimiter">//</span><span class="org-comment">DF = 0 (&#26041;&#21521;&#26631;&#24535;)</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#25805;&#20316;&#20018;&#30001; DS:SI &#21644; ES:DI &#25351;&#23450;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23558; DS:SI &#25351;&#21521;&#30340;&#23383;&#20256;&#36865;&#21040; ES:DI &#25351;&#21521;&#30340;&#20869;&#23384;&#21333;&#20803;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">DF = 0 , &#22240;&#27492; SI += 2 ; DI += 2</span>
 <span class="org-keyword">rep</span>
 <span class="org-keyword">movsw</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23558; ds:si &#22788;&#30340;&#36830;&#32493;&#30340; 512 &#23383;&#33410;&#25968;&#25454;&#25644;&#31227;&#21040; es:di &#22320;&#22336;&#22788;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#21363;&#23558;&#21018;&#35835;&#36827;&#26469;&#30340; 512 &#23383;&#33410;&#30340;&#25968;&#25454;&#25644;&#31227;&#21040;&#20869;&#23384;&#22320;&#22336;&#22320;&#22336; 0x8000 &#22788;</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23492;&#23384;&#22120;&#36824;&#21407;</span>
 <span class="org-keyword">popw</span> <span class="org-variable-name">%ds</span>
 <span class="org-keyword">popa</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#29616;&#22312; boot.S &#30340;&#25152;&#26377;&#20219;&#21153;&#20840;&#37096;&#23436;&#25104; , &#20877;&#25191;&#34892;&#19968;&#26465;&#36339;&#36716;&#25351;&#20196; , &#25226;&#25511;&#21046;&#26435;&#20132;&#32473; diskboot.S &#21518;&#23601;&#21151;&#25104;&#36523;&#36864;&#20102;</span>
 <span class="org-comment-delimiter">/* </span><span class="org-comment">boot kernel */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">kernel_address = 0x8000</span>
 <span class="org-keyword">jmp</span> *(kernel_address)
 <span class="org-comment-delimiter">// </span><span class="org-comment">0x8000 &#22788;&#23384;&#25918;&#20102; diskboot.S &#29983;&#25104;&#30340;&#26426;&#22120;&#30721;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#33267;&#20110; 0x8000 &#22788;&#30340; 512 &#23383;&#33410;&#20195;&#30721;&#23436;&#25104;&#20160;&#20040;&#21151;&#33021; , &#35265; diskboot.S &#27880;&#37322;</span>

<span class="org-comment-delimiter">/* </span><span class="org-comment">END OF MAIN LOOP */</span>

<span class="org-comment-delimiter">/*</span>
<span class="org-comment"> * BIOS Geometry translation error (past the end of the disk geometry!).</span>
<span class="org-comment"> */</span>
<span class="org-function-name">geometry_error</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#25171;&#21360;&#38169;&#35823;&#20449;&#24687;&#20018; geometry_error_string &#28982;&#21518;&#36339;&#36716;&#21040; general_error</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23439;&#23637;&#24320;&#21518;&#26159; : movw $(geometry_error_string-_start+0x7c00), %si; call message</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">geometry_error_string = "Geom"</span>
 <span class="org-keyword">MSG</span>(geometry_error_string)
 <span class="org-keyword">jmp</span> general_error

<span class="org-comment-delimiter">/*</span>
<span class="org-comment"> * Disk probe failure.</span>
<span class="org-comment"> */</span>
<span class="org-function-name">hd_probe_error</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#25171;&#21360;&#38169;&#35823;&#20449;&#24687;&#20018; hd_probe_error_string &#28982;&#21518;&#36339;&#36716;&#21040; general_error</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23439;&#23637;&#24320;&#21518;&#26159; : movw $(hd_probe_error_string-_start+0x7c00), %si; call message</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">hd_probe_error_string = "Hard Disk"</span>
 <span class="org-keyword">MSG</span>(hd_probe_error_string)
 <span class="org-keyword">jmp</span> general_error

<span class="org-comment-delimiter">/*</span>
<span class="org-comment"> * Read error on the disk.</span>
<span class="org-comment"> */</span>
<span class="org-function-name">read_error</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#25171;&#21360;&#38169;&#35823;&#20449;&#24687;&#20018; read_error_string</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23439;&#23637;&#24320;&#21518;&#26159; : movw $(read_error_string-_start+0x7c00), %si; call message</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">read_error_string = "Read"</span>
 <span class="org-keyword">MSG</span>(read_error_string)

<span class="org-function-name">general_error</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#25171;&#21360;&#38169;&#35823;&#20449;&#24687;&#20018; general_error_string</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#35843;&#29992; BIOS &#25552;&#20379;&#30340;&#35843;&#29992; INT 0x18 &#21578;&#35785; BIOS &#24341;&#23548;&#22833;&#36133;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36827;&#20837;&#27515;&#24490;&#29615; , &#31561;&#24453;&#25163;&#21160;&#37325;&#36215; ( &#19979;&#38754;&#31532; 4 &#34892; &#22788;&#20195;&#30721; )</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23439;&#23637;&#24320;&#21518;&#26159; : movw $(general_error_string-_start+0x7c00), %si; call message</span>
 <span class="org-keyword">MSG</span>(general_error_string)

<span class="org-comment-delimiter">/* </span><span class="org-comment">go here when you need to stop the machine hard after an error condition */</span>
        <span class="org-comment-delimiter">/* </span><span class="org-comment">tell the BIOS a boot failure, which may result in no effect */</span>
        <span class="org-keyword">int</span> $0x18
<span class="org-function-name">stop</span>: <span class="org-keyword">jmp</span> stop

<span class="org-function-name">notification_string</span>: .string <span class="org-string">"GRUB "</span>
<span class="org-function-name">geometry_error_string</span>: .string <span class="org-string">"Geom"</span>
<span class="org-function-name">hd_probe_error_string</span>: .string <span class="org-string">"Hard Disk"</span>
<span class="org-function-name">read_error_string</span>: .string <span class="org-string">"Read"</span>
<span class="org-function-name">general_error_string</span>: .string <span class="org-string">" Error"</span>

<span class="org-comment-delimiter">/*</span>
<span class="org-comment"> * message: write the string pointed to by %si</span>
<span class="org-comment"> *</span>
<span class="org-comment"> *   WARNING: trashes %si, %ax, and %bx</span>
<span class="org-comment"> */</span>

 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  * Use BIOS "int 10H Function 0Eh" to write character in teletype mode</span>
<span class="org-comment">  * %ah = 0xe %al = character</span>
<span class="org-comment">  * %bh = page %bl = foreground color (graphics modes)</span>
<span class="org-comment">  */</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">message &#36890;&#36807; BIOS &#25552;&#20379;&#30340; INT 0x10 , AH = 0x0E , &#25226; ds:si &#23383;&#31526;&#20018;&#36880;&#20010;&#36755;&#20986;&#21040;&#32456;&#31471;</span>
<span class="org-function-name">1</span>:
 <span class="org-keyword">movw</span> $0x0001, <span class="org-variable-name">%bx</span>
 <span class="org-keyword">movb</span> $0xe, <span class="org-variable-name">%ah</span>
 <span class="org-keyword">int</span> $0x10  <span class="org-comment-delimiter">/* </span><span class="org-comment">display a byte */</span>
<span class="org-function-name">message</span>:
 <span class="org-keyword">lodsb</span>
 <span class="org-keyword">cmpb</span> $0, <span class="org-variable-name">%al</span>
 <span class="org-keyword">jne</span> 1b <span class="org-comment-delimiter">/* </span><span class="org-comment">if not end of string, jmp to display */</span>
 <span class="org-keyword">ret</span>

 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  *  Windows NT breaks compatibility by embedding a magic</span>
<span class="org-comment">  *  number here.</span>
<span class="org-comment">  */</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">Windows NT &#22312;&#27492;&#35774;&#32622;&#20102;&#24187;&#25968; , &#27492;&#22788;&#20445;&#30041;&#24050;&#20445;&#35777;&#20860;&#23481;&#24615;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">GRUB_BOOT_MACHINE_WINDOWS_NT_MAGIC = 0x1B8</span>
 . = _start + GRUB_BOOT_MACHINE_WINDOWS_NT_MAGIC
<span class="org-function-name">nt_magic</span>:
 <span class="org-keyword">.long</span> 0
 <span class="org-keyword">.word</span> 0

 <span class="org-comment-delimiter">/*</span>
<span class="org-comment">  *  This is where an MBR would go if on a hard disk.  The code</span>
<span class="org-comment">  *  here isn't even referenced unless we're on a floppy.  Kinda</span>
<span class="org-comment">  *  sneaky, huh?</span>
<span class="org-comment">  */</span>

<span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#26159;&#30828;&#30424; , &#20197;&#19979;&#26159;&#20998;&#21306;&#34920;&#22320;&#22336;&#22495;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#21542;&#21017;&#22914;&#26524;&#26159;&#36719;&#30424; , &#21017;&#23384;&#20648;</span>
<span class="org-function-name">part_start</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">GRUB_BOOT_MACHINE_PART_START = 0x1BE</span>
 . = _start + GRUB_BOOT_MACHINE_PART_START

<span class="org-function-name">probe_values</span>:
 <span class="org-keyword">.byte</span> 36, 18, 15, 9, 0

<span class="org-comment-delimiter">// </span><span class="org-comment">&#36719;&#30424;&#24341;&#23548;&#25506;&#27979;</span>
<span class="org-function-name">floppy_probe</span>:
<span class="org-comment-delimiter">/*</span>
<span class="org-comment"> *  Perform floppy probe.</span>
<span class="org-comment"> */</span>

 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23439;&#23637;&#24320;&#20043;&#21518; : movw $(probe_values-1 -_start+0x7c00), %si</span>
 <span class="org-keyword">movw</span> $ABS(probe_values-1), <span class="org-variable-name">%si</span>

<span class="org-function-name">probe_loop</span>:
 <span class="org-comment-delimiter">/* </span><span class="org-comment">reset floppy controller INT 13h AH=0 */</span>
 <span class="org-comment-delimiter">/* </span><span class="org-comment">&#30913;&#30424;/&#36719;&#30424;&#22797;&#20301;&#35843;&#29992;</span>
<span class="org-comment">  * INT 0x13 ; AH = 0x00 ; DL = drive number</span>
<span class="org-comment">  * &#25104;&#21151; : CF = 0 , AH = 0x00</span>
<span class="org-comment">  * &#22833;&#36133; : CF = 1 , AH = &#38169;&#35823;&#29366;&#24577;</span>
<span class="org-comment">  * Note:</span>
<span class="org-comment">  * Forces controller to recalibrate drive heads (seek to track 0).</span>
<span class="org-comment">  * For PS/2 35SX, 35LS, 40SX and L40SX, as well as many other systems,</span>
<span class="org-comment">  * both the master drive and the slave drive respond to the Reset function</span>
<span class="org-comment">  * that is issued to either drive</span>
<span class="org-comment">  */</span>


 <span class="org-keyword">xorw</span> <span class="org-variable-name">%ax</span>, <span class="org-variable-name">%ax</span>
 <span class="org-keyword">int</span> $0x13

 <span class="org-keyword">incw</span> <span class="org-variable-name">%si</span>
 <span class="org-keyword">movb</span> (<span class="org-variable-name">%si</span>), <span class="org-variable-name">%cl</span>

 <span class="org-comment-delimiter">/* </span><span class="org-comment">if number of sectors is 0, display error and die */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#25159;&#21306;&#25968;&#20026; 0 , &#20986;&#38169; , &#21542;&#21017;&#36339;&#36716;&#33267; 1f</span>
 <span class="org-keyword">cmpb</span> $0, <span class="org-variable-name">%cl</span>
 <span class="org-keyword">jne</span> 1f

<span class="org-comment-delimiter">/*</span>
<span class="org-comment"> * Floppy disk probe failure.</span>
<span class="org-comment"> */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23439;&#26367;&#25442;&#21518; : movw $(fd_probe_error_string-_start+0x7c00), %si; call message</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">fd_probe_error_string = "Flobby"</span>
 <span class="org-keyword">MSG</span>(fd_probe_error_string)
 <span class="org-keyword">jmp</span> general_error

<span class="org-function-name">fd_probe_error_string</span>: .string <span class="org-string">"Floppy"</span>

<span class="org-function-name">1</span>:
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#36719;&#30424;&#35835;&#21462; , BIOS &#35843;&#29992;&#21644; CHS &#35835;&#21462;&#30340; BIOS &#35843;&#29992;&#23436;&#20840;&#19968;&#33268; , &#35814;&#32454;&#35265; chs_mod &#22788;&#30340;&#27880;&#37322;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#23492;&#23384;&#22120;&#20540; ah = 0x02 , al = 0x01 , ch = dh = 0 , cl = start sector , dl = driver number</span>
 <span class="org-comment-delimiter">/* </span><span class="org-comment">perform read */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">GRUB_BOOT_MACHINE_BUFFER_SEG = 0x7000</span>
 <span class="org-keyword">movw</span> $GRUB_BOOT_MACHINE_BUFFER_SEG, <span class="org-variable-name">%bx</span>
 <span class="org-keyword">movw</span> $0x201, <span class="org-variable-name">%ax</span>
 <span class="org-keyword">movb</span> $0, <span class="org-variable-name">%ch</span>
 <span class="org-keyword">movb</span> $0, <span class="org-variable-name">%dh</span>
 <span class="org-keyword">int</span> $0x13

 <span class="org-comment-delimiter">/* </span><span class="org-comment">if error, jump to "probe_loop" */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#35835;&#22833;&#36133;&#36820;&#22238; probe_loop &#37325;&#35835;</span>
 <span class="org-keyword">jc</span> probe_loop

 <span class="org-comment-delimiter">/* </span><span class="org-comment">%cl is already the correct value! */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#35774;&#32622; &#25159;&#21306;/&#26609;&#38754;/&#30913;&#22836;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">cl &#21363; start sector &#24050;&#35774;&#32622;&#27491;&#30830;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">dh &#35774;&#32622;&#20026; 79 , &#34920;&#31034;&#26609;&#38754;&#26368;&#22823;&#20540;&#20026; 79(80&#26609;:0~79)</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">dh &#35774;&#32622;&#20026; 1 , &#34920;&#31034;&#30913;&#22836;&#25968;&#26368;&#22823;&#20540;&#20026; 1(2&#22836;:0~1)</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#28982;&#21518;&#36339;&#36716;&#33267; final_init</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#26597;&#30475; final_init , &#30693;&#36947;&#20445;&#23384;&#26102;&#20250;&#25226;&#26609;&#38754;&#21644;&#30913;&#22836;&#20998;&#21035;&#21152; 1 , &#25159;&#21306;&#19981;&#21464;</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#22240;&#27492; , &#22312;&#36719;&#30424;&#21152;&#36733;&#26102; , &#23558;&#35774;&#32622; Cylinder : Head : Sector = 80 : 2 : start_sector</span>
 <span class="org-keyword">movb</span> $1, <span class="org-variable-name">%dh</span>
 <span class="org-keyword">movb</span> $79, <span class="org-variable-name">%ch</span>

 <span class="org-keyword">jmp</span> final_init

 <span class="org-comment-delimiter">// </span><span class="org-comment">GRUB_BOOT_MACHINE_PART_END = 0x1FE</span>
 . = _start + GRUB_BOOT_MACHINE_PART_END
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#31354;&#38388;&#20445;&#30041; , &#20998;&#21306;&#20449;&#24687;&#21344;&#29992;&#20869;&#23384;&#22320;&#22336;&#26159; _start + 0x1BE ~ _start + 0x1FD</span>

<span class="org-comment-delimiter">/* </span><span class="org-comment">the last 2 bytes in the sector 0 contain the signature */</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">&#24341;&#23548;&#24187;&#25968; , 2 &#23383;&#33410; , &#31561;&#20110; 0xAA55</span>
 <span class="org-comment-delimiter">// </span><span class="org-comment">GRUB_BOOT_MACHINE_SIGNATURE = 0xAA55</span>
 <span class="org-keyword">.word</span> GRUB_BOOT_MACHINE_SIGNATURE


<span class="org-comment-delimiter">//</span><span class="org-comment">&#26412;&#27573;&#20195;&#30721;&#22312;&#32534;&#35793;&#38142;&#25509;&#25104;&#30340;&#26426;&#22120;&#30721;&#22914;&#19979;:( 0x7C00 ~ 0x7DFF &#20849;512&#23383;&#33410; )</span>
<span class="org-comment-delimiter">/*</span>
<span class="org-comment"> * ADDR ---------------CODE----------------</span>
<span class="org-comment"> * 7c00 eb4b9000 00000000 00000000 00000000</span>
<span class="org-comment"> * 7c10 00000000 00000000 00000000 00000000</span>
<span class="org-comment"> * 7c20 00000000 00000000 00000000 00000000</span>
<span class="org-comment"> * 7c30 00000000 00000000 00000000 00000400</span>
<span class="org-comment"> * 7c40 00800008 01000000 00000000 fffaeb07</span>
<span class="org-comment"> * 7c50 f6c28075 02b280ea 5c7c0000 31c08ed8</span>
<span class="org-comment"> * 7c60 8ed0bc00 20fba04c 7c3cff74 0288c252</span>
<span class="org-comment"> * 7c70 be717de8 2301be05 7cf6c280 7448b441</span>
<span class="org-comment"> * 7c80 bbaa55cd 135a5272 3d81fb55 aa753783</span>
<span class="org-comment"> * 7c90 e1017432 31c08944 04408844 ff894402</span>
<span class="org-comment"> * 7ca0 c7041000 668b1e44 7c66895c 08668b1e</span>
<span class="org-comment"> * 7cb0 487c6689 5c0cc744 060070b4 42cd1372</span>
<span class="org-comment"> * 7cc0 05bb0070 eb73b408 cd13730a f6c2800f</span>
<span class="org-comment"> * 7cd0 84f000e9 8300660f b6c68864 ff406689</span>
<span class="org-comment"> * 7ce0 44040fb6 d1c1e202 88e888f4 40894408</span>
<span class="org-comment"> * 7cf0 0fb6c2c0 e8026689 0466a148 7c6609c0</span>
<span class="org-comment"> * 7d00 754f66a1 447c6631 d266f734 88d131d2</span>
<span class="org-comment"> * 7d10 66f77404 3b44087d 38fec188 c530c0c1</span>
<span class="org-comment"> * 7d20 e80208c1 88d05a88 c6bb0070 8ec331db</span>
<span class="org-comment"> * 7d30 b80102cd 13722a8c c38e0642 7c601eb9</span>
<span class="org-comment"> * 7d40 00018edb 31f631ff fcf3a51f 61ff2640</span>
<span class="org-comment"> * 7d50 7cbe777d e84200eb 0ebe7c7d e83a00eb</span>
<span class="org-comment"> * 7d60 06be867d e83200be 8b7de82c 00cd18eb</span>
<span class="org-comment"> * 7d70 fe475255 42200047 656f6d00 48617264</span>
<span class="org-comment"> * 7d80 20446973 6b005265 61640020 4572726f</span>
<span class="org-comment"> * 7d90 7200bb01 00b40ecd 10ac3c00 75f4c300</span>
<span class="org-comment"> * 7da0 00000000 00000000 00000000 00000000</span>
<span class="org-comment"> * 7db0 00000000 00000000 00000000 00002412</span>
<span class="org-comment"> * 7dc0 0f0900be bd7d31c0 cd13468a 0c80f900</span>
<span class="org-comment"> * 7dd0 750fbeda 7de8c1ff eb8d466c 6f707079</span>
<span class="org-comment"> * 7de0 00bb0070 b80102b5 00b600cd 1372d7b6</span>
<span class="org-comment"> * 7df0 01b54fe9 e0fe0000 00000000 000055aa</span>
<span class="org-comment"> */</span>
</pre>
</div>
</div>
<div id="postamble" class="status">
<div id="disqus_thread" class="disqus container"></div>
<script>
  var disqus_config = function () {
    this.page.url = 'http://ycode.org/blogs/bootloader-grub-v1.95-boot.S-comment.html';
    this.page.identifier = 'bootloader-grub-v1.95-boot.S-comment.html';
  };

  (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://yanyg.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<div class="copyright">
2012-2020 Copyright&copy; <i> YANYG - Powered by Emacs Orgmode</i>
</div>
</div>
</body>
</html>
