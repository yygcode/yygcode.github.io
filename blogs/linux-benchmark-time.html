<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
<!-- 2018-06-03 Sun 11:38 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>程序执行时间与代码执行时间评估/Benchmark process execution time and code execution time</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="yanyg" />
<link rel="stylesheet" type="text/css" href="../r/org-code.css" />
<link rel="stylesheet" type="text/css" href="../r/blog-bluetopbar.css" />
<script type="text/javascript" src="../r/MathJax.js?config=TeX-AMS_HTML"> </script>
<script type="text/javascript" src="../r/bootstrap.min.js"></script>
<script type="text/javascript" src="../r/jquery.stickytableheaders.min.js"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="preamble" class="status">
<a href="../index.html">Yanyg - SAN Software Engineer</a>
<div class="sitelinks">
  <a href="archives.html">Archives</a> |
  <a href="theindex.html">Index</a> |
  <a href="tags.html">TAGS</a> |
  <a href="https://github.com/yygcode">Github</a> |
  <a href="../about.html">About Me</a>
</div>
</div>
<div id="content">
<h1 class="title">程序执行时间与代码执行时间评估/Benchmark process execution time and code execution time</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org98698a9">1. 评估进程执行时间</a></li>
<li><a href="#org35fdd00">2. 代码段执行时间评估</a>
<ul>
<li><a href="#org3869c5b">2.1. Methods</a></li>
<li><a href="#org22408ce">2.2. Test Results</a></li>
</ul>
</li>
<li><a href="#orge516ef9">3. Test Code</a></li>
<li><a href="#org966115e">4. 参考资源</a></li>
</ul>
</div>
</div>

<div id="outline-container-org98698a9" class="outline-2">
<h2 id="org98698a9"><span class="section-number-2">1</span> 评估进程执行时间</h2>
<div class="outline-text-2" id="text-1">
<p>
Shell环境下使用time评估。bash shell有内置的time，系统提供功能更多的time命令
(<a href="https://ftp.gnu.org/gnu/time/">GNU Time</a>，<a href="https://savannah.gnu.org/git/?group=time">GNU Time Git</a>，安装位置一般是/usr/bin/time)。GNU Time基于
\(gettimeofday\)和\(wait3\)实现。
</p>
<div class="org-src-container">
<pre class="src src-C">~$<span class="org-whitespace-space"> </span>time<span class="org-whitespace-space"> </span>sudo<span class="org-whitespace-space"> </span>dd<span class="org-whitespace-space"> </span><span class="org-keyword">if</span>=/dev/sdb<span class="org-whitespace-space"> </span>of=/dev/null<span class="org-whitespace-space"> </span>bs=4K<span class="org-whitespace-space"> </span>count=1K<span class="org-whitespace-space"> </span>iflag=direct
1024+0<span class="org-whitespace-space"> </span>records<span class="org-whitespace-space"> </span>in
1024+0<span class="org-whitespace-space"> </span>records<span class="org-whitespace-space"> </span>out
4194304<span class="org-whitespace-space"> </span>bytes<span class="org-whitespace-space"> </span>(4.2<span class="org-whitespace-space"> </span>MB)<span class="org-whitespace-space"> </span>copied,<span class="org-whitespace-space"> </span>0.370473<span class="org-whitespace-space"> </span>s,<span class="org-whitespace-space"> </span>11.3<span class="org-whitespace-space"> </span>MB/s

real<span class="org-whitespace-space">    </span>0m0.380s
user<span class="org-whitespace-space">    </span>0m0.004s
sys<span class="org-whitespace-space">     </span>0m0.004s
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">~$<span class="org-whitespace-space"> </span>/usr/bin/time<span class="org-whitespace-space"> </span>--format<span class="org-whitespace-space"> </span><span class="org-string">"Time:\n\t%E</span><span class="org-whitespace-space"> </span><span class="org-string">real,\n\t%U</span><span class="org-whitespace-space"> </span><span class="org-string">user,\n\t%S</span><span class="org-whitespace-space"> </span><span class="org-string">sys"</span><span class="org-whitespace-space"> </span>sudo<span class="org-whitespace-space"> </span>dd<span class="org-whitespace-space"> </span><span class="org-variable-name">if</span>=/<span class="org-whitespace-line">dev/sdb</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-variable-name"><span class="org-whitespace-line">of</span></span><span class="org-whitespace-line">=/dev/null</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-variable-name"><span class="org-whitespace-line">bs</span></span><span class="org-whitespace-line">=4K</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-variable-name"><span class="org-whitespace-line">count</span></span><span class="org-whitespace-line">=1K</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-variable-name"><span class="org-whitespace-line">iflag</span></span><span class="org-whitespace-line">=direct</span>
1024+0<span class="org-whitespace-space"> </span>records<span class="org-whitespace-space"> </span><span class="org-keyword">in</span>
1024+0<span class="org-whitespace-space"> </span>records<span class="org-whitespace-space"> </span>out
4194304<span class="org-whitespace-space"> </span>bytes<span class="org-whitespace-space"> </span>(4.2<span class="org-whitespace-space"> </span>MB)<span class="org-whitespace-space"> </span>copied,<span class="org-whitespace-space"> </span>0.39669<span class="org-whitespace-space"> </span>s,<span class="org-whitespace-space"> </span>10.6<span class="org-whitespace-space"> </span>MB/s

Time:
<span class="org-whitespace-space">        </span>0:00.40<span class="org-whitespace-space"> </span>real,
<span class="org-whitespace-space">        </span>0.00<span class="org-whitespace-space"> </span>user,
<span class="org-whitespace-space">        </span>0.01<span class="org-whitespace-space"> </span>sys
</pre>
</div>
</div>
</div>

<div id="outline-container-org35fdd00" class="outline-2">
<h2 id="org35fdd00"><span class="section-number-2">2</span> 代码段执行时间评估</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org3869c5b" class="outline-3">
<h3 id="org3869c5b"><span class="section-number-3">2.1</span> Methods</h3>
<div class="outline-text-3" id="text-2-1">
<p>
使用\(time\)、\(gettimeofday\)、\(clock\_gettime\)获取秒、微秒、纳秒级别的时间精度，但上述三者都触发系统调用或vdso。使用内嵌汇编和CPU指令RDTSC获取更高精度(与
CPU主频相同)的时间精度。
</p>
</div>
</div>

<div id="outline-container-org22408ce" class="outline-3">
<h3 id="org22408ce"><span class="section-number-3">2.2</span> Test Results</h3>
<div class="outline-text-3" id="text-2-2">
<p>
通过测试代码，在我的T430(CPU 2.89Hz Cores 4)上2594 TSC为1微秒(10<sup>-6</sup>)，2.8 TSC
为1纳秒(这和CPU的频率2.8GHz是一致的)。系统调用成本大概240-310 TSC，而vdso(虚拟系统调用)110-130 TSC。vdso是系统调用成本的40%左右。传递编译参数\(-static\)使用系统调用，不传递该参数默认为动态链接，在支持vdso系统上优先使用vdso。
</p>

<div class="org-src-container">
<pre class="src src-sh">~$<span class="org-whitespace-space"> </span>lscpu
Architecture:<span class="org-whitespace-space">          </span>x86_64
CPU<span class="org-whitespace-space"> </span>op-mode(s):<span class="org-whitespace-space">        </span>32-bit,<span class="org-whitespace-space"> </span>64-bit
Byte<span class="org-whitespace-space"> </span>Order:<span class="org-whitespace-space">            </span>Little<span class="org-whitespace-space"> </span>Endian
<span class="org-function-name">CPU</span>(s):<span class="org-whitespace-space">                </span>4
On-line<span class="org-whitespace-space"> </span>CPU(s)<span class="org-whitespace-space"> </span>list:<span class="org-whitespace-space">   </span>0-3
<span class="org-function-name">Thread</span>(s)<span class="org-whitespace-space"> </span>per<span class="org-whitespace-space"> </span>core:<span class="org-whitespace-space">    </span>2
<span class="org-function-name">Core</span>(s)<span class="org-whitespace-space"> </span>per<span class="org-whitespace-space"> </span>socket:<span class="org-whitespace-space">    </span>2
<span class="org-function-name">Socket</span>(s):<span class="org-whitespace-space">             </span>1
NUMA<span class="org-whitespace-space"> </span>node(s):<span class="org-whitespace-space">          </span>1
Vendor<span class="org-whitespace-space"> </span>ID:<span class="org-whitespace-space">             </span>GenuineIntel
CPU<span class="org-whitespace-space"> </span>family:<span class="org-whitespace-space">            </span>6
Model:<span class="org-whitespace-space">                 </span>60
Model<span class="org-whitespace-space"> </span>name:<span class="org-whitespace-space">            </span>Intel(R)<span class="org-whitespace-space"> </span>Core(TM)<span class="org-whitespace-space"> </span>i7-4600M<span class="org-whitespace-space"> </span>CPU<span class="org-whitespace-space"> </span>@<span class="org-whitespace-space"> </span>2.90GHz
Stepping:<span class="org-whitespace-space">              </span>3
CPU<span class="org-whitespace-space"> </span>MHz:<span class="org-whitespace-space">               </span>2904.248
CPU<span class="org-whitespace-space"> </span>max<span class="org-whitespace-space"> </span>MHz:<span class="org-whitespace-space">           </span>3600.0000
CPU<span class="org-whitespace-space"> </span>min<span class="org-whitespace-space"> </span>MHz:<span class="org-whitespace-space">           </span>800.0000
BogoMIPS:<span class="org-whitespace-space">              </span>5786.24
Virtualization:<span class="org-whitespace-space">        </span>VT-x
L1d<span class="org-whitespace-space"> </span>cache:<span class="org-whitespace-space">             </span>32K
L1i<span class="org-whitespace-space"> </span>cache:<span class="org-whitespace-space">             </span>32K
L2<span class="org-whitespace-space"> </span>cache:<span class="org-whitespace-space">              </span>256K
L3<span class="org-whitespace-space"> </span>cache:<span class="org-whitespace-space">              </span>4096K
NUMA<span class="org-whitespace-space"> </span>node0<span class="org-whitespace-space"> </span>CPU(s):<span class="org-whitespace-space">     </span>0-3
Flags:<span class="org-whitespace-space">                 </span>fpu<span class="org-whitespace-space"> </span>vme<span class="org-whitespace-space"> </span>de<span class="org-whitespace-space"> </span>pse<span class="org-whitespace-space"> </span>tsc<span class="org-whitespace-space"> </span>msr<span class="org-whitespace-space"> </span>pae<span class="org-whitespace-space"> </span>mce<span class="org-whitespace-space"> </span>cx8<span class="org-whitespace-space"> </span>apic<span class="org-whitespace-space"> </span>sep<span class="org-whitespace-space"> </span>mtrr<span class="org-whitespace-space"> </span>pge<span class="org-whitespace-space"> </span>mca<span class="org-whitespace-space"> </span><span class="org-whitespace-line">cmov</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">pat</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">pse36</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">clflush</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">dts</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">acpi</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">mmx</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">fxsr</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">sse</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">sse2</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">ss</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">ht</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">tm</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">pbe</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">syscall</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">nx</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">pdpe1gb</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">rdtscp</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">lm</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">constant_tsc</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">arch_perfmon</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">pebs</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">bts</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">rep_good</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">nopl</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">xtopology</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">nonstop_tsc</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">aperfmperf</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">eagerfpu</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">pni</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">pclmulqdq</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">dtes64</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">monitor</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">ds_cpl</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">vmx</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">smx</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">est</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">tm2</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">ssse3</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">sdbg</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">fma</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">cx16</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">xtpr</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">pdcm</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">pcid</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">sse4_1</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">sse4_2</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">x2apic</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">movbe</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">popcnt</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">tsc_deadline_timer</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">aes</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">xsave</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">avx</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">f16c</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">rdrand</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">lahf_lm</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">abm</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">epb</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">tpr_shadow</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">vnmi</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">flexpriority</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">ept</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">vpid</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">fsgsbase</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">tsc_adjust</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">bmi1</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">hle</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">avx2</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">smep</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">bmi2</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">erms</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">invpcid</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">rtm</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">xsaveopt</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">dtherm</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">ida</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">arat</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">pln</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">pts</span>
~$<span class="org-whitespace-space"> </span>gcc<span class="org-whitespace-space"> </span>-Wall<span class="org-whitespace-space"> </span>-O3<span class="org-whitespace-space"> </span>benchmark-time.c<span class="org-whitespace-space"> </span>-o<span class="org-whitespace-space"> </span>test-benchmark<span class="org-whitespace-space"> </span>-static<span class="org-whitespace-space">  </span><span class="org-comment-delimiter">#</span><span class="org-comment">&lt;--</span><span class="org-whitespace-space"> </span><span class="org-comment">remove</span><span class="org-whitespace-space"> </span><span class="org-comment">-static</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">for</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">vdso</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">test</span></span>
~$<span class="org-whitespace-space"> </span>taskset<span class="org-whitespace-space"> </span>0x1<span class="org-whitespace-space"> </span>./test-benchmark
init<span class="org-whitespace-space"> </span>TSC<span class="org-whitespace-space"> </span>to<span class="org-whitespace-space"> </span>microsecond<span class="org-whitespace-space"> </span>(about<span class="org-whitespace-space"> </span>2<span class="org-whitespace-space"> </span>seconds)
<span class="org-whitespace-space">        </span>1000<span class="org-whitespace-space"> </span>system<span class="org-whitespace-space"> </span>call<span class="org-whitespace-space"> </span>tsc<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>296148
<span class="org-whitespace-space">        </span><span class="org-variable-name">tsc2microsec</span>=2893<span class="org-whitespace-space"> </span><span class="org-variable-name">tsc2clock</span>=2<span class="org-whitespace-space"> </span><span class="org-variable-name">system_call</span>=296<span class="org-whitespace-space"> </span>[<span class="org-variable-name">tsc</span>=5787006236,<span class="org-whitespace-space"> </span><span class="org-variable-name">milliseco</span><span class="org-variable-name"><span class="org-whitespace-line">nd</span></span><span class="org-whitespace-line">=2000127,</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-variable-name"><span class="org-whitespace-line">nanosec</span></span><span class="org-whitespace-line">=2000123893,</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-variable-name"><span class="org-whitespace-line">tsc2nanosec</span></span><span class="org-whitespace-line">=2.893324]</span>
rdtsc<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>100000000
<span class="org-whitespace-space">        </span>elpased(544894707)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">start</span>=8746910496255,<span class="org-whitespace-space"> </span><span class="org-variable-name">end</span>=8747455390962,<span class="org-whitespace-space"> </span><span class="org-variable-name">time</span>=0.18834<span class="org-whitespace-line">9]</span>
rdtsc<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1000000
<span class="org-whitespace-space">        </span>elpased(5561326)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">start</span>=8747455521373,<span class="org-whitespace-space"> </span><span class="org-variable-name">end</span>=8747461082699,<span class="org-whitespace-space"> </span><span class="org-variable-name">time</span>=0.001922]
rdtsc<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>10000
<span class="org-whitespace-space">        </span>elpased(92467)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">start</span>=8747461122832,<span class="org-whitespace-space"> </span><span class="org-variable-name">end</span>=8747461215299,<span class="org-whitespace-space"> </span><span class="org-variable-name">time</span>=0.000031]
rdtsc<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1000
<span class="org-whitespace-space">        </span>elpased(5018)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">start</span>=8747461231815,<span class="org-whitespace-space"> </span><span class="org-variable-name">end</span>=8747461236833,<span class="org-whitespace-space"> </span><span class="org-variable-name">time</span>=0.000001]
rdtsc<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>100
<span class="org-whitespace-space">        </span>elpased(539)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">start</span>=8747461246770,<span class="org-whitespace-space"> </span><span class="org-variable-name">end</span>=8747461247309,<span class="org-whitespace-space"> </span><span class="org-variable-name">time</span>=0.000000]
gettimeofday<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>100000000
<span class="org-whitespace-space">        </span>elpased(181964)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">time</span>=0.181964]
gettimeofday<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1000000
<span class="org-whitespace-space">        </span>elpased(1737)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">time</span>=0.001737]
gettimeofday<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>10000
<span class="org-whitespace-space">        </span>elpased(22)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">time</span>=0.000022]
gettimeofday<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1000
<span class="org-whitespace-space">        </span>elpased(2)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">time</span>=0.000002]
gettimeofday<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>100
<span class="org-whitespace-space">        </span>elpased(1)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">time</span>=0.000001]
clock<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>100000000
<span class="org-whitespace-space">        </span><span class="org-variable-name">CLOCKS_PER_SEC</span>=1000000
<span class="org-whitespace-space">        </span>elpased(183109)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">clk1</span>=375095,<span class="org-whitespace-space"> </span><span class="org-variable-name">clk2</span>=558204]
clock<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1000000
<span class="org-whitespace-space">        </span><span class="org-variable-name">CLOCKS_PER_SEC</span>=1000000
<span class="org-whitespace-space">        </span>elpased(1795)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">clk1</span>=558251,<span class="org-whitespace-space"> </span><span class="org-variable-name">clk2</span>=560046]
clock<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>10000
<span class="org-whitespace-space">        </span><span class="org-variable-name">CLOCKS_PER_SEC</span>=1000000
<span class="org-whitespace-space">        </span>elpased(29)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">clk1</span>=560054,<span class="org-whitespace-space"> </span><span class="org-variable-name">clk2</span>=560083]
clock<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1000
<span class="org-whitespace-space">        </span><span class="org-variable-name">CLOCKS_PER_SEC</span>=1000000
<span class="org-whitespace-space">        </span>elpased(2)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">clk1</span>=560089,<span class="org-whitespace-space"> </span><span class="org-variable-name">clk2</span>=560091]
clock<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>100
<span class="org-whitespace-space">        </span><span class="org-variable-name">CLOCKS_PER_SEC</span>=1000000
<span class="org-whitespace-space">        </span>elpased(0)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">clk1</span>=560096,<span class="org-whitespace-space"> </span><span class="org-variable-name">clk2</span>=560096]
clock_gettime<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>100000000
<span class="org-whitespace-space">        </span>elpased(173184980)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">start</span>=3012.610434665<span class="org-whitespace-space"> </span><span class="org-variable-name">end</span>=3012.610434665]
clock_gettime<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1000000
<span class="org-whitespace-space">        </span>elpased(1761542)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">start</span>=3012.783671238<span class="org-whitespace-space"> </span><span class="org-variable-name">end</span>=3012.783671238]
clock_gettime<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1000
<span class="org-whitespace-space">        </span>elpased(2169)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">start</span>=3012.785437408<span class="org-whitespace-space"> </span><span class="org-variable-name">end</span>=3012.785437408]
clock_gettime<span class="org-whitespace-space"> </span>test<span class="org-whitespace-space"> </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>100
<span class="org-whitespace-space">        </span>elpased(236)<span class="org-whitespace-space"> </span>[<span class="org-variable-name">start</span>=3012.785444798<span class="org-whitespace-space"> </span><span class="org-variable-name">end</span>=3012.785444798]
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge516ef9" class="outline-2">
<h2 id="orge516ef9"><span class="section-number-2">3</span> Test Code</h2>
<div class="outline-text-2" id="text-3">
<p>
如下是benchmark-time.c代码：
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;errno.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;stdio.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;string.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;time.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;unistd.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;sys/time.h&gt;</span>

<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">val_tsc2microsec</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">val_systemcall</span>;

<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">cpu_burst</span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limits</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">i</span>;
<span class="org-whitespace-space">        </span><span class="org-keyword">volatile</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">x</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>limits)
<span class="org-whitespace-space">                </span>limits<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1000*1000*100;

<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(i<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;<span class="org-whitespace-space"> </span>i<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>limits;<span class="org-whitespace-space"> </span>++i)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>x<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>i;
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span>(<span class="org-type">void</span>)x;
}

<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">T2M</span>(<span class="org-variable-name">tsc</span>)<span class="org-whitespace-space"> </span>({<span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">timeval</span><span class="org-whitespace-space"> </span><span class="org-variable-name">tv</span>;<span class="org-whitespace-space"> </span>tsc2microsec((tsc),<span class="org-whitespace-space"> </span>&amp;tv);<span class="org-whitespace-space"> </span>tv;<span class="org-whitespace-space"> </span>})
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">tsc2microsec</span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">tsc</span>,<span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">timeval</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">tv</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">microsec</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>tsc/val_tsc2microsec;
<span class="org-whitespace-space">        </span>tv-&gt;tv_sec<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>microsec/(1000*1000);
<span class="org-whitespace-space">        </span>tv-&gt;tv_usec<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>microsec%(1000*1000);
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span>__always_inline<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-function-name">rdtsc_ordered</span>(<span class="org-type">void</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">low</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">high</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">asm</span><span class="org-whitespace-space"> </span><span class="org-keyword">volatile</span>(<span class="org-string">"mfence\n\tlfence\n\t"</span><span class="org-whitespace-space"> </span>:::<span class="org-whitespace-space"> </span><span class="org-string">"memory"</span>);
<span class="org-whitespace-space">        </span><span class="org-keyword">asm</span><span class="org-whitespace-space"> </span><span class="org-keyword">volatile</span>(<span class="org-string">"rdtsc"</span><span class="org-whitespace-space"> </span>:<span class="org-whitespace-space"> </span><span class="org-string">"=a"</span><span class="org-whitespace-space"> </span>(low),<span class="org-whitespace-space"> </span><span class="org-string">"=d"</span><span class="org-whitespace-space"> </span>(high));

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>low<span class="org-whitespace-space"> </span>|<span class="org-whitespace-space"> </span>(high<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>32);
}

<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">init_tsc_time</span>()
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">timeval</span><span class="org-whitespace-space"> </span><span class="org-variable-name">tv1</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">tv2</span>;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">start</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">end</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">val</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">microsec</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">idx</span>;

<span class="org-whitespace-space">        </span>printf(<span class="org-string">"init</span><span class="org-whitespace-space"> </span><span class="org-string">TSC</span><span class="org-whitespace-space"> </span><span class="org-string">to</span><span class="org-whitespace-space"> </span><span class="org-string">microsecond</span><span class="org-whitespace-space"> </span><span class="org-string">(about</span><span class="org-whitespace-space"> </span><span class="org-string">2</span><span class="org-whitespace-space"> </span><span class="org-string">seconds)\n"</span>);

<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(val<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0,<span class="org-whitespace-space"> </span>idx<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;<span class="org-whitespace-space"> </span>idx<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>1000;<span class="org-whitespace-space"> </span>++idx)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>start<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>rdtsc_ordered();
<span class="org-whitespace-space">                </span>gettimeofday(&amp;tv1,<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>);
<span class="org-whitespace-space">                </span>end<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>rdtsc_ordered();
<span class="org-whitespace-space">                </span>(<span class="org-type">void</span>)tv1;
<span class="org-whitespace-space">                </span>val<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>end<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>start;
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span>printf(<span class="org-string">"\t1000</span><span class="org-whitespace-space"> </span><span class="org-string">system</span><span class="org-whitespace-space"> </span><span class="org-string">call</span><span class="org-whitespace-space"> </span><span class="org-string">tsc</span><span class="org-whitespace-space"> </span><span class="org-string">=</span><span class="org-whitespace-space"> </span><span class="org-string">%lu\n"</span>,<span class="org-whitespace-space"> </span>val);
<span class="org-whitespace-space">        </span>val_systemcall<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>val/1000;

<span class="org-whitespace-space">        </span>gettimeofday(&amp;tv1,<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>);
<span class="org-whitespace-space">        </span>start<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>rdtsc_ordered();
<span class="org-whitespace-space">        </span>sleep(2);
<span class="org-whitespace-space">        </span>end<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>rdtsc_ordered();
<span class="org-whitespace-space">        </span>gettimeofday(&amp;tv2,<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>);

<span class="org-whitespace-space">        </span>microsec<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>(tv2.tv_sec<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>tv1.tv_sec)*1000*1000;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(tv2.tv_usec<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>tv1.tv_usec)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>tv2.tv_usec<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>1000*1000;
<span class="org-whitespace-space">                </span>microsec<span class="org-whitespace-space"> </span>-=<span class="org-whitespace-space"> </span>1000*1000;
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span>microsec<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>tv2.tv_usec<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>tv1.tv_usec;
<span class="org-whitespace-space">        </span>val_tsc2microsec<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>(end<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>start)/microsec;

<span class="org-whitespace-space">        </span>printf(<span class="org-string">"\ttsc2microsec=%lu</span><span class="org-whitespace-space"> </span><span class="org-string">system_call=%lu</span><span class="org-whitespace-space"> </span><span class="org-string">[tsc=%lu,</span><span class="org-whitespace-space"> </span><span class="org-string">millisecond=%lu]\n"</span><span class="org-whitespace-line">,</span>
<span class="org-whitespace-space">               </span>val_tsc2microsec,<span class="org-whitespace-space"> </span>val_systemcall,<span class="org-whitespace-space"> </span>(end<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>start),<span class="org-whitespace-space"> </span>microsec);
}

<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">rdtsc_test</span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limits</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">start</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">end</span>;
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">timeval</span><span class="org-whitespace-space"> </span><span class="org-variable-name">tv</span>;

<span class="org-whitespace-space">        </span>printf(<span class="org-string">"rdtsc</span><span class="org-whitespace-space"> </span><span class="org-string">test</span><span class="org-whitespace-space"> </span><span class="org-string">limits</span><span class="org-whitespace-space"> </span><span class="org-string">=</span><span class="org-whitespace-space"> </span><span class="org-string">%lu\n"</span>,<span class="org-whitespace-space"> </span>limits);

<span class="org-whitespace-space">        </span>start<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>rdtsc_ordered();
<span class="org-whitespace-space">        </span>cpu_burst(limits);
<span class="org-whitespace-space">        </span>end<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>rdtsc_ordered();
<span class="org-whitespace-space">        </span>tsc2microsec(end<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>start,<span class="org-whitespace-space"> </span>&amp;tv);

<span class="org-whitespace-space">        </span>printf(<span class="org-string">"\telpased(%lu)</span><span class="org-whitespace-space"> </span><span class="org-string">[start=%lu,</span><span class="org-whitespace-space"> </span><span class="org-string">end=%lu,</span><span class="org-whitespace-space"> </span><span class="org-string">time=%lu.%06lu]\n"</span>,
<span class="org-whitespace-space">               </span>end<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>start,<span class="org-whitespace-space"> </span>start,<span class="org-whitespace-space"> </span>end,
<span class="org-whitespace-space">               </span>tv.tv_sec,<span class="org-whitespace-space"> </span>tv.tv_usec);
}

<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">gettimeofday_test</span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limits</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">timeval</span><span class="org-whitespace-space"> </span><span class="org-variable-name">tv1</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">tv2</span>;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">microsec</span>;

<span class="org-whitespace-space">        </span>printf(<span class="org-string">"gettimeofday</span><span class="org-whitespace-space"> </span><span class="org-string">test</span><span class="org-whitespace-space"> </span><span class="org-string">limits</span><span class="org-whitespace-space"> </span><span class="org-string">=</span><span class="org-whitespace-space"> </span><span class="org-string">%lu\n"</span>,<span class="org-whitespace-space"> </span>limits);

<span class="org-whitespace-space">        </span>gettimeofday(&amp;tv1,<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>);
<span class="org-whitespace-space">        </span>cpu_burst(limits);
<span class="org-whitespace-space">        </span>gettimeofday(&amp;tv2,<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>);

<span class="org-whitespace-space">        </span>microsec<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>(tv2.tv_sec<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>tv1.tv_sec)*1000*1000;
<span class="org-whitespace-space">        </span>microsec<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>tv2.tv_usec;
<span class="org-whitespace-space">        </span>microsec<span class="org-whitespace-space"> </span>-=<span class="org-whitespace-space"> </span>tv1.tv_usec;
<span class="org-whitespace-space">        </span>microsec<span class="org-whitespace-space"> </span>-=<span class="org-whitespace-space"> </span>(val_systemcall*2)/val_tsc2microsec;

<span class="org-whitespace-space">        </span>printf(<span class="org-string">"\telpased(%lu)</span><span class="org-whitespace-space"> </span><span class="org-string">[time=%lu.%06lu]\n"</span>,
<span class="org-whitespace-space">               </span>microsec,<span class="org-whitespace-space"> </span>microsec/1000/1000,<span class="org-whitespace-space"> </span>microsec);
}

<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">clock_test</span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limits</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">clock_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">clk1</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">clk2</span>;

<span class="org-whitespace-space">        </span>printf(<span class="org-string">"clock</span><span class="org-whitespace-space"> </span><span class="org-string">test</span><span class="org-whitespace-space"> </span><span class="org-string">limits</span><span class="org-whitespace-space"> </span><span class="org-string">=</span><span class="org-whitespace-space"> </span><span class="org-string">%lu\n"</span>,<span class="org-whitespace-space"> </span>limits);

<span class="org-whitespace-space">        </span>clk1<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>clock();
<span class="org-whitespace-space">        </span>cpu_burst(limits);
<span class="org-whitespace-space">        </span>clk2<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>clock();

<span class="org-whitespace-space">        </span>printf(<span class="org-string">"\tCLOCKS_PER_SEC=%lu\n"</span>,<span class="org-whitespace-space"> </span>CLOCKS_PER_SEC);
<span class="org-whitespace-space">        </span>printf(<span class="org-string">"\telpased(%lu)</span><span class="org-whitespace-space"> </span><span class="org-string">[clk1=%lu,</span><span class="org-whitespace-space"> </span><span class="org-string">clk2=%lu]\n"</span>,
<span class="org-whitespace-space">               </span>clk2<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>clk1,<span class="org-whitespace-space"> </span>clk1,<span class="org-whitespace-space"> </span>clk2);
}

<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">CLOCK_GETX_EXEC_CHECK</span>(<span class="org-variable-name">func</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">arg1</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">arg2</span>)<span class="org-whitespace-tab"> </span>\
<span class="org-whitespace-space">        </span>({<span class="org-whitespace-tab">                                              </span>\
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">ret</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>func(arg1,<span class="org-whitespace-space"> </span>arg2);<span class="org-whitespace-tab">                     </span>\
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(ret)<span class="org-whitespace-tab">                                        </span>\
<span class="org-whitespace-space">                </span>fprintf(stderr,<span class="org-whitespace-space"> </span><span class="org-string">"%s</span><span class="org-whitespace-space"> </span><span class="org-string">error(%d,%s)"</span>,<span class="org-whitespace-tab">      </span>\
<span class="org-whitespace-space">                        </span>#func,<span class="org-whitespace-space"> </span>ret,<span class="org-whitespace-space"> </span>strerror(errno));<span class="org-whitespace-tab">   </span>\
<span class="org-whitespace-space">        </span>ret;<span class="org-whitespace-space"> </span>})

<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">clock_gettime_test</span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limits</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">timespec</span><span class="org-whitespace-space"> </span><span class="org-variable-name">ts1</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">ts2</span>;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">v</span>;

<span class="org-whitespace-space">        </span>printf(<span class="org-string">"clock_gettime</span><span class="org-whitespace-space"> </span><span class="org-string">test</span><span class="org-whitespace-space"> </span><span class="org-string">limits</span><span class="org-whitespace-space"> </span><span class="org-string">=</span><span class="org-whitespace-space"> </span><span class="org-string">%lu\n"</span>,<span class="org-whitespace-space"> </span>limits);

<span class="org-whitespace-space">        </span>CLOCK_GETX_EXEC_CHECK(clock_gettime,CLOCK_MONOTONIC,<span class="org-whitespace-space"> </span>&amp;ts1);
<span class="org-whitespace-space">        </span>cpu_burst(limits);
<span class="org-whitespace-space">        </span>CLOCK_GETX_EXEC_CHECK(clock_gettime,CLOCK_MONOTONIC,<span class="org-whitespace-space"> </span>&amp;ts2);

<span class="org-whitespace-space">        </span>v<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>(ts2.tv_sec<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>ts1.tv_sec)*1000*1000*1000;
<span class="org-whitespace-space">        </span>v<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>ts2.tv_nsec;
<span class="org-whitespace-space">        </span>v<span class="org-whitespace-space"> </span>-=<span class="org-whitespace-space"> </span>ts1.tv_nsec;

<span class="org-whitespace-space">        </span>printf(<span class="org-string">"\telpased(%lu)</span><span class="org-whitespace-space"> </span><span class="org-string">[start=%lu.%09lu</span><span class="org-whitespace-space"> </span><span class="org-string">end=%lu.%09lu]\n"</span>,
<span class="org-whitespace-space">               </span>v,<span class="org-whitespace-space"> </span>ts1.tv_sec,<span class="org-whitespace-space"> </span>ts1.tv_nsec,<span class="org-whitespace-space"> </span>ts1.tv_sec,<span class="org-whitespace-space"> </span>ts1.tv_nsec);
}

<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">main</span>()
{
<span class="org-whitespace-space">        </span>init_tsc_time();

<span class="org-whitespace-space">        </span>rdtsc_test(1000*1000*100);
<span class="org-whitespace-space">        </span>rdtsc_test(1000*1000);
<span class="org-whitespace-space">        </span>rdtsc_test(1000*10);
<span class="org-whitespace-space">        </span>rdtsc_test(1000);
<span class="org-whitespace-space">        </span>rdtsc_test(100);

<span class="org-whitespace-space">        </span>gettimeofday_test(1000*1000*100);
<span class="org-whitespace-space">        </span>gettimeofday_test(1000*1000);
<span class="org-whitespace-space">        </span>gettimeofday_test(1000*10);
<span class="org-whitespace-space">        </span>gettimeofday_test(1000);
<span class="org-whitespace-space">        </span>gettimeofday_test(100);

<span class="org-whitespace-space">        </span>clock_test(1000*1000*100);
<span class="org-whitespace-space">        </span>clock_test(1000*1000);
<span class="org-whitespace-space">        </span>clock_test(1000*10);
<span class="org-whitespace-space">        </span>clock_test(1000);
<span class="org-whitespace-space">        </span>clock_test(100);

<span class="org-whitespace-space">        </span>clock_gettime_test(1000*1000*100);
<span class="org-whitespace-space">        </span>clock_gettime_test(1000*1000);
<span class="org-whitespace-space">        </span>clock_gettime_test(1000<span class="org-whitespace-space"> </span>);
<span class="org-whitespace-space">        </span>clock_gettime_test(100);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org966115e" class="outline-2">
<h2 id="org966115e"><span class="section-number-2">4</span> 参考资源</h2>
<div class="outline-text-2" id="text-4">
<dl class="org-dl">
<dt>LWN - X86: Unify/Rewrite SMP TSC sync mode</dt><dd><a href="https://lwn.net/Articles/211051/">https://lwn.net/Articles/211051/</a></dd>
<dt>Time Stamp Counter</dt><dd><a href="https://en.wikipedia.org/wiki/Time_Stamp_Counter">https://en.wikipedia.org/wiki/Time_Stamp_Counter</a></dd>
<dt>LWN - A guide to inline assembly code in GCC</dt><dd><a href="https://lwn.net/Articles/686055/">https://lwn.net/Articles/686055/</a></dd>
<dt>章炎 - GCC内嵌汇编</dt><dd><a href="https://dirtysalt.github.io/html/gcc-asm.html">https://dirtysalt.github.io/html/gcc-asm.html</a></dd>
<dt>GCC OnlineDocs - Inline Assembly</dt><dd><a href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html">https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html</a></dd>
<dt>linux rdtsc code</dt><dd><a href="https://elixir.bootlin.com/linux/v4.15.7/source/arch/x86/include/asm/msr.h#L204">https://elixir.bootlin.com/linux/v4.15.7/source/arch/x86/include/asm/msr.h#L204</a></dd>
<dt>Performance measurements with RDTSC</dt><dd><a href="https://www.strchr.com/performance_measurements_with_rdtsc">https://www.strchr.com/performance_measurements_with_rdtsc</a></dd>
<dt>LWN The trouble with the TSC</dt><dd><a href="https://lwn.net/Articles/388188/">https://lwn.net/Articles/388188/</a></dd>
<dt>The Definitive Guide to Linux System Calls</dt><dd><a href="https://blog.packagecloud.io/eng/2016/04/05/the-definitive-guide-to-linux-system-calls/">https://blog.packagecloud.io/eng/2016/04/05/the-definitive-guide-to-linux-system-calls/</a></dd>
<dt>How does strace work?</dt><dd><a href="https://blog.packagecloud.io/eng/2016/02/29/how-does-strace-work/">https://blog.packagecloud.io/eng/2016/02/29/how-does-strace-work/</a></dd>
</dl>
</div>
</div>
</div>
<div id="postamble" class="status">
<div id="disqus_thread" class="disqus container"></div>
<script>
  var disqus_config = function () {
    this.page.url = 'http://ycode.org/blogs/linux-benchmark-time.html';
    this.page.identifier = 'linux-benchmark-time.html';
  };

  (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://yanyg.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<div class="copyright">
2012-2020 Copyright&copy; <i> YANYG - Powered by Emacs Orgmode</i>
</div>
</div>
</body>
</html>
