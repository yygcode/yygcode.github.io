<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
<!-- 2018-07-04 Wed 22:22 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>Shell脚本嵌入到二进制代码中</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="yanyg" />
<link rel="stylesheet" type="text/css" href="../r/org-code.css" />
<link rel="stylesheet" type="text/css" href="../r/blog-bluetopbar.css" />
<script type="text/javascript" src="../r/MathJax.js?config=TeX-AMS_HTML"> </script>
<script type="text/javascript" src="../r/bootstrap.min.js"></script>
<script type="text/javascript" src="../r/jquery.stickytableheaders.min.js"></script>
</head>
<body>
<div id="preamble" class="status">
<a href="../index.html">Yanyg - SAN Software Engineer</a>
<div class="sitelinks">
  <a href="archives.html">Archives</a> |
  <a href="theindex.html">Index</a> |
  <a href="tags.html">TAGS</a> |
  <a href="https://github.com/yygcode">Github</a> |
  <a href="../about.html">About Me</a>
</div>
</div>
<div id="content">
<h1 class="title">Shell脚本嵌入到二进制代码中</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgadec13f">1. 描述</a></li>
<li><a href="#orge098b08">2. 技术点备忘</a>
<ul>
<li><a href="#org2e87b85">2.1. openssl加解密</a></li>
<li><a href="#org90e0e8f">2.2. objcopy转换任意文件为二进制目标对象</a></li>
<li><a href="#org77cb623">2.3. strip symbol</a></li>
<li><a href="#org703a433">2.4. gpg howto</a></li>
</ul>
</li>
<li><a href="#orgf0c88b8">3. 其他设计事项</a>
<ul>
<li><a href="#org783599a">3.1. 为保证尽可能多的平台兼容性，使用静态链接</a></li>
<li><a href="#orga922a07">3.2. 关键二进制程序静态链接生成，内置到二进制发布包中</a></li>
<li><a href="#orge0849a5">3.3. 交互式输入密码策略，降低可用性，但更安全</a></li>
<li><a href="#org980e97b">3.4. 充分应用非对称加密提高可靠性</a></li>
</ul>
</li>
<li><a href="#orgb11017a">4. References</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgadec13f" class="outline-2">
<h2 id="orgadec13f"><span class="section-number-2">1</span> 描述</h2>
<div class="outline-text-2" id="text-1">
<p>
最近需要完成一个小的加密工具，有较高安全要求，并要求快速完成，但对加解密性能不敏感。为简化实现，规划使用Bash Shell封装，调用现有工具<a href="https://gnupg.org/">GPG</a>完成。使用<a href="https://github.com/Distrotech/tar">tar</a>和
<a href="http://www.bzip.org/">bzip2</a>压缩，使用<a href="https://www.openssl.org/">openssl</a>对tar包执行对称加密，使用<a href="https://github.com/bminor/binutils-gdb/blob/master/binutils/objcopy.c">objcopy</a>转为二进制对象，与C语言链接生成可执行二进制程序。C语言使用系统调用<a href="http://man7.org/linux/man-pages/man2/unshare.2.html">unshare NewNamespace</a>保护挂载，在挂载点内执行openssl解密、解压缩，并执行具体的非对称安全加密任务。为进一步保证安全，对二进制程序执行移除所有符号。
</p>
</div>
</div>

<div id="outline-container-orge098b08" class="outline-2">
<h2 id="orge098b08"><span class="section-number-2">2</span> 技术点备忘</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org2e87b85" class="outline-3">
<h3 id="org2e87b85"><span class="section-number-3">2.1</span> openssl加解密</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-sh">~$ openssl enc -pass pass:123 -e -aes-256-cbc -in test.txt -out test.txt.enc
~$ openssl enc -pass pass:123 -d -aes-256-cbc -in test.txt.enc -out test.txt.new
<span class="org-comment-delimiter">### </span><span class="org-comment">We can get more notice with wrong option. e.g.: --help, --xxx</span>
~$ openssl enc --help
unknown option <span class="org-string">'--help'</span>
options are
-in &lt;file&gt;     input file
-out &lt;file&gt;    output file
-pass &lt;arg&gt;    pass phrase source
-e             encrypt
-d             decrypt
-a/-base64     base64 encode/decode, depending on encryption flag
-k             passphrase is the next argument
-kfile         passphrase is the first line of the file argument
-md            the next argument is the md to use to create a key
                 from a passphrase.  One of md2, md5, sha or sha1
-S             salt<span class="org-keyword"> in</span> hex is the next argument
-K/-iv         key/iv<span class="org-keyword"> in</span> hex is the next argument
-[pP]          print the iv/key (<span class="org-keyword">then exit</span> if -P)
-bufsize &lt;n&gt;   buffer size
-nopad         disable standard block padding
-engine e      use engine e, possibly a hardware device.
Cipher Types
-aes-128-cbc               -aes-128-cbc-hmac-sha1     -aes-128-cfb
-aes-128-cfb1              -aes-128-cfb8              -aes-128-ctr
-aes-128-ecb               -aes-128-gcm               -aes-128-ofb
-aes-128-xts               -aes-192-cbc               -aes-192-cfb
... ...
</pre>
</div>
</div>
</div>

<div id="outline-container-org90e0e8f" class="outline-3">
<h3 id="org90e0e8f"><span class="section-number-3">2.2</span> objcopy转换任意文件为二进制目标对象</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-sh">~$ objcopy -I binary -O elf64-x86-64 -B i386 file.in file.o
~$ readelf -s test.o

Symbol table <span class="org-string">'.symtab'</span> contains 5 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND
     1: 0000000000000000     0 SECTION LOCAL  DEFAULT    1
     2: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT    1 _binary_test_in_start
     3: 0000000000000205     0 NOTYPE  GLOBAL DEFAULT    1 _binary_test_in_end
     4: 0000000000000205     0 NOTYPE  GLOBAL DEFAULT  ABS _binary_test_in_size
<span class="org-comment-delimiter">#### </span><span class="org-comment">=&gt; We need to define extern char variable with above name</span>
~$ cat eg.c
extern const char _binary_test_in_start;
extern const char _binary_test_in_end;
// <span class="org-comment-delimiter">#### </span><span class="org-comment">=&gt; The data is positioned bewteen above symbol</span>
... ...
<span class="org-function-name">copy_region_to_data</span>(&amp;_binary_test_in_start, &amp;_binary_test_in_end, <span class="org-string">"test.data"</span>);
// <span class="org-comment-delimiter">#### </span><span class="org-comment">=&gt; DATA RANGE: [&amp;_binary_test_in_start, &amp;_binary_test_in_end)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org77cb623" class="outline-3">
<h3 id="org77cb623"><span class="section-number-3">2.3</span> strip symbol</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">
<pre class="src src-sh">~$ strip --strip-all test
</pre>
</div>
</div>
</div>

<div id="outline-container-org703a433" class="outline-3">
<h3 id="org703a433"><span class="section-number-3">2.4</span> gpg howto</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>See <a href="tools-encrypt-gpg.html">tools-encrypt-gpg.html</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgf0c88b8" class="outline-2">
<h2 id="orgf0c88b8"><span class="section-number-2">3</span> 其他设计事项</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org783599a" class="outline-3">
<h3 id="org783599a"><span class="section-number-3">3.1</span> 为保证尽可能多的平台兼容性，使用静态链接</h3>
</div>
<div id="outline-container-orga922a07" class="outline-3">
<h3 id="orga922a07"><span class="section-number-3">3.2</span> 关键二进制程序静态链接生成，内置到二进制发布包中</h3>
</div>
<div id="outline-container-orge0849a5" class="outline-3">
<h3 id="orge0849a5"><span class="section-number-3">3.3</span> 交互式输入密码策略，降低可用性，但更安全</h3>
</div>
<div id="outline-container-org980e97b" class="outline-3">
<h3 id="org980e97b"><span class="section-number-3">3.4</span> 充分应用非对称加密提高可靠性</h3>
</div>
</div>

<div id="outline-container-orgb11017a" class="outline-2">
<h2 id="orgb11017a"><span class="section-number-2">4</span> References</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>GPG入门：<a href="tools-encrypt-gpg.html">GPG - encrypt tools in this site</a></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<div id="disqus_thread" class="disqus container"></div>
<script>
  var disqus_config = function () {
    this.page.url = 'http://ycode.org/blogs/sh-imbed-to-binary-exec.html';
    this.page.identifier = 'sh-imbed-to-binary-exec.html';
  };

  (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://yanyg.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<div class="copyright">
2012-2020 Copyright&copy; <i> YANYG - Powered by Emacs Orgmode</i>
</div>
</div>
</body>
</html>
