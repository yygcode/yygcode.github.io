<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>GDB Tips</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="yanyg &lt;yygcode@gmail.com&gt;" />
<link rel="stylesheet" type="text/css" href="/themes/readtheorg/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="/themes/readtheorg/styles/readtheorg/css/readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="/themes/readtheorg/styles/readtheorg/css/rtd-full.css"/>
<script src="/themes/jquery/2.1.3/jquery.min.js"></script>
<script src="/themes/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/themes/readtheorg/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="/themes/readtheorg/styles/readtheorg/js/readtheorg.js"></script>
</head>
<body>
<div id="content">
<h1 class="title">GDB Tips</h1>
<div id="table-of-contents">
<h2>&#30446;&#24405;</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org39ffd63">1. 给进程pid生成一个core</a></li>
<li><a href="#org02070c6">2. info symbol</a></li>
<li><a href="#orgd798efc">3. C++相关</a>
<ul>
<li><a href="#orgff18e9e">3.1. 显示VTBL</a></li>
</ul>
</li>
<li><a href="#orgec38260">4. Python扩展</a>
<ul>
<li><a href="#orgd08cd9f">4.1. &#x2013;with-python编译gdb</a></li>
<li><a href="#org465baa7">4.2. hellogdb.py</a></li>
<li><a href="#orgf167cb8">4.3. pl_showsymbol - 展示多个symbol</a></li>
<li><a href="#orgff81315">4.4. gdb API</a></li>
</ul>
</li>
<li><a href="#org47f3fe1">5. 示例代码</a>
<ul>
<li><a href="#orgda0a5f4">5.1. example1</a></li>
<li><a href="#org44f7598">5.2. example2</a></li>
</ul>
</li>
<li><a href="#orgafa0ec9">6. References</a></li>
</ul>
</div>
</div>

<div id="outline-container-org39ffd63" class="outline-2">
<h2 id="org39ffd63"><span class="section-number-2">1</span> 给进程pid生成一个core</h2>
<div class="outline-text-2" id="text-1">
<p>
脚本 gcore.sh, 调用 ./gcore.sh 1234 1277 给进程1234和1277分别打一个core.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span class="org-comment-delimiter">#</span><span class="org-comment">!</span><span class="org-whitespace-space"> </span><span class="org-comment">/bin/</span><span class="org-keyword">bash</span>

<span class="org-function-name">echo_exit</span>()
{
<span class="org-whitespace-space">    </span><span class="org-builtin">echo</span><span class="org-whitespace-space"> </span><span class="org-string">"ERROR</span><span class="org-whitespace-space"> </span><span class="org-string">[LINE</span><span class="org-whitespace-space"> </span><span class="org-string">$(</span><span class="org-sh-quoted-exec">caller</span><span class="org-whitespace-space"> </span><span class="org-string">0)]</span><span class="org-whitespace-space"> </span><span class="org-string">:</span><span class="org-whitespace-space"> </span><span class="org-string">$@"</span><span class="org-whitespace-space"> </span>&gt;&amp;2
<span class="org-whitespace-space">    </span><span class="org-keyword">exit</span><span class="org-whitespace-space"> </span>1
}

<span class="org-function-name">echo_warn</span>()
{
<span class="org-whitespace-space">    </span><span class="org-builtin">echo</span><span class="org-whitespace-space"> </span><span class="org-string">"WARN</span><span class="org-whitespace-space"> </span><span class="org-string">[LINE</span><span class="org-whitespace-space"> </span><span class="org-string">$(</span><span class="org-sh-quoted-exec">caller</span><span class="org-whitespace-space"> </span><span class="org-string">0)]</span><span class="org-whitespace-space"> </span><span class="org-string">:</span><span class="org-whitespace-space"> </span><span class="org-string">$@"</span><span class="org-whitespace-space"> </span>&gt;&amp;2
}

<span class="org-function-name">echo_info</span>()
{
<span class="org-whitespace-space">    </span><span class="org-builtin">echo</span><span class="org-whitespace-space"> </span><span class="org-string">"INFO</span><span class="org-whitespace-space"> </span><span class="org-string">[LINE</span><span class="org-whitespace-space"> </span><span class="org-string">$(</span><span class="org-sh-quoted-exec">caller</span><span class="org-whitespace-space"> </span><span class="org-string">0)]</span><span class="org-whitespace-space"> </span><span class="org-string">:</span><span class="org-whitespace-space"> </span><span class="org-string">$@"</span>
}

<span class="org-keyword">for</span><span class="org-whitespace-space"> </span>pid<span class="org-whitespace-space"> </span><span class="org-keyword">in</span><span class="org-whitespace-space"> </span><span class="org-string">"$@"</span>;<span class="org-whitespace-space"> </span><span class="org-keyword">do</span>
<span class="org-whitespace-space">    </span><span class="org-variable-name">pdir</span>=<span class="org-string">"/proc/$pid"</span>
<span class="org-whitespace-space">    </span>[<span class="org-whitespace-space"> </span>-d<span class="org-whitespace-space"> </span><span class="org-string">"$pdir"</span><span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>||<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">        </span>echo_warn<span class="org-whitespace-space"> </span><span class="org-string">"process</span><span class="org-whitespace-space"> </span><span class="org-string">$pid</span><span class="org-whitespace-space"> </span><span class="org-string">not</span><span class="org-whitespace-space"> </span><span class="org-string">exist."</span>
<span class="org-whitespace-space">        </span><span class="org-keyword">continue</span>
<span class="org-whitespace-space">    </span>}
<span class="org-whitespace-space">    </span><span class="org-variable-name">pexe</span>=<span class="org-string">"$pdir/exe"</span>
<span class="org-whitespace-space">    </span>[<span class="org-whitespace-space"> </span>-r<span class="org-whitespace-space"> </span><span class="org-string">"$pexe"</span><span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>||<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">        </span>echo_warn<span class="org-whitespace-space"> </span><span class="org-string">"process</span><span class="org-whitespace-space"> </span><span class="org-string">$pid</span><span class="org-whitespace-space"> </span><span class="org-string">no</span><span class="org-whitespace-space"> </span><span class="org-string">permission"</span>
<span class="org-whitespace-space">        </span><span class="org-keyword">continue</span>
<span class="org-whitespace-space">    </span>}

<span class="org-whitespace-space">    </span><span class="org-variable-name">pathname</span>=$(<span class="org-sh-quoted-exec">readlink</span><span class="org-whitespace-space"> </span>-f<span class="org-whitespace-space"> </span><span class="org-string">"$pexe"</span>)
<span class="org-whitespace-space">    </span><span class="org-variable-name">pname</span>=<span class="org-string">"${pathname##*/}"</span>
<span class="org-whitespace-space">    </span>gdb<span class="org-whitespace-space"> </span>--quiet<span class="org-whitespace-space"> </span>-batch<span class="org-whitespace-space"> </span>-nx<span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">"attach</span><span class="org-whitespace-space"> </span><span class="org-string">$pid"</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">"gcore</span><span class="org-whitespace-space"> </span><span class="org-string">$pname.$pid"</span><span class="org-whitespace-space"> </span><span class="org-sh-escaped-newline">\</span>
<span class="org-whitespace-space">        </span>-ex<span class="org-whitespace-space"> </span>detach<span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span>quit<span class="org-whitespace-space"> </span>&gt;/dev/null<span class="org-whitespace-space"> </span>2&gt;&amp;1
<span class="org-whitespace-space">    </span><span class="org-variable-name">ret</span>=$<span class="org-variable-name">?</span>
<span class="org-whitespace-space">    </span>[<span class="org-whitespace-space"> </span><span class="org-string">"$ret"</span><span class="org-whitespace-space"> </span>-eq<span class="org-whitespace-space"> </span>0<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>||<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">        </span>echo_warn<span class="org-whitespace-space"> </span><span class="org-string">"gcore</span><span class="org-whitespace-space"> </span><span class="org-string">$pid$(</span><span class="org-sh-quoted-exec">binary</span><span class="org-whitespace-space"> </span><span class="org-string">$pathname)</span><span class="org-whitespace-space"> </span><span class="org-string">failed"</span>
<span class="org-whitespace-space">        </span><span class="org-keyword">continue</span>
<span class="org-whitespace-space">    </span>}
<span class="org-whitespace-space">    </span>echo_info<span class="org-whitespace-space"> </span><span class="org-string">"Generate</span><span class="org-whitespace-space"> </span><span class="org-string">core</span><span class="org-whitespace-space"> </span><span class="org-string">$pname.$pid</span><span class="org-whitespace-space"> </span><span class="org-string">for</span><span class="org-whitespace-space"> </span><span class="org-string">$pid($pathname)"</span>
<span class="org-keyword">done</span>
</pre>
</div>

<p>
示例:
</p>
<div class="org-src-container">
<pre class="src src-bash">[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-19<span class="org-whitespace-space"> </span>21:27:56&gt;
$<span class="org-whitespace-space"> </span>sleep<span class="org-whitespace-space"> </span>100<span class="org-whitespace-space"> </span>&amp;
[1]<span class="org-whitespace-space"> </span>6991
[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-19<span class="org-whitespace-space"> </span>21:28:00&gt;
$<span class="org-whitespace-space"> </span>sleep<span class="org-whitespace-space"> </span>200<span class="org-whitespace-space"> </span>&amp;
[2]<span class="org-whitespace-space"> </span>7132
[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-19<span class="org-whitespace-space"> </span>21:28:04&gt;
$<span class="org-whitespace-space"> </span>./gcore.sh<span class="org-whitespace-space"> </span>6991<span class="org-whitespace-space"> </span>7132
INFO<span class="org-whitespace-space"> </span>[LINE<span class="org-whitespace-space"> </span>40<span class="org-whitespace-space"> </span>main<span class="org-whitespace-space"> </span>./gcore.sh]<span class="org-whitespace-space"> </span>:<span class="org-whitespace-space"> </span>Generate<span class="org-whitespace-space"> </span>core<span class="org-whitespace-space"> </span>sleep.6991<span class="org-whitespace-space"> </span>for<span class="org-whitespace-space"> </span>6991(/usr/bin/slee<span class="org-whitespace-line">p)</span>
INFO<span class="org-whitespace-space"> </span>[LINE<span class="org-whitespace-space"> </span>40<span class="org-whitespace-space"> </span>main<span class="org-whitespace-space"> </span>./gcore.sh]<span class="org-whitespace-space"> </span>:<span class="org-whitespace-space"> </span>Generate<span class="org-whitespace-space"> </span>core<span class="org-whitespace-space"> </span>sleep.7132<span class="org-whitespace-space"> </span>for<span class="org-whitespace-space"> </span>7132(/usr/bin/slee<span class="org-whitespace-line">p)</span>
</pre>
</div>

<p>
也命令行直接调用gdb生成core:
</p>
<div class="org-src-container">
<pre class="src src-bash">[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>21:38:32&gt;
$<span class="org-whitespace-space"> </span>sleep<span class="org-whitespace-space"> </span>100<span class="org-whitespace-space"> </span>&amp;
[1]<span class="org-whitespace-space"> </span>14429
[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>21:38:39&gt;
$<span class="org-whitespace-space"> </span>gdb<span class="org-whitespace-space"> </span>--quiet<span class="org-whitespace-space"> </span>-batch<span class="org-whitespace-space"> </span>-nx<span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'attach</span><span class="org-whitespace-space"> </span><span class="org-string">14429'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'gcore</span><span class="org-whitespace-space"> </span><span class="org-string">sleep.14429'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span>bt<span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span>d<span class="org-whitespace-line">etach</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">-ex</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">quit</span>
0x00007f95d73e86f4<span class="org-whitespace-space"> </span><span class="org-keyword">in</span><span class="org-whitespace-space"> </span>__GI___nanosleep<span class="org-whitespace-space"> </span>(<span class="org-variable-name">requested_time</span>=0x7ffc751ab0a0,<span class="org-whitespace-space"> </span><span class="org-variable-name">remaining</span><span class="org-whitespace-line">=0x0)</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">at</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">../sysdeps/unix/sysv/linux/nanosleep.c:28</span>
28<span class="org-whitespace-space">      </span>../sysdeps/unix/sysv/linux/nanosleep.c:<span class="org-whitespace-space"> </span>No<span class="org-whitespace-space"> </span>such<span class="org-whitespace-space"> </span>file<span class="org-whitespace-space"> </span>or<span class="org-whitespace-space"> </span>directory.
warning:<span class="org-whitespace-space"> </span>target<span class="org-whitespace-space"> </span>file<span class="org-whitespace-space"> </span>/proc/14429/cmdline<span class="org-whitespace-space"> </span>contained<span class="org-whitespace-space"> </span>unexpected<span class="org-whitespace-space"> </span>null<span class="org-whitespace-space"> </span>characters
Saved<span class="org-whitespace-space"> </span>corefile<span class="org-whitespace-space"> </span>sleep.14429
<span class="org-comment-delimiter">#</span><span class="org-comment">0</span><span class="org-whitespace-space">  </span><span class="org-comment">0x00007f95d73e86f4</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">__GI___nanosleep</span><span class="org-whitespace-space"> </span><span class="org-comment">(requested_time=0x7ffc751ab0a0,</span><span class="org-whitespace-space"> </span><span class="org-comment">remai</span><span class="org-comment"><span class="org-whitespace-line">ning=0x0)</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">at</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">../sysdeps/unix/sysv/linux/nanosleep.c:28</span></span>
<span class="org-comment-delimiter">#</span><span class="org-comment">1</span><span class="org-whitespace-space">  </span><span class="org-comment">0x000055f9f651b5a7</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">??</span><span class="org-whitespace-space"> </span><span class="org-comment">()</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">2</span><span class="org-whitespace-space">  </span><span class="org-comment">0x000055f9f651b380</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">??</span><span class="org-whitespace-space"> </span><span class="org-comment">()</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">3</span><span class="org-whitespace-space">  </span><span class="org-comment">0x000055f9f6518500</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">??</span><span class="org-whitespace-space"> </span><span class="org-comment">()</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">4</span><span class="org-whitespace-space">  </span><span class="org-comment">0x00007f95d734609b</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">__libc_start_main</span><span class="org-whitespace-space"> </span><span class="org-comment">(main=0x55f9f6518300,</span><span class="org-whitespace-space"> </span><span class="org-comment">argc=2,</span><span class="org-whitespace-space"> </span><span class="org-comment">argv=0</span><span class="org-comment"><span class="org-whitespace-line">x7ffc751ab268,</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">init=&lt;optimized</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">out&gt;,</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">fini=&lt;optimized</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">out&gt;,</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">rtld_fini=&lt;optimized</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">out&gt;,</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">stack_end=0x7ffc751ab258)</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">at</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-comment"><span class="org-whitespace-line">../csu/libc-start.c:308</span></span>
<span class="org-comment-delimiter">#</span><span class="org-comment">5</span><span class="org-whitespace-space">  </span><span class="org-comment">0x000055f9f65185ca</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">??</span><span class="org-whitespace-space"> </span><span class="org-comment">()</span>
[Inferior<span class="org-whitespace-space"> </span>1<span class="org-whitespace-space"> </span>(process<span class="org-whitespace-space"> </span>14429)<span class="org-whitespace-space"> </span>detached]
[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>21:39:02&gt;
$<span class="org-whitespace-space"> </span>ls<span class="org-whitespace-space"> </span>-lh<span class="org-whitespace-space"> </span>sleep.14429
-rw-r--r--<span class="org-whitespace-space"> </span>1<span class="org-whitespace-space"> </span>yanyg<span class="org-whitespace-space"> </span>yanyg<span class="org-whitespace-space"> </span>345K<span class="org-whitespace-space"> </span>Aug<span class="org-whitespace-space"> </span>23<span class="org-whitespace-space"> </span>21:39<span class="org-whitespace-space"> </span>sleep.14429
</pre>
</div>
</div>
</div>

<div id="outline-container-org02070c6" class="outline-2">
<h2 id="org02070c6"><span class="section-number-2">2</span> info symbol</h2>
<div class="outline-text-2" id="text-2">
<p>
通过变量拿到一个裸地址, 可以通过 <code>info symbol ADDR</code> 获取该地址的符号.
</p>
<div class="org-src-container">
<pre class="src src-bash">(gdb)<span class="org-whitespace-space"> </span><span class="org-builtin">help</span><span class="org-whitespace-space"> </span>info<span class="org-whitespace-space"> </span>symbol
Describe<span class="org-whitespace-space"> </span>what<span class="org-whitespace-space"> </span>symbol<span class="org-whitespace-space"> </span>is<span class="org-whitespace-space"> </span>at<span class="org-whitespace-space"> </span>location<span class="org-whitespace-space"> </span>ADDR.
Only<span class="org-whitespace-space"> </span>for<span class="org-whitespace-space"> </span>symbols<span class="org-whitespace-space"> </span>with<span class="org-whitespace-space"> </span>fixed<span class="org-whitespace-space"> </span>locations<span class="org-whitespace-space"> </span>(global<span class="org-whitespace-space"> </span>or<span class="org-whitespace-space"> </span>static<span class="org-whitespace-space"> </span>scope)<span class="org-builtin">.</span>
(gdb)<span class="org-whitespace-space"> </span>p<span class="org-whitespace-space"> </span>func
$<span class="org-variable-name">1</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>{void<span class="org-whitespace-space"> </span>(int<span class="org-whitespace-space"> </span>*)}<span class="org-whitespace-space"> </span>0x5578e4943125<span class="org-whitespace-space"> </span>&lt;func&gt;
(gdb)<span class="org-whitespace-space"> </span>info<span class="org-whitespace-space"> </span>symbol<span class="org-whitespace-space"> </span>0x5578e4943125
func<span class="org-whitespace-space"> </span><span class="org-keyword">in</span><span class="org-whitespace-space"> </span>section<span class="org-whitespace-space"> </span>.text<span class="org-whitespace-space"> </span>of<span class="org-whitespace-space"> </span>/home/yanyg/test/a.out
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd798efc" class="outline-2">
<h2 id="orgd798efc"><span class="section-number-2">3</span> C++相关</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgff18e9e" class="outline-3">
<h3 id="orgff18e9e"><span class="section-number-3">3.1</span> 显示VTBL</h3>
<div class="outline-text-3" id="text-3-1">
<p>
info vtbl &lt;variable&gt;
</p>
</div>
</div>
</div>

<div id="outline-container-orgec38260" class="outline-2">
<h2 id="orgec38260"><span class="section-number-2">4</span> Python扩展</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgd08cd9f" class="outline-3">
<h3 id="orgd08cd9f"><span class="section-number-3">4.1</span> &#x2013;with-python编译gdb</h3>
<div class="outline-text-3" id="text-4-1">
<p>
gdb show configuration查看
</p>
<div class="org-src-container">
<pre class="src src-bash">[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>20:49:59&gt;
$<span class="org-whitespace-space"> </span>gdb<span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'show</span><span class="org-whitespace-space"> </span><span class="org-string">configuration'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'quit'</span><span class="org-whitespace-space"> </span>|<span class="org-whitespace-space"> </span>grep<span class="org-whitespace-space"> </span>--<span class="org-whitespace-space"> </span>--with-python
<span class="org-whitespace-space">             </span>--with-python=/usr<span class="org-whitespace-space"> </span>(relocatable)
</pre>
</div>
</div>
</div>

<div id="outline-container-org465baa7" class="outline-3">
<h3 id="org465baa7"><span class="section-number-3">4.2</span> hellogdb.py</h3>
<div class="outline-text-3" id="text-4-2">
<p>
写一个hellogdb.py, 让gdb调用下:
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span><span class="org-whitespace-space"> </span>gdb
<span class="org-keyword">import</span><span class="org-whitespace-space"> </span>gdb.types

<span class="org-keyword">class</span><span class="org-whitespace-space"> </span><span class="org-type">HelloGdb</span>(gdb.Command):
<span class="org-whitespace-space">    </span><span class="org-keyword">def</span><span class="org-whitespace-space"> </span><span class="org-function-name">__init__</span>(<span class="org-keyword">self</span>):
<span class="org-whitespace-space">        </span><span class="org-builtin">super</span>(<span class="org-keyword">self</span>.__class__,<span class="org-whitespace-space"> </span><span class="org-keyword">self</span>).__init__(<span class="org-string">"hellogdb"</span>,<span class="org-whitespace-space"> </span>gdb.COMMAND_USER)

<span class="org-whitespace-space">    </span><span class="org-keyword">def</span><span class="org-whitespace-space"> </span><span class="org-function-name">invoke</span>(<span class="org-keyword">self</span>,<span class="org-whitespace-space"> </span>args,<span class="org-whitespace-space"> </span>from_tty):
<span class="org-whitespace-space">        </span><span class="org-doc">'''</span>
<span class="org-whitespace-space">        </span><span class="org-doc">argv[0]</span><span class="org-whitespace-space"> </span><span class="org-doc">must</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer.</span>
<span class="org-whitespace-space">        </span><span class="org-doc">'''</span>
<span class="org-whitespace-space">        </span><span class="org-keyword">print</span>(<span class="org-string">"Hello,</span><span class="org-whitespace-space"> </span><span class="org-string">GdbPython"</span>)

HelloGdb()
</pre>
</div>

<p>
运行下:
</p>
<div class="org-src-container">
<pre class="src src-bash">[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>21:36:35&gt;
$<span class="org-whitespace-space"> </span>gdb<span class="org-whitespace-space"> </span>--quiet<span class="org-whitespace-space"> </span>-batch<span class="org-whitespace-space"> </span>-nx<span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'source</span><span class="org-whitespace-space"> </span><span class="org-string">hellogdb.py'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span>hellogdb
Hello,<span class="org-whitespace-space"> </span>GdbPython
[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>21:36:43&gt;
$<span class="org-whitespace-space"> </span>echo<span class="org-whitespace-space"> </span>$<span class="org-variable-name">?</span>
0
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf167cb8" class="outline-3">
<h3 id="orgf167cb8"><span class="section-number-3">4.3</span> pl_showsymbol - 展示多个symbol</h3>
<div class="outline-text-3" id="text-4-3">
<p>
用于快速的检测地址范围有哪些符号.
</p>

<p>
写一个Python扩展脚本pl_showsymbols.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">import</span><span class="org-whitespace-space"> </span>gdb
<span class="org-keyword">import</span><span class="org-whitespace-space"> </span>gdb.types

<span class="org-keyword">class</span><span class="org-whitespace-space"> </span><span class="org-type">ShowSymbols</span>(gdb.Command):
<span class="org-whitespace-space">    </span><span class="org-keyword">def</span><span class="org-whitespace-space"> </span><span class="org-function-name">__init__</span>(<span class="org-keyword">self</span>):
<span class="org-whitespace-space">        </span><span class="org-builtin">super</span>(<span class="org-keyword">self</span>.__class__,<span class="org-whitespace-space"> </span><span class="org-keyword">self</span>).__init__(<span class="org-string">"pl_showsymbols"</span>,<span class="org-whitespace-space"> </span>gdb.COMMAND_USER)

<span class="org-whitespace-space">    </span><span class="org-keyword">def</span><span class="org-whitespace-space"> </span><span class="org-function-name">invoke</span>(<span class="org-keyword">self</span>,<span class="org-whitespace-space"> </span>parasString,<span class="org-whitespace-space"> </span>from_tty):
<span class="org-whitespace-space">        </span><span class="org-variable-name">paras</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>gdb.string_to_argv(parasString)
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-builtin">len</span>(paras)<span class="org-whitespace-space"> </span>!=<span class="org-whitespace-space"> </span>2):
<span class="org-whitespace-space">            </span><span class="org-keyword">print</span>(<span class="org-string">"ERROR:</span><span class="org-whitespace-space"> </span><span class="org-string">pl_showsymbols</span><span class="org-whitespace-space"> </span><span class="org-string">needs</span><span class="org-whitespace-space"> </span><span class="org-string">two</span><span class="org-whitespace-space"> </span><span class="org-string">arguments"</span>)
<span class="org-whitespace-space">            </span><span class="org-keyword">return</span>

<span class="org-whitespace-space">        </span><span class="org-variable-name">addr</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>paras[0]
<span class="org-whitespace-space">        </span><span class="org-variable-name">nbytes</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-builtin">int</span>(<span class="org-builtin">int</span>(paras[1])<span class="org-whitespace-space"> </span>/<span class="org-whitespace-space"> </span>8)
<span class="org-whitespace-space">        </span><span class="org-variable-name">out</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>gdb.execute(<span class="org-string">'x/{}xg</span><span class="org-whitespace-space"> </span><span class="org-string">{}'</span>.<span class="org-builtin">format</span>(nbytes,<span class="org-whitespace-space"> </span>addr),<span class="org-whitespace-space"> </span>to_string=<span class="org-constant">True</span>)

<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>line<span class="org-whitespace-space"> </span><span class="org-keyword">in</span><span class="org-whitespace-space"> </span>out.split(<span class="org-string">'\n'</span>):
<span class="org-whitespace-space">            </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span><span class="org-keyword">not</span><span class="org-whitespace-space"> </span>line:
<span class="org-whitespace-space">                </span><span class="org-keyword">continue</span>

<span class="org-whitespace-space">            </span><span class="org-variable-name">line_cols</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>line.split(<span class="org-string">'\t'</span>)
<span class="org-whitespace-space">            </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>col<span class="org-whitespace-space"> </span><span class="org-keyword">in</span><span class="org-whitespace-space"> </span>line_cols[1:]:
<span class="org-whitespace-space">                </span><span class="org-variable-name">sym_info</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>gdb.execute(<span class="org-string">'info</span><span class="org-whitespace-space"> </span><span class="org-string">symbol</span><span class="org-whitespace-space"> </span><span class="org-string">'</span><span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>col,
<span class="org-whitespace-space">                                       </span>to_string=<span class="org-constant">True</span>).rstrip(<span class="org-string">'\n'</span>)
<span class="org-whitespace-space">                </span><span class="org-keyword">print</span>(col,<span class="org-whitespace-space"> </span><span class="org-string">'\t'</span>,<span class="org-whitespace-space"> </span>sym_info)

ShowSymbols()
</pre>
</div>

<p>
保存为pl_showsymbols.py. 调试从<a href="#org6346116">5.2</a>生成的binary.
</p>
<div class="org-src-container">
<pre class="src src-bash">[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>22:24:13&gt;
$<span class="org-whitespace-space"> </span>g++<span class="org-whitespace-space"> </span>-g<span class="org-whitespace-space"> </span>-O0<span class="org-whitespace-space"> </span>-Wall<span class="org-whitespace-space"> </span>baseder.cc
[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>22:24:16&gt;
$<span class="org-whitespace-space"> </span>gdb<span class="org-whitespace-space"> </span>--quiet<span class="org-whitespace-space"> </span>a.out<span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'b</span><span class="org-whitespace-space"> </span><span class="org-string">main'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'run'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'n'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'n'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'n'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'n'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'</span><span class="org-string"><span class="org-whitespace-line">n'</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">-ex</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-string"><span class="org-whitespace-line">'n'</span></span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">-ex</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-string"><span class="org-whitespace-line">'n'</span></span>
Reading<span class="org-whitespace-space"> </span>symbols<span class="org-whitespace-space"> </span>from<span class="org-whitespace-space"> </span>a.out...done.
Breakpoint<span class="org-whitespace-space"> </span>1<span class="org-whitespace-space"> </span>at<span class="org-whitespace-space"> </span>0x11a5:<span class="org-whitespace-space"> </span>file<span class="org-whitespace-space"> </span>baseder.cc,<span class="org-whitespace-space"> </span>line<span class="org-whitespace-space"> </span>48.
Starting<span class="org-whitespace-space"> </span>program:<span class="org-whitespace-space"> </span>/home/yanyg/test/a.out

Breakpoint<span class="org-whitespace-space"> </span>1,<span class="org-whitespace-space"> </span>main<span class="org-whitespace-space"> </span>(<span class="org-variable-name">argc</span>=1,<span class="org-whitespace-space"> </span><span class="org-variable-name">argv</span>=0x7fffffffe5b8)<span class="org-whitespace-space"> </span>at<span class="org-whitespace-space"> </span>baseder.cc:48
48<span class="org-whitespace-space">          </span>Base<span class="org-whitespace-space"> </span>b;
49<span class="org-whitespace-space">          </span>b.func();
virtual<span class="org-whitespace-space"> </span>void<span class="org-whitespace-space"> </span>Base::func()<span class="org-whitespace-space"> </span>const
50<span class="org-whitespace-space">          </span>Derived<span class="org-whitespace-space"> </span>d;
51<span class="org-whitespace-space">          </span>d.func();
virtual<span class="org-whitespace-space"> </span>void<span class="org-whitespace-space"> </span>Derived::func()<span class="org-whitespace-space"> </span>const
52<span class="org-whitespace-space">          </span>Base<span class="org-whitespace-space"> </span>*b2<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>new<span class="org-whitespace-space"> </span>Derived;
53<span class="org-whitespace-space">          </span>b2-&gt;func();
virtual<span class="org-whitespace-space"> </span>void<span class="org-whitespace-space"> </span>Derived::func()<span class="org-whitespace-space"> </span>const
54<span class="org-whitespace-space">          </span>Base<span class="org-whitespace-space"> </span>*b3<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>new<span class="org-whitespace-space"> </span>DerivedSecond;
55<span class="org-whitespace-space">          </span>b3-&gt;func();
(gdb)<span class="org-whitespace-space"> </span><span class="org-builtin">source</span><span class="org-whitespace-space"> </span>pl_showsymbols.py
(gdb)<span class="org-whitespace-space"> </span>p<span class="org-whitespace-space"> </span>b2
$<span class="org-variable-name">1</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>(Base<span class="org-whitespace-space"> </span>*)<span class="org-whitespace-space"> </span>0x55555556b290
(gdb)<span class="org-whitespace-space"> </span>p<span class="org-whitespace-space"> </span>*b2
$<span class="org-variable-name">2</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>{_vptr.Base<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0x555555557cd0<span class="org-whitespace-space"> </span>&lt;vtable<span class="org-whitespace-space"> </span>for<span class="org-whitespace-space"> </span>Derived+80&gt;,<span class="org-whitespace-space"> </span>mVal<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>100}
(gdb)<span class="org-whitespace-space"> </span>pl_showsymbols<span class="org-whitespace-space"> </span>0x555555557cd0<span class="org-whitespace-space"> </span>32
0x000055555555541b<span class="org-whitespace-space">       </span>virtual<span class="org-whitespace-space"> </span>thunk<span class="org-whitespace-space"> </span>to<span class="org-whitespace-space"> </span>Derived::~Derived()<span class="org-whitespace-space"> </span><span class="org-keyword">in</span><span class="org-whitespace-space"> </span>section<span class="org-whitespace-space"> </span>.text<span class="org-whitespace-space"> </span>o<span class="org-whitespace-line">f</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">/home/yanyg/test/a.out</span>
0x000055555555544f<span class="org-whitespace-space">       </span>virtual<span class="org-whitespace-space"> </span>thunk<span class="org-whitespace-space"> </span>to<span class="org-whitespace-space"> </span>Derived::~Derived()<span class="org-whitespace-space"> </span><span class="org-keyword">in</span><span class="org-whitespace-space"> </span>section<span class="org-whitespace-space"> </span>.text<span class="org-whitespace-space"> </span>o<span class="org-whitespace-line">f</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">/home/yanyg/test/a.out</span>
0x000055555555548f<span class="org-whitespace-space">       </span>virtual<span class="org-whitespace-space"> </span>thunk<span class="org-whitespace-space"> </span>to<span class="org-whitespace-space"> </span>Derived::func()<span class="org-whitespace-space"> </span>const<span class="org-whitespace-space"> </span><span class="org-keyword">in</span><span class="org-whitespace-space"> </span>section<span class="org-whitespace-space"> </span>.text<span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">of</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">/home/yanyg/test/a.out</span>
0x0000555555557c98<span class="org-whitespace-space">       </span>vtable<span class="org-whitespace-space"> </span>for<span class="org-whitespace-space"> </span>Derived<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>24<span class="org-whitespace-space"> </span><span class="org-keyword">in</span><span class="org-whitespace-space"> </span>section<span class="org-whitespace-space"> </span>.data.rel.ro<span class="org-whitespace-space"> </span>of<span class="org-whitespace-space"> </span>/hom<span class="org-whitespace-line">e/yanyg/test/a.out</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgff81315" class="outline-3">
<h3 id="orgff81315"><span class="section-number-3">4.4</span> gdb API</h3>
<div class="outline-text-3" id="text-4-4">
<p>
<a href="https://sourceware.org/gdb/onlinedocs/gdb/Python-API.html">https://sourceware.org/gdb/onlinedocs/gdb/Python-API.html</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org47f3fe1" class="outline-2">
<h2 id="org47f3fe1"><span class="section-number-2">5</span> 示例代码</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orgda0a5f4" class="outline-3">
<h3 id="orgda0a5f4"><span class="section-number-3">5.1</span> example1</h3>
<div class="outline-text-3" id="text-5-1">
<p>
<a id="org51108cf"></a>
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;stddef.h&gt;</span>

<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">main</span>(<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">argc</span>,<span class="org-whitespace-space"> </span><span class="org-type">char</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">argv</span>[])
{
<span class="org-whitespace-space">    </span><span class="org-type">int</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">p</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">    </span>*p<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1234;
<span class="org-whitespace-space">    </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>0;
}
</pre>
</div>

<p>
编译运行:
</p>
<div class="org-src-container">
<pre class="src src-bash">[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>20:42:34&gt;
$<span class="org-whitespace-space"> </span>ulimit<span class="org-whitespace-space"> </span>-c<span class="org-whitespace-space"> </span>unlimited
[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>20:42:39&gt;
$<span class="org-whitespace-space"> </span>./a.out
Segmentation<span class="org-whitespace-space"> </span>fault<span class="org-whitespace-space"> </span>(core<span class="org-whitespace-space"> </span>dumped)
[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>20:50:37&gt;
$<span class="org-whitespace-space"> </span>gdb<span class="org-whitespace-space"> </span>a.out<span class="org-whitespace-space"> </span>core<span class="org-whitespace-space"> </span>--quiet<span class="org-whitespace-space">  </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">"bt"</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">"quit"</span>
Reading<span class="org-whitespace-space"> </span>symbols<span class="org-whitespace-space"> </span>from<span class="org-whitespace-space"> </span>a.out...done.
[New<span class="org-whitespace-space"> </span>LWP<span class="org-whitespace-space"> </span>30996]
Core<span class="org-whitespace-space"> </span>was<span class="org-whitespace-space"> </span>generated<span class="org-whitespace-space"> </span>by<span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">`./a.out'.</span>
<span class="org-sh-quoted-exec">Program</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">terminated</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">with</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">signal</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">SIGSEGV,</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">Segmentation</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">fault.</span>
<span class="org-sh-quoted-exec">#0</span><span class="org-whitespace-space">  </span><span class="org-sh-quoted-exec">0x00005578e4943131</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">in</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">func</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">(p=0x0)</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">at</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">core.c:5</span>
<span class="org-sh-quoted-exec">5</span><span class="org-whitespace-space">           </span><span class="org-sh-quoted-exec">*p</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">=</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">1234;</span>
<span class="org-sh-quoted-exec">#0</span><span class="org-whitespace-space">  </span><span class="org-sh-quoted-exec">0x00005578e4943131</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">in</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">func</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">(p=0x0)</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">at</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">core.c:5</span>
<span class="org-sh-quoted-exec">#1</span><span class="org-whitespace-space">  </span><span class="org-sh-quoted-exec">0x00005578e494315d</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">in</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">main</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">(argc=1,</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">argv=0x7ffd55097308)</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">at</span><span class="org-whitespace-space"> </span><span class="org-sh-quoted-exec">core.c:11</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org44f7598" class="outline-3">
<h3 id="org44f7598"><span class="section-number-3">5.2</span> example2</h3>
<div class="outline-text-3" id="text-5-2">
<p>
<a id="org6346116"></a>
</p>

<p>
一个简单的虚Base和Derived类. 用于分析vtable.
</p>
<div class="org-src-container">
<pre class="src src-c++"><span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;iostream&gt;</span>

<span class="org-keyword">class</span><span class="org-whitespace-space"> </span><span class="org-type">Base</span>
{
<span class="org-keyword">public</span>:
<span class="org-whitespace-space">    </span><span class="org-keyword">virtual</span><span class="org-whitespace-space"> </span>~<span class="org-function-name">Base</span>()<span class="org-whitespace-space"> </span>{}
<span class="org-whitespace-space">    </span><span class="org-keyword">virtual</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">func</span>()<span class="org-whitespace-space"> </span><span class="org-keyword">const</span>
<span class="org-whitespace-space">    </span>{
<span class="org-whitespace-space">        </span><span class="org-constant">std</span>::cout<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>__PRETTY_FUNCTION__<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span><span class="org-constant">std</span>::endl;
<span class="org-whitespace-space">    </span>}

<span class="org-whitespace-space">    </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mVal</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>100;
};

<span class="org-keyword">class</span><span class="org-whitespace-space"> </span><span class="org-type">Derived</span><span class="org-whitespace-space"> </span>:<span class="org-whitespace-space"> </span><span class="org-keyword">virtual</span><span class="org-whitespace-space"> </span><span class="org-keyword">public</span><span class="org-whitespace-space"> </span><span class="org-type">Base</span>
{
<span class="org-keyword">public</span>:
<span class="org-whitespace-space">    </span>~<span class="org-function-name">Derived</span>()<span class="org-whitespace-space"> </span><span class="org-keyword">override</span><span class="org-whitespace-space"> </span>{}
<span class="org-whitespace-space">    </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">func</span>()<span class="org-whitespace-space"> </span><span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">override</span>
<span class="org-whitespace-space">    </span>{
<span class="org-whitespace-space">        </span><span class="org-constant">std</span>::cout<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>__PRETTY_FUNCTION__<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span><span class="org-constant">std</span>::endl;
<span class="org-whitespace-space">    </span>}
<span class="org-whitespace-space">    </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mVal</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>200;
};

<span class="org-keyword">class</span><span class="org-whitespace-space"> </span><span class="org-type">Derived2</span><span class="org-whitespace-space"> </span>:<span class="org-whitespace-space"> </span><span class="org-keyword">virtual</span><span class="org-whitespace-space"> </span><span class="org-keyword">public</span><span class="org-whitespace-space"> </span><span class="org-type">Base</span>
{
<span class="org-keyword">public</span>:
<span class="org-whitespace-space">    </span>~<span class="org-function-name">Derived2</span>()<span class="org-whitespace-space"> </span><span class="org-keyword">override</span><span class="org-whitespace-space"> </span>{}
<span class="org-whitespace-space">    </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">func</span>()<span class="org-whitespace-space"> </span><span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">override</span>
<span class="org-whitespace-space">    </span>{
<span class="org-whitespace-space">        </span><span class="org-constant">std</span>::cout<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>__PRETTY_FUNCTION__<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span><span class="org-constant">std</span>::endl;
<span class="org-whitespace-space">    </span>}
<span class="org-whitespace-space">    </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mVal</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>300;
};

<span class="org-keyword">class</span><span class="org-whitespace-space"> </span><span class="org-type">DerivedSecond</span><span class="org-whitespace-space"> </span>:<span class="org-whitespace-space"> </span><span class="org-keyword">public</span><span class="org-whitespace-space"> </span><span class="org-type">Derived</span>,<span class="org-whitespace-space"> </span><span class="org-type">Derived2</span>
{
<span class="org-keyword">public</span>:
<span class="org-whitespace-space">    </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">func</span>()<span class="org-whitespace-space"> </span><span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">override</span>
<span class="org-whitespace-space">    </span>{
<span class="org-whitespace-space">        </span><span class="org-constant">std</span>::cout<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>__PRETTY_FUNCTION__<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span><span class="org-constant">std</span>::endl;
<span class="org-whitespace-space">    </span>}
};

<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">main</span>(<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">argc</span>,<span class="org-whitespace-space"> </span><span class="org-type">char</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">argv</span>[])
{
<span class="org-whitespace-space">    </span><span class="org-type">Base</span><span class="org-whitespace-space"> </span><span class="org-variable-name">b</span>;
<span class="org-whitespace-space">    </span>b.func();
<span class="org-whitespace-space">    </span><span class="org-type">Derived</span><span class="org-whitespace-space"> </span><span class="org-variable-name">d</span>;
<span class="org-whitespace-space">    </span>d.func();
<span class="org-whitespace-space">    </span><span class="org-type">Base</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">b2</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-keyword">new</span><span class="org-whitespace-space"> </span><span class="org-type">Derived</span>;
<span class="org-whitespace-space">    </span>b2-&gt;func();
<span class="org-whitespace-space">    </span><span class="org-type">Base</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">b3</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-keyword">new</span><span class="org-whitespace-space"> </span><span class="org-type">DerivedSecond</span>;
<span class="org-whitespace-space">    </span>b3-&gt;func();
<span class="org-whitespace-space">    </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>0;
}
</pre>
</div>

<p>
编译:
</p>
<div class="org-src-container">
<pre class="src src-bash">[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>23:51:19&gt;
$<span class="org-whitespace-space"> </span>g++<span class="org-whitespace-space"> </span>-g<span class="org-whitespace-space"> </span>-O0<span class="org-whitespace-space"> </span>-Wall<span class="org-whitespace-space"> </span>example2.cc
[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>23:51:23&gt;
$<span class="org-whitespace-space"> </span>./a.out
virtual<span class="org-whitespace-space"> </span>void<span class="org-whitespace-space"> </span>Base::func()<span class="org-whitespace-space"> </span>const
virtual<span class="org-whitespace-space"> </span>void<span class="org-whitespace-space"> </span>Derived::func()<span class="org-whitespace-space"> </span>const
virtual<span class="org-whitespace-space"> </span>void<span class="org-whitespace-space"> </span>Derived::func()<span class="org-whitespace-space"> </span>const
[yanyg@x1{192.168.0.106}<span class="org-whitespace-space"> </span>~/test<span class="org-whitespace-space"> </span>]<span class="org-whitespace-space"> </span>&lt;2022-08-20<span class="org-whitespace-space"> </span>23:52:53&gt;
$<span class="org-whitespace-space"> </span>gdb<span class="org-whitespace-space"> </span>--quiet<span class="org-whitespace-space"> </span>a.out<span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'b</span><span class="org-whitespace-space"> </span><span class="org-string">main'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'run'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'n'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'n'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'n'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'n'</span><span class="org-whitespace-space"> </span>-ex<span class="org-whitespace-space"> </span><span class="org-string">'</span><span class="org-string"><span class="org-whitespace-line">n'</span></span>
Reading<span class="org-whitespace-space"> </span>symbols<span class="org-whitespace-space"> </span>from<span class="org-whitespace-space"> </span>a.out...done.
Breakpoint<span class="org-whitespace-space"> </span>1<span class="org-whitespace-space"> </span>at<span class="org-whitespace-space"> </span>0x11a5:<span class="org-whitespace-space"> </span>file<span class="org-whitespace-space"> </span>baseder.cc,<span class="org-whitespace-space"> </span>line<span class="org-whitespace-space"> </span>28.
Starting<span class="org-whitespace-space"> </span>program:<span class="org-whitespace-space"> </span>/home/yanyg/test/a.out

Breakpoint<span class="org-whitespace-space"> </span>1,<span class="org-whitespace-space"> </span>main<span class="org-whitespace-space"> </span>(<span class="org-variable-name">argc</span>=1,<span class="org-whitespace-space"> </span><span class="org-variable-name">argv</span>=0x7fffffffe5b8)<span class="org-whitespace-space"> </span>at<span class="org-whitespace-space"> </span>baseder.cc:28
28<span class="org-whitespace-space">          </span>Base<span class="org-whitespace-space"> </span>b;
29<span class="org-whitespace-space">          </span>b.func();
virtual<span class="org-whitespace-space"> </span>void<span class="org-whitespace-space"> </span>Base::func()<span class="org-whitespace-space"> </span>const
30<span class="org-whitespace-space">          </span>Derived<span class="org-whitespace-space"> </span>d;
31<span class="org-whitespace-space">          </span>d.func();
virtual<span class="org-whitespace-space"> </span>void<span class="org-whitespace-space"> </span>Derived::func()<span class="org-whitespace-space"> </span>const
32<span class="org-whitespace-space">          </span>Base<span class="org-whitespace-space"> </span>*b2<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>new<span class="org-whitespace-space"> </span>Derived;
33<span class="org-whitespace-space">          </span>b2-&gt;func();
(gdb)<span class="org-whitespace-space"> </span>p<span class="org-whitespace-space"> </span>d
$<span class="org-variable-name">1</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>{&lt;Base&gt;<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>{_vptr.Base<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0x555555557d50<span class="org-whitespace-space"> </span>&lt;vtable<span class="org-whitespace-space"> </span>for<span class="org-whitespace-space"> </span>Derived+16&gt;,<span class="org-whitespace-space"> </span>mVal<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>100}<span class="org-whitespace-line">,</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">mVal</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">=</span><span class="org-whitespace-space"><span class="org-whitespace-line"> </span></span><span class="org-whitespace-line">20}</span>
(gdb)<span class="org-whitespace-space"> </span>info<span class="org-whitespace-space"> </span>vtable<span class="org-whitespace-space"> </span>0x555555557d50
Undefined<span class="org-whitespace-space"> </span>info<span class="org-whitespace-space"> </span>command:<span class="org-whitespace-space"> </span><span class="org-string">"vtable</span><span class="org-whitespace-space"> </span><span class="org-string">0x555555557d50"</span>.<span class="org-whitespace-space">  </span>Try<span class="org-whitespace-space"> </span><span class="org-string">"help</span><span class="org-whitespace-space"> </span><span class="org-string">info"</span>.
(gdb)<span class="org-whitespace-space"> </span>info<span class="org-whitespace-space"> </span>vtbl<span class="org-whitespace-space"> </span>0x555555557d50
This<span class="org-whitespace-space"> </span>object<span class="org-whitespace-space"> </span>does<span class="org-whitespace-space"> </span>not<span class="org-whitespace-space"> </span>have<span class="org-whitespace-space"> </span>a<span class="org-whitespace-space"> </span>virtual<span class="org-whitespace-space"> </span><span class="org-keyword">function</span><span class="org-whitespace-space"> </span><span class="org-function-name">table</span>
(gdb)<span class="org-whitespace-space"> </span>info<span class="org-whitespace-space"> </span>vtbl<span class="org-whitespace-space"> </span>d
vtable<span class="org-whitespace-space"> </span>for<span class="org-whitespace-space"> </span><span class="org-string">'Derived'</span><span class="org-whitespace-space"> </span>@<span class="org-whitespace-space"> </span>0x555555557d50<span class="org-whitespace-space"> </span>(subobject<span class="org-whitespace-space"> </span>@<span class="org-whitespace-space"> </span>0x7fffffffe490):
[0]:<span class="org-whitespace-space"> </span>0x555555555348<span class="org-whitespace-space"> </span>&lt;Derived::~Derived()&gt;
[1]:<span class="org-whitespace-space"> </span>0x555555555372<span class="org-whitespace-space"> </span>&lt;Derived::~Derived()&gt;
[2]:<span class="org-whitespace-space"> </span>0x55555555539e<span class="org-whitespace-space"> </span>&lt;Derived::func()<span class="org-whitespace-space"> </span>const&gt;
(gdb)<span class="org-whitespace-space"> </span>info<span class="org-whitespace-space"> </span>vtbl<span class="org-whitespace-space"> </span>b
vtable<span class="org-whitespace-space"> </span>for<span class="org-whitespace-space"> </span><span class="org-string">'Base'</span><span class="org-whitespace-space"> </span>@<span class="org-whitespace-space"> </span>0x555555557d78<span class="org-whitespace-space"> </span>(subobject<span class="org-whitespace-space"> </span>@<span class="org-whitespace-space"> </span>0x7fffffffe4a0):
[0]:<span class="org-whitespace-space"> </span>0x5555555552ca<span class="org-whitespace-space"> </span>&lt;Base::~Base()&gt;
[1]:<span class="org-whitespace-space"> </span>0x5555555552e4<span class="org-whitespace-space"> </span>&lt;Base::~Base()&gt;
[2]:<span class="org-whitespace-space"> </span>0x555555555310<span class="org-whitespace-space"> </span>&lt;Base::func()<span class="org-whitespace-space"> </span>const&gt;
</pre>
</div>

<p>
可以看出来, vtable里有2个析构函数. 这是编译器相关的, 这里有说明:
</p>
<blockquote>
<p>
Virtual Table Layout: <a href="https://itanium-cxx-abi.github.io/cxx-abi/abi.html#vtable">https://itanium-cxx-abi.github.io/cxx-abi/abi.html#vtable</a>
</p>

<p>
The entries for virtual destructors are actually pairs of entries. The first
destructor, called the complete object destructor, performs the destruction
without calling delete() on the object. The second destructor, called the
deleting destructor, calls delete() after destroying the object. Both destroy
any virtual bases; a separate, non-virtual function, called the base object
destructor, performs destruction of the object but not its virtual base
subobjects, and does not call delete().
</p>
</blockquote>

<p>
用参数-fdump-lang-class(老版本编译器用参数-fdump-class-hierarchy), 生成class文件
example2.cc.001l.class:
</p>
<div class="org-src-container">
<pre class="src src-c++">VTT<span class="org-whitespace-space"> </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>Derived
<span class="org-constant">Derived</span>::_ZTT7Derived:<span class="org-whitespace-space"> </span>2<span class="org-whitespace-space"> </span>entries
0<span class="org-whitespace-space">     </span>((&amp;<span class="org-whitespace-space"> </span><span class="org-constant">Derived</span>::_ZTV7Derived)<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>24)
8<span class="org-whitespace-space">     </span>((&amp;<span class="org-whitespace-space"> </span><span class="org-constant">Derived</span>::_ZTV7Derived)<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>80)

Class<span class="org-whitespace-space"> </span><span class="org-type">Derived</span>
<span class="org-whitespace-space">   </span><span class="org-variable-name">size</span>=32<span class="org-whitespace-space"> </span>align=8
<span class="org-whitespace-space">   </span>base<span class="org-whitespace-space"> </span>size=12<span class="org-whitespace-space"> </span>base<span class="org-whitespace-space"> </span>align=8
Derived<span class="org-whitespace-space"> </span>(<span class="org-keyword">0x</span><span class="org-constant">0</span>x7fb124fae068)<span class="org-whitespace-space"> </span>0
<span class="org-whitespace-space">    </span>vptridx=0<span class="org-whitespace-space"> </span>vptr=((&amp;<span class="org-whitespace-space"> </span><span class="org-constant">Derived</span>::_ZTV7Derived)<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>24)
<span class="org-whitespace-space">  </span>Base<span class="org-whitespace-space"> </span>(<span class="org-keyword">0x</span><span class="org-constant">0</span>x7fb124f50f60)<span class="org-whitespace-space"> </span>16<span class="org-whitespace-space"> </span><span class="org-keyword">virtual</span>
<span class="org-whitespace-space">      </span>vptridx=8<span class="org-whitespace-space"> </span>vbaseoffset=-24<span class="org-whitespace-space"> </span>vptr=((&amp;<span class="org-whitespace-space"> </span><span class="org-constant">Derived</span>::_ZTV7Derived)<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>80)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgafa0ec9" class="outline-2">
<h2 id="orgafa0ec9"><span class="section-number-2">6</span> References</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li><a href="https://hellogcc.github.io/">https://hellogcc.github.io/</a></li>
<li><a href="https://github.com/hellogcc/100-gdb-tips">https://github.com/hellogcc/100-gdb-tips</a></li>
</ul>
</div>
</div>

<script src="https://utteranc.es/client.js"
        repo="yygcode/yygcode.github.io"
        issue-term="pathname"
        label=" Utterances"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>
</div>
<div id="postamble" class="status">
<div class="copyright">
2012-2020 Copyright&copy; <i> YANYG<br/>Powered by Emacs Orgmode</i>
</div>
</div>
</body>
</html>
