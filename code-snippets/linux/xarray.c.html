<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>linux/lib/xarray.c</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="yanyg" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="/themes/code/css/code-snippet.css" />
<script type="text/javascript" src="/themes/code/js/code-snippet.js"> </script>
</head>
<body>
<div id="preamble" class="status">
<a href="../../index.html">Yanyg - SAN Software Engineer</a>
<div class="sitelinks">
  <a href="../snippets.html">Snippets</a> |
  <a href="../theindex.html">Index</a> |
  <a href="../tags.html">TAGS</a> |
  <a href="https://github.com/yygcode">Github</a> |
  <a href="../../about.html">About Me</a>
</div>
</div>
<div id="content">
<h1 class="title">linux/lib/xarray.c</h1>
<div class="org-src-container">
<pre class="src src-C"><span class="org-comment-delimiter">//</span><span class="org-whitespace-space"> </span><span class="org-comment">SPDX-License-Identifier:</span><span class="org-whitespace-space"> </span><span class="org-comment">GPL-2.0+</span>
<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray</span><span class="org-whitespace-space"> </span><span class="org-comment">implementation</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Copyright</span><span class="org-whitespace-space"> </span><span class="org-comment">(c)</span><span class="org-whitespace-space"> </span><span class="org-comment">2017</span><span class="org-whitespace-space"> </span><span class="org-comment">Microsoft</span><span class="org-whitespace-space"> </span><span class="org-comment">Corporation</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Author:</span><span class="org-whitespace-space"> </span><span class="org-comment">Matthew</span><span class="org-whitespace-space"> </span><span class="org-comment">Wilcox</span><span class="org-whitespace-space"> </span><span class="org-comment"><a href="mailto:willy%40infradead.org">&lt;willy@infradead.org&gt;</a></span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>

<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;linux/bitmap.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;linux/export.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;linux/list.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;linux/slab.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;linux/xarray.h&gt;</span>

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Coding</span><span class="org-whitespace-space"> </span><span class="org-comment">conventions</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">this</span><span class="org-whitespace-space"> </span><span class="org-comment">file:</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@xa</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">used</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">refer</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">entire</span><span class="org-whitespace-space"> </span><span class="org-comment">xarray.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">'xarray</span><span class="org-whitespace-space"> </span><span class="org-comment">operation</span><span class="org-whitespace-space"> </span><span class="org-comment">state'.</span><span class="org-whitespace-space">  </span><span class="org-comment">It</span><span class="org-whitespace-space"> </span><span class="org-comment">may</span><span class="org-whitespace-space"> </span><span class="org-comment">be</span><span class="org-whitespace-space"> </span><span class="org-comment">either</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">pointer</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_state,</span><span class="org-whitespace-space"> </span><span class="org-comment">or</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_state</span><span class="org-whitespace-space"> </span><span class="org-comment">stored</span><span class="org-whitespace-space"> </span><span class="org-comment">on</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">stack.</span><span class="org-whitespace-space">  </span><span class="org-comment">This</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">unfortunate</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">ambiguity.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@index</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">index</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">being</span><span class="org-whitespace-space"> </span><span class="org-comment">operated</span><span class="org-whitespace-space"> </span><span class="org-comment">on</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@mark</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_mark_t;</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">small</span><span class="org-whitespace-space"> </span><span class="org-comment">number</span><span class="org-whitespace-space"> </span><span class="org-comment">indicating</span><span class="org-whitespace-space"> </span><span class="org-comment">one</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">mark</span><span class="org-whitespace-space"> </span><span class="org-comment">bits.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@node</span><span class="org-whitespace-space"> </span><span class="org-comment">refers</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_node;</span><span class="org-whitespace-space"> </span><span class="org-comment">usually</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">primary</span><span class="org-whitespace-space"> </span><span class="org-comment">one</span><span class="org-whitespace-space"> </span><span class="org-comment">being</span><span class="org-whitespace-space"> </span><span class="org-comment">operated</span><span class="org-whitespace-space"> </span><span class="org-comment">on</span><span class="org-whitespace-space"> </span><span class="org-comment">by</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">this</span><span class="org-whitespace-space"> </span><span class="org-comment">function.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@offset</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">index</span><span class="org-whitespace-space"> </span><span class="org-comment">into</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">slots</span><span class="org-whitespace-space"> </span><span class="org-comment">array</span><span class="org-whitespace-space"> </span><span class="org-comment">inside</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_node.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@parent</span><span class="org-whitespace-space"> </span><span class="org-comment">refers</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">@xa_node</span><span class="org-whitespace-space"> </span><span class="org-comment">closer</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">head</span><span class="org-whitespace-space"> </span><span class="org-comment">than</span><span class="org-whitespace-space"> </span><span class="org-comment">@node.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@entry</span><span class="org-whitespace-space"> </span><span class="org-comment">refers</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">something</span><span class="org-whitespace-space"> </span><span class="org-comment">stored</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">slot</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">xarray</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_lock_type</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(__force<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span>)xa-&gt;xa_flags<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>3;
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_lock_type</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">lock_type</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(lock_type<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_LOCK_IRQ)
<span class="org-whitespace-space">                </span>xas_lock_irq(xas);
<span class="org-whitespace-space">        </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(lock_type<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_LOCK_BH)
<span class="org-whitespace-space">                </span>xas_lock_bh(xas);
<span class="org-whitespace-space">        </span><span class="org-keyword">else</span>
<span class="org-whitespace-space">                </span>xas_lock(xas);
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_unlock_type</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">lock_type</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(lock_type<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_LOCK_IRQ)
<span class="org-whitespace-space">                </span>xas_unlock_irq(xas);
<span class="org-whitespace-space">        </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(lock_type<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_LOCK_BH)
<span class="org-whitespace-space">                </span>xas_unlock_bh(xas);
<span class="org-whitespace-space">        </span><span class="org-keyword">else</span>
<span class="org-whitespace-space">                </span>xas_unlock(xas);
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_track_free</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa-&gt;xa_flags<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_FLAGS_TRACK_FREE;
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_zero_busy</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa-&gt;xa_flags<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_FLAGS_ZERO_BUSY;
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_mark_set</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>(xa-&gt;xa_flags<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_FLAGS_MARK(mark)))
<span class="org-whitespace-space">                </span>xa-&gt;xa_flags<span class="org-whitespace-space"> </span>|=<span class="org-whitespace-space"> </span>XA_FLAGS_MARK(mark);
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_mark_clear</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa-&gt;xa_flags<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_FLAGS_MARK(mark))
<span class="org-whitespace-space">                </span>xa-&gt;xa_flags<span class="org-whitespace-space"> </span>&amp;=<span class="org-whitespace-space"> </span>~(XA_FLAGS_MARK(mark));
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">node_marks</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>node-&gt;marks[(__force<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span>)mark];
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">node_get_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>,
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>test_bit(offset,<span class="org-whitespace-space"> </span>node_marks(node,<span class="org-whitespace-space"> </span>mark));
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">returns</span><span class="org-whitespace-space"> </span><span class="org-comment">true</span><span class="org-whitespace-space"> </span><span class="org-comment">if</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">bit</span><span class="org-whitespace-space"> </span><span class="org-comment">was</span><span class="org-whitespace-space"> </span><span class="org-comment">set</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">node_set_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span>,
<span class="org-whitespace-space">                                </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>__test_and_set_bit(offset,<span class="org-whitespace-space"> </span>node_marks(node,<span class="org-whitespace-space"> </span>mark));
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">returns</span><span class="org-whitespace-space"> </span><span class="org-comment">true</span><span class="org-whitespace-space"> </span><span class="org-comment">if</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">bit</span><span class="org-whitespace-space"> </span><span class="org-comment">was</span><span class="org-whitespace-space"> </span><span class="org-comment">set</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">node_clear_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span>,
<span class="org-whitespace-space">                                </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>__test_and_clear_bit(offset,<span class="org-whitespace-space"> </span>node_marks(node,<span class="org-whitespace-space"> </span>mark));
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">node_any_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>bitmap_empty(node_marks(node,<span class="org-whitespace-space"> </span>mark),<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE);
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">node_mark_all</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span>bitmap_fill(node_marks(node,<span class="org-whitespace-space"> </span>mark),<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE);
}

<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">mark_inc</span>(<span class="org-variable-name">mark</span>)<span class="org-whitespace-space"> </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">        </span>mark<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>(__force<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>)((__force<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span>)(mark)<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1);<span class="org-whitespace-space"> </span>\
}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(0)

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">xas_squash_marks()</span><span class="org-whitespace-space"> </span><span class="org-comment">-</span><span class="org-whitespace-space"> </span><span class="org-comment">Merge</span><span class="org-whitespace-space"> </span><span class="org-comment">all</span><span class="org-whitespace-space"> </span><span class="org-comment">marks</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">first</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas:</span><span class="org-whitespace-space"> </span><span class="org-comment">Array</span><span class="org-whitespace-space"> </span><span class="org-comment">operation</span><span class="org-whitespace-space"> </span><span class="org-comment">state.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Set</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">mark</span><span class="org-whitespace-space"> </span><span class="org-comment">on</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">first</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">if</span><span class="org-whitespace-space"> </span><span class="org-comment">any</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">has</span><span class="org-whitespace-space"> </span><span class="org-comment">it</span><span class="org-whitespace-space"> </span><span class="org-comment">set.</span><span class="org-whitespace-space">  </span><span class="org-comment">Clear</span><span class="org-whitespace-space"> </span><span class="org-comment">marks</span><span class="org-whitespace-space"> </span><span class="org-comment">on</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">all</span><span class="org-whitespace-space"> </span><span class="org-comment">sibling</span><span class="org-whitespace-space"> </span><span class="org-comment">entries.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_squash_marks</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limit</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>xas-&gt;xa_sibs<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_sibs)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">marks</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node-&gt;marks[mark];
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(find_next_bit(marks,<span class="org-whitespace-space"> </span>limit,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1)<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>limit)
<span class="org-whitespace-space">                        </span><span class="org-keyword">continue</span>;
<span class="org-whitespace-space">                </span>__set_bit(xas-&gt;xa_offset,<span class="org-whitespace-space"> </span>marks);
<span class="org-whitespace-space">                </span>bitmap_clear(marks,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1,<span class="org-whitespace-space"> </span>xas-&gt;xa_sibs);
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(mark++<span class="org-whitespace-space"> </span>!=<span class="org-whitespace-space"> </span>(__force<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span>)XA_MARK_MAX);
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">extracts</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">offset</span><span class="org-whitespace-space"> </span><span class="org-comment">within</span><span class="org-whitespace-space"> </span><span class="org-comment">this</span><span class="org-whitespace-space"> </span><span class="org-comment">node</span><span class="org-whitespace-space"> </span><span class="org-comment">from</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">index</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">get_offset</span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(index<span class="org-whitespace-space"> </span>&gt;&gt;<span class="org-whitespace-space"> </span>node-&gt;shift)<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_CHUNK_MASK;
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_set_offset</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>get_offset(xas-&gt;xa_index,<span class="org-whitespace-space"> </span>xas-&gt;xa_node);
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">move</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">index</span><span class="org-whitespace-space"> </span><span class="org-comment">either</span><span class="org-whitespace-space"> </span><span class="org-comment">forwards</span><span class="org-whitespace-space"> </span><span class="org-comment">(find)</span><span class="org-whitespace-space"> </span><span class="org-comment">or</span><span class="org-whitespace-space"> </span><span class="org-comment">backwards</span><span class="org-whitespace-space"> </span><span class="org-comment">(sibling</span><span class="org-whitespace-space"> </span><span class="org-comment">slot)</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_move_index</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">shift</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node-&gt;shift;
<span class="org-whitespace-space">        </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>&amp;=<span class="org-whitespace-space"> </span>~XA_CHUNK_MASK<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>shift;
<span class="org-whitespace-space">        </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>offset<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>shift;
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_advance</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span>xas-&gt;xa_offset++;
<span class="org-whitespace-space">        </span>xas_move_index(xas,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset);
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">set_bounds</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XAS_BOUNDS;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
}

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Starts</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">walk.</span><span class="org-whitespace-space">  </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">already</span><span class="org-whitespace-space"> </span><span class="org-comment">valid,</span><span class="org-whitespace-space"> </span><span class="org-comment">we</span><span class="org-whitespace-space"> </span><span class="org-comment">assume</span><span class="org-whitespace-space"> </span><span class="org-comment">that</span><span class="org-whitespace-space"> </span><span class="org-comment">it's</span><span class="org-whitespace-space"> </span><span class="org-comment">on</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">right</span><span class="org-whitespace-space"> </span><span class="org-comment">path</span><span class="org-whitespace-space"> </span><span class="org-comment">and</span><span class="org-whitespace-space"> </span><span class="org-comment">just</span><span class="org-whitespace-space"> </span><span class="org-comment">return</span><span class="org-whitespace-space"> </span><span class="org-comment">where</span><span class="org-whitespace-space"> </span><span class="org-comment">we've</span><span class="org-whitespace-space"> </span><span class="org-comment">got</span><span class="org-whitespace-space"> </span><span class="org-comment">to.</span><span class="org-whitespace-space">  </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">we're</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">error</span><span class="org-whitespace-space"> </span><span class="org-comment">state,</span><span class="org-whitespace-space"> </span><span class="org-comment">return</span><span class="org-whitespace-space"> </span><span class="org-comment">NULL.</span><span class="org-whitespace-space">  </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">index</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">outside</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">current</span><span class="org-whitespace-space"> </span><span class="org-comment">scope</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">xarray,</span><span class="org-whitespace-space"> </span><span class="org-comment">return</span><span class="org-whitespace-space"> </span><span class="org-comment">NULL</span><span class="org-whitespace-space"> </span><span class="org-comment">without</span><span class="org-whitespace-space"> </span><span class="org-comment">changing</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas-&gt;xa_node.</span><span class="org-whitespace-space">  </span><span class="org-comment">Otherwise</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">set</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas-&gt;xa_node</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">NULL</span><span class="org-whitespace-space"> </span><span class="org-comment">and</span><span class="org-whitespace-space"> </span><span class="org-comment">return</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">current</span><span class="org-whitespace-space"> </span><span class="org-comment">head</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">array.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_start</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_valid(xas))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_reload(xas);
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_error(xas))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;

<span class="org-whitespace-space">        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_head(xas-&gt;xa);
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_node(entry))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_index)
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>set_bounds(xas);
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>((xas-&gt;xa_index<span class="org-whitespace-space"> </span>&gt;&gt;<span class="org-whitespace-space"> </span>xa_to_node(entry)-&gt;shift)<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>XA_CHUNK_MASK)
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>set_bounds(xas);
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_descend</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>get_offset(xas-&gt;xa_index,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry(xas-&gt;xa,<span class="org-whitespace-space"> </span>node,<span class="org-whitespace-space"> </span>offset);

<span class="org-whitespace-space">        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>node;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_sibling(entry))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_sibling(entry);
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry(xas-&gt;xa,<span class="org-whitespace-space"> </span>node,<span class="org-whitespace-space"> </span>offset);
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>offset;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_load()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Load</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">(advanced).</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Usually</span><span class="org-whitespace-space"> </span><span class="org-doc">walks</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">appropriate</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">load</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_index.</span><span class="org-whitespace-space">  </span><span class="org-doc">However,</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">do</span><span class="org-whitespace-space"> </span><span class="org-doc">nothing</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span><span class="org-whitespace-space">  </span><span class="org-doc"><span class="org-constant">xas_load()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">never</span><span class="org-whitespace-space"> </span><span class="org-doc">expand</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">tree.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_state</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span><span class="org-whitespace-space"> </span><span class="org-doc">up</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">operate</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">multi-index</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_load()</span></span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">internal</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">even</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">there</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">present</span><span class="org-whitespace-space"> </span><span class="org-doc">within</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">range</span><span class="org-whitespace-space"> </span><span class="org-doc">specified</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">caller</span><span class="org-whitespace-space"> </span><span class="org-doc">should</span><span class="org-whitespace-space"> </span><span class="org-doc">hold</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">Usually</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray,</span><span class="org-whitespace-space"> </span><span class="org-doc">but</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">description</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">exceptions.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_load</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_start(xas);

<span class="org-whitespace-space">        </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(xa_is_node(entry))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(entry);

<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_shift<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>node-&gt;shift)
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_descend(xas,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node-&gt;shift<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>0)
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(xas_load);

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Move</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">radix</span><span class="org-whitespace-space"> </span><span class="org-comment">tree</span><span class="org-whitespace-space"> </span><span class="org-comment">node</span><span class="org-whitespace-space"> </span><span class="org-comment">cache</span><span class="org-whitespace-space"> </span><span class="org-comment">here</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">extern</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">kmem_cache</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">radix_tree_node_cachep</span>;
<span class="org-keyword">extern</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">radix_tree_node_rcu_free</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">rcu_head</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">head</span>);

<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_RCU_FREE</span><span class="org-whitespace-tab">     </span>((<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*)1)

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_node_free</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>)
{
<span class="org-whitespace-space">        </span>XA_NODE_BUG_ON(node,<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>list_empty(&amp;node-&gt;private_list));
<span class="org-whitespace-space">        </span>node-&gt;array<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XA_RCU_FREE;
<span class="org-whitespace-space">        </span>call_rcu(&amp;node-&gt;rcu_head,<span class="org-whitespace-space"> </span>radix_tree_node_rcu_free);
}

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">xas_destroy()</span><span class="org-whitespace-space"> </span><span class="org-comment">-</span><span class="org-whitespace-space"> </span><span class="org-comment">Free</span><span class="org-whitespace-space"> </span><span class="org-comment">any</span><span class="org-whitespace-space"> </span><span class="org-comment">resources</span><span class="org-whitespace-space"> </span><span class="org-comment">allocated</span><span class="org-whitespace-space"> </span><span class="org-comment">during</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray</span><span class="org-whitespace-space"> </span><span class="org-comment">operation.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas:</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray</span><span class="org-whitespace-space"> </span><span class="org-comment">operation</span><span class="org-whitespace-space"> </span><span class="org-comment">state.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">This</span><span class="org-whitespace-space"> </span><span class="org-comment">function</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">now</span><span class="org-whitespace-space"> </span><span class="org-comment">internal-only.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_destroy</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_alloc;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>node)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span>;
<span class="org-whitespace-space">        </span>XA_NODE_BUG_ON(node,<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>list_empty(&amp;node-&gt;private_list));
<span class="org-whitespace-space">        </span>kmem_cache_free(radix_tree_node_cachep,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">        </span>xas-&gt;xa_alloc<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_nomem()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Allocate</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">needed.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">we</span><span class="org-whitespace-space"> </span><span class="org-doc">need</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">add</span><span class="org-whitespace-space"> </span><span class="org-doc">new</span><span class="org-whitespace-space"> </span><span class="org-doc">nodes</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray,</span><span class="org-whitespace-space"> </span><span class="org-doc">we</span><span class="org-whitespace-space"> </span><span class="org-doc">try</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">allocate</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc">GFP_NOWAIT</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc">holding</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">lock,</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">usually</span><span class="org-whitespace-space"> </span><span class="org-doc">succeed.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">fails,</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">flagged</span><span class="org-whitespace-space"> </span><span class="org-doc">as</span><span class="org-whitespace-space"> </span><span class="org-doc">needing</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">continue.</span><span class="org-whitespace-space">  </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">caller</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">should</span><span class="org-whitespace-space"> </span><span class="org-doc">drop</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">lock</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_nomem()</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_nomem()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">succeeds,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">caller</span><span class="org-whitespace-space"> </span><span class="org-doc">should</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">operation.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Forward</span><span class="org-whitespace-space"> </span><span class="org-doc">progress</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">guaranteed</span><span class="org-whitespace-space"> </span><span class="org-doc">as</span><span class="org-whitespace-space"> </span><span class="org-doc">one</span><span class="org-whitespace-space"> </span><span class="org-doc">node</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">here</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_state</span><span class="org-whitespace-space"> </span><span class="org-doc">where</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">found</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_alloc()</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">More</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">nodes</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">likely</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">found</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">slab</span><span class="org-whitespace-space"> </span><span class="org-doc">allocator,</span><span class="org-whitespace-space"> </span><span class="org-doc">but</span><span class="org-whitespace-space"> </span><span class="org-doc">we</span><span class="org-whitespace-space"> </span><span class="org-doc">do</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">tie</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">them</span><span class="org-whitespace-space"> </span><span class="org-doc">up</span><span class="org-whitespace-space"> </span><span class="org-doc">here.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">true</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">was</span><span class="org-whitespace-space"> </span><span class="org-doc">needed,</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">was</span><span class="org-whitespace-space"> </span><span class="org-doc">successfully</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_nomem</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_node<span class="org-whitespace-space"> </span>!=<span class="org-whitespace-space"> </span>XA_ERROR(-ENOMEM))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas_destroy(xas);
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">false</span>;
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa-&gt;xa_flags<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_FLAGS_ACCOUNT)
<span class="org-whitespace-space">                </span>gfp<span class="org-whitespace-space"> </span>|=<span class="org-whitespace-space"> </span>__GFP_ACCOUNT;
<span class="org-whitespace-space">        </span>xas-&gt;xa_alloc<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>kmem_cache_alloc(radix_tree_node_cachep,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_alloc)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">false</span>;
<span class="org-whitespace-space">        </span>XA_NODE_BUG_ON(xas-&gt;xa_alloc,<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>list_empty(&amp;xas-&gt;xa_alloc-&gt;private_list))<span class="org-whitespace-line">;</span>
<span class="org-whitespace-space">        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XAS_RESTART;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">true</span>;
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(xas_nomem);

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">__xas_nomem()</span><span class="org-whitespace-space"> </span><span class="org-comment">-</span><span class="org-whitespace-space"> </span><span class="org-comment">Drop</span><span class="org-whitespace-space"> </span><span class="org-comment">locks</span><span class="org-whitespace-space"> </span><span class="org-comment">and</span><span class="org-whitespace-space"> </span><span class="org-comment">allocate</span><span class="org-whitespace-space"> </span><span class="org-comment">memory</span><span class="org-whitespace-space"> </span><span class="org-comment">if</span><span class="org-whitespace-space"> </span><span class="org-comment">needed.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas:</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray</span><span class="org-whitespace-space"> </span><span class="org-comment">operation</span><span class="org-whitespace-space"> </span><span class="org-comment">state.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@gfp:</span><span class="org-whitespace-space"> </span><span class="org-comment">Memory</span><span class="org-whitespace-space"> </span><span class="org-comment">allocation</span><span class="org-whitespace-space"> </span><span class="org-comment">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Internal</span><span class="org-whitespace-space"> </span><span class="org-comment">variant</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">xas_nomem().</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Return:</span><span class="org-whitespace-space"> </span><span class="org-comment">true</span><span class="org-whitespace-space"> </span><span class="org-comment">if</span><span class="org-whitespace-space"> </span><span class="org-comment">memory</span><span class="org-whitespace-space"> </span><span class="org-comment">was</span><span class="org-whitespace-space"> </span><span class="org-comment">needed,</span><span class="org-whitespace-space"> </span><span class="org-comment">and</span><span class="org-whitespace-space"> </span><span class="org-comment">was</span><span class="org-whitespace-space"> </span><span class="org-comment">successfully</span><span class="org-whitespace-space"> </span><span class="org-comment">allocated.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">__xas_nomem</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
<span class="org-whitespace-space">        </span><span class="org-function-name">__must_hold</span>(xas-&gt;xa-&gt;xa_lock)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">lock_type</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_lock_type(xas-&gt;xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_node<span class="org-whitespace-space"> </span>!=<span class="org-whitespace-space"> </span>XA_ERROR(-ENOMEM))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas_destroy(xas);
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">false</span>;
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa-&gt;xa_flags<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_FLAGS_ACCOUNT)
<span class="org-whitespace-space">                </span>gfp<span class="org-whitespace-space"> </span>|=<span class="org-whitespace-space"> </span>__GFP_ACCOUNT;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(gfpflags_allow_blocking(gfp))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas_unlock_type(xas,<span class="org-whitespace-space"> </span>lock_type);
<span class="org-whitespace-space">                </span>xas-&gt;xa_alloc<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>kmem_cache_alloc(radix_tree_node_cachep,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">                </span>xas_lock_type(xas,<span class="org-whitespace-space"> </span>lock_type);
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas-&gt;xa_alloc<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>kmem_cache_alloc(radix_tree_node_cachep,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_alloc)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">false</span>;
<span class="org-whitespace-space">        </span>XA_NODE_BUG_ON(xas-&gt;xa_alloc,<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>list_empty(&amp;xas-&gt;xa_alloc-&gt;private_list))<span class="org-whitespace-line">;</span>
<span class="org-whitespace-space">        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XAS_RESTART;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">true</span>;
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_update</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_update)
<span class="org-whitespace-space">                </span>xas-&gt;xa_update(node);
<span class="org-whitespace-space">        </span><span class="org-keyword">else</span>
<span class="org-whitespace-space">                </span>XA_NODE_BUG_ON(node,<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>list_empty(&amp;node-&gt;private_list));
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_alloc</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">shift</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">parent</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_alloc;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_invalid(xas))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas-&gt;xa_alloc<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>GFP_NOWAIT<span class="org-whitespace-space"> </span>|<span class="org-whitespace-space"> </span>__GFP_NOWARN;

<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa-&gt;xa_flags<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_FLAGS_ACCOUNT)
<span class="org-whitespace-space">                        </span>gfp<span class="org-whitespace-space"> </span>|=<span class="org-whitespace-space"> </span>__GFP_ACCOUNT;

<span class="org-whitespace-space">                </span>node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>kmem_cache_alloc(radix_tree_node_cachep,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>node)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>xas_set_err(xas,<span class="org-whitespace-space"> </span>-ENOMEM);
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(parent)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>node-&gt;offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_offset;
<span class="org-whitespace-space">                </span>parent-&gt;count++;
<span class="org-whitespace-space">                </span>XA_NODE_BUG_ON(node,<span class="org-whitespace-space"> </span>parent-&gt;count<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE);
<span class="org-whitespace-space">                </span>xas_update(xas,<span class="org-whitespace-space"> </span>parent);
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span>XA_NODE_BUG_ON(node,<span class="org-whitespace-space"> </span>shift<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>BITS_PER_LONG);
<span class="org-whitespace-space">        </span>XA_NODE_BUG_ON(node,<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>list_empty(&amp;node-&gt;private_list));
<span class="org-whitespace-space">        </span>node-&gt;shift<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>shift;
<span class="org-whitespace-space">        </span>node-&gt;count<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">        </span>node-&gt;nr_values<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">        </span>RCU_INIT_POINTER(node-&gt;parent,<span class="org-whitespace-space"> </span>xas-&gt;xa_node);
<span class="org-whitespace-space">        </span>node-&gt;array<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa;

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>node;
}

<span class="org-preprocessor">#ifdef</span><span class="org-whitespace-space"> </span>CONFIG_XARRAY_MULTI
<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Returns</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">number</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">indices</span><span class="org-whitespace-space"> </span><span class="org-comment">covered</span><span class="org-whitespace-space"> </span><span class="org-comment">by</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">given</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_state</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_size</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_sibs<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1UL)<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>xas-&gt;xa_shift;
}
<span class="org-preprocessor">#endif</span>

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Use</span><span class="org-whitespace-space"> </span><span class="org-comment">this</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">calculate</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">maximum</span><span class="org-whitespace-space"> </span><span class="org-comment">index</span><span class="org-whitespace-space"> </span><span class="org-comment">that</span><span class="org-whitespace-space"> </span><span class="org-comment">will</span><span class="org-whitespace-space"> </span><span class="org-comment">need</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">be</span><span class="org-whitespace-space"> </span><span class="org-comment">created</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">order</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">add</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">described</span><span class="org-whitespace-space"> </span><span class="org-comment">by</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas.</span><span class="org-whitespace-space">  </span><span class="org-comment">Because</span><span class="org-whitespace-space"> </span><span class="org-comment">we</span><span class="org-whitespace-space"> </span><span class="org-comment">cannot</span><span class="org-whitespace-space"> </span><span class="org-comment">store</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">multiple-index</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">at</span><span class="org-whitespace-space"> </span><span class="org-comment">index</span><span class="org-whitespace-space"> </span><span class="org-comment">0,</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">calculation</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">little</span><span class="org-whitespace-space"> </span><span class="org-comment">more</span><span class="org-whitespace-space"> </span><span class="org-comment">complex</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">than</span><span class="org-whitespace-space"> </span><span class="org-comment">you</span><span class="org-whitespace-space"> </span><span class="org-comment">might</span><span class="org-whitespace-space"> </span><span class="org-comment">expect.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_max</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_index;

<span class="org-preprocessor">#ifdef</span><span class="org-whitespace-space"> </span>CONFIG_XARRAY_MULTI
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_shift<span class="org-whitespace-space"> </span>||<span class="org-whitespace-space"> </span>xas-&gt;xa_sibs)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mask</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_size(xas)<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">                </span>max<span class="org-whitespace-space"> </span>|=<span class="org-whitespace-space"> </span>mask;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(mask<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>max)
<span class="org-whitespace-space">                        </span>max++;
<span class="org-whitespace-space">        </span>}
<span class="org-preprocessor">#endif</span>

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>max;
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">The</span><span class="org-whitespace-space"> </span><span class="org-comment">maximum</span><span class="org-whitespace-space"> </span><span class="org-comment">index</span><span class="org-whitespace-space"> </span><span class="org-comment">that</span><span class="org-whitespace-space"> </span><span class="org-comment">can</span><span class="org-whitespace-space"> </span><span class="org-comment">be</span><span class="org-whitespace-space"> </span><span class="org-comment">contained</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">array</span><span class="org-whitespace-space"> </span><span class="org-comment">without</span><span class="org-whitespace-space"> </span><span class="org-comment">expanding</span><span class="org-whitespace-space"> </span><span class="org-comment">it</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-function-name">max_index</span>(<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_node(entry))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(XA_CHUNK_SIZE<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>xa_to_node(entry)-&gt;shift)<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1;
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_shrink</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa;
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;

<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(;;)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">                </span>XA_NODE_BUG_ON(node,<span class="org-whitespace-space"> </span>node-&gt;count<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node-&gt;count<span class="org-whitespace-space"> </span>!=<span class="org-whitespace-space"> </span>1)
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry_locked(xa,<span class="org-whitespace-space"> </span>node,<span class="org-whitespace-space"> </span>0);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>entry)
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_node(entry)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>node-&gt;shift)
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_zero(entry)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>xa_zero_busy(xa))
<span class="org-whitespace-space">                        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">                </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XAS_BOUNDS;

<span class="org-whitespace-space">                </span>RCU_INIT_POINTER(xa-&gt;xa_head,<span class="org-whitespace-space"> </span>entry);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_track_free(xa)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>node_get_mark(node,<span class="org-whitespace-space"> </span>0,<span class="org-whitespace-space"> </span>XA_FREE_MARK))
<span class="org-whitespace-space">                        </span>xa_mark_clear(xa,<span class="org-whitespace-space"> </span>XA_FREE_MARK);

<span class="org-whitespace-space">                </span>node-&gt;count<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">                </span>node-&gt;nr_values<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_node(entry))
<span class="org-whitespace-space">                        </span>RCU_INIT_POINTER(node-&gt;slots[0],<span class="org-whitespace-space"> </span>XA_RETRY_ENTRY);
<span class="org-whitespace-space">                </span>xas_update(xas,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">                </span>xa_node_free(node);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_node(entry))
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span>node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(entry);
<span class="org-whitespace-space">                </span>node-&gt;parent<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">        </span>}
}

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">xas_delete_node()</span><span class="org-whitespace-space"> </span><span class="org-comment">-</span><span class="org-whitespace-space"> </span><span class="org-comment">Attempt</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">delete</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_node</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas:</span><span class="org-whitespace-space"> </span><span class="org-comment">Array</span><span class="org-whitespace-space"> </span><span class="org-comment">operation</span><span class="org-whitespace-space"> </span><span class="org-comment">state.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Attempts</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">delete</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas-&gt;xa_node.</span><span class="org-whitespace-space">  </span><span class="org-comment">This</span><span class="org-whitespace-space"> </span><span class="org-comment">will</span><span class="org-whitespace-space"> </span><span class="org-comment">fail</span><span class="org-whitespace-space"> </span><span class="org-comment">if</span><span class="org-whitespace-space"> </span><span class="org-comment">xa-&gt;node</span><span class="org-whitespace-space"> </span><span class="org-comment">has</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">non-zero</span><span class="org-whitespace-space"> </span><span class="org-comment">reference</span><span class="org-whitespace-space"> </span><span class="org-comment">count.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_delete_node</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;

<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(;;)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">parent</span>;

<span class="org-whitespace-space">                </span>XA_NODE_BUG_ON(node,<span class="org-whitespace-space"> </span>node-&gt;count<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node-&gt;count)
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;

<span class="org-whitespace-space">                </span>parent<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_parent_locked(xas-&gt;xa,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">                </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>parent;
<span class="org-whitespace-space">                </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>node-&gt;offset;
<span class="org-whitespace-space">                </span>xa_node_free(node);

<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>parent)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>xas-&gt;xa-&gt;xa_head<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">                        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XAS_BOUNDS;
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span>;
<span class="org-whitespace-space">                </span>}

<span class="org-whitespace-space">                </span>parent-&gt;slots[xas-&gt;xa_offset]<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">                </span>parent-&gt;count--;
<span class="org-whitespace-space">                </span>XA_NODE_BUG_ON(parent,<span class="org-whitespace-space"> </span>parent-&gt;count<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE);
<span class="org-whitespace-space">                </span>node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>parent;
<span class="org-whitespace-space">                </span>xas_update(xas,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>node-&gt;parent)
<span class="org-whitespace-space">                </span>xas_shrink(xas);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_free_nodes()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Free</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">node</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">nodes</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">references</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Array</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@top</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Node</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">free</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">node</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span><span class="org-whitespace-space"> </span><span class="org-doc">removed</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">tree.</span><span class="org-whitespace-space">  </span><span class="org-doc">We</span><span class="org-whitespace-space"> </span><span class="org-doc">must</span><span class="org-whitespace-space"> </span><span class="org-doc">now</span><span class="org-whitespace-space"> </span><span class="org-doc">free</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">its</span><span class="org-whitespace-space"> </span><span class="org-doc">subnodes.</span><span class="org-whitespace-space">  </span><span class="org-doc">There</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">walkers</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc">references</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">tree,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">so</span><span class="org-whitespace-space"> </span><span class="org-doc">we</span><span class="org-whitespace-space"> </span><span class="org-doc">must</span><span class="org-whitespace-space"> </span><span class="org-doc">replace</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">markers.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_free_nodes</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">top</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>top;

<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(;;)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry_locked(xas-&gt;xa,<span class="org-whitespace-space"> </span>node,<span class="org-whitespace-space"> </span>offset);

<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node-&gt;shift<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>xa_is_node(entry))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(entry);
<span class="org-whitespace-space">                        </span>offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">                        </span><span class="org-keyword">continue</span>;
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(entry)
<span class="org-whitespace-space">                        </span>RCU_INIT_POINTER(node-&gt;slots[offset],<span class="org-whitespace-space"> </span>XA_RETRY_ENTRY);
<span class="org-whitespace-space">                </span>offset++;
<span class="org-whitespace-space">                </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">parent</span>;

<span class="org-whitespace-space">                        </span>parent<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_parent_locked(xas-&gt;xa,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">                        </span>offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>node-&gt;offset<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">                        </span>node-&gt;count<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">                        </span>node-&gt;nr_values<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">                        </span>xas_update(xas,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">                        </span>xa_node_free(node);
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>top)
<span class="org-whitespace-space">                                </span><span class="org-keyword">return</span>;
<span class="org-whitespace-space">                        </span>node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>parent;
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">        </span>}
}

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">xas_expand</span><span class="org-whitespace-space"> </span><span class="org-comment">adds</span><span class="org-whitespace-space"> </span><span class="org-comment">nodes</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">head</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">tree</span><span class="org-whitespace-space"> </span><span class="org-comment">until</span><span class="org-whitespace-space"> </span><span class="org-comment">it</span><span class="org-whitespace-space"> </span><span class="org-comment">has</span><span class="org-whitespace-space"> </span><span class="org-comment">reached</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">sufficient</span><span class="org-whitespace-space"> </span><span class="org-comment">height</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">be</span><span class="org-whitespace-space"> </span><span class="org-comment">able</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">contain</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas-&gt;xa_index</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_expand</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">head</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa;
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">shift</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_max(xas);

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>head)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(max<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>0)
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">                </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>((max<span class="org-whitespace-space"> </span>&gt;&gt;<span class="org-whitespace-space"> </span>shift)<span class="org-whitespace-space"> </span>&gt;=<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE)
<span class="org-whitespace-space">                        </span>shift<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT;
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>shift<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT;
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_node(head))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(head);
<span class="org-whitespace-space">                </span>shift<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>node-&gt;shift<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT;
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(max<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>max_index(head))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;

<span class="org-whitespace-space">                </span>XA_NODE_BUG_ON(node,<span class="org-whitespace-space"> </span>shift<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>BITS_PER_LONG);
<span class="org-whitespace-space">                </span>node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_alloc(xas,<span class="org-whitespace-space"> </span>shift);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>node)
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>-ENOMEM;

<span class="org-whitespace-space">                </span>node-&gt;count<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_value(head))
<span class="org-whitespace-space">                        </span>node-&gt;nr_values<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">                </span>RCU_INIT_POINTER(node-&gt;slots[0],<span class="org-whitespace-space"> </span>head);

<span class="org-whitespace-space">                </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Propagate</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">aggregated</span><span class="org-whitespace-space"> </span><span class="org-comment">mark</span><span class="org-whitespace-space"> </span><span class="org-comment">info</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">new</span><span class="org-whitespace-space"> </span><span class="org-comment">child</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">                </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(;;)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_track_free(xa)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>mark<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_FREE_MARK)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                                </span>node_mark_all(node,<span class="org-whitespace-space"> </span>XA_FREE_MARK);
<span class="org-whitespace-space">                                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_marked(xa,<span class="org-whitespace-space"> </span>XA_FREE_MARK))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                                        </span>node_clear_mark(node,<span class="org-whitespace-space"> </span>0,<span class="org-whitespace-space"> </span>XA_FREE_MARK);
<span class="org-whitespace-space">                                        </span>xa_mark_set(xa,<span class="org-whitespace-space"> </span>XA_FREE_MARK);
<span class="org-whitespace-space">                                </span>}
<span class="org-whitespace-space">                        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_marked(xa,<span class="org-whitespace-space"> </span>mark))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                                </span>node_set_mark(node,<span class="org-whitespace-space"> </span>0,<span class="org-whitespace-space"> </span>mark);
<span class="org-whitespace-space">                        </span>}
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(mark<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_MARK_MAX)
<span class="org-whitespace-space">                                </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                        </span>mark_inc(mark);
<span class="org-whitespace-space">                </span>}

<span class="org-whitespace-space">                </span><span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space">                 </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Now</span><span class="org-whitespace-space"> </span><span class="org-comment">that</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">new</span><span class="org-whitespace-space"> </span><span class="org-comment">node</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">fully</span><span class="org-whitespace-space"> </span><span class="org-comment">initialised,</span><span class="org-whitespace-space"> </span><span class="org-comment">we</span><span class="org-whitespace-space"> </span><span class="org-comment">can</span><span class="org-whitespace-space"> </span><span class="org-comment">add</span>
<span class="org-whitespace-space">                 </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">it</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">tree</span>
<span class="org-whitespace-space">                 </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_node(head))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>xa_to_node(head)-&gt;offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">                        </span>rcu_assign_pointer(xa_to_node(head)-&gt;parent,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span>head<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_mk_node(node);
<span class="org-whitespace-space">                </span>rcu_assign_pointer(xa-&gt;xa_head,<span class="org-whitespace-space"> </span>head);
<span class="org-whitespace-space">                </span>xas_update(xas,<span class="org-whitespace-space"> </span>node);

<span class="org-whitespace-space">                </span>shift<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT;
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>node;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>shift;
}

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">xas_create()</span><span class="org-whitespace-space"> </span><span class="org-comment">-</span><span class="org-whitespace-space"> </span><span class="org-comment">Create</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">slot</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">store</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">in.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas:</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray</span><span class="org-whitespace-space"> </span><span class="org-comment">operation</span><span class="org-whitespace-space"> </span><span class="org-comment">state.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@allow_root:</span><span class="org-whitespace-space"> </span><span class="org-comment">%true</span><span class="org-whitespace-space"> </span><span class="org-comment">if</span><span class="org-whitespace-space"> </span><span class="org-comment">we</span><span class="org-whitespace-space"> </span><span class="org-comment">can</span><span class="org-whitespace-space"> </span><span class="org-comment">store</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">root</span><span class="org-whitespace-space"> </span><span class="org-comment">directly</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Most</span><span class="org-whitespace-space"> </span><span class="org-comment">users</span><span class="org-whitespace-space"> </span><span class="org-comment">will</span><span class="org-whitespace-space"> </span><span class="org-comment">not</span><span class="org-whitespace-space"> </span><span class="org-comment">need</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">call</span><span class="org-whitespace-space"> </span><span class="org-comment">this</span><span class="org-whitespace-space"> </span><span class="org-comment">function</span><span class="org-whitespace-space"> </span><span class="org-comment">directly,</span><span class="org-whitespace-space"> </span><span class="org-comment">as</span><span class="org-whitespace-space"> </span><span class="org-comment">it</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">called</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">by</span><span class="org-whitespace-space"> </span><span class="org-comment">xas_store().</span><span class="org-whitespace-space">  </span><span class="org-comment">It</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">useful</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">doing</span><span class="org-whitespace-space"> </span><span class="org-comment">conditional</span><span class="org-whitespace-space"> </span><span class="org-comment">store</span><span class="org-whitespace-space"> </span><span class="org-comment">operations</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">(see</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_cmpxchg()</span><span class="org-whitespace-space"> </span><span class="org-comment">implementation</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">example).</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Return:</span><span class="org-whitespace-space"> </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">slot</span><span class="org-whitespace-space"> </span><span class="org-comment">already</span><span class="org-whitespace-space"> </span><span class="org-comment">existed,</span><span class="org-whitespace-space"> </span><span class="org-comment">returns</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">contents</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">this</span><span class="org-whitespace-space"> </span><span class="org-comment">slot.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">slot</span><span class="org-whitespace-space"> </span><span class="org-comment">was</span><span class="org-whitespace-space"> </span><span class="org-comment">newly</span><span class="org-whitespace-space"> </span><span class="org-comment">created,</span><span class="org-whitespace-space"> </span><span class="org-comment">returns</span><span class="org-whitespace-space"> </span><span class="org-comment">%NULL.</span><span class="org-whitespace-space">  </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">it</span><span class="org-whitespace-space"> </span><span class="org-comment">failed</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">create</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">slot,</span><span class="org-whitespace-space"> </span><span class="org-comment">returns</span><span class="org-whitespace-space"> </span><span class="org-comment">%NULL</span><span class="org-whitespace-space"> </span><span class="org-comment">and</span><span class="org-whitespace-space"> </span><span class="org-comment">indicates</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">error</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_create</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-variable-name">allow_root</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa;
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-variable-name">__rcu</span><span class="org-whitespace-space"> </span>**slot;
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">shift</span>;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">order</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_shift;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_top(node))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_head_locked(xa);
<span class="org-whitespace-space">                </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>entry<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>xa_zero_busy(xa))
<span class="org-whitespace-space">                        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XA_ZERO_ENTRY;
<span class="org-whitespace-space">                </span>shift<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_expand(xas,<span class="org-whitespace-space"> </span>entry);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(shift<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>0)
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>shift<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>allow_root)
<span class="org-whitespace-space">                        </span>shift<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT;
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_head_locked(xa);
<span class="org-whitespace-space">                </span>slot<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>&amp;xa-&gt;xa_head;
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_error(xas))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_offset;

<span class="org-whitespace-space">                </span>shift<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>node-&gt;shift;
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry_locked(xa,<span class="org-whitespace-space"> </span>node,<span class="org-whitespace-space"> </span>offset);
<span class="org-whitespace-space">                </span>slot<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>&amp;node-&gt;slots[offset];
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>shift<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_head_locked(xa);
<span class="org-whitespace-space">                </span>slot<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>&amp;xa-&gt;xa_head;
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(shift<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>order)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>shift<span class="org-whitespace-space"> </span>-=<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>entry)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_alloc(xas,<span class="org-whitespace-space"> </span>shift);
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>node)
<span class="org-whitespace-space">                                </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_track_free(xa))
<span class="org-whitespace-space">                                </span>node_mark_all(node,<span class="org-whitespace-space"> </span>XA_FREE_MARK);
<span class="org-whitespace-space">                        </span>rcu_assign_pointer(*slot,<span class="org-whitespace-space"> </span>xa_mk_node(node));
<span class="org-whitespace-space">                </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_node(entry))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(entry);
<span class="org-whitespace-space">                </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_descend(xas,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">                </span>slot<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>&amp;node-&gt;slots[xas-&gt;xa_offset];
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_create_range()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Ensure</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">range</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">succeed</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Creates</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">slots</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">range</span><span class="org-whitespace-space"> </span><span class="org-doc">covered</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">Sets</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">to</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">create</span><span class="org-whitespace-space"> </span><span class="org-doc">single-index</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">positions</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">beginning</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">range.</span><span class="org-whitespace-space">  </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">benefit</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">users</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">yet</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">converted</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">use</span><span class="org-whitespace-space"> </span><span class="org-doc">multi-index</span><span class="org-whitespace-space"> </span><span class="org-doc">entries.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_create_range</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_index;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">char</span><span class="org-whitespace-space"> </span><span class="org-variable-name">shift</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_shift;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">char</span><span class="org-whitespace-space"> </span><span class="org-variable-name">sibs</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_sibs;

<span class="org-whitespace-space">        </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>|=<span class="org-whitespace-space"> </span>((sibs<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1)<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>shift)<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_is_node(xas)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>xas-&gt;xa_node-&gt;shift<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>xas-&gt;xa_shift)
<span class="org-whitespace-space">                </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>|=<span class="org-whitespace-space"> </span>sibs;
<span class="org-whitespace-space">        </span>xas-&gt;xa_shift<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">        </span>xas-&gt;xa_sibs<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;

<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(;;)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas_create(xas,<span class="org-whitespace-space"> </span><span class="org-constant">true</span>);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_error(xas))
<span class="org-whitespace-space">                        </span><span class="org-keyword">goto</span><span class="org-whitespace-space"> </span><span class="org-constant">restore</span>;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_index<span class="org-whitespace-space"> </span>&lt;=<span class="org-whitespace-space"> </span>(index<span class="org-whitespace-space"> </span>|<span class="org-whitespace-space"> </span>XA_CHUNK_MASK))
<span class="org-whitespace-space">                        </span><span class="org-keyword">goto</span><span class="org-whitespace-space"> </span><span class="org-constant">success</span>;
<span class="org-whitespace-space">                </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>-=<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE;

<span class="org-whitespace-space">                </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(;;)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;
<span class="org-whitespace-space">                        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_parent_locked(xas-&gt;xa,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">                        </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>node-&gt;offset<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node-&gt;offset<span class="org-whitespace-space"> </span>!=<span class="org-whitespace-space"> </span>0)
<span class="org-whitespace-space">                                </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">        </span>}

<span class="org-constant">restore</span>:
<span class="org-whitespace-space">        </span>xas-&gt;xa_shift<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>shift;
<span class="org-whitespace-space">        </span>xas-&gt;xa_sibs<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>sibs;
<span class="org-whitespace-space">        </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>index;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span>;
<span class="org-constant">success</span>:
<span class="org-whitespace-space">        </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>index;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_node)
<span class="org-whitespace-space">                </span>xas_set_offset(xas);
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(xas_create_range);

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">update_node</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>,
<span class="org-whitespace-space">                </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">count</span>,<span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">values</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>node<span class="org-whitespace-space"> </span>||<span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>count<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>values))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span>;

<span class="org-whitespace-space">        </span>node-&gt;count<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>count;
<span class="org-whitespace-space">        </span>node-&gt;nr_values<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>values;
<span class="org-whitespace-space">        </span>XA_NODE_BUG_ON(node,<span class="org-whitespace-space"> </span>node-&gt;count<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE);
<span class="org-whitespace-space">        </span>XA_NODE_BUG_ON(node,<span class="org-whitespace-space"> </span>node-&gt;nr_values<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE);
<span class="org-whitespace-space">        </span>xas_update(xas,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(count<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>0)
<span class="org-whitespace-space">                </span>xas_delete_node(xas);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_store()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">operating</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">multi-index</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">returned</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">essentially</span><span class="org-whitespace-space"> </span><span class="org-doc">meaningless</span><span class="org-whitespace-space"> </span><span class="org-doc">(it</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">internal</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">even</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">there</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">non-NULL</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">some</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">indices</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">covered</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">range).</span><span class="org-whitespace-space">  </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">problem</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">any</span><span class="org-whitespace-space"> </span><span class="org-doc">current</span><span class="org-whitespace-space"> </span><span class="org-doc">users,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">can</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">changed</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">needed.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">old</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_store</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>;
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-variable-name">__rcu</span><span class="org-whitespace-space"> </span>**slot<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>&amp;xas-&gt;xa-&gt;xa_head;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>;
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">count</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">values</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">first</span>,<span class="org-whitespace-space"> </span>*<span class="org-variable-name">next</span>;
<span class="org-whitespace-space">        </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-variable-name">value</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_is_value(entry);

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(entry)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-variable-name">allow_root</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>xa_is_node(entry)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>xa_is_zero(entry);
<span class="org-whitespace-space">                </span>first<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_create(xas,<span class="org-whitespace-space"> </span>allow_root);
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>first<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_load(xas);
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_invalid(xas))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>first;
<span class="org-whitespace-space">        </span>node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>(xas-&gt;xa_shift<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>node-&gt;shift))
<span class="org-whitespace-space">                </span>xas-&gt;xa_sibs<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>((first<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>entry)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>xas-&gt;xa_sibs)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>first;

<span class="org-whitespace-space">        </span>next<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>first;
<span class="org-whitespace-space">        </span>offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_offset;
<span class="org-whitespace-space">        </span>max<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>xas-&gt;xa_sibs;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>slot<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>&amp;node-&gt;slots[offset];
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_sibs)
<span class="org-whitespace-space">                        </span>xas_squash_marks(xas);
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>entry)
<span class="org-whitespace-space">                </span>xas_init_marks(xas);

<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(;;)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space">                 </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Must</span><span class="org-whitespace-space"> </span><span class="org-comment">clear</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">marks</span><span class="org-whitespace-space"> </span><span class="org-comment">before</span><span class="org-whitespace-space"> </span><span class="org-comment">setting</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">NULL,</span>
<span class="org-whitespace-space">                 </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">otherwise</span><span class="org-whitespace-space"> </span><span class="org-comment">xas_for_each_marked</span><span class="org-whitespace-space"> </span><span class="org-comment">may</span><span class="org-whitespace-space"> </span><span class="org-comment">find</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">NULL</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">and</span>
<span class="org-whitespace-space">                 </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">stop</span><span class="org-whitespace-space"> </span><span class="org-comment">early.</span><span class="org-whitespace-space">  </span><span class="org-comment">rcu_assign_pointer</span><span class="org-whitespace-space"> </span><span class="org-comment">contains</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">release</span><span class="org-whitespace-space"> </span><span class="org-comment">barrier</span>
<span class="org-whitespace-space">                 </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">so</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">mark</span><span class="org-whitespace-space"> </span><span class="org-comment">clearing</span><span class="org-whitespace-space"> </span><span class="org-comment">will</span><span class="org-whitespace-space"> </span><span class="org-comment">appear</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">happen</span><span class="org-whitespace-space"> </span><span class="org-comment">before</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span>
<span class="org-whitespace-space">                 </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">set</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">NULL.</span>
<span class="org-whitespace-space">                 </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">                </span>rcu_assign_pointer(*slot,<span class="org-whitespace-space"> </span>entry);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_node(next)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>node<span class="org-whitespace-space"> </span>||<span class="org-whitespace-space"> </span>node-&gt;shift))
<span class="org-whitespace-space">                        </span>xas_free_nodes(xas,<span class="org-whitespace-space"> </span>xa_to_node(next));
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>node)
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span>count<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>next<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>entry;
<span class="org-whitespace-space">                </span>values<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>xa_is_value(first)<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>value;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(entry)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>max)
<span class="org-whitespace-space">                                </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_sibling(entry))
<span class="org-whitespace-space">                                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_mk_sibling(xas-&gt;xa_offset);
<span class="org-whitespace-space">                </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_CHUNK_MASK)
<span class="org-whitespace-space">                                </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span>next<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry_locked(xas-&gt;xa,<span class="org-whitespace-space"> </span>node,<span class="org-whitespace-space"> </span>++offset);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_sibling(next))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>entry<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>(offset<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>max))
<span class="org-whitespace-space">                                </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                        </span>first<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>next;
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span>slot++;
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span>update_node(xas,<span class="org-whitespace-space"> </span>node,<span class="org-whitespace-space"> </span>count,<span class="org-whitespace-space"> </span>values);
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>first;
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(xas_store);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_get_mark()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Returns</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">mark.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@mark</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Mark</span><span class="org-whitespace-space"> </span><span class="org-doc">number.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">true</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">set,</span><span class="org-whitespace-space"> </span><span class="org-doc">false</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">clear</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_get_mark</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_invalid(xas))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">false</span>;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_node)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_marked(xas-&gt;xa,<span class="org-whitespace-space"> </span>mark);
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>node_get_mark(xas-&gt;xa_node,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset,<span class="org-whitespace-space"> </span>mark);
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(xas_get_mark);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_set_mark()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Sets</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">its</span><span class="org-whitespace-space"> </span><span class="org-doc">parents.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@mark</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Mark</span><span class="org-whitespace-space"> </span><span class="org-doc">number.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Sets</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">specified</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">walks</span><span class="org-whitespace-space"> </span><span class="org-doc">up</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">tree</span><span class="org-whitespace-space"> </span><span class="org-doc">setting</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">ancestor</span><span class="org-whitespace-space"> </span><span class="org-doc">entries.</span><span class="org-whitespace-space">  </span><span class="org-doc">Does</span><span class="org-whitespace-space"> </span><span class="org-doc">nothing</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span><span class="org-whitespace-space"> </span><span class="org-doc">walked</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_set_mark</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_offset;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_invalid(xas))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(node)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node_set_mark(node,<span class="org-whitespace-space"> </span>offset,<span class="org-whitespace-space"> </span>mark))
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span>;
<span class="org-whitespace-space">                </span>offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>node-&gt;offset;
<span class="org-whitespace-space">                </span>node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_parent_locked(xas-&gt;xa,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_marked(xas-&gt;xa,<span class="org-whitespace-space"> </span>mark))
<span class="org-whitespace-space">                </span>xa_mark_set(xas-&gt;xa,<span class="org-whitespace-space"> </span>mark);
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(xas_set_mark);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_clear_mark()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Clears</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">its</span><span class="org-whitespace-space"> </span><span class="org-doc">parents.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@mark</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Mark</span><span class="org-whitespace-space"> </span><span class="org-doc">number.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Clears</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">specified</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">walks</span><span class="org-whitespace-space"> </span><span class="org-doc">back</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">head</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">attempting</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">clear</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">ancestor</span><span class="org-whitespace-space"> </span><span class="org-doc">entries.</span><span class="org-whitespace-space">  </span><span class="org-doc">Does</span><span class="org-whitespace-space"> </span><span class="org-doc">nothing</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span><span class="org-whitespace-space"> </span><span class="org-doc">walked</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_clear_mark</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_offset;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_invalid(xas))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(node)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>node_clear_mark(node,<span class="org-whitespace-space"> </span>offset,<span class="org-whitespace-space"> </span>mark))
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span>;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node_any_mark(node,<span class="org-whitespace-space"> </span>mark))
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span>;

<span class="org-whitespace-space">                </span>offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>node-&gt;offset;
<span class="org-whitespace-space">                </span>node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_parent_locked(xas-&gt;xa,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_marked(xas-&gt;xa,<span class="org-whitespace-space"> </span>mark))
<span class="org-whitespace-space">                </span>xa_mark_clear(xas-&gt;xa,<span class="org-whitespace-space"> </span>mark);
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(xas_clear_mark);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_init_marks()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Initialise</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">marks</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Array</span><span class="org-whitespace-space"> </span><span class="org-doc">operations</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Initialise</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">marks</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">specified</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">we're</span><span class="org-whitespace-space"> </span><span class="org-doc">tracking</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">free</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">mark,</span><span class="org-whitespace-space"> </span><span class="org-doc">we</span><span class="org-whitespace-space"> </span><span class="org-doc">need</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">entries.</span><span class="org-whitespace-space">  </span><span class="org-doc">All</span><span class="org-whitespace-space"> </span><span class="org-doc">other</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">marks</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">cleared.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">implementation</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">as</span><span class="org-whitespace-space"> </span><span class="org-doc">efficient</span><span class="org-whitespace-space"> </span><span class="org-doc">as</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">could</span><span class="org-whitespace-space"> </span><span class="org-doc">be;</span><span class="org-whitespace-space"> </span><span class="org-doc">we</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">walk</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">up</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">tree</span><span class="org-whitespace-space"> </span><span class="org-doc">multiple</span><span class="org-whitespace-space"> </span><span class="org-doc">times.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_init_marks</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;

<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(;;)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_track_free(xas-&gt;xa)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>mark<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_FREE_MARK)
<span class="org-whitespace-space">                        </span>xas_set_mark(xas,<span class="org-whitespace-space"> </span>mark);
<span class="org-whitespace-space">                </span><span class="org-keyword">else</span>
<span class="org-whitespace-space">                        </span>xas_clear_mark(xas,<span class="org-whitespace-space"> </span>mark);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(mark<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_MARK_MAX)
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span>mark_inc(mark);
<span class="org-whitespace-space">        </span>}
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(xas_init_marks);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_pause()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Pause</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">walk</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">drop</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Some</span><span class="org-whitespace-space"> </span><span class="org-doc">users</span><span class="org-whitespace-space"> </span><span class="org-doc">need</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">pause</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">walk</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">drop</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">lock</span><span class="org-whitespace-space"> </span><span class="org-doc">they're</span><span class="org-whitespace-space"> </span><span class="org-doc">holding</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">order</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">yield</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">higher</span><span class="org-whitespace-space"> </span><span class="org-doc">priority</span><span class="org-whitespace-space"> </span><span class="org-doc">thread</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">carry</span><span class="org-whitespace-space"> </span><span class="org-doc">out</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span><span class="org-whitespace-space">  </span><span class="org-doc">Those</span><span class="org-whitespace-space"> </span><span class="org-doc">users</span><span class="org-whitespace-space"> </span><span class="org-doc">should</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">before</span><span class="org-whitespace-space"> </span><span class="org-doc">they</span><span class="org-whitespace-space"> </span><span class="org-doc">drop</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">resets</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">suitable</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">loop</span><span class="org-whitespace-space"> </span><span class="org-doc">after</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">user</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">reacquired</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">most</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">found</span><span class="org-whitespace-space"> </span><span class="org-doc">during</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">walk</span><span class="org-whitespace-space"> </span><span class="org-doc">require</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_pause()</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_for_each()</span></span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">iterator</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">more</span><span class="org-whitespace-space"> </span><span class="org-doc">appropriate.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Note</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_pause()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">only</span><span class="org-whitespace-space"> </span><span class="org-doc">works</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">forward</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">user</span><span class="org-whitespace-space"> </span><span class="org-doc">needs</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">pause</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">reverse</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration,</span><span class="org-whitespace-space"> </span><span class="org-doc">we</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">need</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_pause_rev()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_pause</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_invalid(xas))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_offset;
<span class="org-whitespace-space">                </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(++offset<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_sibling(xa_entry(xas-&gt;xa,<span class="org-whitespace-space"> </span>node,<span class="org-whitespace-space"> </span>offset)))
<span class="org-whitespace-space">                                </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>(offset<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>xas-&gt;xa_offset)<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>node-&gt;shift;
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas-&gt;xa_index++;
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XAS_RESTART;
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(xas_pause);

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">__xas_prev()</span><span class="org-whitespace-space"> </span><span class="org-comment">-</span><span class="org-whitespace-space"> </span><span class="org-comment">Find</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">previous</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas:</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray</span><span class="org-whitespace-space"> </span><span class="org-comment">operation</span><span class="org-whitespace-space"> </span><span class="org-comment">state.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Helper</span><span class="org-whitespace-space"> </span><span class="org-comment">function</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">xas_prev()</span><span class="org-whitespace-space"> </span><span class="org-comment">which</span><span class="org-whitespace-space"> </span><span class="org-comment">handles</span><span class="org-whitespace-space"> </span><span class="org-comment">all</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">complex</span><span class="org-whitespace-space"> </span><span class="org-comment">cases</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">out</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">line.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">__xas_prev</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas_frozen(xas-&gt;xa_node))
<span class="org-whitespace-space">                </span>xas-&gt;xa_index--;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_node)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>set_bounds(xas);
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_not_node(xas-&gt;xa_node))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_load(xas);

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_offset<span class="org-whitespace-space"> </span>!=<span class="org-whitespace-space"> </span>get_offset(xas-&gt;xa_index,<span class="org-whitespace-space"> </span>xas-&gt;xa_node))
<span class="org-whitespace-space">                </span>xas-&gt;xa_offset--;

<span class="org-whitespace-space">        </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>255)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node-&gt;offset<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">                </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_parent(xas-&gt;xa,<span class="org-whitespace-space"> </span>xas-&gt;xa_node);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_node)
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>set_bounds(xas);
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(;;)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry(xas-&gt;xa,<span class="org-whitespace-space"> </span>xas-&gt;xa_node,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_node(entry))
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;

<span class="org-whitespace-space">                </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(entry);
<span class="org-whitespace-space">                </span>xas_set_offset(xas);
<span class="org-whitespace-space">        </span>}
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(__xas_prev);

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">__xas_next()</span><span class="org-whitespace-space"> </span><span class="org-comment">-</span><span class="org-whitespace-space"> </span><span class="org-comment">Find</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">next</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@xas:</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray</span><span class="org-whitespace-space"> </span><span class="org-comment">operation</span><span class="org-whitespace-space"> </span><span class="org-comment">state.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Helper</span><span class="org-whitespace-space"> </span><span class="org-comment">function</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">xas_next()</span><span class="org-whitespace-space"> </span><span class="org-comment">which</span><span class="org-whitespace-space"> </span><span class="org-comment">handles</span><span class="org-whitespace-space"> </span><span class="org-comment">all</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">complex</span><span class="org-whitespace-space"> </span><span class="org-comment">cases</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">out</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">line.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">__xas_next</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas_frozen(xas-&gt;xa_node))
<span class="org-whitespace-space">                </span>xas-&gt;xa_index++;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_node)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>set_bounds(xas);
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_not_node(xas-&gt;xa_node))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_load(xas);

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_offset<span class="org-whitespace-space"> </span>!=<span class="org-whitespace-space"> </span>get_offset(xas-&gt;xa_index,<span class="org-whitespace-space"> </span>xas-&gt;xa_node))
<span class="org-whitespace-space">                </span>xas-&gt;xa_offset++;

<span class="org-whitespace-space">        </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node-&gt;offset<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">                </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_parent(xas-&gt;xa,<span class="org-whitespace-space"> </span>xas-&gt;xa_node);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_node)
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>set_bounds(xas);
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(;;)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry(xas-&gt;xa,<span class="org-whitespace-space"> </span>xas-&gt;xa_node,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_node(entry))
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;

<span class="org-whitespace-space">                </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(entry);
<span class="org-whitespace-space">                </span>xas_set_offset(xas);
<span class="org-whitespace-space">        </span>}
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(__xas_next);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_find()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Find</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">present</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@max</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Highest</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">return.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">yet</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span><span class="org-whitespace-space"> </span><span class="org-doc">walked</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">&gt;=</span><span class="org-whitespace-space"> </span><span class="org-doc">xas.xa_index.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span><span class="org-whitespace-space"> </span><span class="org-doc">walked,</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">currently</span><span class="org-whitespace-space"> </span><span class="org-doc">being</span><span class="org-whitespace-space"> </span><span class="org-doc">pointed</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span><span class="org-whitespace-space"> </span><span class="org-doc">processed,</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">so</span><span class="org-whitespace-space"> </span><span class="org-doc">we</span><span class="org-whitespace-space"> </span><span class="org-doc">move</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">found</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">smaller</span><span class="org-whitespace-space"> </span><span class="org-doc">than</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@max</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iterator</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">smallest</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">yet</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span><span class="org-whitespace-space">  </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">allows</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">immediately</span><span class="org-whitespace-space"> </span><span class="org-doc">passed</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_store()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">found,</span><span class="org-whitespace-space"> </span><span class="org-doc">otherwise</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_find</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_error(xas))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_node)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>set_bounds(xas);
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_top(xas-&gt;xa_node))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_load(xas);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(entry<span class="org-whitespace-space"> </span>||<span class="org-whitespace-space"> </span>xas_not_node(xas-&gt;xa_node))
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_node-&gt;shift<span class="org-whitespace-space"> </span>&amp;&amp;
<span class="org-whitespace-space">                    </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>!=<span class="org-whitespace-space"> </span>(xas-&gt;xa_index<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_CHUNK_MASK))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>((xas-&gt;xa_index<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1)<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_CHUNK_MASK)<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span>xas_advance(xas);

<span class="org-whitespace-space">        </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_node<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>(xas-&gt;xa_index<span class="org-whitespace-space"> </span>&lt;=<span class="org-whitespace-space"> </span>max))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(unlikely(xas-&gt;xa_offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node-&gt;offset<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">                        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_parent(xas-&gt;xa,<span class="org-whitespace-space"> </span>xas-&gt;xa_node);
<span class="org-whitespace-space">                        </span><span class="org-keyword">continue</span>;
<span class="org-whitespace-space">                </span>}

<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry(xas-&gt;xa,<span class="org-whitespace-space"> </span>xas-&gt;xa_node,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_node(entry))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(entry);
<span class="org-whitespace-space">                        </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">                        </span><span class="org-keyword">continue</span>;
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(entry<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>xa_is_sibling(entry))
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;

<span class="org-whitespace-space">                </span>xas_advance(xas);
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_node)
<span class="org-whitespace-space">                </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XAS_BOUNDS;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(xas_find);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_find_marked()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Find</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">marked</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@max</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Highest</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">return.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@mark</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Mark</span><span class="org-whitespace-space"> </span><span class="org-doc">number</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">search</span><span class="org-whitespace-space"> </span><span class="org-doc">for.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">yet</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span><span class="org-whitespace-space"> </span><span class="org-doc">walked</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">marked</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">&gt;=</span><span class="org-whitespace-space"> </span><span class="org-doc">xas.xa_index.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span><span class="org-whitespace-space"> </span><span class="org-doc">walked,</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">currently</span><span class="org-whitespace-space"> </span><span class="org-doc">being</span><span class="org-whitespace-space"> </span><span class="org-doc">pointed</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span><span class="org-whitespace-space"> </span><span class="org-doc">processed,</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">so</span><span class="org-whitespace-space"> </span><span class="org-doc">we</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">first</span><span class="org-whitespace-space"> </span><span class="org-doc">marked</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">&gt;</span><span class="org-whitespace-space"> </span><span class="org-doc">xas.xa_index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">marked</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">found</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">smaller</span><span class="org-whitespace-space"> </span><span class="org-doc">than</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@max</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">bounds</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">xas-&gt;xa_index</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">smallest</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">yet</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span><span class="org-whitespace-space">  </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">allows</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">immediately</span><span class="org-whitespace-space"> </span><span class="org-doc">passed</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_store()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">found</span><span class="org-whitespace-space"> </span><span class="org-doc">before</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@max</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">reached,</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">restart</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">found,</span><span class="org-whitespace-space"> </span><span class="org-doc">otherwise</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_find_marked</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-variable-name">advance</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">true</span>;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span>;
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_error(xas))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_node)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">                </span><span class="org-keyword">goto</span><span class="org-whitespace-space"> </span><span class="org-constant">out</span>;
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_top(xas-&gt;xa_node))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>advance<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">false</span>;
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_head(xas-&gt;xa);
<span class="org-whitespace-space">                </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_index<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>max_index(entry))
<span class="org-whitespace-space">                        </span><span class="org-keyword">goto</span><span class="org-whitespace-space"> </span><span class="org-constant">out</span>;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_node(entry))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_marked(xas-&gt;xa,<span class="org-whitespace-space"> </span>mark))
<span class="org-whitespace-space">                                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
<span class="org-whitespace-space">                        </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">                        </span><span class="org-keyword">goto</span><span class="org-whitespace-space"> </span><span class="org-constant">out</span>;
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(entry);
<span class="org-whitespace-space">                </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>&gt;&gt;<span class="org-whitespace-space"> </span>xas-&gt;xa_node-&gt;shift;
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_index<span class="org-whitespace-space"> </span>&lt;=<span class="org-whitespace-space"> </span>max)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(unlikely(xas-&gt;xa_offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node-&gt;offset<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">                        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_parent(xas-&gt;xa,<span class="org-whitespace-space"> </span>xas-&gt;xa_node);
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_node)
<span class="org-whitespace-space">                                </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                        </span>advance<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">false</span>;
<span class="org-whitespace-space">                        </span><span class="org-keyword">continue</span>;
<span class="org-whitespace-space">                </span>}

<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>advance)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry(xas-&gt;xa,<span class="org-whitespace-space"> </span>xas-&gt;xa_node,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset);
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_sibling(entry))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                                </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_sibling(entry);
<span class="org-whitespace-space">                                </span>xas_move_index(xas,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset);
<span class="org-whitespace-space">                        </span>}
<span class="org-whitespace-space">                </span>}

<span class="org-whitespace-space">                </span>offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_find_chunk(xas,<span class="org-whitespace-space"> </span>advance,<span class="org-whitespace-space"> </span>mark);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(offset<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>xas-&gt;xa_offset)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>advance<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">false</span>;
<span class="org-whitespace-space">                        </span>xas_move_index(xas,<span class="org-whitespace-space"> </span>offset);
<span class="org-whitespace-space">                        </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Mind</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">wrap</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>((xas-&gt;xa_index<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1)<span class="org-whitespace-space"> </span>&gt;=<span class="org-whitespace-space"> </span>max)
<span class="org-whitespace-space">                                </span><span class="org-keyword">goto</span><span class="org-whitespace-space"> </span><span class="org-constant">max</span>;
<span class="org-whitespace-space">                        </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>offset;
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE)
<span class="org-whitespace-space">                                </span><span class="org-keyword">continue</span>;
<span class="org-whitespace-space">                </span>}

<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry(xas-&gt;xa,<span class="org-whitespace-space"> </span>xas-&gt;xa_node,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_node(entry))
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
<span class="org-whitespace-space">                </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(entry);
<span class="org-whitespace-space">                </span>xas_set_offset(xas);
<span class="org-whitespace-space">        </span>}

<span class="org-constant">out</span>:
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_index<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>max)
<span class="org-whitespace-space">                </span><span class="org-keyword">goto</span><span class="org-whitespace-space"> </span><span class="org-constant">max</span>;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>set_bounds(xas);
<span class="org-constant">max</span>:
<span class="org-whitespace-space">        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XAS_RESTART;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(xas_find_marked);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_find_conflict()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Find</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">present</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">range.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">describes</span><span class="org-whitespace-space"> </span><span class="org-doc">both</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">range</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">position</span><span class="org-whitespace-space"> </span><span class="org-doc">within</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">range.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Expects</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">held.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">range</span><span class="org-whitespace-space"> </span><span class="org-doc">covered</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_find_conflict</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">curr</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_error(xas))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_node)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_top(xas-&gt;xa_node))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_start(xas);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>curr)
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">                </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(xa_is_node(curr))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(curr);
<span class="org-whitespace-space">                        </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_descend(xas,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(curr)
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>curr;
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_node-&gt;shift<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>xas-&gt;xa_shift)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(;;)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_node-&gt;shift<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>xas-&gt;xa_shift)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>((xas-&gt;xa_offset<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>xas-&gt;xa_sibs)<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>xas-&gt;xa_sibs)
<span class="org-whitespace-space">                                </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_CHUNK_MASK)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node-&gt;offset;
<span class="org-whitespace-space">                        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_parent_locked(xas-&gt;xa,<span class="org-whitespace-space"> </span>xas-&gt;xa_node);
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas-&gt;xa_node)
<span class="org-whitespace-space">                                </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                        </span><span class="org-keyword">continue</span>;
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry_locked(xas-&gt;xa,<span class="org-whitespace-space"> </span>xas-&gt;xa_node,<span class="org-whitespace-space"> </span>++xas-&gt;xa_offset);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_sibling(curr))
<span class="org-whitespace-space">                        </span><span class="org-keyword">continue</span>;
<span class="org-whitespace-space">                </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(xa_is_node(curr))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(curr);
<span class="org-whitespace-space">                        </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">                        </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry_locked(xas-&gt;xa,<span class="org-whitespace-space"> </span>xas-&gt;xa_node,<span class="org-whitespace-space"> </span>0);
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(curr)
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>curr;
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>-=<span class="org-whitespace-space"> </span>xas-&gt;xa_sibs;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
}
<span class="org-function-name">EXPORT_SYMBOL_GPL</span>(xas_find_conflict);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_load()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Load</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_load</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>index);
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span>rcu_read_lock();
<span class="org-whitespace-space">        </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_load(&amp;xas);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_zero(entry))
<span class="org-whitespace-space">                        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(xas_retry(&amp;xas,<span class="org-whitespace-space"> </span>entry));
<span class="org-whitespace-space">        </span>rcu_read_unlock();

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
}
<span class="org-function-name">EXPORT_SYMBOL</span>(xa_load);

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_result</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">curr</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_zero(curr))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_error(xas))
<span class="org-whitespace-space">                </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>curr;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">__xa_erase()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Erase</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc">locked.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">After</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">returns,</span><span class="org-whitespace-space"> </span><span class="org-doc">loading</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">part</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">multi-index</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">indices</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">erased</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">none</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">part</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">multi-index</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Expects</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">held</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">used</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">__xa_erase</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>index);
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_result(&amp;xas,<span class="org-whitespace-space"> </span>xas_store(&amp;xas,<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>));
}
<span class="org-function-name">EXPORT_SYMBOL</span>(__xa_erase);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_erase()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Erase</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">After</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">returns,</span><span class="org-whitespace-space"> </span><span class="org-doc">loading</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">part</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">multi-index</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">indices</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">erased</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">none</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">part</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">multi-index</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">used</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_erase</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span>xa_lock(xa);
<span class="org-whitespace-space">        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_erase(xa,<span class="org-whitespace-space"> </span>index);
<span class="org-whitespace-space">        </span>xa_unlock(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
}
<span class="org-function-name">EXPORT_SYMBOL</span>(xa_erase);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">__xa_store()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">You</span><span class="org-whitespace-space"> </span><span class="org-doc">must</span><span class="org-whitespace-space"> </span><span class="org-doc">already</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">holding</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">when</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">drop</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">lock</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">needed</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">allocate</span><span class="org-whitespace-space"> </span><span class="org-doc">memory,</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">then</span><span class="org-whitespace-space"> </span><span class="org-doc">reacquire</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">afterwards.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Expects</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">held</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">release</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">reacquire</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">old</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_err()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">happened.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">__xa_store</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>index);
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">curr</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(WARN_ON_ONCE(xa_is_advanced(entry)))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>XA_ERROR(-EINVAL);
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_track_free(xa)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>entry)
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XA_ZERO_ENTRY;

<span class="org-whitespace-space">        </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_store(&amp;xas,<span class="org-whitespace-space"> </span>entry);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_track_free(xa))
<span class="org-whitespace-space">                        </span>xas_clear_mark(&amp;xas,<span class="org-whitespace-space"> </span>XA_FREE_MARK);
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(__xas_nomem(&amp;xas,<span class="org-whitespace-space"> </span>gfp));

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_result(&amp;xas,<span class="org-whitespace-space"> </span>curr);
}
<span class="org-function-name">EXPORT_SYMBOL</span>(__xa_store);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_store()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">After</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">returns,</span><span class="org-whitespace-space"> </span><span class="org-doc">loads</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Storing</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">existing</span><span class="org-whitespace-space"> </span><span class="org-doc">multislot</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">updates</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">every</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">marks</span><span class="org-whitespace-space"> </span><span class="org-doc">associated</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">unaffected</span><span class="org-whitespace-space"> </span><span class="org-doc">unless</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">old</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">success,</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_err(-EINVAL)</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">cannot</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray,</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_err(-ENOMEM)</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">failed.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_store</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">curr</span>;

<span class="org-whitespace-space">        </span>xa_lock(xa);
<span class="org-whitespace-space">        </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_store(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>curr;
}
<span class="org-function-name">EXPORT_SYMBOL</span>(xa_store);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">__xa_cmpxchg()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@old</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Old</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">test</span><span class="org-whitespace-space"> </span><span class="org-doc">against.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">You</span><span class="org-whitespace-space"> </span><span class="org-doc">must</span><span class="org-whitespace-space"> </span><span class="org-doc">already</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">holding</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">when</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">drop</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">lock</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">needed</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">allocate</span><span class="org-whitespace-space"> </span><span class="org-doc">memory,</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">then</span><span class="org-whitespace-space"> </span><span class="org-doc">reacquire</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">afterwards.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Expects</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">held</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">release</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">reacquire</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">old</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_err()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">happened.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">__xa_cmpxchg</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,
<span class="org-whitespace-space">                        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">old</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>index);
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">curr</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(WARN_ON_ONCE(xa_is_advanced(entry)))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>XA_ERROR(-EINVAL);

<span class="org-whitespace-space">        </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_load(&amp;xas);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(curr<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>old)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>xas_store(&amp;xas,<span class="org-whitespace-space"> </span>entry);
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_track_free(xa)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>entry<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>curr)
<span class="org-whitespace-space">                                </span>xas_clear_mark(&amp;xas,<span class="org-whitespace-space"> </span>XA_FREE_MARK);
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(__xas_nomem(&amp;xas,<span class="org-whitespace-space"> </span>gfp));

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_result(&amp;xas,<span class="org-whitespace-space"> </span>curr);
}
<span class="org-function-name">EXPORT_SYMBOL</span>(__xa_cmpxchg);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">__xa_insert()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">present.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Inserting</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">reserved</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">(like</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_reserve()</span></span><span class="org-doc">)</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">present.</span><span class="org-whitespace-space">  </span><span class="org-doc">Inserting</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">fail</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">reserved</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">present,</span><span class="org-whitespace-space"> </span><span class="org-doc">even</span><span class="org-whitespace-space"> </span><span class="org-doc">though</span><span class="org-whitespace-space"> </span><span class="org-doc">loading</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Expects</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">held</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">release</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">reacquire</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded.</span><span class="org-whitespace-space">  </span><span class="org-doc">-EBUSY</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">another</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">was</span><span class="org-whitespace-space"> </span><span class="org-doc">present.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">could</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">__xa_insert</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>index);
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">curr</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(WARN_ON_ONCE(xa_is_advanced(entry)))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>-EINVAL;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>entry)
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XA_ZERO_ENTRY;

<span class="org-whitespace-space">        </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_load(&amp;xas);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>curr)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>xas_store(&amp;xas,<span class="org-whitespace-space"> </span>entry);
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_track_free(xa))
<span class="org-whitespace-space">                                </span>xas_clear_mark(&amp;xas,<span class="org-whitespace-space"> </span>XA_FREE_MARK);
<span class="org-whitespace-space">                </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>xas_set_err(&amp;xas,<span class="org-whitespace-space"> </span>-EBUSY);
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(__xas_nomem(&amp;xas,<span class="org-whitespace-space"> </span>gfp));

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_error(&amp;xas);
}
<span class="org-function-name">EXPORT_SYMBOL</span>(__xa_insert);

<span class="org-preprocessor">#ifdef</span><span class="org-whitespace-space"> </span>CONFIG_XARRAY_MULTI
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_set_range</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">first</span>,
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">last</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">shift</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">sibs</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>last<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>first;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XA_CHUNK_MASK;

<span class="org-whitespace-space">        </span>xas_set(xas,<span class="org-whitespace-space"> </span>first);

<span class="org-whitespace-space">        </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>((first<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_CHUNK_MASK)<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>0)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(sibs<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>XA_CHUNK_MASK)
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>((sibs<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_CHUNK_MASK)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>(offset<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>XA_CHUNK_MASK))
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span>shift<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_CHUNK_MASK)
<span class="org-whitespace-space">                        </span>offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>sibs<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_CHUNK_MASK;
<span class="org-whitespace-space">                </span>sibs<span class="org-whitespace-space"> </span>&gt;&gt;=<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT;
<span class="org-whitespace-space">                </span>first<span class="org-whitespace-space"> </span>&gt;&gt;=<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT;
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span>offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>first<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_CHUNK_MASK;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(offset<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>sibs<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>XA_CHUNK_MASK)
<span class="org-whitespace-space">                </span>sibs<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XA_CHUNK_MASK<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>offset;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>((((first<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>sibs<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1)<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>shift)<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1)<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>last)
<span class="org-whitespace-space">                </span>sibs<span class="org-whitespace-space"> </span>-=<span class="org-whitespace-space"> </span>1;

<span class="org-whitespace-space">        </span>xas-&gt;xa_shift<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>shift;
<span class="org-whitespace-space">        </span>xas-&gt;xa_sibs<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>sibs;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_store_range()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">range</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">indices</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@first</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">First</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">affect.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@last</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Last</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">affect.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">After</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">returns,</span><span class="org-whitespace-space"> </span><span class="org-doc">loads</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">any</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">between</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@first</span></span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@last</span></span><span class="org-doc">,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">inclusive</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Storing</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">existing</span><span class="org-whitespace-space"> </span><span class="org-doc">multislot</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">updates</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">every</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">marks</span><span class="org-whitespace-space"> </span><span class="org-doc">associated</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">unaffected</span><span class="org-whitespace-space"> </span><span class="org-doc">unless</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Process</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">success,</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_err(-EINVAL)</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-whitespace-space"> </span><span class="org-doc">cannot</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray,</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_err(-ENOMEM)</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">failed.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_store_range</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">first</span>,
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">last</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>0);

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(WARN_ON_ONCE(xa_is_internal(entry)))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>XA_ERROR(-EINVAL);
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(last<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>first)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>XA_ERROR(-EINVAL);

<span class="org-whitespace-space">        </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas_lock(&amp;xas);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(entry)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">order</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>BITS_PER_LONG;
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(last<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1)
<span class="org-whitespace-space">                                </span>order<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__ffs(last<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1);
<span class="org-whitespace-space">                        </span>xas_set_order(&amp;xas,<span class="org-whitespace-space"> </span>last,<span class="org-whitespace-space"> </span>order);
<span class="org-whitespace-space">                        </span>xas_create(&amp;xas,<span class="org-whitespace-space"> </span><span class="org-constant">true</span>);
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_error(&amp;xas))
<span class="org-whitespace-space">                                </span><span class="org-keyword">goto</span><span class="org-whitespace-space"> </span><span class="org-constant">unlock</span>;
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>xas_set_range(&amp;xas,<span class="org-whitespace-space"> </span>first,<span class="org-whitespace-space"> </span>last);
<span class="org-whitespace-space">                        </span>xas_store(&amp;xas,<span class="org-whitespace-space"> </span>entry);
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_error(&amp;xas))
<span class="org-whitespace-space">                                </span><span class="org-keyword">goto</span><span class="org-whitespace-space"> </span><span class="org-constant">unlock</span>;
<span class="org-whitespace-space">                        </span>first<span class="org-whitespace-space"> </span>+=<span class="org-whitespace-space"> </span>xas_size(&amp;xas);
<span class="org-whitespace-space">                </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(first<span class="org-whitespace-space"> </span>&lt;=<span class="org-whitespace-space"> </span>last);
<span class="org-constant">unlock</span>:
<span class="org-whitespace-space">                </span>xas_unlock(&amp;xas);
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(xas_nomem(&amp;xas,<span class="org-whitespace-space"> </span>gfp));

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_result(&amp;xas,<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>);
}
<span class="org-function-name">EXPORT_SYMBOL</span>(xa_store_range);
<span class="org-preprocessor">#endif</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">CONFIG_XARRAY_MULTI</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">__xa_alloc()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Find</span><span class="org-whitespace-space"> </span><span class="org-doc">somewhere</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@id</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">ID.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@limit</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Range</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">ID.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Finds</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-whitespace-space"> </span><span class="org-doc">between</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.min</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.max,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-whitespace-space"> </span><span class="org-doc">pointer,</span><span class="org-whitespace-space"> </span><span class="org-doc">then</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span><span class="org-whitespace-space">  </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">concurrent</span><span class="org-whitespace-space"> </span><span class="org-doc">lookup</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">uninitialised</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Expects</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">held</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">release</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">reacquire</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">success,</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">could</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">-EBUSY</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">there</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">free</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">__xa_alloc</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">id</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,
<span class="org-whitespace-space">                </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_limit</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limit</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>0);

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(WARN_ON_ONCE(xa_is_advanced(entry)))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>-EINVAL;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(WARN_ON_ONCE(<span class="org-negation-char">!</span>xa_track_free(xa)))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>-EINVAL;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>entry)
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XA_ZERO_ENTRY;

<span class="org-whitespace-space">        </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xas.xa_index<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>limit.min;
<span class="org-whitespace-space">                </span>xas_find_marked(&amp;xas,<span class="org-whitespace-space"> </span>limit.max,<span class="org-whitespace-space"> </span>XA_FREE_MARK);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas.xa_node<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XAS_RESTART)
<span class="org-whitespace-space">                        </span>xas_set_err(&amp;xas,<span class="org-whitespace-space"> </span>-EBUSY);
<span class="org-whitespace-space">                </span><span class="org-keyword">else</span>
<span class="org-whitespace-space">                        </span>*id<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas.xa_index;
<span class="org-whitespace-space">                </span>xas_store(&amp;xas,<span class="org-whitespace-space"> </span>entry);
<span class="org-whitespace-space">                </span>xas_clear_mark(&amp;xas,<span class="org-whitespace-space"> </span>XA_FREE_MARK);
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(__xas_nomem(&amp;xas,<span class="org-whitespace-space"> </span>gfp));

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_error(&amp;xas);
}
<span class="org-function-name">EXPORT_SYMBOL</span>(__xa_alloc);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">__xa_alloc_cyclic()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Find</span><span class="org-whitespace-space"> </span><span class="org-doc">somewhere</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@id</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">ID.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@limit</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Range</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">ID.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@next</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">ID</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">allocate.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Finds</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-whitespace-space"> </span><span class="org-doc">between</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.min</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.max,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-whitespace-space"> </span><span class="org-doc">pointer,</span><span class="org-whitespace-space"> </span><span class="org-doc">then</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span><span class="org-whitespace-space">  </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">concurrent</span><span class="org-whitespace-space"> </span><span class="org-doc">lookup</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">uninitialised</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">search</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">start</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@next</span></span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">wrap</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">around</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">necessary.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Expects</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">held</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">release</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">reacquire</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded</span><span class="org-whitespace-space"> </span><span class="org-doc">without</span><span class="org-whitespace-space"> </span><span class="org-doc">wrapping.</span><span class="org-whitespace-space">  </span><span class="org-doc">1</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded</span><span class="org-whitespace-space"> </span><span class="org-doc">after</span><span class="org-whitespace-space"> </span><span class="org-doc">wrapping,</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">could</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">-EBUSY</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">there</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">free</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">__xa_alloc_cyclic</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">id</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,
<span class="org-whitespace-space">                </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_limit</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limit</span>,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">next</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span><span class="org-variable-name">min</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>limit.min;
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">ret</span>;

<span class="org-whitespace-space">        </span>limit.min<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>max(min,<span class="org-whitespace-space"> </span>*next);
<span class="org-whitespace-space">        </span>ret<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_alloc(xa,<span class="org-whitespace-space"> </span>id,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>limit,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>((xa-&gt;xa_flags<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_FLAGS_ALLOC_WRAPPED)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>ret<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>0)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>xa-&gt;xa_flags<span class="org-whitespace-space"> </span>&amp;=<span class="org-whitespace-space"> </span>~XA_FLAGS_ALLOC_WRAPPED;
<span class="org-whitespace-space">                </span>ret<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(ret<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>0<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>limit.min<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>min)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>limit.min<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>min;
<span class="org-whitespace-space">                </span>ret<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_alloc(xa,<span class="org-whitespace-space"> </span>id,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>limit,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(ret<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>0)
<span class="org-whitespace-space">                        </span>ret<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(ret<span class="org-whitespace-space"> </span>&gt;=<span class="org-whitespace-space"> </span>0)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>*next<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>*id<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(*next<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>0)
<span class="org-whitespace-space">                        </span>xa-&gt;xa_flags<span class="org-whitespace-space"> </span>|=<span class="org-whitespace-space"> </span>XA_FLAGS_ALLOC_WRAPPED;
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>ret;
}
<span class="org-function-name">EXPORT_SYMBOL</span>(__xa_alloc_cyclic);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">__xa_set_mark()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Set</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc">locked.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@mark</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Mark</span><span class="org-whitespace-space"> </span><span class="org-doc">number.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Attempting</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">does</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">succeed.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Expects</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">held</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">__xa_set_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>index);
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_load(&amp;xas);

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(entry)
<span class="org-whitespace-space">                </span>xas_set_mark(&amp;xas,<span class="org-whitespace-space"> </span>mark);
}
<span class="org-function-name">EXPORT_SYMBOL</span>(__xa_set_mark);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">__xa_clear_mark()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Clear</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc">locked.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@mark</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Mark</span><span class="org-whitespace-space"> </span><span class="org-doc">number.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Expects</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">held</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">__xa_clear_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>index);
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_load(&amp;xas);

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(entry)
<span class="org-whitespace-space">                </span>xas_clear_mark(&amp;xas,<span class="org-whitespace-space"> </span>mark);
}
<span class="org-function-name">EXPORT_SYMBOL</span>(__xa_clear_mark);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_get_mark()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Inquire</span><span class="org-whitespace-space"> </span><span class="org-doc">whether</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@mark</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Mark</span><span class="org-whitespace-space"> </span><span class="org-doc">number.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">uses</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">read</span><span class="org-whitespace-space"> </span><span class="org-doc">lock,</span><span class="org-whitespace-space"> </span><span class="org-doc">so</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">result</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">out</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">date</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">time</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">returns.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">need</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">result</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">stable,</span><span class="org-whitespace-space"> </span><span class="org-doc">use</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">True</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">set,</span><span class="org-whitespace-space"> </span><span class="org-doc">false</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">doesn't.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_get_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>index);
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span>rcu_read_lock();
<span class="org-whitespace-space">        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_start(&amp;xas);
<span class="org-whitespace-space">        </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(xas_get_mark(&amp;xas,<span class="org-whitespace-space"> </span>mark))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_node(entry))
<span class="org-whitespace-space">                        </span><span class="org-keyword">goto</span><span class="org-whitespace-space"> </span><span class="org-constant">found</span>;
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_descend(&amp;xas,<span class="org-whitespace-space"> </span>xa_to_node(entry));
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span>rcu_read_unlock();
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">false</span>;
<span class="org-whitespace-space"> </span><span class="org-constant">found</span>:
<span class="org-whitespace-space">        </span>rcu_read_unlock();
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">true</span>;
}
<span class="org-function-name">EXPORT_SYMBOL</span>(xa_get_mark);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_set_mark()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Set</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@mark</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Mark</span><span class="org-whitespace-space"> </span><span class="org-doc">number.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Attempting</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">does</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">succeed.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Process</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_set_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span>xa_lock(xa);
<span class="org-whitespace-space">        </span>__xa_set_mark(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>mark);
<span class="org-whitespace-space">        </span>xa_unlock(xa);
}
<span class="org-function-name">EXPORT_SYMBOL</span>(xa_set_mark);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_clear_mark()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Clear</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@mark</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Mark</span><span class="org-whitespace-space"> </span><span class="org-doc">number.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Clearing</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">always</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeds.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Process</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_clear_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span>xa_lock(xa);
<span class="org-whitespace-space">        </span>__xa_clear_mark(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>mark);
<span class="org-whitespace-space">        </span>xa_unlock(xa);
}
<span class="org-function-name">EXPORT_SYMBOL</span>(xa_clear_mark);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_find()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Search</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@indexp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@max</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Maximum</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">search</span><span class="org-whitespace-space"> </span><span class="org-doc">to.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@filter</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Selection</span><span class="org-whitespace-space"> </span><span class="org-doc">criterion.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Finds</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">matches</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@filter</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">lowest</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">least</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@indexp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">more</span><span class="org-whitespace-space"> </span><span class="org-doc">than</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@max</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">found,</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@indexp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">updated</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">protected</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">read</span><span class="org-whitespace-space"> </span><span class="org-doc">lock,</span><span class="org-whitespace-space"> </span><span class="org-doc">so</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">find</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">being</span><span class="org-whitespace-space"> </span><span class="org-doc">simultaneously</span><span class="org-whitespace-space"> </span><span class="org-doc">added.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%XA_RETRY_ENTRY</span></span><span class="org-doc">;</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">need</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">entries,</span><span class="org-whitespace-space"> </span><span class="org-doc">use</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_find()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">found,</span><span class="org-whitespace-space"> </span><span class="org-doc">otherwise</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_find</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">indexp</span>,
<span class="org-whitespace-space">                        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">filter</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>*indexp);
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span>rcu_read_lock();
<span class="org-whitespace-space">        </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span>)filter<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>XA_MAX_MARKS)
<span class="org-whitespace-space">                        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_find_marked(&amp;xas,<span class="org-whitespace-space"> </span>max,<span class="org-whitespace-space"> </span>filter);
<span class="org-whitespace-space">                </span><span class="org-keyword">else</span>
<span class="org-whitespace-space">                        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_find(&amp;xas,<span class="org-whitespace-space"> </span>max);
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(xas_retry(&amp;xas,<span class="org-whitespace-space"> </span>entry));
<span class="org-whitespace-space">        </span>rcu_read_unlock();

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(entry)
<span class="org-whitespace-space">                </span>*indexp<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas.xa_index;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
}
<span class="org-function-name">EXPORT_SYMBOL</span>(xa_find);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_find_after()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Search</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">present</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@indexp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@max</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Maximum</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">search</span><span class="org-whitespace-space"> </span><span class="org-doc">to.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@filter</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Selection</span><span class="org-whitespace-space"> </span><span class="org-doc">criterion.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Finds</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">matches</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@filter</span></span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">lowest</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">above</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@indexp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">more</span><span class="org-whitespace-space"> </span><span class="org-doc">than</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@max</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">found,</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@indexp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">updated</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">protected</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">read</span><span class="org-whitespace-space"> </span><span class="org-doc">lock,</span><span class="org-whitespace-space"> </span><span class="org-doc">so</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">miss</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">being</span><span class="org-whitespace-space"> </span><span class="org-doc">simultaneously</span><span class="org-whitespace-space"> </span><span class="org-doc">added.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%XA_RETRY_ENTRY</span></span><span class="org-doc">;</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">need</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">entries,</span><span class="org-whitespace-space"> </span><span class="org-doc">use</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_find()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer,</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">found,</span><span class="org-whitespace-space"> </span><span class="org-doc">otherwise</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_find_after</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">indexp</span>,
<span class="org-whitespace-space">                        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">filter</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>*indexp<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1);
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span>rcu_read_lock();
<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(;;)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span>)filter<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>XA_MAX_MARKS)
<span class="org-whitespace-space">                        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_find_marked(&amp;xas,<span class="org-whitespace-space"> </span>max,<span class="org-whitespace-space"> </span>filter);
<span class="org-whitespace-space">                </span><span class="org-keyword">else</span>
<span class="org-whitespace-space">                        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_find(&amp;xas,<span class="org-whitespace-space"> </span>max);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas.xa_node<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XAS_BOUNDS)
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas.xa_shift)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas.xa_index<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>((1UL<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>xas.xa_shift)<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1))
<span class="org-whitespace-space">                                </span><span class="org-keyword">continue</span>;
<span class="org-whitespace-space">                </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas.xa_offset<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>(xas.xa_index<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_CHUNK_MASK))
<span class="org-whitespace-space">                                </span><span class="org-keyword">continue</span>;
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xas_retry(&amp;xas,<span class="org-whitespace-space"> </span>entry))
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span>rcu_read_unlock();

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(entry)
<span class="org-whitespace-space">                </span>*indexp<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas.xa_index;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
}
<span class="org-function-name">EXPORT_SYMBOL</span>(xa_find_after);

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_extract_present</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>**<span class="org-variable-name">dst</span>,
<span class="org-whitespace-space">                        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">n</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">i</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;

<span class="org-whitespace-space">        </span>rcu_read_lock();
<span class="org-whitespace-space">        </span>xas_for_each(xas,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>max)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_retry(xas,<span class="org-whitespace-space"> </span>entry))
<span class="org-whitespace-space">                        </span><span class="org-keyword">continue</span>;
<span class="org-whitespace-space">                </span>dst[i++]<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>entry;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(i<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>n)
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span>rcu_read_unlock();

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>i;
}

<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_extract_marked</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>**<span class="org-variable-name">dst</span>,
<span class="org-whitespace-space">                        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">n</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">i</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;

<span class="org-whitespace-space">        </span>rcu_read_lock();
<span class="org-whitespace-space">        </span>xas_for_each_marked(xas,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>max,<span class="org-whitespace-space"> </span>mark)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas_retry(xas,<span class="org-whitespace-space"> </span>entry))
<span class="org-whitespace-space">                        </span><span class="org-keyword">continue</span>;
<span class="org-whitespace-space">                </span>dst[i++]<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>entry;
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(i<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>n)
<span class="org-whitespace-space">                        </span><span class="org-keyword">break</span>;
<span class="org-whitespace-space">        </span>}
<span class="org-whitespace-space">        </span>rcu_read_unlock();

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>i;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_extract()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Copy</span><span class="org-whitespace-space"> </span><span class="org-doc">selected</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">normal</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">source</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">copy</span><span class="org-whitespace-space"> </span><span class="org-doc">from.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@dst</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">buffer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">copy</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">into.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@start</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">first</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">eligible</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">selected.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@max</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">last</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">eligible</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">selected.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@n</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">maximum</span><span class="org-whitespace-space"> </span><span class="org-doc">number</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">copy.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@filter</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Selection</span><span class="org-whitespace-space"> </span><span class="org-doc">criterion.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Copies</span><span class="org-whitespace-space"> </span><span class="org-doc">up</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@n</span></span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">match</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@filter</span></span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span><span class="org-whitespace-space">  </span><span class="org-doc">The</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">copied</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">indices</span><span class="org-whitespace-space"> </span><span class="org-doc">between</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@start</span></span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@max</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">inclusive.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@filter</span></span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">value,</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">case</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">marked</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">copied.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">also</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%XA_PRESENT</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">case</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">copied.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">returned</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">represent</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">snapshot</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">moment</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">time.</span><span class="org-whitespace-space">  </span><span class="org-doc">For</span><span class="org-whitespace-space"> </span><span class="org-doc">example,</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">another</span><span class="org-whitespace-space"> </span><span class="org-doc">thread</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">5,</span><span class="org-whitespace-space"> </span><span class="org-doc">then</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">10,</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_extract()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">old</span><span class="org-whitespace-space"> </span><span class="org-doc">contents</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">5</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">new</span><span class="org-whitespace-space"> </span><span class="org-doc">contents</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">10.</span><span class="org-whitespace-space">  </span><span class="org-doc">Indices</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">modified</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">running</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">skipped.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">need</span><span class="org-whitespace-space"> </span><span class="org-doc">stronger</span><span class="org-whitespace-space"> </span><span class="org-doc">guarantees,</span><span class="org-whitespace-space"> </span><span class="org-doc">holding</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">across</span><span class="org-whitespace-space"> </span><span class="org-doc">calls</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">prevent</span><span class="org-whitespace-space"> </span><span class="org-doc">concurrent</span><span class="org-whitespace-space"> </span><span class="org-doc">modification.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">number</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">copied.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_extract</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>**<span class="org-variable-name">dst</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">start</span>,
<span class="org-whitespace-space">                        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">n</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">filter</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>start);

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>n)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>0;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span>)filter<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>XA_MAX_MARKS)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_extract_marked(&amp;xas,<span class="org-whitespace-space"> </span>dst,<span class="org-whitespace-space"> </span>max,<span class="org-whitespace-space"> </span>n,<span class="org-whitespace-space"> </span>filter);
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_extract_present(&amp;xas,<span class="org-whitespace-space"> </span>dst,<span class="org-whitespace-space"> </span>max,<span class="org-whitespace-space"> </span>n);
}
<span class="org-function-name">EXPORT_SYMBOL</span>(xa_extract);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_destroy()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Free</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">internal</span><span class="org-whitespace-space"> </span><span class="org-doc">data</span><span class="org-whitespace-space"> </span><span class="org-doc">structures.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">After</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function,</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">freed</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">its</span><span class="org-whitespace-space"> </span><span class="org-doc">internal</span><span class="org-whitespace-space"> </span><span class="org-doc">data</span><span class="org-whitespace-space"> </span><span class="org-doc">structures.</span><span class="org-whitespace-space">  </span><span class="org-doc">You</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">responsible</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">freeing</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">objects</span><span class="org-whitespace-space"> </span><span class="org-doc">referenced</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock,</span><span class="org-whitespace-space"> </span><span class="org-doc">interrupt-safe.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_destroy</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>)
{
<span class="org-whitespace-space">        </span>XA_STATE(xas,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>0);
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">flags</span>;
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span>xas.xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">        </span>xas_lock_irqsave(&amp;xas,<span class="org-whitespace-space"> </span>flags);
<span class="org-whitespace-space">        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_head_locked(xa);
<span class="org-whitespace-space">        </span>RCU_INIT_POINTER(xa-&gt;xa_head,<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>);
<span class="org-whitespace-space">        </span>xas_init_marks(&amp;xas);
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_zero_busy(xa))
<span class="org-whitespace-space">                </span>xa_mark_clear(xa,<span class="org-whitespace-space"> </span>XA_FREE_MARK);
<span class="org-whitespace-space">        </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">lockdep</span><span class="org-whitespace-space"> </span><span class="org-comment">checks</span><span class="org-whitespace-space"> </span><span class="org-comment">we're</span><span class="org-whitespace-space"> </span><span class="org-comment">still</span><span class="org-whitespace-space"> </span><span class="org-comment">holding</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">lock</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">xas_free_nodes()</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_node(entry))
<span class="org-whitespace-space">                </span>xas_free_nodes(&amp;xas,<span class="org-whitespace-space"> </span>xa_to_node(entry));
<span class="org-whitespace-space">        </span>xas_unlock_irqrestore(&amp;xas,<span class="org-whitespace-space"> </span>flags);
}
<span class="org-function-name">EXPORT_SYMBOL</span>(xa_destroy);

<span class="org-preprocessor">#ifdef</span><span class="org-whitespace-space"> </span>XA_DEBUG
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_dump_node</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-variable-name">i</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">j</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>node)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span>;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>((<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)node<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>3)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span>pr_cont(<span class="org-string">"node</span><span class="org-whitespace-space"> </span><span class="org-string">%px\n"</span>,<span class="org-whitespace-space"> </span>node);
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span>;
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span>pr_cont(<span class="org-string">"node</span><span class="org-whitespace-space"> </span><span class="org-string">%px</span><span class="org-whitespace-space"> </span><span class="org-string">%s</span><span class="org-whitespace-space"> </span><span class="org-string">%d</span><span class="org-whitespace-space"> </span><span class="org-string">parent</span><span class="org-whitespace-space"> </span><span class="org-string">%px</span><span class="org-whitespace-space"> </span><span class="org-string">shift</span><span class="org-whitespace-space"> </span><span class="org-string">%d</span><span class="org-whitespace-space"> </span><span class="org-string">count</span><span class="org-whitespace-space"> </span><span class="org-string">%d</span><span class="org-whitespace-space"> </span><span class="org-string">values</span><span class="org-whitespace-space"> </span><span class="org-string">%d</span><span class="org-whitespace-space"> </span><span class="org-string">"</span>
<span class="org-whitespace-space">                </span><span class="org-string">"array</span><span class="org-whitespace-space"> </span><span class="org-string">%px</span><span class="org-whitespace-space"> </span><span class="org-string">list</span><span class="org-whitespace-space"> </span><span class="org-string">%px</span><span class="org-whitespace-space"> </span><span class="org-string">%px</span><span class="org-whitespace-space"> </span><span class="org-string">marks"</span>,
<span class="org-whitespace-space">                </span>node,<span class="org-whitespace-space"> </span>node-&gt;parent<span class="org-whitespace-space"> </span>?<span class="org-whitespace-space"> </span><span class="org-string">"offset"</span><span class="org-whitespace-space"> </span>:<span class="org-whitespace-space"> </span><span class="org-string">"max"</span>,<span class="org-whitespace-space"> </span>node-&gt;offset,
<span class="org-whitespace-space">                </span>node-&gt;parent,<span class="org-whitespace-space"> </span>node-&gt;shift,<span class="org-whitespace-space"> </span>node-&gt;count,<span class="org-whitespace-space"> </span>node-&gt;nr_values,
<span class="org-whitespace-space">                </span>node-&gt;array,<span class="org-whitespace-space"> </span>node-&gt;private_list.prev,<span class="org-whitespace-space"> </span>node-&gt;private_list.next);
<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(i<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;<span class="org-whitespace-space"> </span>i<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>XA_MAX_MARKS;<span class="org-whitespace-space"> </span>i++)
<span class="org-whitespace-space">                </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(j<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;<span class="org-whitespace-space"> </span>j<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>XA_MARK_LONGS;<span class="org-whitespace-space"> </span>j++)
<span class="org-whitespace-space">                        </span>pr_cont(<span class="org-string">"</span><span class="org-whitespace-space"> </span><span class="org-string">%lx"</span>,<span class="org-whitespace-space"> </span>node-&gt;marks[i][j]);
<span class="org-whitespace-space">        </span>pr_cont(<span class="org-string">"\n"</span>);
}

<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_dump_index</span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">shift</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>shift)
<span class="org-whitespace-space">                </span>pr_info(<span class="org-string">"%lu:</span><span class="org-whitespace-space"> </span><span class="org-string">"</span>,<span class="org-whitespace-space"> </span>index);
<span class="org-whitespace-space">        </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(shift<span class="org-whitespace-space"> </span>&gt;=<span class="org-whitespace-space"> </span>BITS_PER_LONG)
<span class="org-whitespace-space">                </span>pr_info(<span class="org-string">"0-%lu:</span><span class="org-whitespace-space"> </span><span class="org-string">"</span>,<span class="org-whitespace-space"> </span>~0UL);
<span class="org-whitespace-space">        </span><span class="org-keyword">else</span>
<span class="org-whitespace-space">                </span>pr_info(<span class="org-string">"%lu-%lu:</span><span class="org-whitespace-space"> </span><span class="org-string">"</span>,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>index<span class="org-whitespace-space"> </span>|<span class="org-whitespace-space"> </span>((1UL<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>shift)<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1));
}

<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_dump_entry</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">shift</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>entry)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span>;

<span class="org-whitespace-space">        </span>xa_dump_index(index,<span class="org-whitespace-space"> </span>shift);

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_node(entry))<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(shift<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>0)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span>pr_cont(<span class="org-string">"%px\n"</span>,<span class="org-whitespace-space"> </span>entry);
<span class="org-whitespace-space">                </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">i</span>;
<span class="org-whitespace-space">                        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(entry);
<span class="org-whitespace-space">                        </span>xa_dump_node(node);
<span class="org-whitespace-space">                        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(i<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;<span class="org-whitespace-space"> </span>i<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE;<span class="org-whitespace-space"> </span>i++)
<span class="org-whitespace-space">                                </span>xa_dump_entry(node-&gt;slots[i],
<span class="org-whitespace-space">                                      </span>index<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>(i<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>node-&gt;shift),<span class="org-whitespace-space"> </span>node-&gt;shift);
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_value(entry))
<span class="org-whitespace-space">                </span>pr_cont(<span class="org-string">"value</span><span class="org-whitespace-space"> </span><span class="org-string">%ld</span><span class="org-whitespace-space"> </span><span class="org-string">(0x%lx)</span><span class="org-whitespace-space"> </span><span class="org-string">[%px]\n"</span>,<span class="org-whitespace-space"> </span>xa_to_value(entry),
<span class="org-whitespace-space">                                                </span>xa_to_value(entry),<span class="org-whitespace-space"> </span>entry);
<span class="org-whitespace-space">        </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_internal(entry))
<span class="org-whitespace-space">                </span>pr_cont(<span class="org-string">"%px\n"</span>,<span class="org-whitespace-space"> </span>entry);
<span class="org-whitespace-space">        </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_retry(entry))
<span class="org-whitespace-space">                </span>pr_cont(<span class="org-string">"retry</span><span class="org-whitespace-space"> </span><span class="org-string">(%ld)\n"</span>,<span class="org-whitespace-space"> </span>xa_to_internal(entry));
<span class="org-whitespace-space">        </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_sibling(entry))
<span class="org-whitespace-space">                </span>pr_cont(<span class="org-string">"sibling</span><span class="org-whitespace-space"> </span><span class="org-string">(slot</span><span class="org-whitespace-space"> </span><span class="org-string">%ld)\n"</span>,<span class="org-whitespace-space"> </span>xa_to_sibling(entry));
<span class="org-whitespace-space">        </span><span class="org-keyword">else</span><span class="org-whitespace-space"> </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_zero(entry))
<span class="org-whitespace-space">                </span>pr_cont(<span class="org-string">"zero</span><span class="org-whitespace-space"> </span><span class="org-string">(%ld)\n"</span>,<span class="org-whitespace-space"> </span>xa_to_internal(entry));
<span class="org-whitespace-space">        </span><span class="org-keyword">else</span>
<span class="org-whitespace-space">                </span>pr_cont(<span class="org-string">"UNKNOWN</span><span class="org-whitespace-space"> </span><span class="org-string">ENTRY</span><span class="org-whitespace-space"> </span><span class="org-string">(%px)\n"</span>,<span class="org-whitespace-space"> </span>entry);
}

<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_dump</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa-&gt;xa_head;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">shift</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0;

<span class="org-whitespace-space">        </span>pr_info(<span class="org-string">"xarray:</span><span class="org-whitespace-space"> </span><span class="org-string">%px</span><span class="org-whitespace-space"> </span><span class="org-string">head</span><span class="org-whitespace-space"> </span><span class="org-string">%px</span><span class="org-whitespace-space"> </span><span class="org-string">flags</span><span class="org-whitespace-space"> </span><span class="org-string">%x</span><span class="org-whitespace-space"> </span><span class="org-string">marks</span><span class="org-whitespace-space"> </span><span class="org-string">%d</span><span class="org-whitespace-space"> </span><span class="org-string">%d</span><span class="org-whitespace-space"> </span><span class="org-string">%d\n"</span>,<span class="org-whitespace-space"> </span>xa,<span class="org-whitespace-space"> </span>entry,
<span class="org-whitespace-space">                        </span>xa-&gt;xa_flags,<span class="org-whitespace-space"> </span>xa_marked(xa,<span class="org-whitespace-space"> </span>XA_MARK_0),
<span class="org-whitespace-space">                        </span>xa_marked(xa,<span class="org-whitespace-space"> </span>XA_MARK_1),<span class="org-whitespace-space"> </span>xa_marked(xa,<span class="org-whitespace-space"> </span>XA_MARK_2));
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_node(entry))
<span class="org-whitespace-space">                </span>shift<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_to_node(entry)-&gt;shift<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT;
<span class="org-whitespace-space">        </span>xa_dump_entry(entry,<span class="org-whitespace-space"> </span>0,<span class="org-whitespace-space"> </span>shift);
}
<span class="org-preprocessor">#endif</span>
</pre>
</div>

<script src="https://utteranc.es/client.js"
        repo="yygcode/yygcode.github.io"
        issue-term="pathname"
        label=" Utterances"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>
</div>
<div id="postamble" class="status">
<div class="copyright">
2012-2020 Copyright&copy; <i> YANYG - Powered by Emacs Orgmode</i>
</div>
</div>
</body>
</html>
