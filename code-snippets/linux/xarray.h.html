<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
<meta charset="utf-8" />
<title>linux/include/linux/xarray.h</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="yanyg" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="/themes/code/css/code-snippet.css" />
<script type="text/javascript" src="/themes/code/js/code-snippet.js"> </script>
</head>
<body>
<div id="preamble" class="status">
<a href="../../index.html">Yanyg - SAN Software Engineer</a>
<div class="sitelinks">
  <a href="../snippets.html">Snippets</a> |
  <a href="../theindex.html">Index</a> |
  <a href="../tags.html">TAGS</a> |
  <a href="https://github.com/yygcode">Github</a> |
  <a href="../../about.html">About Me</a>
</div>
</div>
<div id="content">
<h1 class="title">linux/include/linux/xarray.h</h1>
<div class="org-src-container">
<pre class="src src-c"><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">SPDX-License-Identifier:</span><span class="org-whitespace-space"> </span><span class="org-comment">GPL-2.0+</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-preprocessor">#if</span><span class="org-negation-char"><span class="org-preprocessor">n</span></span><span class="org-preprocessor">def</span><span class="org-whitespace-space"> </span>_LINUX_XARRAY_H
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">_LINUX_XARRAY_H</span>
<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">eXtensible</span><span class="org-whitespace-space"> </span><span class="org-comment">Arrays</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Copyright</span><span class="org-whitespace-space"> </span><span class="org-comment">(c)</span><span class="org-whitespace-space"> </span><span class="org-comment">2017</span><span class="org-whitespace-space"> </span><span class="org-comment">Microsoft</span><span class="org-whitespace-space"> </span><span class="org-comment">Corporation</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Author:</span><span class="org-whitespace-space"> </span><span class="org-comment">Matthew</span><span class="org-whitespace-space"> </span><span class="org-comment">Wilcox</span><span class="org-whitespace-space"> </span><span class="org-comment"><a href="mailto:willy%40infradead.org">&lt;willy@infradead.org&gt;</a></span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">See</span><span class="org-whitespace-space"> </span><span class="org-comment">Documentation/core-api/xarray.rst</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">how</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">use</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>

<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;linux/bug.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;linux/compiler.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;linux/gfp.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;linux/kconfig.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;linux/kernel.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;linux/rcupdate.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;linux/spinlock.h&gt;</span>
<span class="org-preprocessor">#include</span><span class="org-whitespace-space"> </span><span class="org-string">&lt;linux/types.h&gt;</span>

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">The</span><span class="org-whitespace-space"> </span><span class="org-comment">bottom</span><span class="org-whitespace-space"> </span><span class="org-comment">two</span><span class="org-whitespace-space"> </span><span class="org-comment">bits</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">determine</span><span class="org-whitespace-space"> </span><span class="org-comment">how</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray</span><span class="org-whitespace-space"> </span><span class="org-comment">interprets</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">contents:</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">00:</span><span class="org-whitespace-space"> </span><span class="org-comment">Pointer</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">10:</span><span class="org-whitespace-space"> </span><span class="org-comment">Internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">x1:</span><span class="org-whitespace-space"> </span><span class="org-comment">Value</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">or</span><span class="org-whitespace-space"> </span><span class="org-comment">tagged</span><span class="org-whitespace-space"> </span><span class="org-comment">pointer</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Attempting</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">store</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entries</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">bug.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Most</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entries</span><span class="org-whitespace-space"> </span><span class="org-comment">are</span><span class="org-whitespace-space"> </span><span class="org-comment">pointers</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">next</span><span class="org-whitespace-space"> </span><span class="org-comment">node</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">tree.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">The</span><span class="org-whitespace-space"> </span><span class="org-comment">following</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entries</span><span class="org-whitespace-space"> </span><span class="org-comment">have</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">special</span><span class="org-whitespace-space"> </span><span class="org-comment">meaning:</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">0-62:</span><span class="org-whitespace-space"> </span><span class="org-comment">Sibling</span><span class="org-whitespace-space"> </span><span class="org-comment">entries</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">256:</span><span class="org-whitespace-space"> </span><span class="org-comment">Zero</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">257:</span><span class="org-whitespace-space"> </span><span class="org-comment">Retry</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Errors</span><span class="org-whitespace-space"> </span><span class="org-comment">are</span><span class="org-whitespace-space"> </span><span class="org-comment">also</span><span class="org-whitespace-space"> </span><span class="org-comment">represented</span><span class="org-whitespace-space"> </span><span class="org-comment">as</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entries,</span><span class="org-whitespace-space"> </span><span class="org-comment">but</span><span class="org-whitespace-space"> </span><span class="org-comment">use</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">negative</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">space</span><span class="org-whitespace-space"> </span><span class="org-comment">(-4094</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">-2).</span><span class="org-whitespace-space">  </span><span class="org-comment">They're</span><span class="org-whitespace-space"> </span><span class="org-comment">never</span><span class="org-whitespace-space"> </span><span class="org-comment">stored</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">slots</span><span class="org-whitespace-space"> </span><span class="org-comment">array;</span><span class="org-whitespace-space"> </span><span class="org-comment">only</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">returned</span><span class="org-whitespace-space"> </span><span class="org-comment">by</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">normal</span><span class="org-whitespace-space"> </span><span class="org-comment">API.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>

<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">BITS_PER_XA_VALUE</span><span class="org-whitespace-tab">       </span>(BITS_PER_LONG<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1)

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_mk_value()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Create</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">integer.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@v</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Value</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">An</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">suitable</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">storing</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_mk_value</span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">v</span>)
{
<span class="org-whitespace-space">        </span>WARN_ON((<span class="org-type">long</span>)v<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>0);
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(<span class="org-type">void</span><span class="org-whitespace-space"> </span>*)((v<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>1)<span class="org-whitespace-space"> </span>|<span class="org-whitespace-space"> </span>1);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_to_value()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Get</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_to_value</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)entry<span class="org-whitespace-space"> </span>&gt;&gt;<span class="org-whitespace-space"> </span>1;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_is_value()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Determine</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">value.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">True</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">value,</span><span class="org-whitespace-space"> </span><span class="org-doc">false</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_is_value</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)entry<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>1;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_tag_pointer()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Create</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">tagged</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@p</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Plain</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@tag</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Tag</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">(0,</span><span class="org-whitespace-space"> </span><span class="org-doc">1</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">3).</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">user</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">prefers,</span><span class="org-whitespace-space"> </span><span class="org-doc">they</span><span class="org-whitespace-space"> </span><span class="org-doc">can</span><span class="org-whitespace-space"> </span><span class="org-doc">tag</span><span class="org-whitespace-space"> </span><span class="org-doc">their</span><span class="org-whitespace-space"> </span><span class="org-doc">pointers</span><span class="org-whitespace-space"> </span><span class="org-doc">instead</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">storing</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">entries.</span><span class="org-whitespace-space">  </span><span class="org-doc">Three</span><span class="org-whitespace-space"> </span><span class="org-doc">tags</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">available</span><span class="org-whitespace-space"> </span><span class="org-doc">(0,</span><span class="org-whitespace-space"> </span><span class="org-doc">1</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">3).</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">These</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">distinct</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-doc">as</span><span class="org-whitespace-space"> </span><span class="org-doc">they</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">replicated</span><span class="org-whitespace-space"> </span><span class="org-doc">up</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">through</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">cannot</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">searched</span><span class="org-whitespace-space"> </span><span class="org-doc">for.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">An</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_tag_pointer</span>(<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">p</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">tag</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(<span class="org-type">void</span><span class="org-whitespace-space"> </span>*)((<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)p<span class="org-whitespace-space"> </span>|<span class="org-whitespace-space"> </span>tag);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_untag_pointer()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Turn</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">plain</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">tagged</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray,</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">get</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">untagged</span><span class="org-whitespace-space"> </span><span class="org-doc">version</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_untag_pointer</span>(<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(<span class="org-type">void</span><span class="org-whitespace-space"> </span>*)((<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)entry<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>~3UL);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_pointer_tag()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Get</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">tag</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">tagged</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray,</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">get</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">tag</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">tag.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_pointer_tag</span>(<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)entry<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>3UL;
}

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_mk_internal()</span><span class="org-whitespace-space"> </span><span class="org-comment">-</span><span class="org-whitespace-space"> </span><span class="org-comment">Create</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@v:</span><span class="org-whitespace-space"> </span><span class="org-comment">Value</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">turn</span><span class="org-whitespace-space"> </span><span class="org-comment">into</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entries</span><span class="org-whitespace-space"> </span><span class="org-comment">are</span><span class="org-whitespace-space"> </span><span class="org-comment">used</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">number</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">purposes.</span><span class="org-whitespace-space">  </span><span class="org-comment">Entries</span><span class="org-whitespace-space"> </span><span class="org-comment">0-255</span><span class="org-whitespace-space"> </span><span class="org-comment">are</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">used</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">sibling</span><span class="org-whitespace-space"> </span><span class="org-comment">entries</span><span class="org-whitespace-space"> </span><span class="org-comment">(only</span><span class="org-whitespace-space"> </span><span class="org-comment">0-62</span><span class="org-whitespace-space"> </span><span class="org-comment">are</span><span class="org-whitespace-space"> </span><span class="org-comment">used</span><span class="org-whitespace-space"> </span><span class="org-comment">by</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">current</span><span class="org-whitespace-space"> </span><span class="org-comment">code).</span><span class="org-whitespace-space">  </span><span class="org-comment">256</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">used</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">retry</span><span class="org-whitespace-space"> </span><span class="org-comment">entry.</span><span class="org-whitespace-space">  </span><span class="org-comment">257</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">used</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">reserved</span><span class="org-whitespace-space"> </span><span class="org-comment">/</span><span class="org-whitespace-space"> </span><span class="org-comment">zero</span><span class="org-whitespace-space"> </span><span class="org-comment">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Negative</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entries</span><span class="org-whitespace-space"> </span><span class="org-comment">are</span><span class="org-whitespace-space"> </span><span class="org-comment">used</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">represent</span><span class="org-whitespace-space"> </span><span class="org-comment">errnos.</span><span class="org-whitespace-space">  </span><span class="org-comment">Node</span><span class="org-whitespace-space"> </span><span class="org-comment">pointers</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">are</span><span class="org-whitespace-space"> </span><span class="org-comment">also</span><span class="org-whitespace-space"> </span><span class="org-comment">tagged</span><span class="org-whitespace-space"> </span><span class="org-comment">as</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entries</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">some</span><span class="org-whitespace-space"> </span><span class="org-comment">situations.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Context:</span><span class="org-whitespace-space"> </span><span class="org-comment">Any</span><span class="org-whitespace-space"> </span><span class="org-comment">context.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Return:</span><span class="org-whitespace-space"> </span><span class="org-comment">An</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">corresponding</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">this</span><span class="org-whitespace-space"> </span><span class="org-comment">value.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_mk_internal</span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">v</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(<span class="org-type">void</span><span class="org-whitespace-space"> </span>*)((v<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>2)<span class="org-whitespace-space"> </span>|<span class="org-whitespace-space"> </span>2);
}

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_to_internal()</span><span class="org-whitespace-space"> </span><span class="org-comment">-</span><span class="org-whitespace-space"> </span><span class="org-comment">Extract</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">value</span><span class="org-whitespace-space"> </span><span class="org-comment">from</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@entry:</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray</span><span class="org-whitespace-space"> </span><span class="org-comment">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Context:</span><span class="org-whitespace-space"> </span><span class="org-comment">Any</span><span class="org-whitespace-space"> </span><span class="org-comment">context.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Return:</span><span class="org-whitespace-space"> </span><span class="org-comment">The</span><span class="org-whitespace-space"> </span><span class="org-comment">value</span><span class="org-whitespace-space"> </span><span class="org-comment">which</span><span class="org-whitespace-space"> </span><span class="org-comment">was</span><span class="org-whitespace-space"> </span><span class="org-comment">stored</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_to_internal</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)entry<span class="org-whitespace-space"> </span>&gt;&gt;<span class="org-whitespace-space"> </span>2;
}

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_is_internal()</span><span class="org-whitespace-space"> </span><span class="org-comment">-</span><span class="org-whitespace-space"> </span><span class="org-comment">Is</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entry?</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@entry:</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray</span><span class="org-whitespace-space"> </span><span class="org-comment">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Context:</span><span class="org-whitespace-space"> </span><span class="org-comment">Any</span><span class="org-whitespace-space"> </span><span class="org-comment">context.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Return:</span><span class="org-whitespace-space"> </span><span class="org-comment">%true</span><span class="org-whitespace-space"> </span><span class="org-comment">if</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_is_internal</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>((<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)entry<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>3)<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>2;
}

<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_ZERO_ENTRY</span><span class="org-whitespace-tab">           </span>xa_mk_internal(257)

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_is_zero()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Is</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">zero</span><span class="org-whitespace-space"> </span><span class="org-doc">entry?</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Entry</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieved</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">normal</span><span class="org-whitespace-space"> </span><span class="org-doc">API</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL</span><span class="org-whitespace-space"> </span><span class="org-doc">as</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">contents</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">slot</span><span class="org-whitespace-space"> </span><span class="org-doc">containing</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">zero</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span><span class="org-whitespace-space">  </span><span class="org-doc">You</span><span class="org-whitespace-space"> </span><span class="org-doc">can</span><span class="org-whitespace-space"> </span><span class="org-doc">only</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">zero</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc">using</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">advanced</span><span class="org-whitespace-space"> </span><span class="org-doc">API.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%true</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">zero</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_is_zero</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>unlikely(entry<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_ZERO_ENTRY);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_is_err()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Report</span><span class="org-whitespace-space"> </span><span class="org-doc">whether</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">returned</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Result</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">cannot</span><span class="org-whitespace-space"> </span><span class="org-doc">complete</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">operation,</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">special</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">indicating</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error.</span><span class="org-whitespace-space">  </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">tells</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">whether</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">occurred;</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_err()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">tells</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">occurred.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%true</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">indicates</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_is_err</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>unlikely(xa_is_internal(entry)<span class="org-whitespace-space"> </span>&amp;&amp;
<span class="org-whitespace-space">                        </span>entry<span class="org-whitespace-space"> </span>&gt;=<span class="org-whitespace-space"> </span>xa_mk_internal(-MAX_ERRNO));
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_err()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Turn</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">result</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">errno.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Result</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">function.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">cannot</span><span class="org-whitespace-space"> </span><span class="org-doc">complete</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">operation,</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">special</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">encodes</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">errno.</span><span class="org-whitespace-space">  </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">extracts</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">errno</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">value,</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">returns</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">does</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">represent</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">errno.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">negative</span><span class="org-whitespace-space"> </span><span class="org-doc">errno</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">0.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_err</span>(<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_to_internal()</span><span class="org-whitespace-space"> </span><span class="org-comment">would</span><span class="org-whitespace-space"> </span><span class="org-comment">not</span><span class="org-whitespace-space"> </span><span class="org-comment">do</span><span class="org-whitespace-space"> </span><span class="org-comment">sign</span><span class="org-whitespace-space"> </span><span class="org-comment">extension.</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_err(entry))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(<span class="org-type">long</span>)entry<span class="org-whitespace-space"> </span>&gt;&gt;<span class="org-whitespace-space"> </span>2;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>0;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">struct</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_limit</span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Represents</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">range</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">IDs.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@min</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">lowest</span><span class="org-whitespace-space"> </span><span class="org-doc">ID</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">allocate</span><span class="org-whitespace-space"> </span><span class="org-doc">(inclusive).</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@max</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">maximum</span><span class="org-whitespace-space"> </span><span class="org-doc">ID</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">allocate</span><span class="org-whitespace-space"> </span><span class="org-doc">(inclusive).</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">structure</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">used</span><span class="org-whitespace-space"> </span><span class="org-doc">either</span><span class="org-whitespace-space"> </span><span class="org-doc">directly</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">via</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">XA_LIMIT()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">macro</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">communicate</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">range</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">IDs</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">valid</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Two</span><span class="org-whitespace-space"> </span><span class="org-doc">common</span><span class="org-whitespace-space"> </span><span class="org-doc">ranges</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">predefined</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">you:</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_limit_32b</span><span class="org-whitespace-tab">       </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">[0</span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">UINT_MAX]</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_limit_31b</span><span class="org-whitespace-tab">       </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">[0</span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">INT_MAX]</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_limit</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">        </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>;
<span class="org-whitespace-space">        </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span><span class="org-variable-name">min</span>;
};

<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">XA_LIMIT</span>(<span class="org-variable-name">_min</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">_max</span>)<span class="org-whitespace-space"> </span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_limit</span>)<span class="org-whitespace-space"> </span>{<span class="org-whitespace-space"> </span>.min<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>_min,<span class="org-whitespace-space"> </span>.max<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>_max<span class="org-whitespace-space"> </span>}

<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">xa_limit_32b</span><span class="org-whitespace-tab">    </span>XA_LIMIT(0,<span class="org-whitespace-space"> </span>UINT_MAX)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">xa_limit_31b</span><span class="org-whitespace-tab">    </span>XA_LIMIT(0,<span class="org-whitespace-space"> </span>INT_MAX)

<span class="org-keyword">typedef</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">__bitwise</span><span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>;
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_MARK_0</span><span class="org-whitespace-tab">               </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>)0U)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_MARK_1</span><span class="org-whitespace-tab">               </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>)1U)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_MARK_2</span><span class="org-whitespace-tab">               </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>)2U)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_PRESENT</span><span class="org-whitespace-tab">              </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>)8U)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_MARK_MAX</span><span class="org-whitespace-tab">             </span>XA_MARK_2
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_FREE_MARK</span><span class="org-whitespace-tab">            </span>XA_MARK_0

<span class="org-keyword">enum</span><span class="org-whitespace-space"> </span><span class="org-type">xa_lock_type</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">        </span><span class="org-variable-name">XA_LOCK_IRQ</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>1,
<span class="org-whitespace-space">        </span><span class="org-variable-name">XA_LOCK_BH</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>2,
};

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Values</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_flags.</span><span class="org-whitespace-space">  </span><span class="org-comment">The</span><span class="org-whitespace-space"> </span><span class="org-comment">radix</span><span class="org-whitespace-space"> </span><span class="org-comment">tree</span><span class="org-whitespace-space"> </span><span class="org-comment">stores</span><span class="org-whitespace-space"> </span><span class="org-comment">its</span><span class="org-whitespace-space"> </span><span class="org-comment">GFP</span><span class="org-whitespace-space"> </span><span class="org-comment">flags</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_flags,</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">and</span><span class="org-whitespace-space"> </span><span class="org-comment">we</span><span class="org-whitespace-space"> </span><span class="org-comment">remain</span><span class="org-whitespace-space"> </span><span class="org-comment">compatible</span><span class="org-whitespace-space"> </span><span class="org-comment">with</span><span class="org-whitespace-space"> </span><span class="org-comment">that.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_FLAGS_LOCK_IRQ</span><span class="org-whitespace-tab">       </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span>)XA_LOCK_IRQ)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_FLAGS_LOCK_BH</span><span class="org-whitespace-tab">        </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span>)XA_LOCK_BH)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_FLAGS_TRACK_FREE</span><span class="org-whitespace-tab">     </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span>)4U)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_FLAGS_ZERO_BUSY</span><span class="org-whitespace-tab">      </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span>)8U)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_FLAGS_ALLOC_WRAPPED</span><span class="org-whitespace-tab">  </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span>)16U)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_FLAGS_ACCOUNT</span><span class="org-whitespace-tab">        </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span>)32U)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">XA_FLAGS_MARK</span>(<span class="org-variable-name">mark</span>)<span class="org-whitespace-tab">     </span>((__force<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span>)((1U<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>__GFP_BITS_SHIFT)<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">                                                </span>(__force<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span>)(mark)))

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">ALLOC</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">normal</span><span class="org-whitespace-space"> </span><span class="org-comment">0-based</span><span class="org-whitespace-space"> </span><span class="org-comment">alloc.</span><span class="org-whitespace-space">  </span><span class="org-comment">ALLOC1</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">1-based</span><span class="org-whitespace-space"> </span><span class="org-comment">alloc</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_FLAGS_ALLOC</span><span class="org-whitespace-tab">  </span>(XA_FLAGS_TRACK_FREE<span class="org-whitespace-space"> </span>|<span class="org-whitespace-space"> </span>XA_FLAGS_MARK(XA_FREE_MARK))
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_FLAGS_ALLOC1</span><span class="org-whitespace-tab"> </span>(XA_FLAGS_TRACK_FREE<span class="org-whitespace-space"> </span>|<span class="org-whitespace-space"> </span>XA_FLAGS_ZERO_BUSY)

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">struct</span><span class="org-whitespace-space"> </span><span class="org-doc">xarray</span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">anchor</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa_lock</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Lock</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">protects</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">contents</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">To</span><span class="org-whitespace-space"> </span><span class="org-doc">use</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xarray,</span><span class="org-whitespace-space"> </span><span class="org-doc">define</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">statically</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">embed</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">your</span><span class="org-whitespace-space"> </span><span class="org-doc">data</span><span class="org-whitespace-space"> </span><span class="org-doc">structure.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">very</span><span class="org-whitespace-space"> </span><span class="org-doc">small</span><span class="org-whitespace-space"> </span><span class="org-doc">data</span><span class="org-whitespace-space"> </span><span class="org-doc">structure,</span><span class="org-whitespace-space"> </span><span class="org-doc">so</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">does</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">usually</span><span class="org-whitespace-space"> </span><span class="org-doc">make</span><span class="org-whitespace-space"> </span><span class="org-doc">sense</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">allocate</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">separately</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">keep</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">your</span><span class="org-whitespace-space"> </span><span class="org-doc">data</span><span class="org-whitespace-space"> </span><span class="org-doc">structure.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">You</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">use</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">protect</span><span class="org-whitespace-space"> </span><span class="org-doc">your</span><span class="org-whitespace-space"> </span><span class="org-doc">own</span><span class="org-whitespace-space"> </span><span class="org-doc">data</span><span class="org-whitespace-space"> </span><span class="org-doc">structures</span><span class="org-whitespace-space"> </span><span class="org-doc">as</span><span class="org-whitespace-space"> </span><span class="org-doc">well.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">all</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">entries</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">array</span><span class="org-whitespace-space"> </span><span class="org-comment">are</span><span class="org-whitespace-space"> </span><span class="org-comment">NULL,</span><span class="org-whitespace-space"> </span><span class="org-comment">@xa_head</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">NULL</span><span class="org-whitespace-space"> </span><span class="org-comment">pointer.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">only</span><span class="org-whitespace-space"> </span><span class="org-comment">non-NULL</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">array</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">at</span><span class="org-whitespace-space"> </span><span class="org-comment">index</span><span class="org-whitespace-space"> </span><span class="org-comment">0,</span><span class="org-whitespace-space"> </span><span class="org-comment">@xa_head</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">that</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">entry.</span><span class="org-whitespace-space">  </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">any</span><span class="org-whitespace-space"> </span><span class="org-comment">other</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">array</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">non-NULL,</span><span class="org-whitespace-space"> </span><span class="org-comment">@xa_head</span><span class="org-whitespace-space"> </span><span class="org-comment">points</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">@xa_node.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">        </span><span class="org-type">spinlock_t</span><span class="org-whitespace-tab">      </span><span class="org-variable-name">xa_lock</span>;
<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">private:</span><span class="org-whitespace-space"> </span><span class="org-comment">The</span><span class="org-whitespace-space"> </span><span class="org-comment">rest</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">data</span><span class="org-whitespace-space"> </span><span class="org-comment">structure</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">not</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">be</span><span class="org-whitespace-space"> </span><span class="org-comment">used</span><span class="org-whitespace-space"> </span><span class="org-comment">directly.</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">        </span><span class="org-type">gfp_t</span><span class="org-whitespace-tab">           </span><span class="org-variable-name">xa_flags</span>;
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-variable-name">__rcu</span><span class="org-whitespace-space"> </span>*<span class="org-whitespace-tab">    </span>xa_head;
};

<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">XARRAY_INIT</span>(<span class="org-variable-name">name</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">flags</span>)<span class="org-whitespace-space"> </span>{<span class="org-whitespace-tab">                              </span>\
<span class="org-whitespace-space">        </span>.xa_lock<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__SPIN_LOCK_UNLOCKED(name.xa_lock),<span class="org-whitespace-tab">          </span>\
<span class="org-whitespace-space">        </span>.xa_flags<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>flags,<span class="org-whitespace-tab">                                      </span>\
<span class="org-whitespace-space">        </span>.xa_head<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>,<span class="org-whitespace-tab">                                        </span>\
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">DEFINE_XARRAY_FLAGS()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Define</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc">custom</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@name</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">string</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">names</span><span class="org-whitespace-space"> </span><span class="org-doc">your</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@flags</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XA_FLAG</span><span class="org-whitespace-space"> </span><span class="org-doc">values.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">intended</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">file</span><span class="org-whitespace-space"> </span><span class="org-doc">scope</span><span class="org-whitespace-space"> </span><span class="org-doc">definitions</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">XArrays.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">declares</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">initialises</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">chosen</span><span class="org-whitespace-space"> </span><span class="org-doc">name</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">equivalent</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_init_flags()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array,</span><span class="org-whitespace-space"> </span><span class="org-doc">but</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">does</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">initialisation</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">compiletime</span><span class="org-whitespace-space"> </span><span class="org-doc">instead</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">runtime.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">DEFINE_XARRAY_FLAGS</span>(<span class="org-variable-name">name</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">flags</span>)<span class="org-whitespace-tab">                                </span>\
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span><span class="org-variable-name">name</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XARRAY_INIT(name,<span class="org-whitespace-space"> </span>flags)

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">DEFINE_XARRAY()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Define</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@name</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">string</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">names</span><span class="org-whitespace-space"> </span><span class="org-doc">your</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">intended</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">file</span><span class="org-whitespace-space"> </span><span class="org-doc">scope</span><span class="org-whitespace-space"> </span><span class="org-doc">definitions</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">XArrays.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">declares</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">initialises</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">chosen</span><span class="org-whitespace-space"> </span><span class="org-doc">name.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">equivalent</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_init()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array,</span><span class="org-whitespace-space"> </span><span class="org-doc">but</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">does</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">initialisation</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">compiletime</span><span class="org-whitespace-space"> </span><span class="org-doc">instead</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">runtime.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">DEFINE_XARRAY</span>(<span class="org-variable-name">name</span>)<span class="org-whitespace-space"> </span>DEFINE_XARRAY_FLAGS(name,<span class="org-whitespace-space"> </span>0)

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">DEFINE_XARRAY_ALLOC()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Define</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">allocates</span><span class="org-whitespace-space"> </span><span class="org-doc">IDs</span><span class="org-whitespace-space"> </span><span class="org-doc">starting</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">0.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@name</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">string</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">names</span><span class="org-whitespace-space"> </span><span class="org-doc">your</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">intended</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">file</span><span class="org-whitespace-space"> </span><span class="org-doc">scope</span><span class="org-whitespace-space"> </span><span class="org-doc">definitions</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">allocating</span><span class="org-whitespace-space"> </span><span class="org-doc">XArrays.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">See</span><span class="org-whitespace-space"> </span><span class="org-doc">also</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">DEFINE_XARRAY()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">DEFINE_XARRAY_ALLOC</span>(<span class="org-variable-name">name</span>)<span class="org-whitespace-space"> </span>DEFINE_XARRAY_FLAGS(name,<span class="org-whitespace-space"> </span>XA_FLAGS_ALLOC)

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">DEFINE_XARRAY_ALLOC1()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Define</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">allocates</span><span class="org-whitespace-space"> </span><span class="org-doc">IDs</span><span class="org-whitespace-space"> </span><span class="org-doc">starting</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">1.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@name</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">string</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">names</span><span class="org-whitespace-space"> </span><span class="org-doc">your</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">intended</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">file</span><span class="org-whitespace-space"> </span><span class="org-doc">scope</span><span class="org-whitespace-space"> </span><span class="org-doc">definitions</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">allocating</span><span class="org-whitespace-space"> </span><span class="org-doc">XArrays.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">See</span><span class="org-whitespace-space"> </span><span class="org-doc">also</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">DEFINE_XARRAY()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">DEFINE_XARRAY_ALLOC1</span>(<span class="org-variable-name">name</span>)<span class="org-whitespace-space"> </span>DEFINE_XARRAY_FLAGS(name,<span class="org-whitespace-space"> </span>XA_FLAGS_ALLOC1)

<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_load</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_store</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_erase</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_store_range</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">first</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">last</span>,
<span class="org-whitespace-space">                        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span>);
<span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_get_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_set_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_clear_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_find</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">index</span>,
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>)<span class="org-whitespace-space"> </span><span class="org-keyword">__attribute__</span>((nonnull(2)));
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_find_after</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">index</span>,
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>)<span class="org-whitespace-space"> </span><span class="org-keyword">__attribute__</span>((nonnull(2)));
<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_extract</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>**<span class="org-variable-name">dst</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">start</span>,
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">n</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_destroy</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_init_flags()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Initialise</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@flags</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XA_FLAG</span><span class="org-whitespace-space"> </span><span class="org-doc">values.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">need</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">initialise</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc">special</span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">(eg</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">need</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">take</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">lock</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">interrupt</span><span class="org-whitespace-space"> </span><span class="org-doc">context),</span><span class="org-whitespace-space"> </span><span class="org-doc">use</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">instead</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_init()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_init_flags</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">flags</span>)
{
<span class="org-whitespace-space">        </span>spin_lock_init(&amp;xa-&gt;xa_lock);
<span class="org-whitespace-space">        </span>xa-&gt;xa_flags<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>flags;
<span class="org-whitespace-space">        </span>xa-&gt;xa_head<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_init()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Initialise</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">An</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">full</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL</span><span class="org-whitespace-space"> </span><span class="org-doc">entries.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_init</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>)
{
<span class="org-whitespace-space">        </span>xa_init_flags(xa,<span class="org-whitespace-space"> </span>0);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_empty()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Determine</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">any</span><span class="org-whitespace-space"> </span><span class="org-doc">present</span><span class="org-whitespace-space"> </span><span class="org-doc">entries.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%true</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">contains</span><span class="org-whitespace-space"> </span><span class="org-doc">only</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL</span><span class="org-whitespace-space"> </span><span class="org-doc">pointers.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_empty</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa-&gt;xa_head<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_marked()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Inquire</span><span class="org-whitespace-space"> </span><span class="org-doc">whether</span><span class="org-whitespace-space"> </span><span class="org-doc">any</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Array</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@mark</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Mark</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%true</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">any</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">mark</span><span class="org-whitespace-space"> </span><span class="org-doc">set.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_marked</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa-&gt;xa_flags<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_FLAGS_MARK(mark);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_for_each_start()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Iterate</span><span class="org-whitespace-space"> </span><span class="org-doc">over</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">portion</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Entry</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieved</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@start</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">First</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieve</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">During</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration,</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">You</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">modify</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">during</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">want</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">skip</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">reprocess</span><span class="org-whitespace-space"> </span><span class="org-doc">indices.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">safe</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">modify</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">during</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration.</span><span class="org-whitespace-space">  </span><span class="org-doc">At</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">end</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration,</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">less</span><span class="org-whitespace-space"> </span><span class="org-doc">than</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">equal</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">max.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_for_each_start()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">O(n.log(n))</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">O(n).</span><span class="org-whitespace-space">  </span><span class="org-doc">You</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">handle</span><span class="org-whitespace-space"> </span><span class="org-doc">your</span><span class="org-whitespace-space"> </span><span class="org-doc">own</span><span class="org-whitespace-space"> </span><span class="org-doc">locking</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each()</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">unlock</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">after</span><span class="org-whitespace-space"> </span><span class="org-doc">each</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration,</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">also</span><span class="org-whitespace-space"> </span><span class="org-doc">end</span><span class="org-whitespace-space"> </span><span class="org-doc">up</span><span class="org-whitespace-space"> </span><span class="org-doc">being</span><span class="org-whitespace-space"> </span><span class="org-doc">O(n.log(n)).</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_for_each_start()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">spin</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">hits</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">entry;</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">intend</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">entries,</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">should</span><span class="org-whitespace-space"> </span><span class="org-doc">use</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">iterator</span><span class="org-whitespace-space"> </span><span class="org-doc">instead.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">iterator</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">expand</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">more</span><span class="org-whitespace-space"> </span><span class="org-doc">inline</span><span class="org-whitespace-space"> </span><span class="org-doc">code</span><span class="org-whitespace-space"> </span><span class="org-doc">than</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_for_each_start()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_for_each_start</span>(<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">start</span>)<span class="org-whitespace-tab">                      </span>\
<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(index<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>start,<span class="org-whitespace-tab">                                             </span>\
<span class="org-whitespace-space">             </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_find(xa,<span class="org-whitespace-space"> </span>&amp;index,<span class="org-whitespace-space"> </span>ULONG_MAX,<span class="org-whitespace-space"> </span>XA_PRESENT);<span class="org-whitespace-tab">        </span>\
<span class="org-whitespace-space">             </span>entry;<span class="org-whitespace-tab">                                                     </span>\
<span class="org-whitespace-space">             </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_find_after(xa,<span class="org-whitespace-space"> </span>&amp;index,<span class="org-whitespace-space"> </span>ULONG_MAX,<span class="org-whitespace-space"> </span>XA_PRESENT))

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_for_each()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Iterate</span><span class="org-whitespace-space"> </span><span class="org-doc">over</span><span class="org-whitespace-space"> </span><span class="org-doc">present</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Entry</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieved</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">During</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration,</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">You</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">modify</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">during</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">want</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">skip</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">reprocess</span><span class="org-whitespace-space"> </span><span class="org-doc">indices.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">safe</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">modify</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">during</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration.</span><span class="org-whitespace-space">  </span><span class="org-doc">At</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">end</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration,</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">less</span><span class="org-whitespace-space"> </span><span class="org-doc">than</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">equal</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">max.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_for_each()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">O(n.log(n))</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">O(n).</span><span class="org-whitespace-space">  </span><span class="org-doc">You</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">handle</span><span class="org-whitespace-space"> </span><span class="org-doc">your</span><span class="org-whitespace-space"> </span><span class="org-doc">own</span><span class="org-whitespace-space"> </span><span class="org-doc">locking</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each()</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">unlock</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">after</span><span class="org-whitespace-space"> </span><span class="org-doc">each</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration,</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">also</span><span class="org-whitespace-space"> </span><span class="org-doc">end</span><span class="org-whitespace-space"> </span><span class="org-doc">up</span><span class="org-whitespace-space"> </span><span class="org-doc">being</span><span class="org-whitespace-space"> </span><span class="org-doc">O(n.log(n)).</span><span class="org-whitespace-space">  </span><span class="org-doc"><span class="org-constant">xa_for_each()</span></span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">spin</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">hits</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">entry;</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">intend</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">entries,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">should</span><span class="org-whitespace-space"> </span><span class="org-doc">use</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">iterator</span><span class="org-whitespace-space"> </span><span class="org-doc">instead.</span><span class="org-whitespace-space">  </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each()</span></span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">iterator</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">expand</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">more</span><span class="org-whitespace-space"> </span><span class="org-doc">inline</span><span class="org-whitespace-space"> </span><span class="org-doc">code</span><span class="org-whitespace-space"> </span><span class="org-doc">than</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_for_each()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_for_each</span>(<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">entry</span>)<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">        </span>xa_for_each_start(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>0)

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_for_each_marked()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Iterate</span><span class="org-whitespace-space"> </span><span class="org-doc">over</span><span class="org-whitespace-space"> </span><span class="org-doc">marked</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Entry</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieved</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@filter</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Selection</span><span class="org-whitespace-space"> </span><span class="org-doc">criterion.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">During</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration,</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">skip</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">do</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">match</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@filter</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">You</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">modify</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">during</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">want</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">skip</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">reprocess</span><span class="org-whitespace-space"> </span><span class="org-doc">indices.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">safe</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">modify</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">during</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration.</span><span class="org-whitespace-space">  </span><span class="org-doc">At</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">end</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration,</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">less</span><span class="org-whitespace-space"> </span><span class="org-doc">than</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">equal</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">max.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_for_each_marked()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">O(n.log(n))</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each_marked()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">O(n).</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">You</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">handle</span><span class="org-whitespace-space"> </span><span class="org-doc">your</span><span class="org-whitespace-space"> </span><span class="org-doc">own</span><span class="org-whitespace-space"> </span><span class="org-doc">locking</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each()</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">unlock</span><span class="org-whitespace-space"> </span><span class="org-doc">after</span><span class="org-whitespace-space"> </span><span class="org-doc">each</span><span class="org-whitespace-space"> </span><span class="org-doc">iteration,</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">also</span><span class="org-whitespace-space"> </span><span class="org-doc">end</span><span class="org-whitespace-space"> </span><span class="org-doc">up</span><span class="org-whitespace-space"> </span><span class="org-doc">being</span><span class="org-whitespace-space"> </span><span class="org-doc">O(n.log(n)).</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_for_each_marked()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">spin</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">hits</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">entry;</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">intend</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">entries,</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">should</span><span class="org-whitespace-space"> </span><span class="org-doc">use</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each_marked()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">iterator</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">instead.</span><span class="org-whitespace-space">  </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each_marked()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">iterator</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">expand</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">more</span><span class="org-whitespace-space"> </span><span class="org-doc">inline</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">code</span><span class="org-whitespace-space"> </span><span class="org-doc">than</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_for_each_marked()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_for_each_marked</span>(<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">filter</span>)<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(index<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0,<span class="org-whitespace-space"> </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_find(xa,<span class="org-whitespace-space"> </span>&amp;index,<span class="org-whitespace-space"> </span>ULONG_MAX,<span class="org-whitespace-space"> </span>filter);<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">             </span>entry;<span class="org-whitespace-space"> </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_find_after(xa,<span class="org-whitespace-space"> </span>&amp;index,<span class="org-whitespace-space"> </span>ULONG_MAX,<span class="org-whitespace-space"> </span>filter))

<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_trylock</span>(<span class="org-variable-name">xa</span>)<span class="org-whitespace-tab">          </span>spin_trylock(&amp;(xa)-&gt;xa_lock)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_lock</span>(<span class="org-variable-name">xa</span>)<span class="org-whitespace-tab">             </span>spin_lock(&amp;(xa)-&gt;xa_lock)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_unlock</span>(<span class="org-variable-name">xa</span>)<span class="org-whitespace-tab">           </span>spin_unlock(&amp;(xa)-&gt;xa_lock)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_lock_bh</span>(<span class="org-variable-name">xa</span>)<span class="org-whitespace-tab">          </span>spin_lock_bh(&amp;(xa)-&gt;xa_lock)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_unlock_bh</span>(<span class="org-variable-name">xa</span>)<span class="org-whitespace-tab">        </span>spin_unlock_bh(&amp;(xa)-&gt;xa_lock)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_lock_irq</span>(<span class="org-variable-name">xa</span>)<span class="org-whitespace-tab">         </span>spin_lock_irq(&amp;(xa)-&gt;xa_lock)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_unlock_irq</span>(<span class="org-variable-name">xa</span>)<span class="org-whitespace-tab">       </span>spin_unlock_irq(&amp;(xa)-&gt;xa_lock)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_lock_irqsave</span>(<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">flags</span>)<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">                                </span>spin_lock_irqsave(&amp;(xa)-&gt;xa_lock,<span class="org-whitespace-space"> </span>flags)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_unlock_irqrestore</span>(<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">flags</span>)<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">                                </span>spin_unlock_irqrestore(&amp;(xa)-&gt;xa_lock,<span class="org-whitespace-space"> </span>flags)

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Versions</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">normal</span><span class="org-whitespace-space"> </span><span class="org-comment">API</span><span class="org-whitespace-space"> </span><span class="org-comment">which</span><span class="org-whitespace-space"> </span><span class="org-comment">require</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">caller</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">hold</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_lock.</span><span class="org-whitespace-space">  </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">GFP</span><span class="org-whitespace-space"> </span><span class="org-comment">flags</span><span class="org-whitespace-space"> </span><span class="org-comment">allow</span><span class="org-whitespace-space"> </span><span class="org-comment">it,</span><span class="org-whitespace-space"> </span><span class="org-comment">they</span><span class="org-whitespace-space"> </span><span class="org-comment">will</span><span class="org-whitespace-space"> </span><span class="org-comment">drop</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">lock</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">allocate</span><span class="org-whitespace-space"> </span><span class="org-comment">memory,</span><span class="org-whitespace-space"> </span><span class="org-comment">then</span><span class="org-whitespace-space"> </span><span class="org-comment">reacquire</span><span class="org-whitespace-space"> </span><span class="org-comment">it</span><span class="org-whitespace-space"> </span><span class="org-comment">afterwards.</span><span class="org-whitespace-space">  </span><span class="org-comment">These</span><span class="org-whitespace-space"> </span><span class="org-comment">functions</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">may</span><span class="org-whitespace-space"> </span><span class="org-comment">also</span><span class="org-whitespace-space"> </span><span class="org-comment">re-enable</span><span class="org-whitespace-space"> </span><span class="org-comment">interrupts</span><span class="org-whitespace-space"> </span><span class="org-comment">if</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray</span><span class="org-whitespace-space"> </span><span class="org-comment">flags</span><span class="org-whitespace-space"> </span><span class="org-comment">indicate</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">locking</span><span class="org-whitespace-space"> </span><span class="org-comment">should</span><span class="org-whitespace-space"> </span><span class="org-comment">be</span><span class="org-whitespace-space"> </span><span class="org-comment">interrupt</span><span class="org-whitespace-space"> </span><span class="org-comment">safe.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">__xa_erase</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">__xa_store</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">__xa_cmpxchg</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">old</span>,
<span class="org-whitespace-space">                </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span>);
<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">__must_check</span><span class="org-whitespace-space"> </span>__xa_insert(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,
<span class="org-whitespace-space">                </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span>gfp_t);
<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">__must_check</span><span class="org-whitespace-space"> </span>__xa_alloc(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">id</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,
<span class="org-whitespace-space">                </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_limit</span>,<span class="org-whitespace-space"> </span>gfp_t);
<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">__must_check</span><span class="org-whitespace-space"> </span>__xa_alloc_cyclic(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">id</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,
<span class="org-whitespace-space">                </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_limit</span>,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">next</span>,<span class="org-whitespace-space"> </span>gfp_t);
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">__xa_set_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">__xa_clear_mark</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_store_bh()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">like</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_store()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">except</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">disables</span><span class="org-whitespace-space"> </span><span class="org-doc">softirqs</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc">holding</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">softirqs.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">used</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_store_bh</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,
<span class="org-whitespace-space">                </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">curr</span>;

<span class="org-whitespace-space">        </span>xa_lock_bh(xa);
<span class="org-whitespace-space">        </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_store(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock_bh(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>curr;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_store_irq()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">like</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_store()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">except</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">disables</span><span class="org-whitespace-space"> </span><span class="org-doc">interrupts</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc">holding</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Process</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">interrupts.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">used</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_store_irq</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,
<span class="org-whitespace-space">                </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">curr</span>;

<span class="org-whitespace-space">        </span>xa_lock_irq(xa);
<span class="org-whitespace-space">        </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_store(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock_irq(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>curr;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_erase_bh()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Erase</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">After</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">returns,</span><span class="org-whitespace-space"> </span><span class="org-doc">loading</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">part</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">multi-index</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">indices</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">erased</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">none</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">part</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">multi-index</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">softirqs.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">used</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_erase_bh</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span>xa_lock_bh(xa);
<span class="org-whitespace-space">        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_erase(xa,<span class="org-whitespace-space"> </span>index);
<span class="org-whitespace-space">        </span>xa_unlock_bh(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_erase_irq()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Erase</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">After</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">returns,</span><span class="org-whitespace-space"> </span><span class="org-doc">loading</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">part</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">multi-index</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">indices</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">erased</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">none</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">part</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">multi-index</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Process</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">interrupts.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">used</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_erase_irq</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span>xa_lock_irq(xa);
<span class="org-whitespace-space">        </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_erase(xa,<span class="org-whitespace-space"> </span>index);
<span class="org-whitespace-space">        </span>xa_unlock_irq(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_cmpxchg()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Conditionally</span><span class="org-whitespace-space"> </span><span class="org-doc">replace</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@old</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Old</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">test</span><span class="org-whitespace-space"> </span><span class="org-doc">against.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">place</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">same</span><span class="org-whitespace-space"> </span><span class="org-doc">as</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@old</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">replace</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">equal</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@old</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">then</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">exchange</span><span class="org-whitespace-space"> </span><span class="org-doc">was</span><span class="org-whitespace-space"> </span><span class="org-doc">successful.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">old</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_err()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">happened.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_cmpxchg</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,
<span class="org-whitespace-space">                        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">old</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">curr</span>;

<span class="org-whitespace-space">        </span>xa_lock(xa);
<span class="org-whitespace-space">        </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_cmpxchg(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>old,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>curr;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_cmpxchg_bh()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Conditionally</span><span class="org-whitespace-space"> </span><span class="org-doc">replace</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@old</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Old</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">test</span><span class="org-whitespace-space"> </span><span class="org-doc">against.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">place</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">like</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_cmpxchg()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">except</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">disables</span><span class="org-whitespace-space"> </span><span class="org-doc">softirqs</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc">holding</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">softirqs.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">old</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_err()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">happened.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_cmpxchg_bh</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,
<span class="org-whitespace-space">                        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">old</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">curr</span>;

<span class="org-whitespace-space">        </span>xa_lock_bh(xa);
<span class="org-whitespace-space">        </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_cmpxchg(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>old,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock_bh(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>curr;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_cmpxchg_irq()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Conditionally</span><span class="org-whitespace-space"> </span><span class="org-doc">replace</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@old</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Old</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">test</span><span class="org-whitespace-space"> </span><span class="org-doc">against.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">place</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">like</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_cmpxchg()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">except</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">disables</span><span class="org-whitespace-space"> </span><span class="org-doc">interrupts</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc">holding</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Process</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">interrupts.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">old</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_err()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">happened.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_cmpxchg_irq</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,
<span class="org-whitespace-space">                        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">old</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">curr</span>;

<span class="org-whitespace-space">        </span>xa_lock_irq(xa);
<span class="org-whitespace-space">        </span>curr<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_cmpxchg(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>old,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock_irq(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>curr;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_insert()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">unless</span><span class="org-whitespace-space"> </span><span class="org-doc">another</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-tab">                      </span><span class="org-doc">already</span><span class="org-whitespace-space"> </span><span class="org-doc">present.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Inserting</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">reserved</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">(like</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_reserve()</span></span><span class="org-doc">)</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">present.</span><span class="org-whitespace-space">  </span><span class="org-doc">Inserting</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">fail</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">reserved</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">present,</span><span class="org-whitespace-space"> </span><span class="org-doc">even</span><span class="org-whitespace-space"> </span><span class="org-doc">though</span><span class="org-whitespace-space"> </span><span class="org-doc">loading</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded.</span><span class="org-whitespace-space">  </span><span class="org-doc">-EBUSY</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">another</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">was</span><span class="org-whitespace-space"> </span><span class="org-doc">present.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">could</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">__must_check</span><span class="org-whitespace-space"> </span>xa_insert(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">err</span>;

<span class="org-whitespace-space">        </span>xa_lock(xa);
<span class="org-whitespace-space">        </span>err<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_insert(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>err;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_insert_bh()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">unless</span><span class="org-whitespace-space"> </span><span class="org-doc">another</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-tab">                      </span><span class="org-doc">already</span><span class="org-whitespace-space"> </span><span class="org-doc">present.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Inserting</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">reserved</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">(like</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_reserve()</span></span><span class="org-doc">)</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">present.</span><span class="org-whitespace-space">  </span><span class="org-doc">Inserting</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">fail</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">reserved</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">present,</span><span class="org-whitespace-space"> </span><span class="org-doc">even</span><span class="org-whitespace-space"> </span><span class="org-doc">though</span><span class="org-whitespace-space"> </span><span class="org-doc">loading</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">softirqs.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded.</span><span class="org-whitespace-space">  </span><span class="org-doc">-EBUSY</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">another</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">was</span><span class="org-whitespace-space"> </span><span class="org-doc">present.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">could</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">__must_check</span><span class="org-whitespace-space"> </span>xa_insert_bh(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">err</span>;

<span class="org-whitespace-space">        </span>xa_lock_bh(xa);
<span class="org-whitespace-space">        </span>err<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_insert(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock_bh(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>err;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_insert_irq()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">unless</span><span class="org-whitespace-space"> </span><span class="org-doc">another</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-tab">                      </span><span class="org-doc">already</span><span class="org-whitespace-space"> </span><span class="org-doc">present.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Inserting</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">reserved</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">(like</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_reserve()</span></span><span class="org-doc">)</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">present.</span><span class="org-whitespace-space">  </span><span class="org-doc">Inserting</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">fail</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">reserved</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">present,</span><span class="org-whitespace-space"> </span><span class="org-doc">even</span><span class="org-whitespace-space"> </span><span class="org-doc">though</span><span class="org-whitespace-space"> </span><span class="org-doc">loading</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc">NULL.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Process</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">interrupts.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded.</span><span class="org-whitespace-space">  </span><span class="org-doc">-EBUSY</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">another</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">was</span><span class="org-whitespace-space"> </span><span class="org-doc">present.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">could</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">__must_check</span><span class="org-whitespace-space"> </span>xa_insert_irq(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">err</span>;

<span class="org-whitespace-space">        </span>xa_lock_irq(xa);
<span class="org-whitespace-space">        </span>err<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_insert(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock_irq(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>err;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_alloc()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Find</span><span class="org-whitespace-space"> </span><span class="org-doc">somewhere</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@id</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">ID.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@limit</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Range</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">ID</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">allocate.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Finds</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-whitespace-space"> </span><span class="org-doc">between</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.min</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.max,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-whitespace-space"> </span><span class="org-doc">pointer,</span><span class="org-whitespace-space"> </span><span class="org-doc">then</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span><span class="org-whitespace-space">  </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">concurrent</span><span class="org-whitespace-space"> </span><span class="org-doc">lookup</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">uninitialised</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">success,</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">could</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">-EBUSY</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">there</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">free</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span>__must_check<span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_alloc</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">id</span>,
<span class="org-whitespace-space">                </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_limit</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limit</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">err</span>;

<span class="org-whitespace-space">        </span>xa_lock(xa);
<span class="org-whitespace-space">        </span>err<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_alloc(xa,<span class="org-whitespace-space"> </span>id,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>limit,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>err;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_alloc_bh()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Find</span><span class="org-whitespace-space"> </span><span class="org-doc">somewhere</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@id</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">ID.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@limit</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Range</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">ID</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">allocate.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Finds</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-whitespace-space"> </span><span class="org-doc">between</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.min</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.max,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-whitespace-space"> </span><span class="org-doc">pointer,</span><span class="org-whitespace-space"> </span><span class="org-doc">then</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span><span class="org-whitespace-space">  </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">concurrent</span><span class="org-whitespace-space"> </span><span class="org-doc">lookup</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">uninitialised</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">softirqs.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">success,</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">could</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">-EBUSY</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">there</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">free</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">__must_check</span><span class="org-whitespace-space"> </span>xa_alloc_bh(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">id</span>,
<span class="org-whitespace-space">                </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_limit</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limit</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">err</span>;

<span class="org-whitespace-space">        </span>xa_lock_bh(xa);
<span class="org-whitespace-space">        </span>err<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_alloc(xa,<span class="org-whitespace-space"> </span>id,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>limit,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock_bh(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>err;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_alloc_irq()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Find</span><span class="org-whitespace-space"> </span><span class="org-doc">somewhere</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@id</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">ID.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@limit</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Range</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">ID</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">allocate.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Finds</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-whitespace-space"> </span><span class="org-doc">between</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.min</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.max,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-whitespace-space"> </span><span class="org-doc">pointer,</span><span class="org-whitespace-space"> </span><span class="org-doc">then</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span><span class="org-whitespace-space">  </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">concurrent</span><span class="org-whitespace-space"> </span><span class="org-doc">lookup</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">uninitialised</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Process</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">interrupts.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">success,</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">could</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">-EBUSY</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">there</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">free</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">__must_check</span><span class="org-whitespace-space"> </span>xa_alloc_irq(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">id</span>,
<span class="org-whitespace-space">                </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_limit</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limit</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">err</span>;

<span class="org-whitespace-space">        </span>xa_lock_irq(xa);
<span class="org-whitespace-space">        </span>err<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_alloc(xa,<span class="org-whitespace-space"> </span>id,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>limit,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock_irq(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>err;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_alloc_cyclic()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Find</span><span class="org-whitespace-space"> </span><span class="org-doc">somewhere</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@id</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">ID.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@limit</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Range</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">ID.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@next</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">ID</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">allocate.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Finds</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-whitespace-space"> </span><span class="org-doc">between</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.min</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.max,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-whitespace-space"> </span><span class="org-doc">pointer,</span><span class="org-whitespace-space"> </span><span class="org-doc">then</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span><span class="org-whitespace-space">  </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">concurrent</span><span class="org-whitespace-space"> </span><span class="org-doc">lookup</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">uninitialised</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">search</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">start</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@next</span></span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">wrap</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">around</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">necessary.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded</span><span class="org-whitespace-space"> </span><span class="org-doc">without</span><span class="org-whitespace-space"> </span><span class="org-doc">wrapping.</span><span class="org-whitespace-space">  </span><span class="org-doc">1</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded</span><span class="org-whitespace-space"> </span><span class="org-doc">after</span><span class="org-whitespace-space"> </span><span class="org-doc">wrapping,</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">could</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">-EBUSY</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">there</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">free</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_alloc_cyclic</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">id</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,
<span class="org-whitespace-space">                </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_limit</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limit</span>,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">next</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">err</span>;

<span class="org-whitespace-space">        </span>xa_lock(xa);
<span class="org-whitespace-space">        </span>err<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_alloc_cyclic(xa,<span class="org-whitespace-space"> </span>id,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>limit,<span class="org-whitespace-space"> </span>next,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>err;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_alloc_cyclic_bh()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Find</span><span class="org-whitespace-space"> </span><span class="org-doc">somewhere</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@id</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">ID.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@limit</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Range</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">ID.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@next</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">ID</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">allocate.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Finds</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-whitespace-space"> </span><span class="org-doc">between</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.min</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.max,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-whitespace-space"> </span><span class="org-doc">pointer,</span><span class="org-whitespace-space"> </span><span class="org-doc">then</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span><span class="org-whitespace-space">  </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">concurrent</span><span class="org-whitespace-space"> </span><span class="org-doc">lookup</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">uninitialised</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">search</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">start</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@next</span></span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">wrap</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">around</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">necessary.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">softirqs.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded</span><span class="org-whitespace-space"> </span><span class="org-doc">without</span><span class="org-whitespace-space"> </span><span class="org-doc">wrapping.</span><span class="org-whitespace-space">  </span><span class="org-doc">1</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded</span><span class="org-whitespace-space"> </span><span class="org-doc">after</span><span class="org-whitespace-space"> </span><span class="org-doc">wrapping,</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">could</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">-EBUSY</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">there</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">free</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_alloc_cyclic_bh</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">id</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,
<span class="org-whitespace-space">                </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_limit</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limit</span>,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">next</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">err</span>;

<span class="org-whitespace-space">        </span>xa_lock_bh(xa);
<span class="org-whitespace-space">        </span>err<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_alloc_cyclic(xa,<span class="org-whitespace-space"> </span>id,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>limit,<span class="org-whitespace-space"> </span>next,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock_bh(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>err;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_alloc_cyclic_irq()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Find</span><span class="org-whitespace-space"> </span><span class="org-doc">somewhere</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@id</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">ID.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@limit</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Range</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">ID.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@next</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Pointer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">ID</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">allocate.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Finds</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xa</span></span><span class="org-whitespace-space"> </span><span class="org-doc">between</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.min</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.max,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-whitespace-space"> </span><span class="org-doc">pointer,</span><span class="org-whitespace-space"> </span><span class="org-doc">then</span><span class="org-whitespace-space"> </span><span class="org-doc">stores</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span><span class="org-whitespace-space">  </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">concurrent</span><span class="org-whitespace-space"> </span><span class="org-doc">lookup</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">uninitialised</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@id</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">search</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">empty</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">start</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@next</span></span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">wrap</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">around</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">necessary.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Process</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">interrupts.</span><span class="org-whitespace-space">  </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded</span><span class="org-whitespace-space"> </span><span class="org-doc">without</span><span class="org-whitespace-space"> </span><span class="org-doc">wrapping.</span><span class="org-whitespace-space">  </span><span class="org-doc">1</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded</span><span class="org-whitespace-space"> </span><span class="org-doc">after</span><span class="org-whitespace-space"> </span><span class="org-doc">wrapping,</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">could</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">allocated</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">-EBUSY</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">there</span><span class="org-whitespace-space"> </span><span class="org-doc">are</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">free</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@limit</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_alloc_cyclic_irq</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">id</span>,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>,
<span class="org-whitespace-space">                </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_limit</span><span class="org-whitespace-space"> </span><span class="org-variable-name">limit</span>,<span class="org-whitespace-space"> </span><span class="org-type">u32</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">next</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">err</span>;

<span class="org-whitespace-space">        </span>xa_lock_irq(xa);
<span class="org-whitespace-space">        </span>err<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__xa_alloc_cyclic(xa,<span class="org-whitespace-space"> </span>id,<span class="org-whitespace-space"> </span>entry,<span class="org-whitespace-space"> </span>limit,<span class="org-whitespace-space"> </span>next,<span class="org-whitespace-space"> </span>gfp);
<span class="org-whitespace-space">        </span>xa_unlock_irq(xa);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>err;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_reserve()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Reserve</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Ensures</span><span class="org-whitespace-space"> </span><span class="org-doc">there</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">somewhere</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">store</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">there</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">already</span><span class="org-whitespace-space"> </span><span class="org-doc">something</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">does</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">nothing.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">there</span><span class="org-whitespace-space"> </span><span class="org-doc">was</span><span class="org-whitespace-space"> </span><span class="org-doc">nothing</span><span class="org-whitespace-space"> </span><span class="org-doc">there,</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">marked</span><span class="org-whitespace-space"> </span><span class="org-doc">as</span><span class="org-whitespace-space"> </span><span class="org-doc">reserved.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Loading</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">reserved</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">returns</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-whitespace-space"> </span><span class="org-doc">pointer.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">do</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">use</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">reserved,</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_release()</span></span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_erase()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">free</span><span class="org-whitespace-space"> </span><span class="org-doc">any</span><span class="org-whitespace-space"> </span><span class="org-doc">unnecessary</span><span class="org-whitespace-space"> </span><span class="org-doc">memory.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">May</span><span class="org-whitespace-space"> </span><span class="org-doc">sleep</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@gfp</span></span><span class="org-whitespace-space"> </span><span class="org-doc">flags</span><span class="org-whitespace-space"> </span><span class="org-doc">permit.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">reservation</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">failed.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span>__must_check
<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_reserve</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_err(xa_cmpxchg(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>,<span class="org-whitespace-space"> </span>XA_ZERO_ENTRY,<span class="org-whitespace-space"> </span>gfp));
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_reserve_bh()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Reserve</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">softirq-disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">version</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_reserve()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">softirqs.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">reservation</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">failed.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span>__must_check
<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_reserve_bh</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_err(xa_cmpxchg_bh(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>,<span class="org-whitespace-space"> </span>XA_ZERO_ENTRY,<span class="org-whitespace-space"> </span>gfp));
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_reserve_irq()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Reserve</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@gfp</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Memory</span><span class="org-whitespace-space"> </span><span class="org-doc">allocation</span><span class="org-whitespace-space"> </span><span class="org-doc">flags.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">An</span><span class="org-whitespace-space"> </span><span class="org-doc">interrupt-disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">version</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_reserve()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Process</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span><span class="org-whitespace-space">  </span><span class="org-doc">Takes</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">releases</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">disabling</span><span class="org-whitespace-space"> </span><span class="org-doc">interrupts.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">reservation</span><span class="org-whitespace-space"> </span><span class="org-doc">succeeded</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">-ENOMEM</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">failed.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span>__must_check
<span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_reserve_irq</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">gfp</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_err(xa_cmpxchg_irq(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>,<span class="org-whitespace-space"> </span>XA_ZERO_ENTRY,<span class="org-whitespace-space"> </span>gfp));
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_release()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Release</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">reserved</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xa</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">After</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_reserve()</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">can</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">release</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">reservation.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@index</span></span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">to,</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">do</span><span class="org-whitespace-space"> </span><span class="org-doc">nothing.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_release</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>)
{
<span class="org-whitespace-space">        </span>xa_cmpxchg(xa,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>XA_ZERO_ENTRY,<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>,<span class="org-whitespace-space"> </span>0);
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Everything</span><span class="org-whitespace-space"> </span><span class="org-comment">below</span><span class="org-whitespace-space"> </span><span class="org-comment">here</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">Advanced</span><span class="org-whitespace-space"> </span><span class="org-comment">API.</span><span class="org-whitespace-space">  </span><span class="org-comment">Proceed</span><span class="org-whitespace-space"> </span><span class="org-comment">with</span><span class="org-whitespace-space"> </span><span class="org-comment">caution.</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">The</span><span class="org-whitespace-space"> </span><span class="org-comment">xarray</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">constructed</span><span class="org-whitespace-space"> </span><span class="org-comment">out</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">set</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">'chunks'</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">pointers.</span><span class="org-whitespace-space">  </span><span class="org-comment">Choosing</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">best</span><span class="org-whitespace-space"> </span><span class="org-comment">chunk</span><span class="org-whitespace-space"> </span><span class="org-comment">size</span><span class="org-whitespace-space"> </span><span class="org-comment">requires</span><span class="org-whitespace-space"> </span><span class="org-comment">some</span><span class="org-whitespace-space"> </span><span class="org-comment">tradeoffs.</span><span class="org-whitespace-space">  </span><span class="org-comment">A</span><span class="org-whitespace-space"> </span><span class="org-comment">power</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">two</span><span class="org-whitespace-space"> </span><span class="org-comment">recommends</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">itself</span><span class="org-whitespace-space"> </span><span class="org-comment">so</span><span class="org-whitespace-space"> </span><span class="org-comment">that</span><span class="org-whitespace-space"> </span><span class="org-comment">we</span><span class="org-whitespace-space"> </span><span class="org-comment">can</span><span class="org-whitespace-space"> </span><span class="org-comment">walk</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">tree</span><span class="org-whitespace-space"> </span><span class="org-comment">based</span><span class="org-whitespace-space"> </span><span class="org-comment">purely</span><span class="org-whitespace-space"> </span><span class="org-comment">on</span><span class="org-whitespace-space"> </span><span class="org-comment">shifts</span><span class="org-whitespace-space"> </span><span class="org-comment">and</span><span class="org-whitespace-space"> </span><span class="org-comment">masks.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">Generally,</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">larger</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">better;</span><span class="org-whitespace-space"> </span><span class="org-comment">as</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">number</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">slots</span><span class="org-whitespace-space"> </span><span class="org-comment">per</span><span class="org-whitespace-space"> </span><span class="org-comment">level</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">tree</span><span class="org-whitespace-space"> </span><span class="org-comment">increases,</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">less</span><span class="org-whitespace-space"> </span><span class="org-comment">tall</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">tree</span><span class="org-whitespace-space"> </span><span class="org-comment">needs</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">be.</span><span class="org-whitespace-space">  </span><span class="org-comment">But</span><span class="org-whitespace-space"> </span><span class="org-comment">that</span><span class="org-whitespace-space"> </span><span class="org-comment">needs</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">be</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">balanced</span><span class="org-whitespace-space"> </span><span class="org-comment">against</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">memory</span><span class="org-whitespace-space"> </span><span class="org-comment">consumption</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">each</span><span class="org-whitespace-space"> </span><span class="org-comment">node.</span><span class="org-whitespace-space">  </span><span class="org-comment">On</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">64-bit</span><span class="org-whitespace-space"> </span><span class="org-comment">system,</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_node</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">currently</span><span class="org-whitespace-space"> </span><span class="org-comment">576</span><span class="org-whitespace-space"> </span><span class="org-comment">bytes,</span><span class="org-whitespace-space"> </span><span class="org-comment">and</span><span class="org-whitespace-space"> </span><span class="org-comment">we</span><span class="org-whitespace-space"> </span><span class="org-comment">get</span><span class="org-whitespace-space"> </span><span class="org-comment">7</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">them</span><span class="org-whitespace-space"> </span><span class="org-comment">per</span><span class="org-whitespace-space"> </span><span class="org-comment">4kB</span><span class="org-whitespace-space"> </span><span class="org-comment">page.</span><span class="org-whitespace-space">  </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">we</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">doubled</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">number</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">slots</span><span class="org-whitespace-space"> </span><span class="org-comment">per</span><span class="org-whitespace-space"> </span><span class="org-comment">node,</span><span class="org-whitespace-space"> </span><span class="org-comment">we'd</span><span class="org-whitespace-space"> </span><span class="org-comment">get</span><span class="org-whitespace-space"> </span><span class="org-comment">only</span><span class="org-whitespace-space"> </span><span class="org-comment">3</span><span class="org-whitespace-space"> </span><span class="org-comment">nodes</span><span class="org-whitespace-space"> </span><span class="org-comment">per</span><span class="org-whitespace-space"> </span><span class="org-comment">4kB</span><span class="org-whitespace-space"> </span><span class="org-comment">page.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-preprocessor">#if</span><span class="org-negation-char"><span class="org-preprocessor">n</span></span><span class="org-preprocessor">def</span><span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_CHUNK_SHIFT</span><span class="org-whitespace-tab">          </span>(CONFIG_BASE_SMALL<span class="org-whitespace-space"> </span>?<span class="org-whitespace-space"> </span>4<span class="org-whitespace-space"> </span>:<span class="org-whitespace-space"> </span>6)
<span class="org-preprocessor">#endif</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_CHUNK_SIZE</span><span class="org-whitespace-tab">           </span>(1UL<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_CHUNK_MASK</span><span class="org-whitespace-tab">           </span>(XA_CHUNK_SIZE<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_MAX_MARKS</span><span class="org-whitespace-tab">            </span>3
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_MARK_LONGS</span><span class="org-whitespace-tab">           </span>DIV_ROUND_UP(XA_CHUNK_SIZE,<span class="org-whitespace-space"> </span>BITS_PER_LONG)

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@count</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">count</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">every</span><span class="org-whitespace-space"> </span><span class="org-comment">non-NULL</span><span class="org-whitespace-space"> </span><span class="org-comment">element</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">-&gt;slots</span><span class="org-whitespace-space"> </span><span class="org-comment">array</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">whether</span><span class="org-whitespace-space"> </span><span class="org-comment">that</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">value</span><span class="org-whitespace-space"> </span><span class="org-comment">entry,</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">retry</span><span class="org-whitespace-space"> </span><span class="org-comment">entry,</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">user</span><span class="org-whitespace-space"> </span><span class="org-comment">pointer,</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">sibling</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">or</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">pointer</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">next</span><span class="org-whitespace-space"> </span><span class="org-comment">level</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">tree.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@nr_values</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">count</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">every</span><span class="org-whitespace-space"> </span><span class="org-comment">element</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">-&gt;slots</span><span class="org-whitespace-space"> </span><span class="org-comment">which</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">either</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">value</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">or</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">sibling</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">value</span><span class="org-whitespace-space"> </span><span class="org-comment">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">char</span><span class="org-whitespace-tab">   </span><span class="org-variable-name">shift</span>;<span class="org-whitespace-tab">          </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Bits</span><span class="org-whitespace-space"> </span><span class="org-comment">remaining</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">each</span><span class="org-whitespace-space"> </span><span class="org-comment">slot</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">char</span><span class="org-whitespace-tab">   </span><span class="org-variable-name">offset</span>;<span class="org-whitespace-tab">         </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Slot</span><span class="org-whitespace-space"> </span><span class="org-comment">offset</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">parent</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">char</span><span class="org-whitespace-tab">   </span><span class="org-variable-name">count</span>;<span class="org-whitespace-tab">          </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Total</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">count</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">char</span><span class="org-whitespace-tab">   </span><span class="org-variable-name">nr_values</span>;<span class="org-whitespace-tab">      </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Value</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">count</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span><span class="org-type">__rcu</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">parent</span>;<span class="org-whitespace-tab">   </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">NULL</span><span class="org-whitespace-space"> </span><span class="org-comment">at</span><span class="org-whitespace-space"> </span><span class="org-comment">top</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">tree</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-tab">   </span>*<span class="org-variable-name">array</span>;<span class="org-whitespace-tab">         </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">The</span><span class="org-whitespace-space"> </span><span class="org-comment">array</span><span class="org-whitespace-space"> </span><span class="org-comment">we</span><span class="org-whitespace-space"> </span><span class="org-comment">belong</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">        </span><span class="org-keyword">union</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">list_head</span><span class="org-whitespace-space"> </span><span class="org-variable-name">private_list</span>;<span class="org-whitespace-tab">  </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">For</span><span class="org-whitespace-space"> </span><span class="org-comment">tree</span><span class="org-whitespace-space"> </span><span class="org-comment">user</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">                </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">rcu_head</span><span class="org-whitespace-tab"> </span><span class="org-variable-name">rcu_head</span>;<span class="org-whitespace-tab">       </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Used</span><span class="org-whitespace-space"> </span><span class="org-comment">when</span><span class="org-whitespace-space"> </span><span class="org-comment">freeing</span><span class="org-whitespace-space"> </span><span class="org-comment">node</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">        </span>};
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-variable-name">__rcu</span><span class="org-whitespace-tab">      </span>*slots[XA_CHUNK_SIZE];
<span class="org-whitespace-space">        </span><span class="org-keyword">union</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-tab">   </span><span class="org-variable-name">tags</span>[XA_MAX_MARKS][XA_MARK_LONGS];
<span class="org-whitespace-space">                </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-tab">   </span><span class="org-variable-name">marks</span>[XA_MAX_MARKS][XA_MARK_LONGS];
<span class="org-whitespace-space">        </span>};
};

<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_dump</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*);
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_dump_node</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*);

<span class="org-preprocessor">#ifdef</span><span class="org-whitespace-space"> </span>XA_DEBUG
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">XA_BUG_ON</span>(<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">x</span>)<span class="org-whitespace-space"> </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{<span class="org-whitespace-tab">                                   </span>\
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(x)<span class="org-whitespace-space"> </span>{<span class="org-whitespace-tab">                                        </span>\
<span class="org-whitespace-space">                        </span>xa_dump(xa);<span class="org-whitespace-tab">                            </span>\
<span class="org-whitespace-space">                        </span>BUG();<span class="org-whitespace-tab">                                  </span>\
<span class="org-whitespace-space">                </span>}<span class="org-whitespace-tab">                                               </span>\
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(0)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">XA_NODE_BUG_ON</span>(<span class="org-variable-name">node</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">x</span>)<span class="org-whitespace-space"> </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{<span class="org-whitespace-tab">                            </span>\
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(x)<span class="org-whitespace-space"> </span>{<span class="org-whitespace-tab">                                        </span>\
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node)<span class="org-whitespace-space"> </span>xa_dump_node(node);<span class="org-whitespace-tab">           </span>\
<span class="org-whitespace-space">                        </span>BUG();<span class="org-whitespace-tab">                                  </span>\
<span class="org-whitespace-space">                </span>}<span class="org-whitespace-tab">                                               </span>\
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(0)
<span class="org-preprocessor">#else</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">XA_BUG_ON</span>(<span class="org-variable-name">xa</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">x</span>)<span class="org-whitespace-tab">        </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{<span class="org-whitespace-space"> </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(0)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">XA_NODE_BUG_ON</span>(<span class="org-variable-name">node</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">x</span>)<span class="org-whitespace-tab"> </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{<span class="org-whitespace-space"> </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(0)
<span class="org-preprocessor">#endif</span>

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Private</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_head</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>rcu_dereference_check(xa-&gt;xa_head,
<span class="org-whitespace-space">                                                </span>lockdep_is_held(&amp;xa-&gt;xa_lock));
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Private</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_head_locked</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>rcu_dereference_protected(xa-&gt;xa_head,
<span class="org-whitespace-space">                                                </span>lockdep_is_held(&amp;xa-&gt;xa_lock));
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Private</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_entry</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,
<span class="org-whitespace-space">                                </span><span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span>)
{
<span class="org-whitespace-space">        </span>XA_NODE_BUG_ON(node,<span class="org-whitespace-space"> </span>offset<span class="org-whitespace-space"> </span>&gt;=<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE);
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>rcu_dereference_check(node-&gt;slots[offset],
<span class="org-whitespace-space">                                                </span>lockdep_is_held(&amp;xa-&gt;xa_lock));
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Private</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_entry_locked</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,
<span class="org-whitespace-space">                                </span><span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span>)
{
<span class="org-whitespace-space">        </span>XA_NODE_BUG_ON(node,<span class="org-whitespace-space"> </span>offset<span class="org-whitespace-space"> </span>&gt;=<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE);
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>rcu_dereference_protected(node-&gt;slots[offset],
<span class="org-whitespace-space">                                                </span>lockdep_is_held(&amp;xa-&gt;xa_lock));
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Private</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_parent</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,
<span class="org-whitespace-space">                                        </span><span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>rcu_dereference_check(node-&gt;parent,
<span class="org-whitespace-space">                                                </span>lockdep_is_held(&amp;xa-&gt;xa_lock));
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Private</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_parent_locked</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>,
<span class="org-whitespace-space">                                        </span><span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>rcu_dereference_protected(node-&gt;parent,
<span class="org-whitespace-space">                                                </span>lockdep_is_held(&amp;xa-&gt;xa_lock));
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Private</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_mk_node</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(<span class="org-type">void</span><span class="org-whitespace-space"> </span>*)((<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)node<span class="org-whitespace-space"> </span>|<span class="org-whitespace-space"> </span>2);
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Private</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_to_node</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*)((<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)entry<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>2);
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Private</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_is_node</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_is_internal(entry)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)entry<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>4096;
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Private</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xa_mk_sibling</span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_mk_internal(offset);
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Private</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_to_sibling</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_to_internal(entry);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_is_sibling()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Is</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">sibling</span><span class="org-whitespace-space"> </span><span class="org-doc">entry?</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Entry</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieved</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%true</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">sibling</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_is_sibling</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>IS_ENABLED(CONFIG_XARRAY_MULTI)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>xa_is_internal(entry)<span class="org-whitespace-space"> </span>&amp;&amp;
<span class="org-whitespace-space">                </span>(entry<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>xa_mk_sibling(XA_CHUNK_SIZE<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1));
}

<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XA_RETRY_ENTRY</span><span class="org-whitespace-tab">          </span>xa_mk_internal(256)

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_is_retry()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Is</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">entry?</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Entry</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieved</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%true</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_is_retry</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>unlikely(entry<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_RETRY_ENTRY);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_is_advanced()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Is</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">only</span><span class="org-whitespace-space"> </span><span class="org-doc">permitted</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">advanced</span><span class="org-whitespace-space"> </span><span class="org-doc">API?</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Entry</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%true</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">cannot</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">normal</span><span class="org-whitespace-space"> </span><span class="org-doc">API.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xa_is_advanced</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_is_internal(entry)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>(entry<span class="org-whitespace-space"> </span>&lt;=<span class="org-whitespace-space"> </span>XA_RETRY_ENTRY);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">typedef</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_update_node_t</span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">callback</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@node</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">node</span><span class="org-whitespace-space"> </span><span class="org-doc">which</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">being</span><span class="org-whitespace-space"> </span><span class="org-doc">processed</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">called</span><span class="org-whitespace-space"> </span><span class="org-doc">every</span><span class="org-whitespace-space"> </span><span class="org-doc">time</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">updates</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">count</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">present</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">value</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">node.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">allows</span><span class="org-whitespace-space"> </span><span class="org-doc">advanced</span><span class="org-whitespace-space"> </span><span class="org-doc">users</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">maintain</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">private_list</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">node.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">held</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">interrupts</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">disabled.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-tab">      </span><span class="org-whitespace-space">    </span><span class="org-doc">Implementations</span><span class="org-whitespace-space"> </span><span class="org-doc">should</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">drop</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock,</span><span class="org-whitespace-space"> </span><span class="org-doc">nor</span><span class="org-whitespace-space"> </span><span class="org-doc">re-enable</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-tab">      </span><span class="org-whitespace-space">    </span><span class="org-doc">interrupts.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">typedef</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>(*<span class="org-type">xa_update_node_t</span>)(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>);

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">The</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_state</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">opaque</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">its</span><span class="org-whitespace-space"> </span><span class="org-comment">users.</span><span class="org-whitespace-space">  </span><span class="org-comment">It</span><span class="org-whitespace-space"> </span><span class="org-comment">contains</span><span class="org-whitespace-space"> </span><span class="org-comment">various</span><span class="org-whitespace-space"> </span><span class="org-comment">different</span><span class="org-whitespace-space"> </span><span class="org-comment">pieces</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">state</span><span class="org-whitespace-space"> </span><span class="org-comment">involved</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">current</span><span class="org-whitespace-space"> </span><span class="org-comment">operation</span><span class="org-whitespace-space"> </span><span class="org-comment">on</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray.</span><span class="org-whitespace-space">  </span><span class="org-comment">It</span><span class="org-whitespace-space"> </span><span class="org-comment">should</span><span class="org-whitespace-space"> </span><span class="org-comment">be</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">declared</span><span class="org-whitespace-space"> </span><span class="org-comment">on</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">stack</span><span class="org-whitespace-space"> </span><span class="org-comment">and</span><span class="org-whitespace-space"> </span><span class="org-comment">passed</span><span class="org-whitespace-space"> </span><span class="org-comment">between</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">various</span><span class="org-whitespace-space"> </span><span class="org-comment">internal</span><span class="org-whitespace-space"> </span><span class="org-comment">routines.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">The</span><span class="org-whitespace-space"> </span><span class="org-comment">various</span><span class="org-whitespace-space"> </span><span class="org-comment">elements</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">it</span><span class="org-whitespace-space"> </span><span class="org-comment">should</span><span class="org-whitespace-space"> </span><span class="org-comment">not</span><span class="org-whitespace-space"> </span><span class="org-comment">be</span><span class="org-whitespace-space"> </span><span class="org-comment">accessed</span><span class="org-whitespace-space"> </span><span class="org-comment">directly,</span><span class="org-whitespace-space"> </span><span class="org-comment">but</span><span class="org-whitespace-space"> </span><span class="org-comment">only</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">through</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">provided</span><span class="org-whitespace-space"> </span><span class="org-comment">accessor</span><span class="org-whitespace-space"> </span><span class="org-comment">functions.</span><span class="org-whitespace-space">  </span><span class="org-comment">The</span><span class="org-whitespace-space"> </span><span class="org-comment">below</span><span class="org-whitespace-space"> </span><span class="org-comment">documentation</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">benefit</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">those</span><span class="org-whitespace-space"> </span><span class="org-comment">working</span><span class="org-whitespace-space"> </span><span class="org-comment">on</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">code,</span><span class="org-whitespace-space"> </span><span class="org-comment">not</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">users</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">@xa_node</span><span class="org-whitespace-space"> </span><span class="org-comment">usually</span><span class="org-whitespace-space"> </span><span class="org-comment">points</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_node</span><span class="org-whitespace-space"> </span><span class="org-comment">containing</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">slot</span><span class="org-whitespace-space"> </span><span class="org-comment">we're</span><span class="org-whitespace-space"> </span><span class="org-comment">operating</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">on</span><span class="org-whitespace-space"> </span><span class="org-comment">(and</span><span class="org-whitespace-space"> </span><span class="org-comment">@xa_offset</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">offset</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">slots</span><span class="org-whitespace-space"> </span><span class="org-comment">array).</span><span class="org-whitespace-space">  </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">there</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">single</span><span class="org-whitespace-space"> </span><span class="org-comment">entry</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">array</span><span class="org-whitespace-space"> </span><span class="org-comment">at</span><span class="org-whitespace-space"> </span><span class="org-comment">index</span><span class="org-whitespace-space"> </span><span class="org-comment">0,</span><span class="org-whitespace-space"> </span><span class="org-comment">there</span><span class="org-whitespace-space"> </span><span class="org-comment">are</span><span class="org-whitespace-space"> </span><span class="org-comment">no</span><span class="org-whitespace-space"> </span><span class="org-comment">allocated</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_nodes</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">point</span><span class="org-whitespace-space"> </span><span class="org-comment">to,</span><span class="org-whitespace-space"> </span><span class="org-comment">and</span><span class="org-whitespace-space"> </span><span class="org-comment">so</span><span class="org-whitespace-space"> </span><span class="org-comment">we</span><span class="org-whitespace-space"> </span><span class="org-comment">store</span><span class="org-whitespace-space"> </span><span class="org-comment">%NULL</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">@xa_node.</span><span class="org-whitespace-space">  </span><span class="org-comment">@xa_node</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">set</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">value</span><span class="org-whitespace-space"> </span><span class="org-comment">%XAS_RESTART</span><span class="org-whitespace-space"> </span><span class="org-comment">if</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_state</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">not</span><span class="org-whitespace-space"> </span><span class="org-comment">walked</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">correct</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">position</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">tree</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">nodes</span><span class="org-whitespace-space"> </span><span class="org-comment">for</span><span class="org-whitespace-space"> </span><span class="org-comment">this</span><span class="org-whitespace-space"> </span><span class="org-comment">operation.</span><span class="org-whitespace-space">  </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">error</span><span class="org-whitespace-space"> </span><span class="org-comment">occurs</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">during</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">operation,</span><span class="org-whitespace-space"> </span><span class="org-comment">it</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">set</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">%XAS_ERROR</span><span class="org-whitespace-space"> </span><span class="org-comment">value.</span><span class="org-whitespace-space">  </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">we</span><span class="org-whitespace-space"> </span><span class="org-comment">run</span><span class="org-whitespace-space"> </span><span class="org-comment">off</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">end</span><span class="org-whitespace-space"> </span><span class="org-comment">of</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">allocated</span><span class="org-whitespace-space"> </span><span class="org-comment">nodes,</span><span class="org-whitespace-space"> </span><span class="org-comment">it</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">set</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">%XAS_BOUNDS.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xarray</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa</span>;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">xa_index</span>;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">char</span><span class="org-whitespace-space"> </span><span class="org-variable-name">xa_shift</span>;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">char</span><span class="org-whitespace-space"> </span><span class="org-variable-name">xa_sibs</span>;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">char</span><span class="org-whitespace-space"> </span><span class="org-variable-name">xa_offset</span>;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">char</span><span class="org-whitespace-space"> </span><span class="org-variable-name">xa_pad</span>;<span class="org-whitespace-tab">           </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Helps</span><span class="org-whitespace-space"> </span><span class="org-comment">gcc</span><span class="org-whitespace-space"> </span><span class="org-comment">generate</span><span class="org-whitespace-space"> </span><span class="org-comment">better</span><span class="org-whitespace-space"> </span><span class="org-comment">code</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa_node</span>;
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xa_alloc</span>;
<span class="org-whitespace-space">        </span><span class="org-type">xa_update_node_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">xa_update</span>;
};

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">We</span><span class="org-whitespace-space"> </span><span class="org-comment">encode</span><span class="org-whitespace-space"> </span><span class="org-comment">errnos</span><span class="org-whitespace-space"> </span><span class="org-comment">in</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">xas-&gt;xa_node.</span><span class="org-whitespace-space">  </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">error</span><span class="org-whitespace-space"> </span><span class="org-comment">has</span><span class="org-whitespace-space"> </span><span class="org-comment">happened,</span><span class="org-whitespace-space"> </span><span class="org-comment">we</span><span class="org-whitespace-space"> </span><span class="org-comment">need</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">drop</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">lock</span><span class="org-whitespace-space"> </span><span class="org-comment">to</span><span class="org-whitespace-space"> </span><span class="org-comment">fix</span><span class="org-whitespace-space"> </span><span class="org-comment">it,</span><span class="org-whitespace-space"> </span><span class="org-comment">and</span><span class="org-whitespace-space"> </span><span class="org-comment">once</span><span class="org-whitespace-space"> </span><span class="org-comment">we've</span><span class="org-whitespace-space"> </span><span class="org-comment">done</span><span class="org-whitespace-space"> </span><span class="org-comment">so</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">xa_state</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">invalid.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">XA_ERROR</span>(<span class="org-variable-name">errno</span>)<span class="org-whitespace-space"> </span>((<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*)(((<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)errno<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>2)<span class="org-whitespace-space"> </span>|<span class="org-whitespace-space"> </span>2UL))
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XAS_BOUNDS</span><span class="org-whitespace-tab">      </span>((<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*)1UL)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-variable-name">XAS_RESTART</span><span class="org-whitespace-tab">     </span>((<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*)3UL)

<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">__XA_STATE</span>(<span class="org-variable-name">array</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">shift</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">sibs</span>)<span class="org-whitespace-space">  </span>{<span class="org-whitespace-tab">        </span>\
<span class="org-whitespace-space">        </span>.xa<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>array,<span class="org-whitespace-tab">                                    </span>\
<span class="org-whitespace-space">        </span>.xa_index<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-tab">                              </span>\
<span class="org-whitespace-space">        </span>.xa_shift<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>shift,<span class="org-whitespace-tab">                              </span>\
<span class="org-whitespace-space">        </span>.xa_sibs<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>sibs,<span class="org-whitespace-tab">                                </span>\
<span class="org-whitespace-space">        </span>.xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0,<span class="org-whitespace-tab">                                 </span>\
<span class="org-whitespace-space">        </span>.xa_pad<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>0,<span class="org-whitespace-tab">                                    </span>\
<span class="org-whitespace-space">        </span>.xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XAS_RESTART,<span class="org-whitespace-tab">                         </span>\
<span class="org-whitespace-space">        </span>.xa_alloc<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>,<span class="org-whitespace-tab">                               </span>\
<span class="org-whitespace-space">        </span>.xa_update<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span><span class="org-constant">NULL</span><span class="org-whitespace-tab">                               </span>\
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">XA_STATE()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Declare</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@name</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Name</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span><span class="org-whitespace-space"> </span><span class="org-doc">(usually</span><span class="org-whitespace-space"> </span><span class="org-doc">xas).</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@array</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Array</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">operate</span><span class="org-whitespace-space"> </span><span class="org-doc">on.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Initial</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">interest.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Declare</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">initialise</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_state</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">stack.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">XA_STATE</span>(<span class="org-variable-name">name</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">array</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>)<span class="org-whitespace-tab">                            </span>\
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span><span class="org-variable-name">name</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__XA_STATE(array,<span class="org-whitespace-space"> </span>index,<span class="org-whitespace-space"> </span>0,<span class="org-whitespace-space"> </span>0)

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">XA_STATE_ORDER()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Declare</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@name</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Name</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span><span class="org-whitespace-space"> </span><span class="org-doc">(usually</span><span class="org-whitespace-space"> </span><span class="org-doc">xas).</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@array</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Array</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">operate</span><span class="org-whitespace-space"> </span><span class="org-doc">on.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Initial</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">interest.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@order</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Order</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Declare</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">initialise</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_state</span><span class="org-whitespace-space"> </span><span class="org-doc">on</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">stack.</span><span class="org-whitespace-space">  </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">variant</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">XA_STATE()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">allows</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">specify</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">'order'</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">element</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">want</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">operate</span><span class="org-whitespace-space"> </span><span class="org-doc">on.`</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">XA_STATE_ORDER</span>(<span class="org-variable-name">name</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">array</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">order</span>)<span class="org-whitespace-tab">               </span>\
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span><span class="org-variable-name">name</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>__XA_STATE(array,<span class="org-whitespace-tab">                </span>\
<span class="org-whitespace-space">                        </span>(index<span class="org-whitespace-space"> </span>&gt;&gt;<span class="org-whitespace-space"> </span>order)<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>order,<span class="org-whitespace-tab">              </span>\
<span class="org-whitespace-space">                        </span>order<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>(order<span class="org-whitespace-space"> </span>%<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT),<span class="org-whitespace-tab">       </span>\
<span class="org-whitespace-space">                        </span>(1U<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>(order<span class="org-whitespace-space"> </span>%<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT))<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1)

<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_marked</span>(<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)<span class="org-whitespace-tab">   </span>xa_marked((xas)-&gt;xa,<span class="org-whitespace-space"> </span>(mark))
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_trylock</span>(<span class="org-variable-name">xas</span>)<span class="org-whitespace-tab">        </span>xa_trylock((xas)-&gt;xa)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_lock</span>(<span class="org-variable-name">xas</span>)<span class="org-whitespace-tab">           </span>xa_lock((xas)-&gt;xa)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_unlock</span>(<span class="org-variable-name">xas</span>)<span class="org-whitespace-tab">         </span>xa_unlock((xas)-&gt;xa)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_lock_bh</span>(<span class="org-variable-name">xas</span>)<span class="org-whitespace-tab">        </span>xa_lock_bh((xas)-&gt;xa)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_unlock_bh</span>(<span class="org-variable-name">xas</span>)<span class="org-whitespace-tab">      </span>xa_unlock_bh((xas)-&gt;xa)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_lock_irq</span>(<span class="org-variable-name">xas</span>)<span class="org-whitespace-tab">       </span>xa_lock_irq((xas)-&gt;xa)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_unlock_irq</span>(<span class="org-variable-name">xas</span>)<span class="org-whitespace-tab">     </span>xa_unlock_irq((xas)-&gt;xa)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_lock_irqsave</span>(<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">flags</span>)<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">                                </span>xa_lock_irqsave((xas)-&gt;xa,<span class="org-whitespace-space"> </span>flags)
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_unlock_irqrestore</span>(<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">flags</span>)<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">                                </span>xa_unlock_irqrestore((xas)-&gt;xa,<span class="org-whitespace-space"> </span>flags)

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_error()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Return</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">errno</span><span class="org-whitespace-space"> </span><span class="org-doc">stored</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">0</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">no</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span><span class="org-whitespace-space"> </span><span class="org-doc">noted.</span><span class="org-whitespace-space">  </span><span class="org-doc">A</span><span class="org-whitespace-space"> </span><span class="org-doc">negative</span><span class="org-whitespace-space"> </span><span class="org-doc">errno</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">one</span><span class="org-whitespace-space"> </span><span class="org-doc">has.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_error</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_err(xas-&gt;xa_node);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_set_err()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Note</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@err</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Negative</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">number.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Only</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">negative</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@err</span></span><span class="org-doc">;</span><span class="org-whitespace-space"> </span><span class="org-doc">zero</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">positive</span><span class="org-whitespace-space"> </span><span class="org-doc">errors</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">probably</span><span class="org-whitespace-space"> </span><span class="org-doc">not</span><span class="org-whitespace-space"> </span><span class="org-doc">behave</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">way</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">think</span><span class="org-whitespace-space"> </span><span class="org-doc">they</span><span class="org-whitespace-space"> </span><span class="org-doc">should.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">want</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">clear</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_state,</span><span class="org-whitespace-space"> </span><span class="org-doc">use</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_reset()</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_set_err</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">err</span>)
{
<span class="org-whitespace-space">        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XA_ERROR(err);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_invalid()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Is</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xas</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">state?</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%true</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xas</span><span class="org-whitespace-space"> </span><span class="org-doc">cannot</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">used</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">operations.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_invalid</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)xas-&gt;xa_node<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>3;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_valid()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Is</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xas</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">valid</span><span class="org-whitespace-space"> </span><span class="org-doc">cursor</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array?</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%true</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xas</span><span class="org-whitespace-space"> </span><span class="org-doc">can</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">used</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">operations.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_valid</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>xas_invalid(xas);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_is_node()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Does</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xas</span><span class="org-whitespace-space"> </span><span class="org-doc">point</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">node?</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%true</span></span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xas</span><span class="org-whitespace-space"> </span><span class="org-doc">currently</span><span class="org-whitespace-space"> </span><span class="org-doc">references</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">node.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_is_node</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_valid(xas)<span class="org-whitespace-space"> </span>&amp;&amp;<span class="org-whitespace-space"> </span>xas-&gt;xa_node;
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">True</span><span class="org-whitespace-space"> </span><span class="org-comment">if</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">pointer</span><span class="org-whitespace-space"> </span><span class="org-comment">is</span><span class="org-whitespace-space"> </span><span class="org-comment">something</span><span class="org-whitespace-space"> </span><span class="org-comment">other</span><span class="org-whitespace-space"> </span><span class="org-comment">than</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">node</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_not_node</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>((<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)node<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>3)<span class="org-whitespace-space"> </span>||<span class="org-whitespace-space"> </span><span class="org-negation-char">!</span>node;
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">True</span><span class="org-whitespace-space"> </span><span class="org-comment">if</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">node</span><span class="org-whitespace-space"> </span><span class="org-comment">represents</span><span class="org-whitespace-space"> </span><span class="org-comment">RESTART</span><span class="org-whitespace-space"> </span><span class="org-comment">or</span><span class="org-whitespace-space"> </span><span class="org-comment">an</span><span class="org-whitespace-space"> </span><span class="org-comment">error</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_frozen</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>(<span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span>)node<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>2;
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">True</span><span class="org-whitespace-space"> </span><span class="org-comment">if</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">node</span><span class="org-whitespace-space"> </span><span class="org-comment">represents</span><span class="org-whitespace-space"> </span><span class="org-comment">head-of-tree,</span><span class="org-whitespace-space"> </span><span class="org-comment">RESTART</span><span class="org-whitespace-space"> </span><span class="org-comment">or</span><span class="org-whitespace-space"> </span><span class="org-comment">BOUNDS</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_top</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>node<span class="org-whitespace-space"> </span>&lt;=<span class="org-whitespace-space"> </span>XAS_RESTART;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_reset()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Reset</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Resets</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">walk</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">so</span><span class="org-whitespace-space"> </span><span class="org-doc">future</span><span class="org-whitespace-space"> </span><span class="org-doc">walks</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">start</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">root.</span><span class="org-whitespace-space">  </span><span class="org-doc">Use</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">dropped</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">xarray</span><span class="org-whitespace-space"> </span><span class="org-doc">lock</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">want</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">reuse</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_reset</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XAS_RESTART;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_retry()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Retry</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">appropriate.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Entry</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">xarray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">advanced</span><span class="org-whitespace-space"> </span><span class="org-doc">functions</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">sometimes</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">internal</span><span class="org-whitespace-space"> </span><span class="org-doc">entry,</span><span class="org-whitespace-space"> </span><span class="org-doc">such</span><span class="org-whitespace-space"> </span><span class="org-doc">as</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">retry</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">zero</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span><span class="org-whitespace-space">  </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">sets</span><span class="org-whitespace-space"> </span><span class="org-doc">up</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">restart</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">walk</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">head</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">needed.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Context:</span><span class="org-whitespace-space"> </span><span class="org-doc">Any</span><span class="org-whitespace-space"> </span><span class="org-doc">context.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">true</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">needs</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">retried.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_retry</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xa_is_zero(entry))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">true</span>;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>xa_is_retry(entry))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">false</span>;
<span class="org-whitespace-space">        </span>xas_reset(xas);
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">true</span>;
}

<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_load</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*);
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_store</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_find</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_find_conflict</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*);

<span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_get_mark</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_set_mark</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_clear_mark</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_find_marked</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_mark_t</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_init_marks</span>(<span class="org-keyword">const</span><span class="org-whitespace-space"> </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*);

<span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_nomem</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*,<span class="org-whitespace-space"> </span><span class="org-type">gfp_t</span>);
<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_pause</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*);

<span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_create_range</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_reload()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Refetch</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xarray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Use</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">check</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">previously</span><span class="org-whitespace-space"> </span><span class="org-doc">loaded</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">still</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">same</span><span class="org-whitespace-space"> </span><span class="org-doc">value.</span><span class="org-whitespace-space">  </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">useful</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">lockless</span><span class="org-whitespace-space"> </span><span class="org-doc">pagecache</span><span class="org-whitespace-space"> </span><span class="org-doc">lookup</span><span class="org-whitespace-space"> </span><span class="org-doc">where</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">we</span><span class="org-whitespace-space"> </span><span class="org-doc">walk</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">with</span><span class="org-whitespace-space"> </span><span class="org-doc">only</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">lock</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">protect</span><span class="org-whitespace-space"> </span><span class="org-doc">us,</span><span class="org-whitespace-space"> </span><span class="org-doc">lock</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">page,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">then</span><span class="org-whitespace-space"> </span><span class="org-doc">check</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">page</span><span class="org-whitespace-space"> </span><span class="org-doc">hasn't</span><span class="org-whitespace-space"> </span><span class="org-doc">moved</span><span class="org-whitespace-space"> </span><span class="org-doc">since</span><span class="org-whitespace-space"> </span><span class="org-doc">we</span><span class="org-whitespace-space"> </span><span class="org-doc">looked</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">up.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">caller</span><span class="org-whitespace-space"> </span><span class="org-doc">guarantees</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">still</span><span class="org-whitespace-space"> </span><span class="org-doc">valid.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">restart</span><span class="org-whitespace-space"> </span><span class="org-doc">state,</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_load()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">instead.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">location</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xarray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_reload</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(node)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_entry(xas-&gt;xa,<span class="org-whitespace-space"> </span>node,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset);
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_head(xas-&gt;xa);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_set()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Set</span><span class="org-whitespace-space"> </span><span class="org-doc">up</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">different</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">New</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">into</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Move</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">refer</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">different</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span><span class="org-whitespace-space">  </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">effect</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">starting</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">walk</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">top;</span><span class="org-whitespace-space"> </span><span class="org-doc">see</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_next()</span></span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">move</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">adjacent</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_set</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>)
{
<span class="org-whitespace-space">        </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>index;
<span class="org-whitespace-space">        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XAS_RESTART;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_set_order()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Set</span><span class="org-whitespace-space"> </span><span class="org-doc">up</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">multislot</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@index</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Target</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">operation.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@order</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Entry</span><span class="org-whitespace-space"> </span><span class="org-doc">occupies</span><span class="org-whitespace-space"> </span><span class="org-doc">2^</span><span class="org-doc"><span class="org-constant">@order</span></span><span class="org-whitespace-space"> </span><span class="org-doc">indices.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_set_order</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">index</span>,
<span class="org-whitespace-space">                                        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">order</span>)
{
<span class="org-preprocessor">#ifdef</span><span class="org-whitespace-space"> </span>CONFIG_XARRAY_MULTI
<span class="org-whitespace-space">        </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>order<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>BITS_PER_LONG<span class="org-whitespace-space"> </span>?<span class="org-whitespace-space"> </span>(index<span class="org-whitespace-space"> </span>&gt;&gt;<span class="org-whitespace-space"> </span>order)<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>order<span class="org-whitespace-space"> </span>:<span class="org-whitespace-space"> </span>0;
<span class="org-whitespace-space">        </span>xas-&gt;xa_shift<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>order<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>(order<span class="org-whitespace-space"> </span>%<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT);
<span class="org-whitespace-space">        </span>xas-&gt;xa_sibs<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>(1<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>(order<span class="org-whitespace-space"> </span>%<span class="org-whitespace-space"> </span>XA_CHUNK_SHIFT))<span class="org-whitespace-space"> </span>-<span class="org-whitespace-space"> </span>1;
<span class="org-whitespace-space">        </span>xas-&gt;xa_node<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>XAS_RESTART;
<span class="org-preprocessor">#else</span>
<span class="org-whitespace-space">        </span>BUG_ON(order<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>0);
<span class="org-whitespace-space">        </span>xas_set(xas,<span class="org-whitespace-space"> </span>index);
<span class="org-preprocessor">#endif</span>
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_set_update()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Set</span><span class="org-whitespace-space"> </span><span class="org-doc">up</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">callback.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@update</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Function</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span><span class="org-whitespace-space"> </span><span class="org-doc">when</span><span class="org-whitespace-space"> </span><span class="org-doc">updating</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">node.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">can</span><span class="org-whitespace-space"> </span><span class="org-doc">notify</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">caller</span><span class="org-whitespace-space"> </span><span class="org-doc">after</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">updated</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_node.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">advanced</span><span class="org-whitespace-space"> </span><span class="org-doc">functionality</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">only</span><span class="org-whitespace-space"> </span><span class="org-doc">needed</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">page</span><span class="org-whitespace-space"> </span><span class="org-doc">cache.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_set_update</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">xa_update_node_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">update</span>)
{
<span class="org-whitespace-space">        </span>xas-&gt;xa_update<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>update;
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_next_entry()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Advance</span><span class="org-whitespace-space"> </span><span class="org-doc">iterator</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">present</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@max</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Highest</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">return.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_next_entry()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">inline</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">optimise</span><span class="org-whitespace-space"> </span><span class="org-doc">xarray</span><span class="org-whitespace-space"> </span><span class="org-doc">traversal</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">speed.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">equivalent</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_find()</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_find()</span></span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">hard</span><span class="org-whitespace-space"> </span><span class="org-doc">cases.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">present</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">after</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">one</span><span class="org-whitespace-space"> </span><span class="org-doc">currently</span><span class="org-whitespace-space"> </span><span class="org-doc">referred</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_next_entry</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;
<span class="org-whitespace-space">        </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">entry</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(unlikely(xas_not_node(node)<span class="org-whitespace-space"> </span>||<span class="org-whitespace-space"> </span>node-&gt;shift<span class="org-whitespace-space"> </span>||
<span class="org-whitespace-space">                        </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>!=<span class="org-whitespace-space"> </span>(xas-&gt;xa_index<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>XA_CHUNK_MASK)))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_find(xas,<span class="org-whitespace-space"> </span>max);

<span class="org-whitespace-space">        </span><span class="org-keyword">do</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(unlikely(xas-&gt;xa_index<span class="org-whitespace-space"> </span>&gt;=<span class="org-whitespace-space"> </span>max))
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_find(xas,<span class="org-whitespace-space"> </span>max);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(unlikely(xas-&gt;xa_offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_CHUNK_MASK))
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_find(xas,<span class="org-whitespace-space"> </span>max);
<span class="org-whitespace-space">                </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xa_entry(xas-&gt;xa,<span class="org-whitespace-space"> </span>node,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>1);
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(unlikely(xa_is_internal(entry)))
<span class="org-whitespace-space">                        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_find(xas,<span class="org-whitespace-space"> </span>max);
<span class="org-whitespace-space">                </span>xas-&gt;xa_offset++;
<span class="org-whitespace-space">                </span>xas-&gt;xa_index++;
<span class="org-whitespace-space">        </span>}<span class="org-whitespace-space"> </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>(<span class="org-negation-char">!</span>entry);

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>entry;
}

<span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">Private</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_find_chunk</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">bool</span><span class="org-whitespace-space"> </span><span class="org-variable-name">advance</span>,
<span class="org-whitespace-space">                </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">addr</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node-&gt;marks[(__force<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span>)mark];
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_offset;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(advance)
<span class="org-whitespace-space">                </span>offset++;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(XA_CHUNK_SIZE<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>BITS_PER_LONG)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(offset<span class="org-whitespace-space"> </span>&lt;<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE)<span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">                        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">data</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>*addr<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>(~0UL<span class="org-whitespace-space"> </span>&lt;&lt;<span class="org-whitespace-space"> </span>offset);
<span class="org-whitespace-space">                        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(data)
<span class="org-whitespace-space">                                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>__ffs(data);
<span class="org-whitespace-space">                </span>}
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>XA_CHUNK_SIZE;
<span class="org-whitespace-space">        </span>}

<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>find_next_bit(addr,<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE,<span class="org-whitespace-space"> </span>offset);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_next_marked()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Advance</span><span class="org-whitespace-space"> </span><span class="org-doc">iterator</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">marked</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@max</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Highest</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">return.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@mark</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Mark</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">search</span><span class="org-whitespace-space"> </span><span class="org-doc">for.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_next_marked()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">inline</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">optimise</span><span class="org-whitespace-space"> </span><span class="org-doc">xarray</span><span class="org-whitespace-space"> </span><span class="org-doc">traversal</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">speed.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">equivalent</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_find_marked()</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_find_marked()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">all</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">hard</span><span class="org-whitespace-space"> </span><span class="org-doc">cases.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">marked</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">after</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">one</span><span class="org-whitespace-space"> </span><span class="org-doc">currently</span><span class="org-whitespace-space"> </span><span class="org-doc">referred</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_next_marked</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">long</span><span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>,
<span class="org-whitespace-space">                                                                </span><span class="org-type">xa_mark_t</span><span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;
<span class="org-whitespace-space">        </span><span class="org-type">unsigned</span><span class="org-whitespace-space"> </span><span class="org-type">int</span><span class="org-whitespace-space"> </span><span class="org-variable-name">offset</span>;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(unlikely(xas_not_node(node)<span class="org-whitespace-space"> </span>||<span class="org-whitespace-space"> </span>node-&gt;shift))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_find_marked(xas,<span class="org-whitespace-space"> </span>max,<span class="org-whitespace-space"> </span>mark);
<span class="org-whitespace-space">        </span>offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_find_chunk(xas,<span class="org-whitespace-space"> </span><span class="org-constant">true</span>,<span class="org-whitespace-space"> </span>mark);
<span class="org-whitespace-space">        </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>offset;
<span class="org-whitespace-space">        </span>xas-&gt;xa_index<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>(xas-&gt;xa_index<span class="org-whitespace-space"> </span>&amp;<span class="org-whitespace-space"> </span>~XA_CHUNK_MASK)<span class="org-whitespace-space"> </span>+<span class="org-whitespace-space"> </span>offset;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(xas-&gt;xa_index<span class="org-whitespace-space"> </span>&gt;<span class="org-whitespace-space"> </span>max)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span><span class="org-constant">NULL</span>;
<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_CHUNK_SIZE)
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xas_find_marked(xas,<span class="org-whitespace-space"> </span>max,<span class="org-whitespace-space"> </span>mark);
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_entry(xas-&gt;xa,<span class="org-whitespace-space"> </span>node,<span class="org-whitespace-space"> </span>offset);
}

<span class="org-comment-delimiter">/*</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">If</span><span class="org-whitespace-space"> </span><span class="org-comment">iterating</span><span class="org-whitespace-space"> </span><span class="org-comment">while</span><span class="org-whitespace-space"> </span><span class="org-comment">holding</span><span class="org-whitespace-space"> </span><span class="org-comment">a</span><span class="org-whitespace-space"> </span><span class="org-comment">lock,</span><span class="org-whitespace-space"> </span><span class="org-comment">drop</span><span class="org-whitespace-space"> </span><span class="org-comment">the</span><span class="org-whitespace-space"> </span><span class="org-comment">lock</span><span class="org-whitespace-space"> </span><span class="org-comment">and</span><span class="org-whitespace-space"> </span><span class="org-comment">reschedule</span>
<span class="org-whitespace-space"> </span><span class="org-comment">*</span><span class="org-whitespace-space"> </span><span class="org-comment">every</span><span class="org-whitespace-space"> </span><span class="org-comment">%XA_CHECK_SCHED</span><span class="org-whitespace-space"> </span><span class="org-comment">loops.</span>
<span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
<span class="org-keyword">enum</span><span class="org-whitespace-space"> </span>{
<span class="org-whitespace-space">        </span><span class="org-variable-name">XA_CHECK_SCHED</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>4096,
};

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Iterate</span><span class="org-whitespace-space"> </span><span class="org-doc">over</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">range</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Entry</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieved</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@max</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Maximum</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieve</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">loop</span><span class="org-whitespace-space"> </span><span class="org-doc">body</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">executed</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">each</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">present</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xarray</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">between</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">current</span><span class="org-whitespace-space"> </span><span class="org-doc">xas</span><span class="org-whitespace-space"> </span><span class="org-doc">position</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@max</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieved</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xarray.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">safe</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">delete</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">loop</span><span class="org-whitespace-space"> </span><span class="org-doc">body.</span><span class="org-whitespace-space">  </span><span class="org-doc">You</span><span class="org-whitespace-space"> </span><span class="org-doc">should</span><span class="org-whitespace-space"> </span><span class="org-doc">hold</span><span class="org-whitespace-space"> </span><span class="org-doc">either</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">lock</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc">iterating.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">need</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">drop</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">lock,</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_pause()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">first.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_for_each</span>(<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>)<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_find(xas,<span class="org-whitespace-space"> </span>max);<span class="org-whitespace-space"> </span>entry;<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">             </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_next_entry(xas,<span class="org-whitespace-space"> </span>max))

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each_marked()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Iterate</span><span class="org-whitespace-space"> </span><span class="org-doc">over</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">range</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Entry</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieved</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@max</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Maximum</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieve</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@mark</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Mark</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">search</span><span class="org-whitespace-space"> </span><span class="org-doc">for.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">loop</span><span class="org-whitespace-space"> </span><span class="org-doc">body</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">executed</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">each</span><span class="org-whitespace-space"> </span><span class="org-doc">marked</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xarray</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">between</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">current</span><span class="org-whitespace-space"> </span><span class="org-doc">xas</span><span class="org-whitespace-space"> </span><span class="org-doc">position</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@max</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">set</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieved</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xarray.</span><span class="org-whitespace-space">  </span><span class="org-doc">It</span><span class="org-whitespace-space"> </span><span class="org-doc">is</span><span class="org-whitespace-space"> </span><span class="org-doc">safe</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">delete</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">loop</span><span class="org-whitespace-space"> </span><span class="org-doc">body.</span><span class="org-whitespace-space">  </span><span class="org-doc">You</span><span class="org-whitespace-space"> </span><span class="org-doc">should</span><span class="org-whitespace-space"> </span><span class="org-doc">hold</span><span class="org-whitespace-space"> </span><span class="org-doc">either</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">RCU</span><span class="org-whitespace-space"> </span><span class="org-doc">lock</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">xa_lock</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc">iterating.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">you</span><span class="org-whitespace-space"> </span><span class="org-doc">need</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">drop</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">lock,</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_pause()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">first.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_for_each_marked</span>(<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">entry</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">max</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">mark</span>)<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">        </span><span class="org-keyword">for</span><span class="org-whitespace-space"> </span>(entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_find_marked(xas,<span class="org-whitespace-space"> </span>max,<span class="org-whitespace-space"> </span>mark);<span class="org-whitespace-space"> </span>entry;<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">             </span>entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_next_marked(xas,<span class="org-whitespace-space"> </span>max,<span class="org-whitespace-space"> </span>mark))

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_for_each_conflict()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Iterate</span><span class="org-whitespace-space"> </span><span class="org-doc">over</span><span class="org-whitespace-space"> </span><span class="org-doc">a</span><span class="org-whitespace-space"> </span><span class="org-doc">range</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@entry</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">Entry</span><span class="org-whitespace-space"> </span><span class="org-doc">retrieved</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">loop</span><span class="org-whitespace-space"> </span><span class="org-doc">body</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">executed</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">each</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">lies</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">within</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">range</span><span class="org-whitespace-space"> </span><span class="org-doc">specified</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">loop</span><span class="org-whitespace-space"> </span><span class="org-doc">completes</span><span class="org-whitespace-space"> </span><span class="org-doc">successfully,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">any</span><span class="org-whitespace-space"> </span><span class="org-doc">entries</span><span class="org-whitespace-space"> </span><span class="org-doc">that</span><span class="org-whitespace-space"> </span><span class="org-doc">lie</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">range</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">replaced</span><span class="org-whitespace-space"> </span><span class="org-doc">by</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@entry</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">caller</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">break</span><span class="org-whitespace-space"> </span><span class="org-doc">out</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">loop;</span><span class="org-whitespace-space"> </span><span class="org-doc">if</span><span class="org-whitespace-space"> </span><span class="org-doc">they</span><span class="org-whitespace-space"> </span><span class="org-doc">do</span><span class="org-whitespace-space"> </span><span class="org-doc">so,</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">contents</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">unchanged.</span><span class="org-whitespace-space">  </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">fail</span><span class="org-whitespace-space"> </span><span class="org-doc">due</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">out</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">memory</span><span class="org-whitespace-space"> </span><span class="org-doc">condition.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">caller</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">also</span><span class="org-whitespace-space"> </span><span class="org-doc">call</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xa_set_err()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">exit</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">loop</span><span class="org-whitespace-space"> </span><span class="org-doc">while</span><span class="org-whitespace-space"> </span><span class="org-doc">setting</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">record</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">reason.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-preprocessor">#define</span><span class="org-whitespace-space"> </span><span class="org-function-name">xas_for_each_conflict</span>(<span class="org-variable-name">xas</span>,<span class="org-whitespace-space"> </span><span class="org-variable-name">entry</span>)<span class="org-whitespace-space"> </span>\
<span class="org-whitespace-space">        </span><span class="org-keyword">while</span><span class="org-whitespace-space"> </span>((entry<span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas_find_conflict(xas)))

<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">__xas_next</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*);
<span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">__xas_prev</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*);

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_prev()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Move</span><span class="org-whitespace-space"> </span><span class="org-doc">iterator</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">previous</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">was</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">state,</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">remain</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">never</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span><span class="org-whitespace-space"> </span><span class="org-doc">walked,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">effect</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_load()</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">Otherwise</span><span class="org-whitespace-space"> </span><span class="org-doc">one</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">subtracted</span><span class="org-whitespace-space"> </span><span class="org-doc">from</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">walked</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">correct</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">location</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">operation.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iterator</span><span class="org-whitespace-space"> </span><span class="org-doc">was</span><span class="org-whitespace-space"> </span><span class="org-doc">referencing</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">0,</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">wraps</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">around</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%ULONG_MAX</span></span><span class="org-doc">.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">new</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span><span class="org-whitespace-space">  </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">internal</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_prev</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(unlikely(xas_not_node(node)<span class="org-whitespace-space"> </span>||<span class="org-whitespace-space"> </span>node-&gt;shift<span class="org-whitespace-space"> </span>||
<span class="org-whitespace-space">                                </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>0))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>__xas_prev(xas);

<span class="org-whitespace-space">        </span>xas-&gt;xa_index--;
<span class="org-whitespace-space">        </span>xas-&gt;xa_offset--;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_entry(xas-&gt;xa,<span class="org-whitespace-space"> </span>node,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset);
}

<span class="org-doc">/**</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_next()</span></span><span class="org-whitespace-space"> </span><span class="org-doc">-</span><span class="org-whitespace-space"> </span><span class="org-doc">Move</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant"><span class="org-constant">@xas</span></span></span><span class="org-doc">:</span><span class="org-whitespace-space"> </span><span class="org-doc">XArray</span><span class="org-whitespace-space"> </span><span class="org-doc">operation</span><span class="org-whitespace-space"> </span><span class="org-doc">state.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">was</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">state,</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">remain</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">error</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">return</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">@xas</span></span><span class="org-whitespace-space"> </span><span class="org-doc">has</span><span class="org-whitespace-space"> </span><span class="org-doc">never</span><span class="org-whitespace-space"> </span><span class="org-doc">been</span><span class="org-whitespace-space"> </span><span class="org-doc">walked,</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">it</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">have</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">effect</span><span class="org-whitespace-space"> </span><span class="org-doc">of</span><span class="org-whitespace-space"> </span><span class="org-doc">calling</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">xas_load()</span></span><span class="org-doc">.</span><span class="org-whitespace-space">  </span><span class="org-doc">Otherwise</span><span class="org-whitespace-space"> </span><span class="org-doc">one</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">added</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc">and</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">state</span><span class="org-whitespace-space"> </span><span class="org-doc">will</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc">walked</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">correct</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">location</span><span class="org-whitespace-space"> </span><span class="org-doc">in</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">array</span><span class="org-whitespace-space"> </span><span class="org-doc">for</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">next</span><span class="org-whitespace-space"> </span><span class="org-doc">operation.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">If</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">iterator</span><span class="org-whitespace-space"> </span><span class="org-doc">was</span><span class="org-whitespace-space"> </span><span class="org-doc">referencing</span><span class="org-whitespace-space"> </span><span class="org-doc">index</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%ULONG_MAX</span></span><span class="org-doc">,</span><span class="org-whitespace-space"> </span><span class="org-doc">this</span><span class="org-whitespace-space"> </span><span class="org-doc">function</span><span class="org-whitespace-space"> </span><span class="org-doc">wraps</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">around</span><span class="org-whitespace-space"> </span><span class="org-doc">to</span><span class="org-whitespace-space"> </span><span class="org-doc">0.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">Return:</span><span class="org-whitespace-space"> </span><span class="org-doc">The</span><span class="org-whitespace-space"> </span><span class="org-doc">entry</span><span class="org-whitespace-space"> </span><span class="org-doc">at</span><span class="org-whitespace-space"> </span><span class="org-doc">the</span><span class="org-whitespace-space"> </span><span class="org-doc">new</span><span class="org-whitespace-space"> </span><span class="org-doc">index.</span><span class="org-whitespace-space">  </span><span class="org-doc">This</span><span class="org-whitespace-space"> </span><span class="org-doc">may</span><span class="org-whitespace-space"> </span><span class="org-doc">be</span><span class="org-whitespace-space"> </span><span class="org-doc"><span class="org-constant">%NULL</span></span><span class="org-whitespace-space"> </span><span class="org-doc">or</span><span class="org-whitespace-space"> </span><span class="org-doc">an</span><span class="org-whitespace-space"> </span><span class="org-doc">internal</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*</span><span class="org-whitespace-space"> </span><span class="org-doc">entry.</span>
<span class="org-whitespace-space"> </span><span class="org-doc">*/</span>
<span class="org-keyword">static</span><span class="org-whitespace-space"> </span><span class="org-keyword">inline</span><span class="org-whitespace-space"> </span><span class="org-type">void</span><span class="org-whitespace-space"> </span>*<span class="org-function-name">xas_next</span>(<span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_state</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">xas</span>)
{
<span class="org-whitespace-space">        </span><span class="org-keyword">struct</span><span class="org-whitespace-space"> </span><span class="org-type">xa_node</span><span class="org-whitespace-space"> </span>*<span class="org-variable-name">node</span><span class="org-whitespace-space"> </span>=<span class="org-whitespace-space"> </span>xas-&gt;xa_node;

<span class="org-whitespace-space">        </span><span class="org-keyword">if</span><span class="org-whitespace-space"> </span>(unlikely(xas_not_node(node)<span class="org-whitespace-space"> </span>||<span class="org-whitespace-space"> </span>node-&gt;shift<span class="org-whitespace-space"> </span>||
<span class="org-whitespace-space">                                </span>xas-&gt;xa_offset<span class="org-whitespace-space"> </span>==<span class="org-whitespace-space"> </span>XA_CHUNK_MASK))
<span class="org-whitespace-space">                </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>__xas_next(xas);

<span class="org-whitespace-space">        </span>xas-&gt;xa_index++;
<span class="org-whitespace-space">        </span>xas-&gt;xa_offset++;
<span class="org-whitespace-space">        </span><span class="org-keyword">return</span><span class="org-whitespace-space"> </span>xa_entry(xas-&gt;xa,<span class="org-whitespace-space"> </span>node,<span class="org-whitespace-space"> </span>xas-&gt;xa_offset);
}

<span class="org-preprocessor">#endif</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">/*</span><span class="org-whitespace-space"> </span><span class="org-comment">_LINUX_XARRAY_H</span><span class="org-whitespace-space"> </span><span class="org-comment-delimiter">*/</span>
</pre>
</div>

<script src="https://utteranc.es/client.js"
        repo="yygcode/yygcode.github.io"
        issue-term="pathname"
        label=" Utterances"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
<noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>
</div>
<div id="postamble" class="status">
<div class="copyright">
2012-2020 Copyright&copy; <i> YANYG - Powered by Emacs Orgmode</i>
</div>
</div>
</body>
</html>
